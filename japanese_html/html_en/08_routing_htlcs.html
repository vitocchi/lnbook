<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.16">
<title>Routing on a Network of Payment Channels</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;-webkit-tap-highlight-color:transparent}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="routing">Routing on a Network of <span class="keep-together">Payment Channels</span></h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this chapter we will finally unpack how payment channels can be connected to form a network of payment channels via a process called <em>routing</em>. Specifically, we will look at the first part of the routing layer, the "Atomic and trustless multihop contracts" protocol. This is highlighted by an outline in the protocol suite, shown in <a href="#LN_protocol_routing_highlight">Atomic payment routing in the Lightning protocol suite</a>.</p>
</div>
<div id="LN_protocol_routing_highlight" class="imageblock">
<div class="content">
<img src="images/mtln_0801.png" alt="Atomic payment routing in the Lightning protocol suite">
</div>
<div class="title">Figure 1. Atomic payment routing in the Lightning protocol suite</div>
</div>
<div class="sect2">
<h3 id="_routing_a_payment">Routing a Payment</h3>
<div class="paragraph">
<p>In this section we will examine routing from the perspective of Dina, a gamer who receives donations from her fans while she streams her game sessions.</p>
</div>
<div class="paragraph">
<p>The innovation of routed payment channels allows Dina to receive tips without maintaining a separate channel with every one of her fans who want to tip her.
As long as there exists a path of well-funded channels from that viewer to Dina, she will be able to receive payment from that fan.</p>
</div>
<div class="paragraph">
<p>In <a href="#dina_routing_diagram">Fans connected (in)directly to Dina on the Lightning Network</a> we see a possible network layout created by various payment channels between Lightning nodes. Everyone in this diagram can send Dina a payment by constructing a path. Imagine that Fan 4 wants to send Dina a payment. Do you see the path that could allow that to happen? Fan 4 could route a payment to Dina via Fan 3, Bob, and Chan. Similarly, Alice could route a payment to Dina via Bob and Chan.</p>
</div>
<div id="dina_routing_diagram" class="imageblock">
<div class="content">
<img src="images/mtln_0802.png" alt="Fans connected (in)directly to Dina on the Lightning Network">
</div>
<div class="title">Figure 2. Fans connected (in)directly to Dina on the Lightning Network</div>
</div>
<div class="paragraph">
<p>The nodes along the path from the fan to Dina are intermediaries called <em>routing nodes</em> in the context of routing a payment. There is no functional difference between the routing nodes and the nodes operated by Dina&#8217;s fans. Any Lightning node is capable of routing payments across its payment channels.</p>
</div>
<div class="paragraph">
<p>Importantly, the routing nodes are unable to steal the funds while routing a payment from a fan to Dina.
Furthermore, routing nodes cannot lose money while participating in the routing process.
Routing nodes can charge a routing fee for acting as an intermediary, although they don&#8217;t have to and may choose to route payments for free.</p>
</div>
<div class="paragraph">
<p>Another important detail is that due to the use of onion routing, intermediary nodes are only explicitly aware of the one node preceding them and the one node following them in the route.
They will not necessarily know who is the sender and recipient of the payment.
This enables fans to use intermediary nodes to pay Dina, without leaking private information and without risking theft.</p>
</div>
<div class="paragraph">
<p>This process of connecting a series of payment channels with end-to-end security, and the incentive structure for nodes to <em>forward</em> payments, is one of the key innovations of the Lightning Network.</p>
</div>
<div class="paragraph">
<p>In this chapter, we&#8217;ll dive into the mechanism of routing in the Lightning Network, detailing the precise manner in which payments flow through the network. First, we will clarify the concept of routing and compare it to that of pathfinding, because these are often confused and used interchangeably. Next, we will construct the fairness protocol: an atomic, trustless, multihop protocol used to route payments. To demonstrate how this fairness protocol works, we will be using a physical equivalent of transferring gold coins between four people. Finally, we will look at the atomic, trustless, multihop protocol implementation currently used in the Lightning Network, which is called a hash time-locked contract (HTLC).</p>
</div>
</div>
<div class="sect2">
<h3 id="_routing_versus_pathfinding">Routing Versus Pathfinding</h3>
<div class="paragraph">
<p>It&#8217;s important to note that we separate the concept of <em>routing</em> from the concept of <em>pathfinding</em>. These two concepts are often confused, and the term <em>routing</em> is often used to describe both concepts. Let&#8217;s remove the ambiguity before we proceed any further.</p>
</div>
<div class="paragraph">
<p>Pathfinding, which is covered in <a href="#path_finding">[path_finding]</a>, is the process of finding and choosing a contiguous path made of payment channels that connects sender A to recipient B. The sender of a payment does the pathfinding by examining the <em>channel graph</em> that they have assembled from channel announcements gossiped by other nodes.</p>
</div>
<div class="paragraph">
<p>Routing refers to the series of interactions across the network that attempt to forward a payment from some point A to another point B, across the path previously selected by pathfinding. Routing is the active process of sending a payment on a path, which involves the cooperation of all the intermediary nodes along that path.</p>
</div>
<div class="paragraph">
<p>An important rule of thumb is that it&#8217;s possible for a <em>path</em> to exist between Alice and Bob (perhaps even more than one), yet there may not be an active <em>route</em> on which to send the payment. One example is the scenario in which all the nodes connecting Alice and Bob are currently offline. In this example, one can examine the channel graph and connect a series of payment channels from Alice to Bob, hence a <em>path</em> exists. However, because the intermediary nodes are offline, the payment cannot be sent and so no <em>route</em> exists.</p>
</div>
</div>
<div class="sect2">
<h3 id="_creating_a_network_of_payment_channels">Creating a Network of Payment Channels</h3>
<div class="paragraph">
<p>Before we dive into the concept of an atomic trustless multihop payment, let&#8217;s work through an example.
Let&#8217;s return to Alice who, in previous chapters, purchased a coffee from Bob with whom she has an open channel.
Now Alice is watching a live stream from Dina, the gamer, and wants to send Dina a tip of 50,000 satoshis via the Lightning Network. But Alice has no direct channel with Dina. What can Alice do?</p>
</div>
<div class="paragraph">
<p>Alice could open a direct channel with Dina; however, that would require liquidity and on-chain fees which could be more than the value of the tip itself. Instead, Alice can use her existing open channels to send a tip to Dina <em>without</em> the need to open a channel directly with Dina. This is possible, as long as there exists some path of channels from Alice to Dina with sufficient capacity to route the tip.</p>
</div>
<div class="paragraph">
<p>As you can see in <a href="#routing_network">A network of payment channels between Alice and Dina</a>, Alice has an open channel with Bob, the coffee shop owner. Bob, in turn, has an open channel with the software developer Chan who helps him with the point of sale system he uses in his coffee shop. Chan is also the owner of a large software company which develops the game that Dina plays, and they already have an open channel which Dina uses to pay for the game&#8217;s license and in-game items.</p>
</div>
<div id="routing_network" class="imageblock">
<div class="content">
<img src="images/mtln_0803.png" alt="A network of payment channels between Alice and Dina">
</div>
<div class="title">Figure 3. A network of payment channels between Alice and Dina</div>
</div>
<div class="paragraph">
<p>It&#8217;s possible to trace a <em>path</em> from Alice to Dina that uses Bob and Chan as intermediary routing nodes.
Alice can then craft a <em>route</em> from this outlined path and use it to send a tip of a few thousand satoshis to Dina, with the payment being <em>forwarded</em> by Bob and Chan.
Essentially, Alice will pay Bob, who will pay Chan, who will pay Dina. No direct channel from Alice to Dina is required.</p>
</div>
<div class="paragraph">
<p>The main challenge is to do this in a way that prevents Bob and Chan from stealing the money that Alice wants delivered to Dina.</p>
</div>
</div>
<div class="sect2">
<h3 id="_a_physical_example_of_routing">A Physical Example of "Routing"</h3>
<div class="paragraph">
<p>To understand how the Lightning Network protects the payment while being routed, we can compare it to an example of routing physical payments with gold coins in the real world.</p>
</div>
<div class="paragraph">
<p>Assume Alice wants to give 10 gold coins to Dina, but does not have direct access to Dina. However, Alice knows Bob, who knows Chan, who knows Dina, so she decides to ask Bob and Chan for help. This is shown in <a href="#alice_dina_routing_1">Alice wants to pay Dina 10 gold coins</a>.</p>
</div>
<div id="alice_dina_routing_1" class="imageblock">
<div class="content">
<img src="images/mtln_0804.png" alt="mtln 0804">
</div>
<div class="title">Figure 4. Alice wants to pay Dina 10 gold coins</div>
</div>
<div class="paragraph">
<p>Alice can pay Bob to pay Chan to pay Dina, but how does she make sure that Bob or Chan don&#8217;t run off with the coins after receiving them?
In the physical world, contracts could be used for safely carrying out a series of payments.</p>
</div>
<div class="paragraph">
<p>Alice could negotiate a contract with Bob, which reads:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><em>I, Alice, will give you, Bob, 10 gold coins if you pass them on to Chan.</em></p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>While this contract is nice in the abstract, in the real world, Alice runs the risk that Bob might breach the contract and hope not to get caught.
Even if Bob is caught and prosecuted, Alice faces the risk that he might be bankrupt and be unable to return her 10 gold coins.
Assuming these issues are magically solved, it&#8217;s still unclear how to leverage such a contract to achieve our desired outcome: getting the coins delivered to Dina.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s improve our contract to incorporate these considerations:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><em>I, Alice, will reimburse you, Bob, with 10 gold coins if you can prove to me (for example, via a receipt) that you have delivered 10 gold coins to Chan.</em></p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>You might ask yourself why should Bob sign such a contract.
He has to pay Chan but ultimately gets nothing out of the exchange, and he runs the risk that Alice might not reimburse him. Bob could offer Chan a similar contract to pay Dina, but similarly Chan has no reason to accept it either.</p>
</div>
<div class="paragraph">
<p>Even putting aside the risk, Bob and Chan must <em>already</em> have 10 gold coins to send; otherwise, they wouldn&#8217;t be able to participate in the contract.</p>
</div>
<div class="paragraph">
<p>Thus Bob and Chan face both risk and opportunity cost for agreeing to this contract, and they would need to be compensated to accept it.</p>
</div>
<div class="paragraph">
<p>Alice can then make this attractive to both Bob and Chan by offering them fees of one gold coin each, if they transmit her payment to Dina.</p>
</div>
<div class="paragraph">
<p>The contract would then read:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><em>I, Alice, will reimburse you, Bob, with 12 gold coins if you can prove to me (for example, via a receipt) that you have delivered 11 gold coins to Chan.</em></p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Alice now promises Bob 12 gold coins. There are 10 to be delivered to Dina and 2 for the fees. She promises 12 to Bob if he can prove that he has forwarded 11 to Chan.
The difference of one gold coin is the fee that Bob will earn for helping out with this particular payment. In <a href="#alice_dina_routing_2">Alice pays Bob, Bob pays Chan, Chan pays Dina</a> we see how this arrangement would get 10 gold coins to Dina via Bob and Chan.</p>
</div>
<div id="alice_dina_routing_2" class="imageblock">
<div class="content">
<img src="images/mtln_0805.png" alt="mtln 0805">
</div>
<div class="title">Figure 5. Alice pays Bob, Bob pays Chan, Chan pays Dina</div>
</div>
<div class="paragraph">
<p>Because there is still the issue of trust and the risk that either Alice or Bob won&#8217;t honor the contract, all parties decide to use an escrow service.
At the start of the exchange, Alice could "lock up" these 12 gold coins in escrow that will only be paid to Bob once he proves that he&#8217;s paid 11 gold coins to Chan.</p>
</div>
<div class="paragraph">
<p>This escrow service is an idealized one, which does not introduce other risks (e.g., counterparty risk). Later we will see how we can replace the escrow with a Bitcoin smart contract. Let&#8217;s assume for now that everyone trusts this escrow service.</p>
</div>
<div class="paragraph">
<p>In the Lightning Network, the receipt (proof of payment) could take the form of a secret that only Dina knows.
In practice, this secret would be a random number that is large enough to prevent others from guessing it (typically a <em>very, very</em> large number, encoded using 256 bits!).</p>
</div>
<div class="paragraph">
<p>Dina generates this secret value R from a random number generator.</p>
</div>
<div class="paragraph">
<p>The secret could then be committed to the contract by including the SHA-256 hash of the secret in the contract itself, as follows:</p>
</div>
<ul class="simplelist">
<li><em>H</em> = SHA-256(<em>R</em>)</li>
</ul>
<div class="paragraph">
<p>We call this hash of the payment&#8217;s secret the <em>payment hash</em>.
The secret that "unlocks" the payment is called the <em>payment secret</em>.</p>
</div>
<div class="paragraph">
<p>For now, we keep things simple and assume that Dina&#8217;s secret is simply the text line: <code>Dinas secret</code>. This secret message is called the <em>payment secret</em> or <em>payment preimage</em>.</p>
</div>
<div class="paragraph">
<p>To "commit" to this secret, Dina computes the SHA-256 hash, which when encoded in hexadecimal, can be displayed as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>0575965b3b44be51e8057d551c4016d83cb1fba9ea8d6e986447ba33fe69f6b3</pre>
</div>
</div>
<div class="paragraph">
<p>To facilitate Alice&#8217;s payment, Dina will create the payment secret and the payment hash, and send the payment hash to Alice. In <a href="#alice_dina_routing_3">Dina sends the hashed secret to Alice</a> we see that Dina sends the payment hash to Alice via some external channel (dashed line), such as an email or text message.</p>
</div>
<div id="alice_dina_routing_3" class="imageblock">
<div class="content">
<img src="images/mtln_0806.png" alt="Dina sends the hashed secret to Alice">
</div>
<div class="title">Figure 6. Dina sends the hashed secret to Alice</div>
</div>
<div class="paragraph">
<p>Alice doesn&#8217;t know the secret, but she can rewrite her contract to use the hash of the secret as a proof of payment:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><em>I, Alice, will reimburse you, Bob, with 12 gold coins if you can show me a valid message that hashes to:`057596`&#8230;&#8203;.
You can acquire this message by setting up a similar contract with Chan who has to set up a similar contract with Dina.
To assure you that you will be reimbursed, I will provide the 12 gold coins to a trusted escrow before you set up your next contract.</em></p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>This new contract now protects Alice from Bob not forwarding to Chan, protects Bob from not being reimbursed by Alice, and ensures that there will be proof that Dina was ultimately paid via the hash of Dina&#8217;s secret.</p>
</div>
<div class="paragraph">
<p>After Bob and Alice agree to the contract, and Bob receives the message from the escrow that Alice has deposited the 12 gold coins, Bob can now negotiate a similar contract with Chan.</p>
</div>
<div class="paragraph">
<p>Note that since Bob is taking a service fee of 1 coin, he will only forward 11 gold coins to Chan once Chan shows proof that he has paid Dina.
Similarly, Chan will also demand a fee and will expect to receive 11 gold coins once he has proved that he has paid Dina the promised 10 gold coins.</p>
</div>
<div class="paragraph">
<p>Bob&#8217;s contract with Chan will read:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><em>I, Bob, will reimburse you, Chan, with 11 gold coins if you can show me a valid message that hashes to:`057596`&#8230;&#8203;.
You can acquire this message by setting up a similar contract with Dina.
To assure you that you will be reimbursed, I will provide the 11 gold coins to a trusted escrow before you set up your next contract.</em></p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Once Chan gets the message from the escrow that Bob has deposited the 11 gold coins, Chan sets up a similar contract with Dina:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><em>I, Chan, will reimburse you, Dina, with 10 gold coins if you can show me a valid message that hashes to:`057596`&#8230;&#8203;.
To assure you that you will be reimbursed after revealing the secret, I will provide the 10 gold coins to a trusted escrow.</em></p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Everything is now in place.
Alice has a contract with Bob and has placed 12 gold coins in escrow.
Bob has a contract with Chan and has placed 11 gold coins in escrow.
Chan has a contract with Dina and has placed 10 gold coins in escrow.
It is now up to Dina to reveal the secret, which is the preimage to the hash she has established as proof of payment.</p>
</div>
<div class="paragraph">
<p>Dina now sends Dinas secret to Chan.</p>
</div>
<div class="paragraph">
<p>Chan checks that Dinas secret hashes to 057596&#8230;&#8203;. Chan now has proof of payment and so instructs the escrow service to release the 10 gold coins to Dina.</p>
</div>
<div class="paragraph">
<p>Chan now provides the secret to Bob. Bob checks it and instructs the escrow service to release the 11 gold coins to Chan.</p>
</div>
<div class="paragraph">
<p>Bob now provides the secret to Alice.
Alice checks it and instructs the escrow to release 12 gold coins to Bob.</p>
</div>
<div class="paragraph">
<p>All the contracts are now settled.
Alice has paid a total of 12 gold coins, 1 of which was received by Bob, 1 of which was received by Chan, and 10 of which were received by Dina.
With a chain of contracts like this in place, Bob and Chan could not run away with the money because they deposited it in escrow first.</p>
</div>
<div class="paragraph">
<p>However, one issue still remains.
If Dina refused to release her secret preimage, then Chan, Bob, and Alice would all have their coins stuck in escrow but wouldn&#8217;t be reimbursed.
And similarly if anyone else along the chain failed to pass on the secret, the same thing would happen.
So while no one can steal money from Alice, everyone would still have their money stuck in escrow permanently.</p>
</div>
<div class="paragraph">
<p>Luckily, this can be resolved by adding a deadline to the contract.</p>
</div>
<div class="paragraph">
<p>We could amend the contract so that if it is not fulfilled by a certain deadline, then the contract expires and the escrow service returns the money to the person who made the original deposit.
We call this deadline a <em>timelock</em>.</p>
</div>
<div class="paragraph">
<p>The deposit is locked with the escrow service for a certain amount of time and is eventually released even if no proof of payment was provided.</p>
</div>
<div class="paragraph">
<p>To factor this in, the contract between Alice and Bob is once again amended with a new clause:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><em>Bob has 24 hours to show the secret after the contract was signed.
If Bob does not provide the secret by this time, Alice&#8217;s deposit will be refunded by the escrow service and the contract becomes invalid.</em></p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Bob, of course, now has to make sure he receives the proof of payment within 24 hours.
Even if he successfully pays Chan, if he receives the proof of payment later than 24 hours, he will not be reimbursed. To remove that risk, Bob must give Chan an even shorter deadline.</p>
</div>
<div class="paragraph">
<p>In turn, Bob will alter his contract with Chan as follows:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><em>Chan has 22 hours to show the secret after the contract was signed.
If he does not provide the secret by this time, Bob&#8217;s deposit will be refunded by the escrow service and the contract becomes invalid.</em></p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>As you might have guessed, Chan will also alter his contract with Dina:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><em>Dina has 20 hours to show the secret after the contract was signed.
If she does not provide the secret by this time, Chan&#8217;s deposit will be refunded by the escrow service and the contract becomes invalid.</em></p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>With such a chain of contracts we can ensure that, after 24 hours, the payment will successfully go from Alice to Bob to Chan to Dina, or it will fail and everyone will be refunded.
Either the contract fails or succeeds, there&#8217;s no middle ground.</p>
</div>
<div class="paragraph">
<p>In the context of the Lightning Network, we call this "all or nothing" property <em>atomicity</em>.</p>
</div>
<div class="paragraph">
<p>As long as the escrow is trustworthy and faithfully performs its duty, no party will have their coins stolen in the process.</p>
</div>
<div class="paragraph">
<p>The precondition to this <em>route</em> working at all is that all parties in the path have enough money to satisfy the required series of deposits.</p>
</div>
<div class="paragraph">
<p>While this seems like a minor detail, we will see later in this chapter that this requirement is actually one of the more difficult issues for LN nodes.
It becomes progressively more difficult as the size of the payment increases.
Furthermore, the parties cannot use their money while it is locked in escrow.</p>
</div>
<div class="paragraph">
<p>Thus, users forwarding payments face an opportunity cost for locking the money, which is ultimately reimbursed through routing fees, as we saw in the preceding example.</p>
</div>
<div class="paragraph">
<p>Now that we&#8217;ve seen a physical payment routing example, we will see how this can be implemented on the Bitcoin blockchain, without any need for third-party escrow. To do this we will be setting up the contracts between the participants using Bitcoin Script. We replace the third-party escrow with <em>smart contracts</em> that implement a fairness protocol. Let&#8217;s break that concept down and implement it!</p>
</div>
</div>
<div class="sect2">
<h3 id="_fairness_protocol">Fairness Protocol</h3>
<div class="paragraph">
<p>As we saw in the first chapter of this book, the innovation of Bitcoin is the ability to use cryptographic primitives to implement a fairness protocol that substitutes trust in third parties (intermediaries) with a trusted protocol.</p>
</div>
<div class="paragraph">
<p>In our gold coin example, we needed an escrow service to prevent any one of the parties from reneging on their obligations. The innovation of cryptographic fairness protocols allows us to replace the escrow service with a protocol.</p>
</div>
<div class="paragraph">
<p>The properties of the fairness protocol we want to create are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Trustless operation</dt>
<dd>
<p>The participants in a routed payment do not need to trust each other, or any intermediary or third party. Instead, they trust the protocol to protect them from cheating.</p>
</dd>
<dt class="hdlist1">Atomicity</dt>
<dd>
<p>Either the payment is fully executed, or it fails and everyone is refunded. There is no possibility of an intermediary collecting a routed payment and not forwarding it to the next hop. Thus, the intermediaries can&#8217;t cheat or steal.</p>
</dd>
<dt class="hdlist1">Multihop</dt>
<dd>
<p>The security of the system extends end to end for payments routed through multiple payment channels, just as it is for a payment between the two ends of a single payment channel.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>An optional, additional property is the ability to split payments into multiple parts while maintaining atomicity for the entire payment. These are called <em>multipart payments</em> (<em>MPP</em>) and are explored further in <a href="#mpp">[mpp]</a>.</p>
</div>
<div class="sect3">
<h4 id="_implementing_atomic_trustless_multihop_payments">Implementing Atomic Trustless Multihop Payments</h4>
<div class="paragraph">
<p>Bitcoin Script is flexible enough that there are dozens of ways to implement a fairness protocol that has the properties of atomicity, trustless operation, and multihop security. Choosing a specific implementation is dependent on certain trade-offs among privacy, efficiency, and complexity.</p>
</div>
<div class="paragraph">
<p>The fairness protocol for routing used in the Lightning Network today is called a hash time-locked contract (HTLC). HTLCs use a hash preimage as the secret that unlocks a payment, as we saw in the gold coin example in this chapter. The recipient of a payment generates a random secret number and calculates its hash. The hash becomes the condition of payment, and once the secret is revealed, all the participants can redeem their incoming payments. HTLCs offer atomicity, trustless operation, and multihop security.</p>
</div>
<div class="paragraph">
<p>Another proposed mechanism for implementing routing is a <em>Point Time-Locked Contract</em> (<em>PTLC</em>). PTLCs also achieve atomicity, trustless operation, and multihop security, but do so with increased efficiency and better privacy.  Efficient implementation of PTLCs depends on a new digital signature algorithm called <em>Schnorr signatures</em>, which is expected to be activated in Bitcoin in 2021.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_revisiting_the_tipping_example">Revisiting the Tipping Example</h3>
<div class="paragraph">
<p>Let&#8217;s revisit our example from the first part of this chapter. Alice wants to tip Dina with a Lightning payment. Let&#8217;s say Alice wants to send Dina 50,000 satoshis as a tip.</p>
</div>
<div class="paragraph">
<p>For Alice to pay Dina, Alice will need Dina&#8217;s node to generate a Lightning invoice. We will discuss this in more detail in <a href="#invoices">[invoices]</a>. For now, let&#8217;s assume that Dina has a website that can produce a Lightning invoice for tips.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>Lightning payments can be sent without an invoice using a feature called <em>keysend</em>, which we will discuss in more detail in <a href="#keysend">[keysend]</a>. For now, we will explain the simpler payment flow using an invoice.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Alice visits Dina&#8217;s site, enters the amount of 50,000 satoshis in a form, and in response, Dina&#8217;s Lightning node generates a payment request for 50,000 satoshis in the form of a Lightning invoice. This interaction takes place over the web and outside the Lightning Network, as shown in <a href="#alice_dina_invoice_1">Alice requests an invoice from Dina&#8217;s website</a>.</p>
</div>
<div id="alice_dina_invoice_1" class="imageblock">
<div class="content">
<img src="images/mtln_0807.png" alt="Alice requests an invoice from Dina&#8217;s website">
</div>
<div class="title">Figure 7. Alice requests an invoice from Dina&#8217;s website</div>
</div>
<div class="paragraph">
<p>As we saw in previous examples, we assume that Alice does not have a direct payment channel to Dina. Instead, Alice has a channel to Bob, Bob has a channel to Chan, and Chan has a channel to Dina. To pay Dina, Alice must find a path that connects her to Dina. We will discuss that step in more detail in <a href="#path_finding">[path_finding]</a>. For now, let&#8217;s assume that Alice is able to gather information about available channels and sees that there is a path from her to Dina, via Bob and Chan.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>Remember how Bob and Chan might expect a small compensation for routing the payment through their nodes? Alice wants to pay Dina 50,000 satoshis, but as you will see in the following sections she will send Bob 50,200 satoshis. The extra 200 satoshis will pay Bob and Chan 100 satoshis each, as a routing fee.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now, Alice&#8217;s node can construct a Lightning payment. In the next few sections, we will see how Alice&#8217;s node constructs an HTLC to pay Dina and how that HTLC is forwarded along the path from Alice to Dina.</p>
</div>
<div class="sect3">
<h4 id="_on_chain_versus_off_chain_settlement_of_htlcs">On-Chain Versus Off-Chain Settlement of HTLCs</h4>
<div class="paragraph">
<p>The purpose of the Lightning Network is to enable <em>off-chain</em> transactions that are trusted just the same as on-chain transactions because no one can cheat. The reason no one can cheat is because at any time, any of the participants can take their off-chain transactions on-chain. Each off-chain transaction is ready to be submitted to the Bitcoin blockchain at any time. Thus, the Bitcoin blockchain acts as a dispute-resolution and final settlement mechanism if necessary.</p>
</div>
<div class="paragraph">
<p>The mere fact that any transaction can be taken on-chain at any time is precisely the reason that all those transactions can be kept off-chain. If you know you have recourse, you can continue to cooperate with the other participants and avoid the need for on-chain settlement and extra fees.</p>
</div>
<div class="paragraph">
<p>In all the examples that follow, we will assume that any of these transactions can be made on-chain at any time. The participants will choose to keep them off-chain, but there is no difference in the functionality of the system other than the higher fees and delay imposed by on-chain mining of the transactions. The example works the same if all the transactions are on-chain or off-chain.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="htlcs">Hash Time-Locked Contracts</h3>
<div class="paragraph">
<p>In this section we explain how HTLCs work.</p>
</div>
<div class="paragraph">
<p>The first part of an HTLC is the <em>hash</em>. This refers to the use of a cryptographic hash algorithm to commit to a randomly generated secret. Knowledge of the secret allows redemption of the payment. The cryptographic hash function guarantees that while it&#8217;s infeasible for anyone to guess the secret preimage, it&#8217;s easy for anyone to verify the hash, and there&#8217;s only one possible preimage that resolves the payment condition.</p>
</div>
<div class="paragraph">
<p>In <a href="#alice_dina_invoice_2">Alice gets a payment hash from Dina</a> we see Alice getting a Lightning invoice from Dina. Inside that invoice Dina has encoded a <em>payment hash</em>, which is the cryptographic hash of a secret that Dina&#8217;s node produced. Dina&#8217;s secret is called the <em>payment preimage</em>. The payment hash acts as an identifier that can be used to route the payment to Dina. The payment preimage acts as a receipt and proof of payment once the payment is complete.</p>
</div>
<div id="alice_dina_invoice_2" class="imageblock">
<div class="content">
<img src="images/mtln_0808.png" alt="Alice gets a payment hash from Dina">
</div>
<div class="title">Figure 8. Alice gets a payment hash from Dina</div>
</div>
<div class="paragraph">
<p>In the Lightning Network, Dina&#8217;s payment preimage won&#8217;t be a phrase like Dinas secret but a random number generated by Dina&#8217;s node. Let&#8217;s call that random number <em>R</em>.</p>
</div>
<div class="paragraph">
<p>Dina&#8217;s node will calculate a cryptographic hash of <em>R</em>, such that:</p>
</div>
<ul class="simplelist">
<li><em>H</em> = SHA-256(<em>R</em>)</li>
</ul>
<div class="paragraph">
<p>In this equation, <em>H</em> is the hash, or <em>payment hash</em> and <em>R</em> is the secret or <em>payment preimage</em>.</p>
</div>
<div class="paragraph">
<p>The use of a cryptographic hash function is one element that guarantees <em>trustless operation</em>. The payment intermediaries do not need to trust each other because they know that no one can guess the secret or fake it.</p>
</div>
<div class="sect3">
<h4 id="_htlcs_in_bitcoin_script">HTLCs in Bitcoin Script</h4>
<div class="paragraph">
<p>In our gold coin example, Alice had a contract enforced by escrow like this:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><em>Alice will reimburse Bob with 12 gold coins if you can show a valid message that hashes to:</em> 0575...f6b3. <em>Bob has 24 hours to show the secret after the contract was signed. If Bob does not provide the secret by this time, Alice&#8217;s deposit will be refunded by the escrow service and the contract becomes invalid.</em></p>
</div>
</blockquote>
</div>
<div class="paragraph pagebreak-before">
<p>Let&#8217;s see how we would implement this as an HTLC in Bitcoin Script. In <a href="#received_htlc">HTLC implemented in Bitcoin Script (BOLT #3)</a> we see an HTLC Bitcoin Script as currently used in the Lightning Network. You can find this definition in <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/03-transactions.md#offered-htlc-outputs">BOLT #3, Transactions</a>.</p>
</div>
<div id="received_htlc" class="exampleblock">
<div class="title">Example 1. HTLC implemented in Bitcoin Script (BOLT #3)</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre># To remote node with revocation key
OP_DUP OP_HASH160 &lt;RIPEMD160(SHA256(revocationpubkey))&gt; OP_EQUAL
OP_IF
    OP_CHECKSIG
OP_ELSE
    &lt;remote_htlcpubkey&gt; OP_SWAP OP_SIZE 32 OP_EQUAL
    OP_IF
        # To local node via HTLC-success transaction.
        OP_HASH160 &lt;RIPEMD160(payment_hash)&gt; OP_EQUALVERIFY
        2 OP_SWAP &lt;local_htlcpubkey&gt; 2 OP_CHECKMULTISIG
    OP_ELSE
        # To remote node after timeout.
        OP_DROP &lt;cltv_expiry&gt; OP_CHECKLOCKTIMEVERIFY OP_DROP
        OP_CHECKSIG
    OP_ENDIF
OP_ENDIF</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Wow, that looks complicated! Don&#8217;t worry though, we will take it one step at a time and simplify it.</p>
</div>
<div class="paragraph">
<p>The Bitcoin Script currently used in the Lightning Network is quite complex because it is optimized for on-chain space efficiency, which makes it very compact but difficult to read.</p>
</div>
<div class="paragraph">
<p>In the following sections, we will focus on the main elements of the script and present simplified scripts that are slightly different from what is actually used in Lightning.</p>
</div>
<div class="paragraph">
<p>The main part of the HTLC is in line 10 of <a href="#received_htlc">HTLC implemented in Bitcoin Script (BOLT #3)</a>. Let&#8217;s build it up from scratch!</p>
</div>
</div>
<div class="sect3">
<h4 id="_payment_preimage_and_hash_verification">Payment Preimage and Hash Verification</h4>
<div class="paragraph">
<p>The core of an HTLC is the hash, where payment can be made if the recipient knows the payment preimage. Alice locks the payment to a specific payment hash, and Bob has to present a payment preimage to claim the funds. The Bitcoin system can verify that Bob&#8217;s payment preimage is correct by hashing it and comparing the result to the payment hash that Alice used to lock the funds.</p>
</div>
<div class="paragraph">
<p>This part of an HTLC can be implemented in Bitcoin Script as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OP_SHA256 &lt;H&gt; OP_EQUAL</pre>
</div>
</div>
<div class="paragraph">
<p>Alice can create a transaction output that pays, 50,200 satoshi with a locking script above, replacing <code>&lt;H&gt;</code> with the hash value 0575...f6b3 provided by Dina. Then, Alice can sign this transaction and offer it to Bob:</p>
</div>
<div class="listingblock">
<div class="title">Alice&#8217;s offers a 50,200 satoshi HTLC to Bob</div>
<div class="content">
<pre>OP_SHA256 0575...f6b3 OP_EQUAL</pre>
</div>
</div>
<div class="paragraph">
<p>Bob can&#8217;t spend this HTLC until he knows Dina&#8217;s secret, so spending the HTLC is conditional on Bob&#8217;s fulfillment of the payment all the way to Dina.</p>
</div>
<div class="paragraph">
<p>Once Bob has Dina&#8217;s secret, Bob can spend this output with an unlocking script containing the secret preimage value <em>R</em>.</p>
</div>
<div class="paragraph">
<p>The unlocking script combined with the locking script would produce:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;R&gt; OP_SHA256 &lt;H&gt; OP_EQUAL</pre>
</div>
</div>
<div class="paragraph">
<p>The Bitcoin Script engine would evaluate this script as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>R is pushed to the stack.</p>
</li>
<li>
<p>The <code>OP_SHA256</code> operator takes the value R off the stack and hashes it, pushing the result H~R~ to the stack.</p>
</li>
<li>
<p>H is pushed to the stack.</p>
</li>
<li>
<p>The <code>OP_EQUAL</code> operator compares H and H~R~. If they are equal, the result is TRUE, the script is complete, and the payment is verified.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_extending_htlcs_from_alice_to_dina">Extending HTLCs from Alice to Dina</h4>
<div class="paragraph">
<p>Alice will now extend the HTLC across the network so that it reaches Dina.</p>
</div>
<div class="paragraph">
<p>In <a href="#alice_dina_htlc_1">Propagating the HTLC across the network</a>, we see the HTLC propagated across the network from Alice to Dina. Alice has given Bob an HTLC for 50,200 satoshi. Bob can now create an HTLC for 50,100 satoshi and give it to Chan.</p>
</div>
<div class="paragraph">
<p>Bob knows that Chan can&#8217;t redeem Bob&#8217;s HTLC without broadcasting the secret, at which point Bob can also use the secret to redeem Alice&#8217;s HTLC. This is a really important point because it ensures end-to-end <em>atomicity</em> of the HTLC. To spend the HTLC, one needs to reveal the secret, which then makes it possible for others to spend their HTLC also. Either all the HTLCs are spendable, or none of the HTLCs are spendable: atomicity!</p>
</div>
<div class="paragraph">
<p>Because Alice&#8217;s HTLC is 100 satoshi more than the HTLC Bob gave to Chan, Bob will earn 100 satoshi as a routing fee if this payment completes.</p>
</div>
<div class="paragraph">
<p>Bob isn&#8217;t taking a risk and isn&#8217;t trusting Alice or Chan. Instead, Bob is trusting that a signed transaction together with the secret will be redeemable on the Bitcoin blockchain.</p>
</div>
<div id="alice_dina_htlc_1" class="imageblock">
<div class="content">
<img src="images/mtln_0809.png" alt="Propagating the HTLC across the network">
</div>
<div class="title">Figure 9. Propagating the HTLC across the network</div>
</div>
<div class="paragraph">
<p>Similarly, Chan can extend a 50,000 HTLC to Dina. He isn&#8217;t risking anything or trusting Bob or Dina. To redeem the HTLC, Dina would have to broadcast the secret, which Chan could use to redeem Bob&#8217;s HTLC. Chan would also earn 100 satoshis as a routing fee.</p>
</div>
</div>
<div class="sect3">
<h4 id="_back_propagating_the_secret">Back-Propagating the Secret</h4>
<div class="paragraph">
<p>Once Dina receives a 50,000 HTLC from Chan, she can now get paid. Dina could simply commit this HTLC on-chain and spend it by revealing the secret in the spending transaction. Or, instead, Dina can update the channel balance with Chan by giving him the secret. There&#8217;s no reason to incur a transaction fee and go on-chain. So, instead, Dina sends the secret to Chan, and they agree to update their channel balances to reflect a 50,000 satoshi Lightning payment to Dina. In <a href="#alice_dina_htlc_redeem_1">Dina settles Chan&#8217;s HTLC off-chain</a> we see Dina giving the secret to Chan, thereby fulfilling the HTLC.</p>
</div>
<div id="alice_dina_htlc_redeem_1" class="imageblock">
<div class="content">
<img src="images/mtln_0810.png" alt="Dina settles Chan&#8217;s HTLC off-chain">
</div>
<div class="title">Figure 10. Dina settles Chan&#8217;s HTLC off-chain</div>
</div>
<div class="paragraph">
<p>Notice that Dina&#8217;s channel balance goes from 50,000 satoshi to 100,000 satoshi. Chan&#8217;s channel balance is reduced from 200,000 satoshi to 150,000 satoshi. The channel capacity hasn&#8217;t changed, but 50,000 has moved from Chan&#8217;s side of the channel to Dina&#8217;s side of the channel.</p>
</div>
<div class="paragraph">
<p>Chan now has the secret and has paid Dina 50,000 satoshi. He can do this without any risk, because the secret allows Chan to redeem the 50,100 HTLC from Bob. Chan has the option to commit that HTLC on-chain and spend it by revealing the secret on the Bitcoin blockchain. But, like Dina, he&#8217;d rather avoid transaction fees. So instead, he sends the secret to Bob so they can update their channel balances to reflect a 50,100 satoshi Lightning payment from Bob to Chan. In <a href="#alice_dina_htlc_redeem_2">Chan settles Bob&#8217;s HTLC off-chain</a> we see Chan sending the secret to Bob and receiving a payment in return.</p>
</div>
<div id="alice_dina_htlc_redeem_2" class="imageblock">
<div class="content">
<img src="images/mtln_0811.png" alt="Chan settles Bob&#8217;s HTLC off-chain">
</div>
<div class="title">Figure 11. Chan settles Bob&#8217;s HTLC off-chain</div>
</div>
<div class="paragraph">
<p>Chan has paid Dina 50,000 satoshi, and received 50,100 satoshi from Bob. So Chan has 100 satoshi more in his channel balances, which he earned as a routing fee.</p>
</div>
<div class="paragraph">
<p>Bob now has the secret too. He can use it to spend Alice&#8217;s HTLC on-chain. Or, he can avoid transaction fees by settling the HTLC in the channel with Alice. In <a href="#alice_dina_htlc_redeem_3">Bob settles Alice&#8217;s HTLC off-chain</a> we see that Bob sends the secret to Alice and they update the channel balance to reflect a 50,200 satoshi Lightning payment from Alice to Bob.</p>
</div>
<div id="alice_dina_htlc_redeem_3" class="imageblock">
<div class="content">
<img src="images/mtln_0812.png" alt="Bob settles Alice&#8217;s HTLC off-chain">
</div>
<div class="title">Figure 12. Bob settles Alice&#8217;s HTLC off-chain</div>
</div>
<div class="paragraph">
<p>Bob has received 50,200 satoshi from Alice and paid 50,100 satoshi to Chan, so he has an extra 100 satoshi in his channel balances from routing fees.</p>
</div>
<div class="paragraph">
<p>Alice receives the secret and has settled the 50,200  satoshi HTLC. The secret can be used as a <em>receipt</em> to prove that Dina got paid for that specific payment hash.</p>
</div>
<div class="paragraph">
<p>The final channel balances reflect Alice&#8217;s payment to Dina and the routing fees paid at each hop, as shown in <a href="#alice_dina_htlc_redeem_4">Channel balances after the payment</a>.</p>
</div>
<div id="alice_dina_htlc_redeem_4" class="imageblock">
<div class="content">
<img src="images/mtln_0813.png" alt="Channel balances after the payment">
</div>
<div class="title">Figure 13. Channel balances after the payment</div>
</div>
</div>
<div class="sect3">
<h4 id="preventing_theft">Signature Binding: Preventing Theft of HTLCs</h4>
<div class="paragraph">
<p>There&#8217;s a catch. Did you notice it?</p>
</div>
<div class="paragraph">
<p>If Alice, Bob, and Chan create the HTLCs as shown in <a href="#alice_dina_htlc_redeem_4">Channel balances after the payment</a>, they face a small but not insignificant risk of loss. Any of those HTLCs can be redeemed (spent) by anyone who knows the secret. At first only Dina knows the secret. Dina is supposed to only spend the HTLC from Chan. But Dina could spend all three HTLCs at the same time, or even in a single spending transaction! After all, Dina knows the secret before anyone else. Similarly, once Chan knows the secret, he is only supposed to spend the HTLC offered by Bob. But what if Chan also spends Alice&#8217;s offered HTLC?</p>
</div>
<div class="paragraph">
<p>This is not <em>trustless</em>! It fails the most important security feature. We need to fix this.</p>
</div>
<div class="paragraph">
<p>The HTLC script must have an additional condition that binds each HTLC to a specific recipient. We do this by requiring a digital signature that matches the public key of each recipient, thereby preventing anyone else from spending that HTLC. Since only the designated recipient has the ability to produce a digital signature matching that public key, only the designated recipient can spend that HTLC.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s look at the scripts again with this modification in mind. Alice&#8217;s HTLC for Bob is modified to include Bob&#8217;s public key and the OP_CHECKSIG operator.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s the modified HTLC script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OP_SHA256 &lt;H&gt; OP_EQUALVERIFY &lt;Bob's Pub&gt; OP_CHECKSIG</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>Notice that we also changed OP_EQUAL to OP_EQUALVERIFY. When an operator has the suffix VERIFY, it does not return TRUE or FALSE on the stack. Instead, it <em>halts</em> execution and fails the script if the result is false and continues without any stack output if it is true.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To redeem this HTLC, Bob has to present an unlocking script that includes a signature from Bob&#8217;s private key as well as the secret payment preimage, like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;Bob's Signature&gt; &lt;R&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>The unlocking and locking scripts are combined and evaluated by the scripting engine, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;Bob's Sig&gt; &lt;R&gt; OP_SHA256 &lt;H&gt; OP_EQUALVERIFY &lt;Bob's Pub&gt; OP_CHECKSIG</pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>&lt;Bob's Sig&gt; is pushed to the stack.</p>
</li>
<li>
<p>R is pushed to the stack.</p>
</li>
<li>
<p>OP_SHA256 pops and hashes R from the top of the stack and pushes H~R~ to the stack.</p>
</li>
<li>
<p>H is pushed to the stack.</p>
</li>
<li>
<p>OP_EQUALVERIFY pops H and H~R~ and compares them. If they are not the same, execution halts. Otherwise, we continue without output to the stack.</p>
</li>
<li>
<p>&lt;Bob's Pub&gt; key is pushed to the stack.</p>
</li>
<li>
<p>OP_CHECKSIG pops &lt;Bob's Sig&gt; and &lt;Bob's Pub&gt; and verifies the signature. The result (<code>TRUE/FALSE</code>) is pushed to the stack.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>As you can see, this is slightly more complicated, but now we have fixed the HTLC and made sure only the intended recipient can spend it.</p>
</div>
</div>
<div class="sect3">
<h4 id="_hash_optimization">Hash Optimization</h4>
<div class="paragraph">
<p>Let&#8217;s look at the first part of the HTLC script so far:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OP_SHA256 &lt;H&gt; OP_EQUALVERIFY</pre>
</div>
</div>
<div class="paragraph">
<p>If we look at this in the preceding symbolic representation, it looks like the OP_ operators take up the most space. But that&#8217;s not the case. Bitcoin Script is encoded in binary, with each operator representing one byte. Meanwhile, the &lt;H&gt; value we use as a placeholder for the payment hash is a 32-byte (256-bit) value. You can find a listing of all the Bitcoin Script operators and their binary and hex encoding in <a href="https://en.bitcoin.it/wiki/Script">Bitcoin Wiki: Script</a>, or in <a href="https://github.com/bitcoinbook/bitcoinbook/blob/develop/appdx-scriptops.asciidoc">Appendix D, "Transaction Script Language Operators, Constants, and Symbols," in <em>Mastering Bitcoin</em></a>.</p>
</div>
<div class="paragraph">
<p>Represented in hexadecimal, our HTLC script would look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>a8 0575965b3b44be51e8057d551c4016d83cb1fba9ea8d6e986447ba33fe69f6b3 88</pre>
</div>
</div>
<div class="paragraph">
<p>In hexadecimal encoding, OP_SHA256 is a8 and OP_EQUALVERIFY is 88. The total length of this script is 34 bytes, of which 32 bytes are the hash.</p>
</div>
<div class="paragraph">
<p>As we&#8217;ve mentioned previously, any participant in the Lightning Network should be able to take an off-chain transaction they hold and put it on-chain if they need to enforce their claim to funds. To take a transaction on-chain, they&#8217;d have to pay transaction fees to the miners, and these fees are proportional to the size, in bytes, of the transaction.</p>
</div>
<div class="paragraph">
<p>Therefore, we want to find ways to minimize the on-chain "weight" of transactions by optimizing the script as much as possible. One way to do that is to add another hash function on top of the SHA-256 algorithm, one that produces smaller hashes. The Bitcoin Script language provides the OP_HASH160 operator that "double hashes" a preimage: first the preimage is hashed with SHA-256, and then the resulting hash is hashed again with the RIPEMD160 hash algorithm. The hash resulting from RIPEMD160 is 160 bits or 20 bytes&#8212;&#8203;much more compact. In Bitcoin Script this is a very common optimization that is used in many of the common address formats.</p>
</div>
<div class="paragraph">
<p>So, let&#8217;s use that optimization instead. Our SHA-256 hash is 057596...69f6b3. Putting that through another round of hashing with RIPEMD160 gives us the result:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>R = "Dinas secret"
H256 = SHA256(R)
H256 = 0575965b3b44be51e8057d551c4016d83cb1fba9ea8d6e986447ba33fe69f6b3
H160 = RIPEMD160(H256)
H160 = 9e017f6767971ed7cea17f98528d5f5c0ccb2c71</pre>
</div>
</div>
<div class="paragraph">
<p>Alice can calculate the RIPEMD160 hash of the payment hash that Dina provides and use the shorter hash in her HTLC, as can Bob and Chan!</p>
</div>
<div class="paragraph pagebreak-before">
<p>The "optimized" HTLC script would look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OP_HASH160 &lt;H160&gt; OP_EQUALVERIFY</pre>
</div>
</div>
<div class="paragraph">
<p>Encoded in hex, this is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>a9 9e017f6767971ed7cea17f98528d5f5c0ccb2c71 88</pre>
</div>
</div>
<div class="paragraph">
<p>Where OP_HASH160 is a9 and OP_EQUALVERIFY is 88. This script is only 22 bytes long! We&#8217;ve saved 12 bytes from every transaction that redeems an HTLC on-chain.</p>
</div>
<div class="paragraph">
<p>With that optimization, you now see how we arrive at the HTLC script shown in line 10 of <a href="#received_htlc">HTLC implemented in Bitcoin Script (BOLT #3)</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>...
    # To local node via HTLC-success transaction.
    OP_HASH160 &lt;RIPEMD160(payment_hash)&gt; OP_EQUALVERIFY...</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_htlc_cooperative_and_timeout_failure">HTLC Cooperative and Timeout Failure</h4>
<div class="paragraph">
<p>So far we looked at the "hash" part of HTLC and how it would work if everyone cooperated and was online at the time of payment.</p>
</div>
<div class="paragraph">
<p>What happens if someone goes offline or fails to cooperate? What happens if the payment cannot succeed?</p>
</div>
<div class="paragraph">
<p>We need to ensure a way to "fail gracefully," because occasional routing failures are inevitable. There are two ways to fail: cooperatively and with a time-locked refund.</p>
</div>
<div class="paragraph">
<p>Cooperative failure is relatively simple: the HTLC is unwound by every participant in the route, removing the HTLC output from their commitment transactions without changing the balance. We&#8217;ll look at how that works in detail in <a href="#channel_operation">[channel_operation]</a>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s look at how we can reverse an HTLC without the cooperation of one or more participants. We need to make sure that if one of the participants does not cooperate, the funds are not simply locked in the HTLC <em>forever</em>. This would give someone the opportunity to ransom the funds of another participant: "I&#8217;ll leave your funds tied up forever if you don&#8217;t pay me ransom."</p>
</div>
<div class="paragraph">
<p>To prevent this, every HTLC script includes a refund clause that is connected to a timelock. Remember our original escrow contract? "Bob has 24 hours to show the secret after the contract is signed. If Bob does not provide the secret by this time, Alice&#8217;s deposit will be refunded."</p>
</div>
<div class="paragraph">
<p>The time-locked refund is an important part of the script that ensures <em>atomicity</em>, so that the entire end-to-end payment either succeeds or fails gracefully. There is no "half paid" state to worry about. If there is a failure, every participant can either unwind the HTLC cooperatively with their channel partner or put the time-locked refund transaction on-chain unilaterally to get their money back.</p>
</div>
<div class="paragraph">
<p>To implement this refund in Bitcoin Script, we use a special operator <code>O&#x2060;P&#x2060;_&#x2060;C&#x2060;H&#x2060;E&#x2060;C&#x2060;K&#x2060;L&#x2060;O&#x2060;C&#x2060;K&#x2060;T&#x2060;I&#x2060;M&#x2060;E&#x200b;V&#x2060;E&#x2060;R&#x2060;I&#x2060;F&#x2060;Y</code> also known OP_CLTV for short. Here&#8217;s the script, as seen previously in line 13 of <a href="#received_htlc">HTLC implemented in Bitcoin Script (BOLT #3)</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>...
	OP_DROP &lt;cltv_expiry&gt; OP_CHECKLOCKTIMEVERIFY OP_DROP
	OP_CHECKSIG
...</pre>
</div>
</div>
<div class="paragraph">
<p>The OP_CLTV operator takes an expiry time defined as the block height after which this transaction is valid. If the transaction timelock is not set the same as &lt;cltv_expiry&gt;, the evaluation of the script fails and the transaction is invalid. Otherwise, the script continues without any output to the stack. Remember, the VERIFY suffix means this operator does not output TRUE or FALSE but instead either halts/fails or continues without stack output.</p>
</div>
<div class="paragraph">
<p>Essentially, the OP_CLTV acts as a "gatekeeper" preventing the script from proceeding any further if the &lt;cltv_expiry&gt; block height has not been reached on the Bitcoin blockchain.</p>
</div>
<div class="paragraph">
<p>The OP_DROP operator simply drops the topmost item on the script stack. This is necessary in the beginning because there is a "leftover" item from the previous script lines. It is necessary <em>after</em> OP_CLTV to remove the &lt;cltv_expiry&gt; item from the top of the stack because it is no longer necessary.</p>
</div>
<div class="paragraph">
<p>Finally, once the stack has been cleaned up, there should be a public key and signature left behind that OP_CHECKSIG can verify. As we saw in <a href="#preventing_theft">Signature Binding: Preventing Theft of HTLCs</a>, this is necessary to ensure that only the rightful owner of the funds can claim them, by binding this output to their public key and requiring a signature.</p>
</div>
</div>
<div class="sect3">
<h4 id="_decrementing_timelocks">Decrementing Timelocks</h4>
<div class="paragraph">
<p>As the HTLCs are extended from Alice to Dina, the time-locked refund clause in each HTLC has a <em>different</em> cltv_expiry value. We will see this in more detail in <a href="#onion_routing">[onion_routing]</a>. But suffice it to say that to ensure an orderly unwinding of a payment that fails, each hop needs to wait a bit less for their refund. The difference between timelocks for each hop is called the cltv_expiry_delta, and is set by each node and advertised to the network, as we will see in <a href="#gossip">[gossip]</a>.</p>
</div>
<div class="paragraph">
<p>For example, Alice sets the refund timelock on the first HTLC to a block height of current + 500 blocks ("current" being the current block height). Bob would then set the timelock cltv_expiry on the HTLC to Chan to current + 450 blocks. Chan would set the timelock to current + 400 blocks from the current block height. This way, Chan can get a refund on the HTLC he offered to Dina <em>before</em> Bob gets a refund on the HTLC he offered to Chan. Bob can get a refund of the HTLC he offered to Chan before Alice can get a refund for the HTLC she offered to Bob. The decrementing timelock prevents race conditions and ensures the HTLC chain is unwound backward, from the destination toward the origin.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_conclusion">Conclusion</h3>
<div class="paragraph">
<p>In this chapter we saw how Alice can pay Dina even if she doesn&#8217;t have a direct payment channel. Alice can find a path that connects her to Dina and route a payment across several payment channels so that it reaches Dina.</p>
</div>
<div class="paragraph">
<p>To ensure that the payment is atomic and trustless across multiple hops, Alice must implement a fairness protocol in cooperation with all the intermediary nodes in the path. The fairness protocol is currently implemented as an HTLC, which commits funds to a payment hash derived from a secret payment preimage.</p>
</div>
<div class="paragraph">
<p>Each of the participants in the payment route can extend an HTLC to the next participant, without worrying about theft or stuck funds. The HTLC can be redeemed by revealing the secret payment preimage. Once an HTLC reaches Dina, she reveals the preimage, which flows backward, resolving all the HTLCs offered.</p>
</div>
<div class="paragraph">
<p>Finally, we saw how a time-locked refund clause completes the HTLC, ensuring that every participant can get a refund if the payment fails but for whatever reason one of the participants doesn&#8217;t cooperate in unwinding the HTLCs. By always having the option to go on-chain for a refund, the HTLC achieves the fairness goal of atomicity and trustless operation.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2022-10-29 15:50:16 +0400
</div>
</div>
</body>
</html>