<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.16">
<title>Channel Operation and Payment Forwarding</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;-webkit-tap-highlight-color:transparent}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="channel_operation">Channel Operation and <span class="keep-together">Payment Forwarding</span></h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this chapter we will bring together payment channels and hash time-locked contracts (HTLCs). In <a href="#payment_channels">[payment_channels]</a>, we explained the way Alice and Bob construct a payment channel between their two nodes. We also looked at the commitment and penalty mechanisms that secure the payment channel. In <a href="#routing">[routing]</a>, we looked at HTLCs and how these can be used to route a payment across a path made of multiple payment channels. In this chapter we bring the two concepts together by looking at how HTLCs are managed on each payment channel, how the HTLCs are committed to the channel state, and how they are settled to update the channel balances.</p>
</div>
<div class="paragraph">
<p>Specifically, we will be discussing "Adding, settling, failing HTLCs" and the "Channel state machine" that form the overlap between the peer-to-peer layer and the routing layer, as highlighted by an outline in <a href="#LN_protocol_channelops_highlight">Channel operation and payment forwarding in the Lightning protocol suite</a>.</p>
</div>
<div id="LN_protocol_channelops_highlight" class="imageblock">
<div class="content">
<img src="images/mtln_0901.png" alt="Channel operation and payment forwarding in the Lightning protocol suite">
</div>
<div class="title">Figure 1. Channel operation and payment forwarding in the Lightning protocol suite</div>
</div>
<div class="sect2">
<h3 id="_local_single_channel_versus_routed_multiple_channels">Local (Single Channel) Versus Routed (Multiple Channels)</h3>
<div class="paragraph">
<p>Even though it is possible to send payments across a payment channel simply by updating the channel balances and creating new commitment transactions, the Lightning protocol uses HTLCs even for "local" payments across a payment channel. The reason for this is to maintain the same protocol design regardless of whether a payment is only one hop (across a single payment channel) or several hops (routed across multiple payment channels).</p>
</div>
<div class="paragraph">
<p>By maintaining the same abstraction for both local and remote, we not only simplify the protocol design but also improve privacy. For the recipient of a payment there is no discernible difference between a payment made directly by their channel partner and a payment forwarded by their channel partner on behalf of someone else.</p>
</div>
</div>
<div class="sect2">
<h3 id="_forwarding_payments_and_updating_commitments_with_htlcs">Forwarding Payments and Updating Commitments <span class="keep-together">with HTLCs</span></h3>
<div class="paragraph">
<p>We will revisit our example from <a href="#routing">[routing]</a> to demonstrate how the HTLCs from Alice to Dina get committed to each payment channel. As you recall in our example, Alice is paying Dina 50,000 satoshis by routing an HTLC via Bob and Chan. The network is shown in <a href="#alice_dina_htlc_2">Alice pays Dina with an HTLC routed via Bob and Chan</a>.</p>
</div>
<div id="alice_dina_htlc_2" class="imageblock">
<div class="content">
<img src="images/mtln_0809.png" alt="Alice pays Dina with an HTLC routed via Bob and Chan">
</div>
<div class="title">Figure 2. Alice pays Dina with an HTLC routed via Bob and Chan</div>
</div>
<div class="paragraph">
<p>We will focus on the payment channel between Alice and Bob and review the messages and transactions that they use to process this HTLC.</p>
</div>
<div class="sect3">
<h4 id="_htlc_and_commitment_message_flow">HTLC and Commitment Message Flow</h4>
<div class="paragraph">
<p>The message flow between Alice and Bob (and also between any pair of channel partners) is shown in <a href="#HTLC_commitment_message_flow">The message flow for HTLC commitment between channel partners</a>.</p>
</div>
<div id="HTLC_commitment_message_flow" class="imageblock">
<div class="content">
<img src="images/mtln_0903.png" alt="The message flow for HTLC commitment between channel partners">
</div>
<div class="title">Figure 3. The message flow for HTLC commitment between channel partners</div>
</div>
<div class="paragraph pagebreak-before">
<p>We&#8217;ve already seen the commitment_signed and revoke_and_ack in <a href="#payment_channels">[payment_channels]</a>. Now we will see how HTLCs fit into the commitment scheme. The two new messages are update_add_htlc, which Alice uses to ask Bob to add an HTLC, and update_fulfill_htlc, which Bob uses to redeem the HTLC once he has received the payment secret (Dina&#8217;s secret).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_forwarding_payments_with_htlcs">Forwarding Payments with HTLCs</h3>
<div class="paragraph">
<p>Alice and Bob start with a payment channel that has a 70,000 satoshi balance on each side.</p>
</div>
<div class="paragraph">
<p>As we saw in <a href="#payment_channels">[payment_channels]</a>, this means that Alice and Bob have negotiated and each hold commitment transactions. These commitment transactions are asymmetric, delayed, and revocable, and look like the example in <a href="#alice_bob_commitment_txs_1">Alice and Bob&#8217;s initial commitment transactions</a>.</p>
</div>
<div id="alice_bob_commitment_txs_1" class="imageblock">
<div class="content">
<img src="images/mtln_0904.png" alt="Alice and Bob&#8217;s initial commitment transactions">
</div>
<div class="title">Figure 4. Alice and Bob&#8217;s initial commitment transactions</div>
</div>
<div class="sect3">
<h4 id="_adding_an_htlc">Adding an HTLC</h4>
<div class="paragraph">
<p>Alice wants Bob to accept an HTLC worth 50,200 satoshis to forward to Dina. To do so, Alice must send the details of this HTLC, including the payment hash and amount, to Bob. Bob will also need to know where to forward it, which is something we discuss in detail in <a href="#onion_routing">[onion_routing]</a>.</p>
</div>
<div class="paragraph">
<p>To add the HTLC, Alice starts the flow we saw in <a href="#HTLC_commitment_message_flow">The message flow for HTLC commitment between channel partners</a> by sending the update_add_htlc message to Bob.</p>
</div>
</div>
<div class="sect3">
<h4 id="update_add_htlc">The update_add_HTLC Message</h4>
<div class="paragraph">
<p>Alice sends the <code>update_add_HTLC</code> Lightning message to Bob. This message is defined in <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/02-peer-protocol.md#adding-an-htlc-update_add_htlc">BOLT #2: Peer Protocol, <code>update_add_HTLC</code></a>, and is shown in Example 9-1.</p>
</div>
<div id="update_add_HTLC_message_fields" class="exampleblock">
<div class="title">Example 1. The <code>update_add_HTLC</code> message</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre>[channel_id:channel_id]
[u64:id]
[u64:amount_msat]
[sha256:payment_hash]
[u32:cltv_expiry]
[1366*byte:onion_routing_packet]</pre>
</div>
</div>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">channel_id</dt>
<dd>
<p>This is the channel that Alice has with Bob where she wants to add the HTLC. Remember that Alice and Bob may have multiple channels with each other.</p>
</dd>
<dt class="hdlist1">id</dt>
<dd>
<p>This is an HTLC counter and starts at 0 for the first HTLC offered to Bob by Alice and is incremented for each subsequent offered HTLC.</p>
</dd>
<dt class="hdlist1">amount_msat</dt>
<dd>
<p>This is the amount (value) of the HTLC in millisatoshis. In our example this is 50,200,000 millisatoshis (i.e., 50,200 satoshis).</p>
</dd>
<dt class="hdlist1">payment_hash</dt>
<dd>
<p>This is the payment hash calculated from Dina&#8217;s invoice. It is <em>H</em> = RIPEMD160(SHA-256(<em>R</em>)), where <em>R</em> is Dina&#8217;s secret that is known only by Dina and will be revealed if Dina is paid.</p>
</dd>
<dt class="hdlist1">cltv_expiry</dt>
<dd>
<p>This is the expiry time for this HTLC, which will be encoded as a time-locked refund in case the HTLC fails to reach Dina in this time.</p>
</dd>
<dt class="hdlist1">onion_routing_packet</dt>
<dd>
<p>This is an onion-encrypted route that tells Bob where to forward this HTLC next (to Chan). Onion routing is covered in detail in <a href="#onion_routing">[onion_routing]</a>.</p>
</dd>
</dl>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>As a reminder, accounting within the Lightning Network is in units of millisatoshis (thousandths of a satoshi), whereas Bitcoin accounting is in satoshis. Any amounts in HTLCs are millisatoshis, which are then rounded to the nearest satoshi in the Bitcoin commitment transactions.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_htlc_in_commitment_transactions">HTLC in Commitment Transactions</h4>
<div class="paragraph">
<p>The received information is enough for Bob to create a new commitment transaction. The new commitment transaction has the same two outputs to_self and to_remote for Alice and Bob&#8217;s balance, and a <em>new</em> output representing the HTLC offered by Alice.</p>
</div>
<div class="paragraph">
<p>We&#8217;ve already seen the basic structure of an HTLC in <a href="#routing">[routing]</a>. The complete script of an offered HTLC is defined in <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/03-transactions.md#offered-htlc-outputs">BOLT #3: Transactions, Offered HTLC Output</a> and is shown in <a href="#offered_htlc_output_script">Offered HTLC output script</a>.</p>
</div>
<div id="offered_htlc_output_script" class="exampleblock">
<div class="title">Example 2. Offered HTLC output script</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text"># Revocation <b class="conum">(1)</b>
OP_DUP OP_HASH160 &lt;RIPEMD160(SHA256(revocationpubkey))&gt; OP_EQUAL
OP_IF
    OP_CHECKSIG
OP_ELSE
    &lt;remote_HTLCpubkey&gt; OP_SWAP OP_SIZE 32 OP_EQUAL
    OP_IF
        # Redemption <b class="conum">(2)</b>
        OP_HASH160 &lt;RIPEMD160(payment_hash)&gt; OP_EQUALVERIFY
        2 OP_SWAP &lt;local_HTLCpubkey&gt; 2 OP_CHECKMULTISIG
    OP_ELSE
        # Refund <b class="conum">(3)</b>
        OP_DROP &lt;cltv_expiry&gt; OP_CHECKLOCKTIMEVERIFY OP_DROP
        OP_CHECKSIG
    OP_ENDIF
OP_ENDIF</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The first clause of the <code>OP_IF</code> conditional is redeemable by Alice with a revocation key. If this commitment is later revoked, Alice will have a revocation key to claim this output in a penalty transaction, taking the whole channel balance.</p>
</li>
<li>
<p>The second clause is redeemable by the preimage (payment secret, or in our example, Dina&#8217;s secret) if it is revealed. This allows Bob to claim this output if he has the secret from Dina, meaning he has successfully delivered the payment to Dina.</p>
</li>
<li>
<p>The third and final clause is a refund of the HTLC to Alice if the HTLC expires without reaching Dina. It is time-locked with the expiration cltv_expiry. This ensures that Alice&#8217;s balance is not "stuck" in an HTLC that can&#8217;t be routed to Dina.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p>There are three ways to claim this output. Try to read the script and see if you can figure it out (remember, it is a stack-based language, so things appear "backward").</p>
</div>
</div>
<div class="sect3">
<h4 id="_new_commitment_with_htlc_output">New Commitment with HTLC Output</h4>
<div class="paragraph">
<p>Bob now has the necessary information to add this HTLC script as an additional output and create a new commitment transaction. Bob&#8217;s new commitment will have 50,200 satoshis in the HTLC output. That amount will come from Alice&#8217;s channel balance, so Alice&#8217;s new balance will be 19,800 satoshis (70,000 – 50,200 = 19,800). Bob constructs this commitment as a tentative "Commitment #3," shown in <a href="#add_commitment_3b">Bob&#8217;s new commitment with an HTLC output</a>.</p>
</div>
<div id="add_commitment_3b" class="imageblock">
<div class="content">
<img src="images/mtln_0905.png" alt="Bob&#8217;s new commitment with an HTLC output">
</div>
<div class="title">Figure 5. Bob&#8217;s new commitment with an HTLC output</div>
</div>
</div>
<div class="sect3 pagebreak-before less_space">
<h4 id="_alice_commits">Alice Commits</h4>
<div class="paragraph">
<p>Shortly after sending the update_add_htlc message, she will commit to the new state of the channel, so that the HTLC can be safely added by Bob. Bob has the HTLC information and has constructed a new commitment but does not yet have this new commitment signed by Alice.</p>
</div>
<div class="paragraph">
<p>Alice sends commitment_signed to Bob, with the signature for the new commitment and for the HTLC within. We saw the commitment_signed message in <a href="#payment_channels">[payment_channels]</a>, but now we can understand the rest of the fields. As a reminder, it is shown in <a href="#ops_commitment_signed_message">The <code>commitment_signed</code> message</a>.</p>
</div>
<div id="ops_commitment_signed_message" class="exampleblock">
<div class="title">Example 3. The <code>commitment_signed</code> message</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre>[channel_id:channel_id]
[signature:signature]
[u16:num_htlcs]
[num_htlcs*signature:htlc_signature]</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The fields num_htlcs and htlc_signature now make more sense:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">num_htlcs</dt>
<dd>
<p>This is the number of HTLCs that are outstanding in the commitment transaction. In our example, just one HTLC, the one Alice offered.</p>
</dd>
<dt class="hdlist1">htlc_signature</dt>
<dd>
<p>This is an array of signatures (num_htlcs in length), containing signatures for the HTLC outputs.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Alice can send these signatures without hesitation: she can always get a refund if the HTLC expires without being routed to Dina.</p>
</div>
<div class="paragraph">
<p>Now, Bob has a new signed commitment transaction, as shown in <a href="#signed_commitment_3b">Bob has a new signed commitment</a>.</p>
</div>
<div id="signed_commitment_3b" class="imageblock">
<div class="content">
<img src="images/mtln_0906.png" alt="Bob has a new signed commitment">
</div>
<div class="title">Figure 6. Bob has a new signed commitment</div>
</div>
</div>
<div class="sect3">
<h4 id="_bob_acknowledges_new_commitment_and_revokes_old_one">Bob Acknowledges New Commitment and Revokes Old One</h4>
<div class="paragraph">
<p>Now that Bob has a new signed commitment, he needs to acknowledge it and revoke the old commitment. He does so by sending the revoke_and_ack message, as we saw in <a href="#payment_channels">[payment_channels]</a> previously. As a reminder, that message is shown in <a href="#revoke_and_ack_message_2">The revoke_and_ack message</a>.</p>
</div>
<div id="revoke_and_ack_message_2" class="exampleblock">
<div class="title">Example 4. The revoke_and_ack message</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre>[channel_id:channel_id]
[32*byte:per_commitment_secret]
[point:next_per_commitment_point]</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Bob sends the per_commitment_secret that allows Alice to construct a revocation key to build a penalty transaction spending Bob&#8217;s old commitment. Once Bob has sent this, he can never publish "Commitment #2" without risking a penalty transaction and losing all his money. So, the old commitment is effectively revoked.</p>
</div>
<div class="paragraph">
<p>Bob has effectively moved the channel state forward, as shown in <a href="#revoked_commitment_2b">Bob has revoked the old commitment</a>.</p>
</div>
<div id="revoked_commitment_2b" class="imageblock">
<div class="content">
<img src="images/mtln_0907.png" alt="Bob has revoked the old commitment">
</div>
<div class="title">Figure 7. Bob has revoked the old commitment</div>
</div>
<div class="paragraph">
<p>Despite the fact that Bob has a new (signed) commitment transaction and an HTLC output inside, he cannot consider his HTLC as being set up successfully.</p>
</div>
<div class="paragraph">
<p>He first needs to have Alice revoke her old commitment, because otherwise, Alice can roll back her balance to 70,000 satoshis. Bob needs to make sure that Alice also has a commitment transaction containing the HTLC and has revoked the old commitment.</p>
</div>
<div class="paragraph">
<p>That is why, if Bob is not the final recipient of the HTLC funds, he should not forward the HTLC yet by offering an HTLC on the next channel with Chan.</p>
</div>
<div class="paragraph">
<p>Alice has constructed a mirror-image new commitment transaction containing the new HTLC, but it is yet to be signed by Bob. We can see it in <a href="#add_commitment_3a">Alice&#8217;s new commitment with an HTLC output</a>.</p>
</div>
<div id="add_commitment_3a" class="imageblock">
<div class="content">
<img src="images/mtln_0908.png" alt="Alice&#8217;s new commitment with an HTLC output">
</div>
<div class="title">Figure 8. Alice&#8217;s new commitment with an HTLC output</div>
</div>
<div class="paragraph">
<p>As we described in <a href="#payment_channels">[payment_channels]</a>, Alice&#8217;s commitment is the mirror image of Bob&#8217;s, as it contains the asymmetric, delayed, revocable construct for revocation and penalty enforcement of old commitments. Alice&#8217;s 19,800 satoshi balance (after deducting the HTLC value), is delayed and revocable. Bob&#8217;s 70,000 satoshi balance is immediately redeemable.</p>
</div>
<div class="paragraph">
<p>Next, the message flow for commitment_signed and revoke_and_ack is now repeated, but in the opposite direction. Bob sends commitment_signed to sign Alice&#8217;s  new commitment, and Alice responds by revoking her old commitment.</p>
</div>
<div class="paragraph">
<p>For completeness sake, let&#8217;s quickly review the commitment transactions as this round of commitment/revocation happens.</p>
</div>
</div>
<div class="sect3 pagebreak-before less_space">
<h4 id="_bob_commits">Bob Commits</h4>
<div class="paragraph">
<p>Bob now sends a commitment_signed back to Alice, with his signatures for Alice&#8217;s new commitment transaction, including the HTLC output she has added.</p>
</div>
<div class="paragraph">
<p>Now Alice has the signature for the new commitment transaction. The state of the channel is shown in <a href="#signed_commitment_3a">Alice has a new signed commitment</a>.</p>
</div>
<div id="signed_commitment_3a" class="imageblock">
<div class="content">
<img src="images/mtln_0909.png" alt="Alice has a new signed commitment">
</div>
<div class="title">Figure 9. Alice has a new signed commitment</div>
</div>
<div class="paragraph">
<p>Alice can now acknowledge the new commitment by revoking the old one. Alice sends the revoke_and_ack message containing the necessary per_commitment_point that will allow Bob to construct a revocation key and penalty transaction. Thus, Alice revokes her old commitment.</p>
</div>
<div class="paragraph">
<p>The channel state is shown in <a href="#revoked_commitment_2a">Alice has revoked the old commitment</a>. </p>
</div>
<div id="revoked_commitment_2a" class="imageblock">
<div class="content">
<img src="images/mtln_0910.png" alt="Alice has revoked the old commitment">
</div>
<div class="title">Figure 10. Alice has revoked the old commitment</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_multiple_htlcs">Multiple HTLCs</h3>
<div class="paragraph">
<p>At any point in time, Alice and Bob may have dozens or even hundreds of HTLCs across a single channel. Each HTLC is offered and added to the commitment transaction as an additional output. A commitment transaction therefore always has two outputs for the channel partner balances and any number of HTLC outputs, one per HTLC.</p>
</div>
<div class="paragraph">
<p>As we saw in the commitment_signed message, there is an array for HTLC signatures so that multiple HTLC commitments can be transmitted at the same time.</p>
</div>
<div class="paragraph">
<p>The current maximum number of HTLCs allowed on a channel is 483 HTLCs to account for the maximum Bitcoin transaction size and ensure that the commitment transactions continue to be valid Bitcoin transactions.</p>
</div>
<div class="paragraph">
<p>As we will see in the next section, the maximum is only for <em>pending</em> HTLCs because, once an HTLC is fulfilled (or fails due to timeout/error), it is removed from the commitment transaction.</p>
</div>
</div>
<div class="sect2">
<h3 id="_htlc_fulfillment">HTLC Fulfillment</h3>
<div class="paragraph">
<p>Now Bob and Alice both have a new commitment transaction with an additional HTLC output, and we have achieved a major step toward updating a payment <span class="keep-together">channel</span>.</p>
</div>
<div class="paragraph">
<p>The new balance of Alice and Bob does not reflect yet that Alice has successfully sent 50,200 satoshis to Bob.</p>
</div>
<div class="paragraph">
<p>However, the HTLCs are now set up in a way that secure settlement in exchange for the proof of payment will be possible.</p>
</div>
<div class="sect3">
<h4 id="_htlc_propagation">HTLC Propagation</h4>
<div class="paragraph">
<p>Let&#8217;s assume that Bob continues the chain and sets up an HTLC with Chan for 50,100 satoshis. The process will be exactly the same as we just saw between Alice and Bob. Bob will send update_add_htlc to Chan, then they will exchange commitment_signed and revoke_and_ack messages in two rounds, progressing their channel to the next state.</p>
</div>
<div class="paragraph">
<p>Next, Chan will do the same with Dina: offer a 50,000 satoshi HTLC, commit, and revoke, etc. However, Dina is the final recipient of the HTLC. Dina is the only one that knows the payment secret (the preimage of the payment hash). Therefore, Dina can fulfill the HTLC with Chan immediately!</p>
</div>
</div>
<div class="sect3">
<h4 id="_dina_fulfills_the_htlc_with_chan">Dina Fulfills the HTLC with Chan</h4>
<div class="paragraph">
<p>Dina can settle the HTLC by sending an update_ful&amp;#x2060;fill_&amp;#x200b;htlc message to Chan. The update_fulfill_htlc message is defined in <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/02-peer-protocol.md#removing-an-htlc-update_fulfill_htlc-update_fail_htlc-and-update_fail_malformed_htlc">BOLT #2: Peer Protocol, <code>update_fulfill_htlc</code></a> and is shown here:</p>
</div>
<div id="update_fulfill_htlc_message" class="listingblock">
<div class="title">The update_fulfill_htlc message</div>
<div class="content">
<pre>[channel_id:channel_id]
[u64:id]
[32*byte:payment_preimage]</pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s a really simple message:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">channel_id</dt>
<dd>
<p>The channel ID on which the HTLC is committed.</p>
</dd>
<dt class="hdlist1">id</dt>
<dd>
<p>The ID of the HTLC (we started with 0 and incremented for each HTLC on the channel).</p>
</dd>
<dt class="hdlist1">payment_preimage</dt>
<dd>
<p>The secret that proves payment was made and redeems the HTLC. This is the R value that was hashed by Dina to produce the payment hash in the invoice to Alice.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>When Chan receives this message, he will immediately check if the <code>payment_preimage</code> (let&#8217;s call it <em>R</em>) produces the payment hash (let&#8217;s call it <em>H</em>) in the HTLC that he offered to Dina. He hashes it like this:</p>
</div>
<ul class="simplelist">
<li><em>H</em> = RIPEMD160(SHA-256 (<em>R</em>))</li>
</ul>
<div class="paragraph">
<p>If the result <em>H</em> matches the payment hash in the HTLC, Chan can do a little dance of celebration. This long-awaited secret can be used to redeem the HTLC, and will be passed back along the chain of payment channels all the way to Alice, resolving every HTLC that was part of this payment to Dina.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s go back to Alice and Bob&#8217;s channel and watch them unwind the HTLC. To get there, let&#8217;s assume Dina sent the update_fulfill_htlc to Chan, Chan sent update_fulfill_htlc to Bob, and Bob sent update_fulfill_htlc to Alice. The payment preimage has propagated all the way back to Alice.</p>
</div>
</div>
<div class="sect3">
<h4 id="_bob_settles_the_htlc_with_alice">Bob Settles the HTLC with Alice</h4>
<div class="paragraph">
<p>When Bob sends the update_fulfill_htlc to Alice, it will contain the same payment_preimage that Dina selected for her invoice. That payment_preimage has traveled backward along the payment path. At each step, the channel_id will be different and id (HTLC ID) may be different. But the preimage is the same!</p>
</div>
<div class="paragraph">
<p>Alice will also validate the payment_preimage received from Bob. She will compare its hash to the HTLC payment hash in the HTLC she offered Bob. She will also find this preimage matches the hash in Dina&#8217;s invoice. This is proof that Dina was paid.</p>
</div>
<div class="paragraph">
<p>The message flow between Alice and Bob is shown in <a href="#htlc_fulfillment_message_flow">The HTLC fulfillment message flow</a>.</p>
</div>
<div id="htlc_fulfillment_message_flow" class="imageblock">
<div class="content">
<img src="images/mtln_0911.png" alt="The HTLC fulfillment message flow">
</div>
<div class="title">Figure 11. The HTLC fulfillment message flow</div>
</div>
<div class="paragraph">
<p>Both Alice and Bob can now remove the HTLC from the commitment transactions and update their channel balances.</p>
</div>
<div class="paragraph">
<p>They create new commitments (Commitment #4), as shown in <a href="#htlc_fulfillment_commitments_added">The HTLC is removed and balances are updated in new commitments</a>.</p>
</div>
<div id="htlc_fulfillment_commitments_added" class="imageblock">
<div class="content">
<img src="images/mtln_0912.png" alt="The HTLC is removed and balances are updated in new commitments">
</div>
<div class="title">Figure 12. The HTLC is removed and balances are updated in new commitments</div>
</div>
<div class="paragraph pagebreak-before">
<p>Next, they complete two rounds of commitment and revocation. First, Alice sends commitment_signed to sign Bob&#8217;s new commitment transaction. Bob responds with revoke_and_ack to revoke his old commitment. Once Bob has moved the state of the channel forward, the commitments look like we see in <a href="#htlc_fulfillment_commitments_bob_commit">Alice signs Bob&#8217;s new commitment and Bob revoked the old one</a>.</p>
</div>
<div id="htlc_fulfillment_commitments_bob_commit" class="imageblock">
<div class="content">
<img src="images/mtln_0913.png" alt="Alice signs Bob&#8217;s new commitment and Bob revoked the old one">
</div>
<div class="title">Figure 13. Alice signs Bob&#8217;s new commitment and Bob revoked the old one</div>
</div>
<div class="paragraph pagebreak-before">
<p>Finally, Bob signs Alice&#8217;s commitment by sending Alice a commitment_signed message. Then Alice acknowledges and revokes her old commitment by sending revoke_and_ack to Bob. The end result is that both Alice and Bob have moved their channel state to Commitment #4, have removed the HTLC, and have updated their balances. Their current channel state is represented by the commitment transactions that are shown in <a href="#alice_bob_htlc_fulfilled">Alice and Bob settle the HTLC and update balances</a>. </p>
</div>
<div id="alice_bob_htlc_fulfilled" class="imageblock">
<div class="content">
<img src="images/mtln_0914.png" alt="Alice and Bob settle the HTLC and update balances">
</div>
<div class="title">Figure 14. Alice and Bob settle the HTLC and update balances</div>
</div>
</div>
</div>
<div class="sect2 pagebreak-before less_space">
<h3 id="_removing_an_htlc_due_to_error_or_expiry">Removing an HTLC Due to Error or Expiry</h3>
<div class="paragraph">
<p>If an HTLC cannot be fulfilled, it can be removed from the channel commitment using the same process of commitment and revocation.</p>
</div>
<div class="paragraph">
<p>Instead of update_fulfill_htlc, Bob would send an update_fail_htlc or update_fail_malformed_htlc. These two messages are defined in <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/02-peer-protocol.md#removing-an-htlc-update_fulfill_htlc-update_fail_htlc-and-update_fail_malformed_htlc">BOLT #2: Peer Protocol, Removing an HTLC</a>.</p>
</div>
<div class="paragraph">
<p>The update_fail_htlc message is shown in the following:</p>
</div>
<div id="update_fail_htlc_message" class="listingblock">
<div class="title">The update_fail_htlc message</div>
<div class="content">
<pre>[channel_id:channel_id]
[u64:id]
[u16:len]
[len*byte:reason]</pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s pretty self-explanatory. The multibyte reason field is defined in <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/04-onion-routing.md#failure-messages">BOLT #4: Onion Routing</a>, which we will describe in <a href="#onion_routing">[onion_routing]</a>.</p>
</div>
<div class="paragraph">
<p>If Alice received an update_fail_htlc from Bob, the process would unfold in much the same way: the two channel partners would remove the HTLC, create updated commitment transactions, and go through two rounds of commitment/revocation to move the channel state forward to the next commitment. The only difference: the end balances would revert back to what they were without the HTLC, essentially refunding Alice for the HTLC value.</p>
</div>
</div>
<div class="sect2">
<h3 id="_making_a_local_payment">Making a Local Payment</h3>
<div class="paragraph">
<p>At this point, you will easily understand why HTLCs are used for both remote and local payments. When Alice pays Bob for a coffee, she doesn&#8217;t just update the channel balance and commit to a new state. Instead, the payment is made with an HTLC, in the same way Alice paid Dina. The fact that there&#8217;s only one channel hop makes no difference. It would work like this:</p>
</div>
<div class="olist arabic">
<ol class="arabic" start="1">
<li>
<p>Alice orders a coffee from Bob&#8217;s shop page.</p>
</li>
<li>
<p>Bob&#8217;s shop sends an invoice with a payment hash.</p>
</li>
<li>
<p>Alice constructs an HTLC from that payment hash.</p>
</li>
<li>
<p>Alice offers the HTLC to Bob with update_add_htlc.</p>
</li>
<li>
<p>Alice and Bob exchange commitments and revocations adding the HTLC to their commitment transactions.</p>
</li>
<li>
<p>Bob sends update_fulfill_htlc to Alice with the payment preimage.</p>
</li>
<li>
<p>Alice and Bob exchange commitments and revocations removing the HTLC and updating the channel balances.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Whether an HTLC is forwarded across many channels or just fulfilled in a single channel "hop," the process is exactly the same</p>
</div>
</div>
<div class="sect2">
<h3 id="_conclusion">Conclusion</h3>
<div class="paragraph">
<p>In this chapter we saw how commitment transactions (from <a href="#payment_channels">[payment_channels]</a>) and HTLCs (from <a href="#routing">[routing]</a>) work together. We saw how an HTLC is added to a commitment transaction, and how it is fulfilled. We saw how the asymmetric, delayed, revocable system for enforcing channel state is extended to HTLCs.</p>
</div>
<div class="paragraph">
<p>We also saw how a local payment and a multihop routed payment are handled identically: using HTLCs.</p>
</div>
<div class="paragraph">
<p>In the next chapter we will look at the encrypted message routing system called <em>onion routing</em>.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2022-10-29 15:50:16 +0400
</div>
</div>
</body>
</html>