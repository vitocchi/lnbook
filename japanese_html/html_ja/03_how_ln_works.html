<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="generator" content="Asciidoctor 2.0.16" />
<title>ライトニング・ネットワークの仕組み</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700" />
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;-webkit-tap-highlight-color:transparent}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="ch03_How_Lightning_Works">ライトニング・ネットワークの仕組み</h2>
<div class="sectionbody">
<div class="paragraph">
<p>アリスがライトニングウォレットをセットアップし、ボブからコーヒーを購入するところまで追ってきましたが、次はそのプロセスに関わるライトニングネットワークの様々なコンポーネントを紐解いていきます。
この章では、ハイレベルな概要を説明し、技術的な詳細をすべて掘り下げることはしません。
むしろ、ライトニング・ネットワークの最も重要な概念と構成要素について知っていただくことを目的としています。</p>
</div>
<div class="paragraph">
<p>コンピュータサイエンス、暗号技術、ビットコイン、プロトコル開発の経験がある方は、この章を読めば、接続の詳細を自分で記入することができるようになるはずです。
経験の浅い方は、この章を読めば、BOLT（Basis of Lightning Technology）と呼ばれる正式なプロトコル仕様を簡単に理解することができるようになります。
初心者の方は、この章を読めば、本書の技術的な章をより理解しやすくなります。</p>
</div>
<div class="paragraph">
<p>ビットコインの基礎知識を再確認したい方は、<a href="#bitcoin_fundamentals_review">【bitcoin_fundamentals_review】で</a>以下のトピックをまとめて復習することが可能です。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>キーとアドレス</p>
</li>
<li>
<p>ハッシュ関数</p>
</li>
<li>
<p>デジタル署名</p>
</li>
<li>
<p>取引構造</p>
</li>
<li>
<p>トランザクションの入力と出力</p>
</li>
<li>
<p>トランザクションの連鎖</p>
</li>
<li>
<p>ビットコインスクリプト</p>
</li>
<li>
<p>マルチシグネチャーのアドレスとスクリプト</p>
</li>
<li>
<p>タイムロック</p>
</li>
<li>
<p>複雑なスクリプト</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>まず、ライトニング・ネットワークとは何かを一文で定義し、この章の残りの部分でそれを分解していきます。</p>
</div>
<div class="paragraph">
<p>ライトニング・ネットワークは、<em>ビットコインのブロックチェーン</em>上にスマートコントラクトとして実装された<em>支払いチャネルの</em>ピアツーピアネットワークであり、参加者がこれらのスマートコントラクトを設定・実行する方法を定義する通信プロトコルでもあります。</p>
</div>
<div class="sect2">
<h3 id="what_is_payment_channel">ペイメントチャネルとは？</h3>
<div class="paragraph">
<p>ペイメントチャネルを説明する方法は、文脈によっていくつかあります。まずはハイレベルなものから始めて、さらに詳細を追加していきましょう。</p>
</div>
<div class="paragraph">
<p>ペイメントチャネルは、<em>チャネルパートナーと</em>呼ばれるライトニングネットワーク上の2つのノード間の<em>金融関係</em>です。この金融関係では、2つのチャネルパートナー間で<em>資金</em>（ミリサトシ建て）の残高が割り当てられます。</p>
</div>
<div class="paragraph">
<p>決済チャネルは<em>暗号プロトコルによって</em>管理されます。つまり、チャネルパートナーは暗号に基づく事前定義されたプロセスを使用して、チャネルの残高を一方または他方のチャネルパートナーに有利に再分配することができるのです。暗号プロトコルは、一方のチャネルパートナーが他方のチャネルパートナーを騙すことができないようにするため、パートナーはお互いを信頼する必要がありません。</p>
</div>
<div class="paragraph">
<p>暗号プロトコルは、2of2<em>マルチシグネチャアドレスの</em>資金調達によって成立し、2つのチャネルパートナーに協力を求め、どちらかのチャネルパートナーが一方的に資金を使うことができないようにします。</p>
</div>
<div class="paragraph">
<p>要約すると、支払いチャネルはノード間の金融関係であり、厳密に定義された暗号プロトコルを通じて、マルチシグネチャアドレスから資金を割り当てることである。</p>
</div>
</div>
<div class="sect2">
<h3 id="_payment_channel_basics">ペイメントチャネルの基礎知識</h3>
<div class="paragraph">
<p>支払いチャネルの根底にあるのは、ビットコインのブロックチェーン上にある2対2のマルチシグネチャアドレスで、その鍵の1つをあなたが持ち、もう1つをチャネルパートナーが持っています。</p>
</div>
<div class="paragraph">
<p>あなたとあなたのチャネルパートナーは、このマルチシグネチャアドレスから支出する一連のトランザクションを交渉します。これらの取引をビットコインのブロックチェーンに送信して記録する代わりに、あなた方は未使用のままそれを保持するのです。</p>
</div>
<div class="paragraph">
<p>その一連のトランザクションの中で最新のものは、チャネルの残高を暗号化し、その残高をあなたとチャネル・パートナーの間でどのように分割するかを定義するものです。</p>
</div>
<div class="paragraph">
<p>したがって、このシーケンスに新しいトランザクションを追加することは、ビットコインネットワークに気づかれることなく、チャネル残高の一部をあるチャネルパートナーから他のチャネルパートナーに移動することと同じである。新しいトランザクションを交渉するたびに、チャネル内の資金の配分を変更すると同時に、前のトランザクションを取り消すので、どちらの当事者も前の状態に逆戻りすることはできない。</p>
</div>
<div class="paragraph">
<p>一連の各トランザクションはビットコインのスクリプト言語を利用しているため、あなたとチャネルパートナー間の資金の交渉は、ビットコインのスマートコントラクトによって管理されています。
スマートコントラクトは、チャネルメンバーが以前に取り消された状態を提出しようとすると、ペナルティを課すように設定されています。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">備考</div>
</td>
<td class="content">
<div class="paragraph">
<p>2of2マルチシグネチャーのアドレスから未公開の取引があり、残高の一部が支払われる場合、相手からの署名があれば、自分の署名を追加することでいつでも独立してこの取引を公開できることが保証されます。</p>
</div>
<div class="paragraph">
<p>部分的に署名された取引をオフラインで未公開のまま保持し、いつでもその残高を公開して所有できる機能は、ライトニング・ネットワークの基礎となっています。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_routing_payments_across_channels">チャネルをまたいだ決済のルーティング</h3>
<div class="paragraph">
<p>複数の参加者が1つの当事者から別の当事者へチャンネルを持つと、複数の決済チャンネル同士をつなぐネットワーク上の<em>パスを</em>設定することで、決済チャンネルから決済チャンネルへ支払いを「転送」することも可能です。</p>
</div>
<div class="paragraph">
<p>例えば、アリスがボブとチャンネルを持ち、ボブがチャーリーとチャンネルを持てば、アリスはチャーリーにお金を送ることができる。</p>
</div>
<div class="paragraph">
<p>ライトニング・ネットワークの設計上、チャネルを操作するスマートコントラクトを拡張することが可能で、ボブは自分のチャネルを通じて転送される資金を盗む方法がない。</p>
</div>
<div class="paragraph">
<p>スマートコントラクトがチャネルパートナーを保護し、お互いを信頼する必要がないのと同じように、ネットワーク全体が参加者を保護し、他の参加者を一切信頼することなく支払いを進めることができるのです。</p>
</div>
<div class="paragraph">
<p>チャネルはマルチシグネチャのアドレスから構築され、残高更新取引はプリサインのビットコイン取引なので、ライトニングネットワークの運用に必要な信頼はすべて分散型ビットコインネットワークの信頼から得られるのです</p>
</div>
<div class="paragraph">
<p>前述の技術革新は、確かにライトニングネットワークの誕生を可能にした大きなブレークスルーである。
しかし、ライトニングネットワークは、ビットコインスクリプト言語上の暗号プロトコルをはるかに超えるものです。
ピアがライトニングメッセージを交換し、ビットコインの送金を実現するための包括的な通信プロトコルなのです。
通信プロトコルは、ライトニングメッセージがどのように暗号化され、交換されるかを定義しています。</p>
</div>
<div class="paragraph">
<p>また、ライトニングネットワークでは、ゴシッププロトコルを用いて、チャンネルに関する公開情報（ネットワークトポロジー）を参加者全員に配布している。</p>
</div>
<div class="paragraph">
<p>例えばアリスは、ボブとチャーリーの間のチャネルを認識し、チャーリーへのルートを構築できるように、ネットワークトポロジー情報を必要とします。</p>
</div>
<div class="paragraph">
<p>最後になりますが、ライトニングネットワークは、ビットコインの上に、ビットコインのトランザクションとビットコインスクリプトを使用するアプリケーションに過ぎないことを理解することが重要です。"ライトニングコイン "や "ライトニングブロックチェーン "は存在しないのです。
すべての技術的なプリミティブを超えて、LNプロトコルは、ビットコインネットワーク以外の誰かを信頼する必要なしに、任意の量の即時決済による支払いを可能にすることで、ビットコインからより多くの利益を得るための創造的な方法です。</p>
</div>
</div>
<div class="sect2">
<h3 id="_payment_channels">決済チャネル</h3>
<div class="paragraph">
<p>前章で見たように、アリスはウォレットソフトを使って、自分と他のLN参加者との間に支払いチャネルを作った。</p>
</div>
<div class="paragraph">
<p>チャンネルは3つしか制限されない。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>まず、インターネットがチャネルの端から端まで資金を移動させるために必要なプロトコルの数百バイトのデータを転送するのにかかる時間です</p>
</li>
<li>
<p>第二に、チャンネルの容量、つまりチャンネル開設時にコミットされるビットコインの量です</p>
</li>
<li>
<p>第三に、ビットコイン取引の最大サイズ制限は、チャネル上で同時に運ぶことができる不完全な（進行中の）ルーティングされた支払の数を制限することもできます。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ペイメント・チャンネルには、非常に興味深く、有用な特性がいくつかあります。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>チャネルの更新時間は主にインターネットの通信速度に拘束されるため、ペイメントチャネルでの支払いはほぼ瞬時に行うことができます。</p>
</li>
<li>
<p>チャネルが開いている場合、支払いを行うには、Bitcoinブロックの確認は必要ありません。実際、あなたとあなたのチャンネルパートナーがプロトコルに従っている限り、ビットコインネットワークやあなたのチャンネルパートナー以外の誰かとのやりとりは必要ありません。</p>
</li>
</ul>
</div>
<div class="ulist pagebreak-before">
<ul>
<li>
<p>暗号プロトコルは、あなたとあなたのチャネルパートナーとの間にほとんど信頼が必要ないように構築されています。パートナーが応答しなくなったり、あなたをだまそうとした場合、ビットコインのシステムが「裁判所」として機能し、あなたとパートナーが以前に合意したスマート契約を解決するように依頼することができます。</p>
</li>
<li>
<p>ペイメントチャネルで行われた支払いは、あなたとあなたのパートナーだけが知っています。その意味で、すべての取引が公開されるビットコインと比較して、プライバシーを得ることができます。  ビットコインのブロックチェーン上では、そのチャネルでのすべての支払いの集計である最終残高のみが見えるようになります。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ビットコインは、才能ある開発者が双方向、無期限、ルーティング可能な決済チャネルを構築する方法を最初に見出したときから5年ほど経っており、現在では少なくとも3種類の方法が知られています。</p>
</div>
<div class="paragraph">
<p>本章では、2015年にJoseph PoonとThaddeus Dryjaが<a href="https://lightning.network/lightning-network-paper.pdf">Lightning Networkのホワイトペーパーで</a>最初に説明したチャネル構築方法を取り上げます。これらは<em>Poon-Dryja</em>チャネルと呼ばれ、現在Lightning Networkで採用されているチャネル構築方式である。
他に提案されているのは、Poon-Dryjaチャネルと同時期にChristian Deckerが紹介した<em>Duplex Micropayment</em>チャネルと、<a href="https://blockstream.com/eltoo.pdf">「eltoo</a>」で紹介されているeltooチャネルである。2018年にChristian Decker、Rusty Russel、（本書の共著者）Olaoluwa Osuntokunによって「<a href="https://blockstream.com/eltoo.pdf">A Simple Layer2 Protocol for Bitcoin</a>」が発表されています。</p>
</div>
<div class="paragraph">
<p>eltooチャンネルには興味深い特性があり、決済チャンネルの実装を簡素化することができます。しかし、eltooチャンネルはビットコインスクリプト言語の変更を必要とするため、2020年現在、ビットコインメインネットに実装することはできません。</p>
</div>
<div class="sect3">
<h4 id="_multisignature_address">マルチシグネチャーのアドレス</h4>
<div class="paragraph">
<p>決済チャネルは、2-of-2のマルチシグネチャアドレスの上に構築されています。</p>
</div>
<div class="paragraph">
<p>要約すると、マルチシグネチャアドレスとは、ビットコインがロックされているため、ロックを解除して使用するために複数の署名が必要なアドレスのことです。ライトニングネットワークで使われているような2-of-2マルチシグネチャアドレスでは、参加する署名者が2人いて、資金を使うには<em>両方の</em>署名が必要である。</p>
</div>
<div class="paragraph">
<p>マルチシグネチャのスクリプトとアドレスについては、<a href="#multisig">[multisig]</a>で詳しく説明されています。</p>
</div>
</div>
<div class="sect3 pagebreak-before less_space">
<h4 id="_funding_transaction">資金調達の取引</h4>
<div class="paragraph">
<p>ペイメントチャネルの基本的な構成要素は、2対2のマルチシグネチャアドレスです。2つのチャネルパートナーのうち1つは、マルチシグネチャアドレスにビットコインを送信することによって、支払いチャネルに資金を提供します。この取引は<em>資金調達取引と</em>呼ばれ、ビットコインブロックチェーンに記録されます。<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup></p>
</div>
<div class="paragraph">
<p>資金取引は公開されていても、チャネルが公示されない限り、それがライトニングの支払チャネルであることは閉じるまで明らかでない。チャネルは通常、支払いを転送したいルーティングノードによって公に発表されます。しかし、非広告型チャネルも存在し、通常、ルーティングに積極的に参加しないモバイルノードによって作成されます。さらに、チャネル支払いはやはりチャネルパートナー以外には見えませんし、パートナー間のチャネル残高の分配も見えません。</p>
</div>
<div class="paragraph">
<p>マルチシグネチャアドレスに入金された金額は<em>チャネル容量と</em>呼ばれ、ペイメントチャネルを越えて送信できる最大金額を設定します。しかし、資金は前後に送ることができるので、チャネルキャパシティは、チャネルを越えて流れることができる価値の上限ではありません。それは、一方向の支払いでチャネル容量を使い切った場合、再び反対方向の支払いに使用することができるためです。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">備考</div>
</td>
<td class="content">
<div class="paragraph">
<p>資金調達取引でマルチシグネチャアドレスに送られる資金は、"Lightningチャネルにロックされている "と表現されることがあります。しかし、実際には、ライトニングチャンネルの資金は "ロックされている "のではなく、"解き放たれている "のです。ライトニングチャンネルの資金は、ビットコインのブロックチェーン上の資金よりも、より速く、より安く、より個人的に使うことができるため、流動性が高いです。ライトニングネットワークに資金を移動することにはデメリットもありますが（「ホット」ウォレットに資金を保管する必要があるなど）、ライトニングに「資金をロックする」という考え方は誤解を招きやすいと言えます。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_example_of_a_poor_channel_opening_procedure">チャンネル開設の手順が悪い例</h5>
<div class="paragraph">
<p>2-of-2マルチシグネチャアドレスについてよく考えてみると、このようなアドレスに資金を投入することは、ある程度のリスクを伴うように思われることに気づかれると思います。もし、あなたのチャネル・パートナーが資金を放出するための取引に署名することを拒否したらどうでしょうか？彼らは永遠に立ち往生しているのでしょうか？では、そのシナリオとLNプロトコルがどのようにそれを回避するのかを見てみましょう。</p>
</div>
<div class="paragraph">
<p>アリスとボブは、支払いチャネルを作りたいと考えている。彼らはそれぞれ秘密鍵/公開鍵のペアを作成し、公開鍵を交換する。これで、2つの公開鍵で多符号化2-of-2を構成し、支払いチャネルの基礎を形成することができる。</p>
</div>
<div class="paragraph">
<p>次に、アリスはアリスとボブの公開鍵から作られたマルチシグネチャアドレスに数mBTCを送るビットコイン取引を構築する。もしアリスが追加の手順を踏まず、単にこの取引をブロードキャストした場合、アリスはボブがマルチシグネチャアドレスから使うために署名を提供することを信頼しなければならない。一方ボブは、自分の署名を保留してアリスが資金にアクセスするのを拒否することで、アリスを脅迫する機会がある。</p>
</div>
<div class="paragraph">
<p>これを防ぐために、アリスはマルチシグネチャーのアドレスから支出する追加トランザクションを作成し、彼女のmBTCを払い戻す必要があります。アリスはその後、ビットコインネットワークに送金する<em>前に</em>、ボブに払い戻し取引に署名してもらう。こうすることで、アリスはボブが失踪したり協力しなかったりしても、返金を受けることができる。</p>
</div>
<div class="paragraph">
<p>アリスを保護する「払い戻し」取引は、次に詳しく検討する<em>コミットメント取引と</em>呼ばれる種類の取引の最初のものである。</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_commitment_transaction">コミットメント取引</h4>
<div class="paragraph">
<p><em>コミットメント</em>・トランザクションは、各チャネル・パートナーにチャ ンネル残高を支払い、チャネル・パートナーが互いに信用する必要 がないようにするためのトランザクションです。コミットメント・トランザクションに署名することで、各チャネル・パートナーは現在の残高を「コミット」し、他のチャネル・パートナーが好きなときに資金を取り戻すことができるようにします。</p>
</div>
<div class="paragraph">
<p>署名されたコミットメントトランザクションを保持することにより、各チャネルパートナーは、他のチャネルパートナーの協力がなくても、彼らの資金を得ることができます。これは、他のチャネルパートナーが失踪したり、協力を拒否したり、あるいは支払いチャネルのプロトコルに違反して不正を行おうとした場合にも保護されます。</p>
</div>
<div class="paragraph">
<p>前の例でAliceが準備したコミットメント取引は、マルチシグネチャアドレスへの最初の支払いの払い戻しであった。しかし、より一般的には、コミットメントトランザクションは支払いチャネルの資金を分割し、2つのチャネルパートナーがそれぞれ保有する分配（残高）に応じて支払いを行うものである。最初は、アリスがすべての残高を保持しているので、単純な払い戻しである。しかし、資金がアリスからボブに流れるとき、彼らは新しい残高分配を表す新しいコミットメントトランザクションの署名を交換し、資金の一部がアリスに支払われ、一部がボブに支払われることになる。</p>
</div>
<div class="paragraph">
<p>アリスがボブと100,000サトシの容量を持つチャネルを開いたと仮定しましょう。
最初、アリスはチャンネルにある資金の全額である10万サトシを所有しています。ここで、支払いチャネルのプロトコルがどのように動くかを説明します。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>アリスは新しい秘密鍵/公開鍵のペアを作成し、<code>open_channel</code>メッセージ（LNプロトコルのメッセージ）を介して、チャンネルを開きたい旨をボブに通知する。</p>
</li>
<li>
<p>ボブはまた、新しい秘密鍵/公開鍵のペアを作成し、アリスからのチャネルを 受け入れることに同意し、<code>accept_channel</code>メッセージで自分の公開鍵をアリスに 送信します。</p>
</li>
<li>
<p>アリスは自分のウォレットから、ロックスクリプトを使ってマルチシグネチャアドレスに100k satoshiを送る資金調達取引を作成する。2 &lt;PubKey Alice&gt; &lt;PubKey Bob&gt; 2 CHECKMULTISIG.</p>
</li>
<li>
<p>Aliceはこの資金取引をまだブロードキャストしないが、Bobのコミットメント取引 のための署名とともに<code>funding_created</code>メッセージで取引IDをBobに送る。</p>
</li>
<li>
<p>アリスとボブの両方が自分バージョンのコミットメント取引を作成する。この取引は資金調達取引から支出し、すべてのビットコインをアリスが管理するアドレスに送り返すことになる。</p>
</li>
<li>
<p>アリスとボブはこのコミットメントトランザクションを交換する必要はない。なぜなら、それぞれがどのように構築されるかを知っており、（入力と出力の正規の順序に合意しているので）独立して両方を構築することができるからである。彼らは署名だけを交換する必要がある。</p>
</li>
<li>
<p>BobはAliceのコミットメントトランザクションに署名を提供し、<code>funding_signed</code>メッセージでAliceにこれを送り返す。</p>
</li>
<li>
<p>署名が交換されたので、アリスはビットコインネットワークにファンディングトランザクションをブロードキャストします。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>このプロトコルに従うと、アリスが1つの鍵しか制御していない2-of-2多重署名アドレスに資金が送られたとしても、アリスは10万サトシの所有権を手放さずにすむ。
もしボブがアリスに応答しなくなったら、アリスは自分のコミットメント取引をブロードキャストし、資金を受け取ることができる。
彼女の唯一のコストはオンチェーン・トランザクションの手数料である。
アリスがプロトコルに従う限り、チャンネルを開設する際のリスクはこれだけである。</p>
</div>
<div class="paragraph">
<p>この最初の交換の後、チャネルバランスが変化するたびにコミットメント・トランザクションが作成される。言い換えれば、アリスとボブの間で支払いが行われるたびに、新しいコミットメント・トランザクションが作成され、署名が交換される。それぞれの新しいコミットメント・トランザクションは、アリスとボブの間の最新の残高を符号化する。</p>
</div>
<div class="paragraph">
<p>アリスがボブに3万通貨を送りたい場合、両者は新しいバージョンのコミットメント取引を作成し、アリスに7万通貨、ボブに3万通貨を支払うことになる。アリスとボブの新しい残高を符号化することで、新しいコミットメント取引は、支払いがチャネルを越えて「送られる」手段となる。</p>
</div>
<div class="paragraph">
<p>さて、コミットメントトランザクションを理解したところで、より微妙な詳細を見てみましょう。このプロトコルはアリスとボブのどちらかが不正をする方法を残していることにお気づきでしょうか。</p>
</div>
</div>
<div class="sect3">
<h4 id="_cheating_with_prior_state">先行国とのカンニング</h4>
<div class="paragraph">
<p>アリスがボブに30kサトシを支払った後、いくつのコミットメントトランザクションを保持しているか？彼女は2つ持っています。最初のものは彼女に10万サトシを支払うもので、最近のものは彼女に7万サトシとボブに3万サトシを支払うものです。</p>
</div>
<div class="paragraph">
<p>これまで見てきたチャネルプロトコルでは、アリスが以前のコミットメント取引を公表することを止めるものはない。不正をしたアリスは自分に10万サトシを与えるコミットメント取引を公表することができる。
そのコミットメント取引はボブによって署名されているので、ボブはアリスがそれを送信するのを防ぐことができない。</p>
</div>
<div class="paragraph">
<p>アリスが古いコミットメントトランザクションを公開するのを防ぐために、何らかのメカニズムが必要である。では、どのようにしてこれを実現し、アリスとボブの間の信頼を必要とせずにライトニングネットワークを運用することを可能にするのかを見ていきましょう。</p>
</div>
<div class="paragraph">
<p>ビットコインは検閲に強いため、誰かが古いコミットメントトランザクションを公開することを誰も阻止できない。このような不正行為を防ぐため、コミットメント・トランザクションは、古いものが送信された場合、不正行為者に罰が与えられるように構成されています。この罰則を十分に大きくすることで、不正行為に対する強いインセンティブを作り出し、システムの安全性を高めているのです。</p>
</div>
<div class="paragraph">
<p>ペナルティの仕組みは、不正をした側に、不正をした側の残高を請求する機会を与えることです。ですから、誰かが古いコミットメント取引を放送して不正をしようとした場合、その取引では、支払期日よりも高い残高が支払われますが、相手側は、自分の残高と不正をした人の残高の<em>両方を</em>取ることで罰することができます。不正をした人はすべてを失うことになる。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">チップ</div>
</td>
<td class="content">
<div class="paragraph">
<p>アリスがチャンネル残高をほとんど使い果たしたら、ほとんど危険を冒さずに不正行為を行えることに気づくかもしれません。ボブのチャンネル残高が少なければ、ボブのペナルティはそれほど痛くはないでしょう。これを防ぐために、ライトニングプロトコルでは、各チャネルパートナーは、常に "skin in the game" を持つように、チャンネルに最低限の残高（<em>リザーブと</em>呼ばれる）を保つことが要求されます。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>ここでもう一度、不正行為から守るためのペナルティ機構を加えて、チャネル構築のシナリオを考えてみましょう。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>アリスはボブとチャンネルを作り、100kサトシを投入する。</p>
</li>
<li>
<p>アリスはボブに30kサトシを送る。</p>
</li>
<li>
<p>アリスは古いコミットメントを公開することで、ボブが稼いだ30kサトシを騙し取り、100kサトシ全額を自分のものにしようとする。</p>
</li>
<li>
<p>ボブは不正を見破り、アリスを罰し、10万サトシをすべて自分のものにした。</p>
</li>
<li>
<p>ボブは100kサトシを手に入れ、アリスの不正を発見したことで70kサトシを獲得した。</p>
</li>
<li>
<p>アリスは0サトシで終了。</p>
</li>
<li>
<p>ボブから3万円を騙し取ろうとしたところ、彼女は所有していた7万円を失ってしまう。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>強力なペナルティ・メカニズムがあれば、アリスは残高をすべて失うリスクがあるため、古いコミットメント取引を公開することで不正をしようという誘惑に駆られることはない。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">備考</div>
</td>
<td class="content">
<div class="paragraph">
<p><em>マスタリング・ビットコイン</em>』の第12章で、アンドレアス・アントノプロス（本書の共著者）は次のように述べています。
"ビットコインの重要な特徴は、一度有効になった取引は有効なままであり、期限切れにならないことである。トランザクションをキャンセルする唯一の方法は、マイニングされる前にその入力を他のトランザクションと二重に消費することである。"</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>なぜ</em>ペナルティの仕組みが必要なのか、どのように不正を防止するのかを理解したところで、その<em>仕組みを</em>具体的に見ていきましょう。</p>
</div>
<div class="paragraph">
<p>通常、コミットメント・トランザクションは少なくとも2つの出力を持ち、各チャネルパートナーに支払いを行う。これを変更し、支払いの1つに<em>タイムロック遅延と</em> <em>失効</em>秘密を追加する。タイムロックは、コミットメント・トランザクションがブロックに含まれると、アウトプットの所有者がすぐにそれを使うことを防ぎます。失効シークレットは、どちらの当事者もタイムロックを回避してその支払いをすぐに使うことを可能にします。</p>
</div>
<div class="paragraph">
<p>つまり、この例では、BobはAliceに<em>直ちに</em>支払うコミットメント取引を持っているが、彼自身の支払いは遅延され、取り消し可能である。アリスもコミットメント取引を持っているが、彼女のものは逆で、ボブにすぐ支払うが、自分の支払いは遅延し、取り消しが可能である。</p>
</div>
<div class="paragraph">
<p>2つのチャネルパートナーは失効の秘密の半分を保持し、どちらも秘密全体を知らないようにする。もし彼らが半分を共有すれば、もう一方のチャネルパートナーは完全な秘密を持ち、それを使って取り消し条件を行使することができる。新しいコミットメントトランザクションに署名するとき、各チャネルパートナーは、相手に取り消し秘密の半分を与えることによって、前のコミットメントを取り消す。</p>
</div>
<div class="paragraph">
<p>リボケーションの仕組みについては、<a href="#revocation">[revocation]</a>で詳しく検討し、リボケーションシークレットの構築と使用方法の詳細を学ぶ予定である。</p>
</div>
<div class="paragraph">
<p>簡単に言えば、アリスはボブが前のコミットメントに対する破棄の秘密の半分を提供し た場合にのみ、ボブの新しいコミットメントトランザクションに署名する。ボブは、アリスが前のコミットメントの取り消し秘密の半分を提供する場合にのみ、アリスの新しいコミットメントトランザクションに署名する。</p>
</div>
<div class="paragraph">
<p>新しいコミットメントをするたびに、彼らは必要な「罰」秘密を交換する。それは、送信に利益をもたらさないようにすることで、前のコミットメント取引を効果的に<em>取り消す</em>ことができる。基本的に、彼らは新しいコミットメントに署名する際に、古いコミットメントを使用する能力を破壊する。つまり、技術的にはまだ古いコミットメントを使用することは可能だが、罰のメカニズムによって、そう<span class="keep-together">する</span>ことは経済的に不合理になるということである。</p>
</div>
<div class="paragraph">
<p>タイムロックは、最大2,016ブロック（約2週間）までの数に設定されています。どちらかのチャネルパートナーがもう一方のパートナーと協力せずにコミットメントトランザクションを発行した場合、そのブロック数（例えば2週間）だけ待って残高を請求する必要があります。もう一方のチャネル・パートナーは、いつでも自分の残高を請求することができる。さらに、相手が公表したコミットメントが以前に取り消された場合、チャンネル・パートナーは不正行為者の残高を直ちに請求する<em>ことも</em>でき、タイムロックを回避して不正行為者を罰することができます。</p>
</div>
<div class="paragraph">
<p>タイムロックは調整可能で、チャネル・パートナー間で交渉することができる。通常、大きな容量のチャネルでは長く、小さなチャネルでは短くし、資金の価値とインセンティブを一致させます。</p>
</div>
<div class="paragraph">
<p>チャネルの残高が新しく更新されるたびに、新しいコミットメント・トランザクションと新しい失効秘密が作成され、保存されなければなりません。チャネルがオープンである限り、そのチャネルで<em>作成された</em>すべての失効秘密は、将来必要になる可能性があるため、保持する必要があります。幸いなことに、秘密はかなり小さなもので、ネットワーク全体ではなく、チャネルパートナーだけが保管する必要があります。さらに、失効秘密の導出に使用されるスマートな導出メカニズムにより、以前の秘密はそこから導出できるため、最新の秘密のみを保存する必要があります(<a href="#revocation_secret_derivation">[revocation_secret_derivation]</a>を参照)。</p>
</div>
<div class="paragraph">
<p>とはいえ、失効秘密の管理と保存は、ライトニングノードの中でも、ノードオペレータがバックアップを維持する必要がある手の込んだ部分である。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">備考</div>
</td>
<td class="content">
<div class="paragraph">
<p>ウォッチタワーサービスやチャネル構築プロトコルをeltooプロトコルに変更するなどの技術は、これらの問題を軽減し、失効秘密、ペナルティトランザクション、チャネルのバックアップの必要性を減らすための将来の戦略であるかもしれません。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>アリスはボブが応答しない場合、いつでもチャンネルを閉じることができ、残高の公正な取り分を要求することができる。
<em>最後の</em>コミットメント取引をチェーン上で公開した後、アリスはコミットメント取引で得た資金を使う前にタイムロックが切れるのを待つ必要がある。後で見るように、アリスとボブの両方がオンラインであり、正しい残高配分でチャネルを閉じるために協力する限り、待つことなくチャネルを閉じるより簡単な方法がある。しかし、各チャネル・パートナーが保存しているコミットメント・トランザクションはフェールセーフとして機能し、チャネル・パートナーに問題がある場合でも資金を失うことはない。</p>
</div>
</div>
<div class="sect3">
<h4 id="_announcing_the_channel">チャンネルを発表</h4>
<div class="paragraph">
<p>チャネルパートナーは、ライトニングネットワーク全体に対してチャネルを発表することに同意し、<em>パブリックチャネルと</em>することができます。チャネルを発表するには、ライトニングネットワークのゴシッププロトコルを使用して、チャネルの存在、容量、料金について他のノードに知らせます。</p>
</div>
<div class="paragraph">
<p>チャンネルを公開することで、他のノードが決済ルーティングに使用できるようになり、それによってチャンネルパートナーにルーティングフィーが発生します。</p>
</div>
<div class="paragraph">
<p>これに対し、チャネルパートナーはチャネルを発表しないことを決定し、<em>非発表</em>チャネルとすることができる。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">備考</div>
</td>
<td class="content">
<div class="paragraph">
<p>未発表のチャンネルを表す言葉として「プライベートチャンネル」という言葉を耳にすることがあります。この用語は誤解を招き、誤ったプライバシーの感覚を与えるため、私たちはこの用語を使用しないようにしています。未発表チャネルは、使用中は他の人に知られることはありませんが、チャネルが閉鎖されると、その詳細が最終決済トランザクションでオンチェーンに表示されるため、その存在と容量が明らかになります。他にもさまざまな形でその存在が漏れる可能性があるため、「プライベート」と呼ぶのは避けた方がよいでしょう。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>非通知チャネルは依然として支払いのルーティングに使用されるが、その存在を認識しているノード、または非通知チャネルを含むパスに関する「ルーティングヒント」を与えられたノードによってのみ使用される。</p>
</div>
<div class="paragraph">
<p>gossipプロトコルを用いてチャネルとそのキャパシティを公示する場合、その公示にはチャネルに関する情報（メタデータ）、例えばルーティング料やタイムロック時間なども含めることができる。</p>
</div>
<div class="paragraph">
<p>新しいノードは、ライトニングネットワークに参加すると、ピアからゴシッププロトコル経由で伝えられるチャネルアナウンスを収集し、ライトニングネットワークの内部マップを構築します。このマップは、支払いのためのパスを見つけるために使用され、チャネルをエンドツーエンドで接続することができます。</p>
</div>
</div>
<div class="sect3">
<h4 id="_closing_the_channel">チャンネルを閉じる</h4>
<div class="paragraph">
<p>チャンネルを閉じる最善の方法は...閉じないことです!
チャンネルを開いたり閉じたりするには、オンチェーン取引が必要で、その際に取引手数料が発生します。
ですから、チャネルはできるだけ長く開いておくのがベストです。
チャンネルの側に十分な容量がある限り、支払いを行ったり転送したりするためにチャンネルを使い続けることができます。
しかし、チャネルのもう一方の端にすべての残高を送ったとしても、その後、チャネル・パートナーから支払いを受けるためにチャネルを使用することができます。
このように、チャネルを一方向に使用し、その後逆方向に使用するコンセプトは「リバランシング」と呼ばれ、別の章で詳しく検討します。
チャネルのリバランスを行うことで、チャネルをほぼ無限に開き、実質的に無制限に支払いに使用することができる。</p>
</div>
<div class="paragraph">
<p>しかし、時にはチャンネルを閉じることが望ましい、あるいは必要な場合があります。例えば、以下のような場合です。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>セキュリティ上の理由から、ライトニング・チャンネルの残高を減らし、"コールドストレージ "に資金を送りたい場合。</p>
</li>
<li>
<p>チャネルパートナーが長期間応答しなくなり、チャネルを使用できなくなった。</p>
</li>
<li>
<p>チャネルパートナーがあまりつながりのないノードであるため、チャネルがあまり使用されていない。</p>
</li>
<li>
<p>チャネルパートナーがソフトウェアのバグまたは故意にプロトコルを破り、資金を保護するためにチャネルを閉じることを余儀なくされた。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>決済チャネルを閉じるには、3つの方法があります。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>相互密着（良い意味で）</p>
</li>
<li>
<p>強制終了(悪い方法)</p>
</li>
<li>
<p>プロトコル違反(醜態)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>これらの方法は、それぞれ異なる状況で有効ですが、本章の次のセクションで説明します。
たとえば、チャネルパートナーがオフラインの場合、協力的なパートナーなしには相互のクローズができないため、「良い方法」に従うことはできません。
通常、LN ソフトウェアは、その状況下で利用可能な最良のクロージングメカニズムを自動的に選択します。</p>
</div>
<div class="sect4">
<h5 id="_mutual_close_the_good_way">相互密着（良い意味で）</h5>
<div class="paragraph">
<p>相互クローズとは、チャネルパートナー双方がチャネルのクローズに合意することであり、チャネルクローズの方法として推奨されている。</p>
</div>
<div class="paragraph">
<p>チャネルを閉じることを決定すると、LN ノードがチャネル・パートナーにその意向を通知します。
これで、あなたのノードとチャネルパートナーのノードの両方がチャネルを閉じるために一緒に動作します。
どちらのチャネルパートナーからも新しいルーティングの試行は受け入れられず、進行中のルーティングの試行はタイムアウト後に解決または削除されます。
ルーティングの試行を確定するには時間がかかるので、相互クローズにも時間がかかることがあります。</p>
</div>
<div class="paragraph">
<p>保留中のルーティングの試行がなくなると、ノードは協力して<em>クローズ トランザクションを</em>準備する。
このトランザクションはコミットメントトランザクションに似ている。それはチャネルの最後のバランスをエンコードするが、出力はタイムロックで暗号化されない。</p>
</div>
<div class="paragraph">
<p>クロージングトランザクションのオンチェーン取引手数料は、チャネルを開設したチャネルパートナーが支払うもので、クロージング手続きを開始したチャネルパートナーが支払うものではありません。
オンチェーン料金見積もりツールを使って、チャネルパートナーは適切な料金に合意し、両者ともクロージングトランザクションに署名します。</p>
</div>
<div class="paragraph">
<p>クロージングトランザクションがブロードキャストされ、ビットコインネットワークによって確認されると、チャネルは効果的に閉じられ、各チャネルパートナーは、チャネル残高の彼らの分け前を受け取ったことになります。
待ち時間はあるものの、相互クローズは通常、フォースクローズよりも高速です。</p>
</div>
</div>
<div class="sect4">
<h5 id="_force_close_the_bad_way">強制終了(悪い方法)</h5>
<div class="paragraph">
<p>フォースクローズとは、一方のチャネルパートナーが、他方のチャネルパートナーの同意なしにチャネルを閉じようとすることです。</p>
</div>
<div class="paragraph">
<p>これは通常、チャネルパートナーの1人が連絡不能で、相互のクローズが不可能な場合に起こります。
この場合、一方的にチャネルをクローズし、資金を「解放」するために、フォースクローズを開始することになります。</p>
</div>
<div class="paragraph">
<p>強制終了を開始するには、ノードが持つ最後のコミットメント・トランザクションを発行すればよいのです。
結局のところ、それがコミットメント・トランザクションの目的です。それは、チャネルの残高を取得するためにチャネル・パートナーを信頼する必要がないことを保証するものです。</p>
</div>
<div class="paragraph">
<p>最後のコミットメント取引をビットコインネットワークにブロードキャストし、それが確認されると、あなたとパートナー用に1つずつ、2つの使用可能な出力が作成されます。
前回説明したように、ビットコインネットワークは、これが最新のコミットメント取引なのか、それともあなたのパートナーから盗むために公開された古い取引なのかを知る術がありません。
したがって、このコミットメント取引はあなたのパートナーに若干の優位性を与えることになる。
強制終了を開始したパートナーは、その出力をタイムロックで拘束され、もう一方のパートナーの出力はすぐに使用できるようになります。
あなたが先にコミットメントをブロードキャストした場合、タイムロックの遅れにより、あなたのパートナーは取り消しの秘密を使ってその取引に異議を唱え、あなたを不正行為で罰する機会が与えられます。</p>
</div>
<div class="paragraph">
<p>フォースクローズ中にコミットメント取引を公開する場合、いくつかの理由により、オンチェーン手数料は相互クローズよりも高くなります。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>コミットメント取引が交渉されたとき、チャネルパートナーは将来取引がブロードキャストされる時点でオンチェーン手数料がいくらになるかを知らなかった。手数料はコミットメント・トランザクションの出力を変更しなければ変更できず（両方の署名が必要）、また強制終了はチャネル・パートナーが署名できないときに起こるため、プロトコル開発者はコミットメント・トランザクションに含まれる手数料率に非常に寛大であることを決定したのである。コミットメント・トランザクションの交渉時に提示される手数料見積もりよりも、最大で5倍も高くなることもあります。</p>
</li>
<li>
<p>コミットメント取引には、保留中のルーティング試行やハッシュタイムロックコントラクト（HTLC）の追加出力が含まれるため、相互クローズ取引よりも（バイト単位で）大きな取引となります。大きなトランザクションは、より多くの手数料を発生させます。</p>
</li>
<li>
<p>保留中のルーティングの試みはオンチェーンで解決しなければならず、追加のオンチェーン・トランザクションを引き起こします。</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">備考</div>
</td>
<td class="content">
<div class="paragraph">
<p>ハッシュタイムロックコントラクト（HTLC）については、<a href="#htlcs">[htlcs]</a>で詳しく説明する予定です。
今のところ、これらは2つのチャネルパートナー間で直接行われる支払いではなく、ライトニングネットワークを経由して行われる支払いであると仮定します。
これらのHTLCはコミットメント・トランザクションの追加出力として運ばれ、それによってトランザクション・サイズとオンチェーン手数料が増加します。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>一般的に、強制終了は絶対に必要な場合を除き、推奨されません。
あなたの資金はより長い間ロックされ、チャネルを開いた人はより高い手数料を支払わなければならなくなります。
さらに、あなたがチャンネルを開いていなくても、ルーティングの試行を中止したり決済したりするために、オンチェーン手数料を支払わなければならないかもしれません。</p>
</div>
<div class="paragraph">
<p>チャネルパートナーが既知であれば、その個人または会社に連絡して、ライトニングノードがダウンしている理由を問い合わせ、再開を依頼することで、相互のチャネルクローズを実現することも検討できます。</p>
</div>
<div class="paragraph">
<p>強制終了は最後の手段としてのみ検討する必要があります。</p>
</div>
</div>
<div class="sect4">
<h5 id="_protocol_breach_the_ugly_way">プロトコル違反(醜態)</h5>
<div class="paragraph">
<p>プロトコル違反とは、チャネルパートナーが意図的かどうかに関わらず、古いコミットメントトランザクションをビットコインのブロックチェーンに公開し、本質的に彼らの側から（不正な）強制終了を開始することで、あなたをだまそうとすることです。</p>
</div>
<div class="paragraph">
<p>これを検出するには、あなたのノードがオンラインであり、ビットコインブロックチェーン上の新しいブロックとトランザクションを監視している必要があります。</p>
</div>
<div class="paragraph">
<p>チャンネル・パートナーの支払いはタイムロックによって担保されるため、ノードにはタイムロックが切れる前にプロトコル違反を検出し、<em>罰のトランザクションを</em>発行するために行動する時間がある。</p>
</div>
<div class="paragraph">
<p>プロトコル違反の検出に成功し、ペナルティを執行した場合、チャネルパートナーの資金を含め、チャネル内のすべての資金を受け取ることができます。</p>
</div>
<div class="paragraph">
<p>このシナリオでは、チャンネル閉鎖はむしろ速くなります。
処罰されたトランザクションを公開するためにオンチェーン料金を支払う必要がありますが、あなたのノードは料金見積もりに従ってこれらの料金を設定し、払い過ぎないようにすることができます。
一般に、できるだけ早く確認を保証するために高い手数料を支払いたいと思うでしょう。
しかし、最終的には不正行為者の資金をすべて受け取ることになるため、このトランザクションの代金を支払うのは基本的に不正行為者である。</p>
</div>
<div class="paragraph">
<p>プロトコルの違反を検出できず、タイムロックが切れた場合、パートナーが公開したコミットメントトランザクションによって割り当てられた資金のみを受け取ることになります。
これ以降に受け取った資金は、パートナーによって盗まれたことになります。
あなたに割り当てられた残高がある場合、その残高を回収するためにオンチェーン手数料を支払う必要があります。</p>
</div>
<div class="paragraph">
<p>強制終了と同様に、保留中のすべてのルーティングの試行もコミットメント・トランザクションで解決する必要があります。</p>
</div>
<div class="paragraph">
<p>プロトコル違反は、相手とのクローズ交渉を待つ必要がないため、相互クローズより早く実行でき、タイムロックが切れるのを待つ必要がないため、フォースクローズより早く実行できる。</p>
</div>
<div class="paragraph">
<p>ゲーム理論によれば、不正行為を発見するのは簡単であり、不正行為者は資金を<em>すべて</em>失う一方で、以前の状態にあったものだけを得ることができるため、不正行為は魅力的な戦略ではありません。
さらに、ライトニングネットワークが成熟し、監視塔が広く利用できるようになると、不正を行ったチャネルパートナーがオフラインであっても、不正者は第三者によって検知されるようになります。</p>
</div>
<div class="paragraph">
<p>従って、私たちは不正行為を推奨しません。
しかし、不正行為者を捕まえた人は、その人の資金を奪って罰することをお勧めします。</p>
</div>
<div class="paragraph">
<p>では、日々の活動で不正行為やプロトコル違反を発見するにはどうすればいいのでしょうか。
それは、あなたのチャンネルのコミットメント取引に対応するオンチェーン取引をパブリックビットコインブロックチェーンで監視するソフトウェアを実行することによって行います。
このソフトウェアは、3つのタイプのうちの1つです。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>適切にメンテナンスされ、24時間365日稼働しているLightningノード</p>
</li>
<li>
<p>チャンネルを監視するために実行する単一目的のウォッチタワーノード</p>
</li>
<li>
<p>チャンネルを視聴するために支払うサードパーティのウォッチタワー・ノード</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>コミットメントトランザクションには、最大2,016ブロックまで、所定のブロック数で指定されたタイムアウト期間があることを覚えておいてください。
タイムアウト期間に達する前にライトニングノードを一度実行しさえすれば、すべての不正行為の試みを捕らえることができます。
このようなリスクを負うことは望ましくありません。十分にメンテナンスされたノードを継続的に稼働させることが重要です（<a href="#continuous_operation">[continuous_operation]</a>を参照してください）。</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_invoices">インボイス</h3>
<div class="paragraph">
<p>ライトニング・ネットワークのほとんどの支払いは、支払先が作成する請求書から始まります。先ほどの例では、ボブがアリスに支払いを依頼するために請求書を作成しました。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">備考</div>
</td>
<td class="content">
<div class="paragraph">
<p>keysendというプロトコルの回避策を利用して、請求書なしで未承諾の支払いを送る方法があります。これについては[<a href="#keysend">keysend]</a>で検討します。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>請求書は、一意の支払識別子（支払ハッシュと呼ばれる）、受取人、金額、およびオプションのテキスト説明などの情報を含む単純な支払命令である。</p>
</div>
<div class="paragraph">
<p>請求書の最も重要な部分は支払いハッシュであり、これにより支払いが<em>原子</em>的に複数のチャネルを行き来することができる。アトミックとは、コンピュータサイエンスにおいて、正常に完了するか、全く完了しないか、中間状態や部分的なアクションの可能性がないアクションや状態変化を意味します。ライトニング・ネットワークでは、決済は全行程を通過するか、完全に失敗するかのどちらかであることを意味します。途中のノードが支払いを受け取り、それを保持できるような部分的な完了はありえない。
部分的な支払い」または「部分的に成功した支払い」というものは存在しない。</p>
</div>
<div class="paragraph">
<p>請求書はライトニング・ネットワーク上で通信されることはありません。代わりに、他の通信メカニズムを使用して「帯域外」で通信されます。これは、ビットコインアドレスがビットコインネットワーク外の送信者に伝達される方法と同様で、QRコード、電子メール、またはテキストメッセージとして伝達されます。例えば、ボブはアリスにライトニングインボイスをQRコード、電子メール、その他のメッセージチャネルで提示することができます。</p>
</div>
<div class="paragraph">
<p>請求書は通常、長い<em>bech32エンコード</em>文字列かQRコードとしてエンコードされており、スマートフォンのライトニングウォレットで読み取ることができます。請求書には、要求されたビットコインの量と、受取人の署名が含まれています。送信者はこの署名を使って受信者の公開鍵（ノードIDとも呼ばれる）を抽出し、送信者が支払先を知ることができるようにします。</p>
</div>
<div class="paragraph">
<p>ビットコインとは対照的で、異なる用語が使われていることにお気づきでしょうか。ビットコインでは、受信者が送信者にアドレスを渡します。Lightningでは、受信者がインボイスを作成し、送信者にインボイスを送信します。ビットコインでは、送り手がアドレスに資金を送ります。ライトニングでは、送信者が請求書を支払い、その支払いは受信者にルーティングされます。ビットコインは "アドレス "の概念に基づき、ライトニングは "インボイス "の概念に基づく決済ネットワークである。ビットコインでは "トランザクション "を作成し、ライトニングでは "支払い "を送信する。</p>
</div>
<div class="sect3">
<h4 id="_payment_hash_and_preimage">Payment HashとPreimage</h4>
<div class="paragraph">
<p>請求書の最も重要な部分は、<em>支払いハッシュ</em>である。請求書を構成する際、Bobは以下のように支払いハッシュを作成する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>ボブは乱数<em>rを</em>選択する。この乱数を<em>プリ画像</em>または<em>支払い秘密と</em>呼ぶ。</p>
</li>
<li>
<p>ボブはSHA-256を使用して、<em>ペイメントハッシュと</em>呼ばれる<em>rの</em>ハッシュ<em>Hを</em>計算する。 <br><em>H</em>= SHA-256<em>(r</em>)とする。</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">備考</div>
</td>
<td class="content">
<div class="paragraph">
<p><em>前像という</em>言葉は、数学に由来する。この場合、関数はSHA-256ハッシュアルゴリズムであり、ハッシュ<em>Hを</em>生成する任意の値<em>rは</em>前像と呼ばれる。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>SHA-256の逆数を求める(つまり、ハッシュから前像を計算する)方法は知られていない。ボブだけが値<em>rを知って</em>いるので、それはボブの秘密である。しかし、ボブが一旦<em>rを</em>明らかにすれば、ハッシュ<em>Hを持って</em>いる人は誰でも、SHA-256<em>(r</em>)を計算してそれが<em>Hと</em>一致するのを見ることで、<em>rが</em>正しい秘密であることを確認することができる。</p>
</div>
<div class="paragraph">
<p>ライトニング・ネットワークの決済プロセスは、<em>rが</em>完全にランダムに選ばれ、予測不可能である場合にのみ安全である。このセキュリティは、ハッシュ関数が反転したり、ブルートフォースされることがなく、したがって、誰も<em>Hから</em> <em>rを</em>見つけることができないという事実に依存している。</p>
</div>
</div>
<div class="sect3">
<h4 id="_additional_metadata">追加メタデータ</h4>
<div class="paragraph">
<p>請求書には、オプションとして、短いテキストによる説明など、その他の有用なメタデータを含めることができます。ユーザーが複数の請求書を支払う場合、ユーザーは説明文を読んで、その請求書が何であるかを思い出すことができます。</p>
</div>
<div class="paragraph">
<p>請求書には、送信者が未発表のチャネルを使用して受信者への経路を構築することを可能にする、いくつかの<em>ルーティングヒントを</em>含めることもできます。ルーティングヒントは、例えば、支払いをルーティングするのに十分な受信容量を持つことが受信者によって知られているチャネルなど、公開チャネルを提案するために使用することもできます。</p>
</div>
<div class="paragraph">
<p>送信者のライトニングノードがライトニングネットワーク上で支払いを送信できない場合、請求書はオプションでフォールバックとしてオンチェーンビットコインアドレスを含むことができます。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">備考</div>
</td>
<td class="content">
<div class="paragraph">
<p>オンチェーンでのビットコイン取引に「フォールバック」することは常に可能ですが、実際には代わりに受取人への新しいチャネルを開く方がよいでしょう。支払いのためにオンチェーンでの手数料が発生するのであれば、チャネルを開設してLightningで支払いを行うために手数料を発生させたほうがよいでしょう。支払いが完了すると、受信者側には流動性のあるオープンチャネルが残り、将来的にあなたのLightningノードに支払いを戻すために使用することができます。1回のオンチェーン取引で、将来使用するための支払いとチャネルを手に入れることができます。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>ライトニングインボイスは有効期限を含んでいる。受取人は、請求書を発行するたびに前画像<em>rを</em>保管する必要があるため、これらの前画像を永久に保管する必要がないように、請求書に有効期限を設けると便利です。請求書の有効期限が切れるか、支払いが完了すれば、受取人はそのプリ画像を破棄することができる。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_delivering_the_payment">お支払いのお届け</h3>
<div class="paragraph">
<p>これまで、受取人が支払いハッシュを含む請求書を作成する方法について見てきた。この支払いハッシュは、送り手から受け手へ、一連の支払いチャネルを越えて支払いを移動させるために使用される。たとえ、両者の間に直接的な支払いチャネルがなくても、である。</p>
</div>
<div class="paragraph">
<p>次のセクションでは、ライトニングネットワーク上で支払いを実現するために、これまで紹介したすべてのコンセプトを使用したアイデアと方法を掘り下げていきます。</p>
</div>
<div class="paragraph">
<p>まず、ライトニング・ネットワークの通信プロトコルを見てみよう。</p>
</div>
<div class="sect3">
<h4 id="_the_peer_to_peer_gossip_protocol">ピアツーピア・ゴシップ・プロトコル</h4>
<div class="paragraph">
<p>前述したように、決済チャネルが構築されると、チャネルパートナーは、その存在と詳細をライトニングネットワーク全体に公表するオプションを持ちます。</p>
</div>
<div class="paragraph">
<p>チャンネル告知はピアツーピアの<em>ゴシッププロトコルで</em>通信される。ピアツーピアプロトコルとは、各ノードがネットワーク内のランダムに選ばれた他のノードに接続する通信プロトコルで、通常はTCP/IPで接続されます。あなたのノードに（TCP/IPで）直接接続されている各ノードは、あなたの<em>ピアと</em>呼ばれます。あなたのノードは、順番に、彼らのピアの1つです。あなたのノードが他のピアと接続されているというのは、支払いチャネルがあるという意味ではなく、ゴシッププロトコルによって接続されているという意味であることに留意してください。</p>
</div>
<div class="paragraph">
<p>チャネルを開設した後、ノードはそのピアに<code>channel_announcement</code>メッセージを通じてチャネルのアナウンスを送信することを選択することができます。
すべてのピアが<code>channel_announcement</code>メッセージの情報を検証し、ビットコインブロックチェーン上で資金取引が確認されることを検証します。
検証後、ノードは自分のピアにゴシップメッセージを転送し、そのピアは自分のピアに転送するというように、ネットワーク全体にアナウンスが広がります。
過剰な通信を避けるため、チャネルアナウンスは、各ノードが以前にそのアナウンスを転送していない場合にのみ転送されます。</p>
</div>
<div class="paragraph">
<p>ゴシッププロトコルはまた、<code>node_announcement</code>メッセージで既知のノードに関する情報を発表するために使用されます。
このメッセージが転送されるためには、ノードはゴシッププロトコルで少なくとも1つのパブリックチャネルを発表している必要があり、これもまた過剰な通信トラフィックを避けるためです。</p>
</div>
<div class="paragraph">
<p>決済チャネルは、ネットワークの他の参加者にとって有用な様々なメタデータを持っています。
このメタデータは主にルーティングの決定を行うために使用されます。
ノードは自分のチャネルのメタデータを変更することがあるため、この情報は<code>channel_update</code>メッセージで共有されます。
これらのメッセージは、過剰な通信を防ぐため、1日に約4回（1チャネルあたり）しか転送されません。
ゴシップ・プロトコルはまた、最初にノードをネットワークのビューと同期させたり、しばらくオフラインだった後にノードのビューを更新するための様々なクエリーやメッセージを持っています。</p>
</div>
<div class="paragraph">
<p>ライトニング・ネットワークの参加者にとっての大きな課題は、ゴシップ・プロトコルで共有されるトポロジー情報が部分的でしかないことです。
例えば、支払いチャネルの容量は、<span class="keep-together"><code>channel_announcement</code></span>メッセージを介してゴシッププロトコル上で共有されています。
しかし、この情報は、2つのチャネル・パートナー間のローカル・バランスという点で、容量の実際の配分ほど有用ではありません。
ノードは、そのチャネル内で実際に所有しているビットコイン（ローカルバランス）と同量だけ転送することができます。</p>
</div>
<div class="paragraph">
<p>ライトニングネットワークは、チャンネルのバランス情報や正確なトポロジーを共有できるように設計することも可能でしたが、いくつかの理由で実現されていません。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ユーザーのプライバシーを保護するために、すべての金融取引や支払いを大声で叫ぶことはありません。チャネル残高の更新により、ある支払いがチャネルを越えて移動したことが明らかになる。この情報は、すべての支払元と支払先を明らかにするために相関させることができる。</p>
</li>
<li>
<p>ライトニング・ネットワークで実施できる決済の量をスケールアップすること。そもそもライトニング・ネットワークは、すべての参加者にすべての支払いについて通知すると、うまくスケールしないために作られたことを思い出してください。したがって、ライトニング・ネットワークは、参加者間でチャネル・バランスの更新を共有するような設計にはできません。</p>
</li>
<li>
<p>ライトニング・ネットワークは動的なシステムです。絶えず、頻繁に変化します。ノードが追加され、他のノードが消され、残高が変化する、などです。たとえすべてが常に伝達されたとしても、その情報が有効なのは短時間だけです。実のところ、情報は受信した時点で古くなっていることが多いのです。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ゴシッププロトコルの詳細については、後の章で検討します。</p>
</div>
<div class="paragraph">
<p>今のところ、ゴシッププロトコルが存在し、ライトニングネットワークのトポロジー情報を共有するために使用されていることだけが重要である。
このトポロジー情報は、決済チャンネルのネットワークを通じて決済を行うために重要です。</p>
</div>
</div>
<div class="sect3">
<h4 id="_pathfinding_and_routing">パスファインディングとルーティング</h4>
<div class="paragraph">
<p>ライトニング・ネットワークにおける支払いは、支払い元から支払い先まで、参加者同士をつなぐチャネルで構成される<em>経路に沿って</em>転送されます。支払元から支払先までの経路を見つけるプロセスを<em>経路探索と</em>呼びます。そのパスを使用して支払いを行うプロセスを<em>ルーティングと</em>呼びます。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">備考</div>
</td>
<td class="content">
<div class="paragraph">
<p>ライトニング・ネットワークに対する批判として、ルーティングが解決されていない、あるいは「解決不可能」な問題であるという意見がよく聞かれる。実際、ルーティングは些細なことです。一方、経路探索は難しい問題です。この2つの用語は混同されがちで、どちらの問題を解決しようとしているのかを明確に定義する必要がある。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>次に見るように、ライトニングネットワークは現在、経路探索に<em>ソースベースプロトコルを</em>、支払いのルーティングに<em>オニオンルートプロトコルを</em>使用しています。ソースベースとは、支払いの送信者がネットワークを経由して目的の宛先までの経路を見つける必要があることを意味する。オニオンルーティングとは、経路の要素が（タマネギのように）何層にもなっており、各層が暗号化されているため、一度に1つのノードしか見ることができないことを意味する。オニオンルーティングについては、次のセクションで説明する。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_source_based_pathfinding">ソースベースのパスファインディング</h3>
<div class="paragraph">
<p>すべてのチャンネルの正確なチャンネル残高がわかれば、コンピュータサイエンスの授業で習う標準的な経路探索アルゴリズムを使って、簡単に支払い経路を計算することができます。これは、支払いを転送するためにノードに支払われる手数料を最適化する方法で解決することも可能です。</p>
</div>
<div class="paragraph">
<p>しかし、すべてのチャンネルのバランス情報は、ネットワークのすべての参加者が知っているわけではありませんし、知ることもできません。より革新的な経路探索戦略が必要である。</p>
</div>
<div class="paragraph">
<p>ネットワークトポロジーの情報が部分的にしかないため、経路探索は本当に難しく、Lightning Networkのこの部分については、現在も活発に研究が行われているところである。ライトニング・ネットワークでは、経路探索の問題が「完全には解決されていない」ことが、この技術に対する大きな批判となっている。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">備考</div>
</td>
<td class="content">
<div class="paragraph">
<p>ライトニングネットワークにおける経路探索は、計算複雑性理論の基本問題であるNP完全な<em>巡回セールスマン問題</em>（TSP）と等価であるため、解けないという批判がよく聞かれます。実際には、ライトニングの経路探索はTSPと等価ではなく、別の問題群に該当します。私たちは、Googleに渋滞回避を伴う道案内を依頼するたびに、この種の問題（不完備情報付きグラフにおける経路探索）をうまく解決しています。また、ライトニングネットワークで支払いを行う際にも、この問題の解決に成功しています。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>経路探索とルーティングは様々な方法で実装でき、インターネットに複数の経路探索とルーティングのアルゴリズムが存在するように、ライトニングネットワークにも複数の経路探索とルーティングのアルゴリズムが共存することが可能です。ソースベースの経路探索は、多くの可能なソリューションの1つであり、現在のライトニング・ネットワークの規模では成功しています。</p>
</div>
<div class="paragraph">
<p>現在ライトニングノードが実装している経路探索戦略は、支払いを転送するのに十分な流動性を持つ経路が見つかるまで、繰り返し試行するものです。これは、試行錯誤の繰り返しで、成功するか、経路が見つからなくなるまで行われます。このアルゴリズムは、現在、必ずしも手数料が最も低い経路になるとは限りません。これは最適ではなく、確かに改善できるのだが、この単純化された戦略でさえ、かなりうまく機能している。</p>
</div>
<div class="paragraph">
<p>この「プロービング」は、ライトニングノードまたはウォレットによって行われ、ユーザーには直接見えません。
ユーザーは、支払いが即座に完了しない場合にのみ、プロービングが行われていることに気づくかもしれません。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">備考</div>
</td>
<td class="content">
<div class="paragraph">
<p>インターネットでは、インターネット・プロトコルとIP転送アルゴリズムを使って、インターネット・パッケージを送信者から宛先に転送しています。これらのプロトコルは、インターネットを介した情報の流れの経路をインターネットホストが協調して見つけることができるという素晴らしい特性を持っていますが、ライトニングネットワークでの支払いの転送にこのプロトコルを再利用して採用することはできません。インターネットとは異なり、ライトニングの支払いは<em>アトミック</em>でなければならず、チャネル残高も<em>非公開の</em>ままでなければならない。さらに、接続容量が比較的固定されているインターネットとは異なり、ライトニングのチャンネル容量は頻繁に変化します。このような制約があるため、新しい<span class="keep-together">戦略が</span>必要です。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>もちろん、直接のチャネル・パートナーに支払いを行い、そのために十分な残高がこちら側にある場合は、経路探索は些細なことです。他のすべてのケースでは、ノードはゴシッププロトコルからの情報を使って経路探索を行います。これには、現在知られている公開支払チャネル、知られているノード、知られているトポロジー（知られているノードの接続方法）、知られているチャネル容量、およびノードの所有者によって設定された知られている料金ポリシーが含まれます。</p>
</div>
<div class="sect3">
<h4 id="_onion_routing">オニオンルーティング</h4>
<div class="paragraph">
<p>ライトニングネットワークは、有名なTor（The Onion Router）ネットワークと同様の<em>オニオンルーティングプロトコルを</em>使用しています。
Lightningで使用されているオニオン・ルーティング・プロトコルは、<em>SPHINX Mix Format</em><sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup>と呼ばれ、後の章で詳しく説明されます。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">備考</div>
</td>
<td class="content">
<div class="paragraph">
<p>LightningのオニオンルーティングSPHINX Mix Formatは、Torネットワークのルーティングとコンセプトが似ているだけで、プロトコルも実装もTorネットワークで使われているものとは全く別物です。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>ルーティングに使用される決済パッケージは「オニオン」と呼ばれる<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup>。</p>
</div>
<div class="paragraph">
<p>タマネギに例えて、経路型決済を追ってみよう。支払者(payer)から支払先(payee)への経路で、タマネギは経路上のノードからノードに渡される。送信者は、タマネギの中心から外に向かって全体を構築する。まず、送信者は支払いの（最終）受取人のための支払い情報を作成し、受取人だけが解読できる暗号化レイヤーでそれを暗号化する。次に、送信者はそのレイヤーを最終受取<em>人の直前の</em>パスのノードに対する指示で包み、そのノードだけが復号化できるレイヤーで暗号化する。</p>
</div>
<div class="paragraph">
<p>層は命令で構築され、パス全体が層で符号化されるまで逆算される。送信者はタマネギをパスの最初のノードに渡すが、ノードは一番外側の層しか読むことができない。各ノードは1層ずつ剥がしていき、次のノードに渡す指示を見つけ、タマネギを渡す。各ノードは1層ずつ剥いていくので、タマネギの残りの部分は読めません。知っているのは、タマネギがどこから来たのか、そして次にどこへ行くのかということだけで、誰が送り主で誰が受け手なのかはわからない。</p>
</div>
<div class="paragraph">
<p>これは、オニオンが支払先（ペイジー）に到着するまで続けられる。その後、宛先のノードはオニオンを開き、これ以上解読する層がないことに気づき、中の支払い情報を読むことができるようになります。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">備考</div>
</td>
<td class="content">
<div class="paragraph">
<p>本物のタマネギとは異なり、各層を剥がす際に、ノードは暗号化されたパディングを追加して、次のノードに対してタマネギの大きさを同じに保つ。これからわかるように、これによって中間ノードはパスのサイズ（長さ）、ルーティングに関与するノード数、先行するノード数、後続するノード数について何も知ることができなくなる。これにより、些細なトラフィック解析攻撃を防ぐことができ、プライバシーが向上する。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Lightningで使用されているオニオン・ルーティング・プロトコルは、以下のような性質を持っています。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>仲介ノードは、どのチャネルでオニオンを受信し、どのチャネルでオニオンを転送するかだけを知ることができる。つまり、どのルーティングノードも、誰が支払いを開始したのか、そして支払いの宛先が誰なのかを知ることはできない。これは最も重要な特性であり、高度なプライバシーをもたらす。</p>
</li>
<li>
<p>タマネギは、1つのTCP/IPパケット、さらにはリンク層（イーサネットなど）のフレームに収まるほどの大きさである。このため、支払いのトラフィック解析が著しく困難となり、プライバシーがさらに高まります。</p>
</li>
<li>
<p>タマネギは、経路上の処理ノードの位置とは無関係に、常に同じ長さになるように構成されている。各層を「剥く」際に、タマネギのサイズを同じにするために、暗号化された「ジャンク」データで水増しされる。これにより、中間ノードがパス上の自分の位置を知ることができなくなる。</p>
</li>
<li>
<p>タマネギは、各層にHMAC（ハッシュベースのメッセージ認証コード）を持つため、タマネギの操作を防ぐことができ、事実上不可能である。</p>
</li>
<li>
<p>タマネギは最大で約26個のホップを持つことができ、お好みでタマネギの層を作ることもできます。これによって、十分に長いパスを実現できる。利用できる正確なパスの長さは、各ホップでルーティングペイロードに割り当てられるバイトの量に依存する。</p>
</li>
<li>
<p>ホップごとのオニオンの暗号化には、異なるエフェメラル暗号鍵が使用される。ある時点で鍵（特にノードの秘密鍵）が漏洩した場合、攻撃者はそれらを解読することができない。簡単に言えば、鍵は再利用されないので、より高い安全性を実現できる。</p>
</li>
<li>
<p>エラーは、同じオニオンルーチングプロトコルを使って、エラーを起こしたノードから元の送信者に送り返すことができる。エラーオニオンは、外部のオブザーバーや仲介ノードにとっては、ルーティングオニオンと区別がつかない。エラールーティングは、支払いを正常にルーティングするのに十分な容量を持つパスを見つけるために使用される試行錯誤の「プロービング」方法を可能にします。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>オニオンルーティングについては、<a href="#onion_routing">[onion_routing]</a>で詳しく検討する予定である。</p>
</div>
</div>
<div class="sect3">
<h4 id="_payment_forwarding_algorithm">支払い転送アルゴリズム</h4>
<div class="paragraph">
<p>支払いの送信者がネットワークを横切る可能性のある経路を見つけ、オニオンを構築すると、その経路の各ノードによって支払いが転送される。各ノードはオニオンの1つのレイヤーを処理し、パスの次のノードにそれを転送する。</p>
</div>
<div class="paragraph">
<p>各中間ノードは、支払いハッシュとオニオンを含む<code>update_add_htlc</code>というライトニングメッセージを受信する。仲介ノードは、<em>支払い転送アルゴリズムと</em>呼ばれる一連のステップを実行する。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>ノードはオニオンの外層を解読し、メッセージの完全性をチェックする。</p>
</li>
<li>
<p>チャネル料金と送信チャネルの利用可能な容量に基づいて、ルーティングのヒントを満たすことができることを確認する。</p>
</li>
<li>
<p>受信したチャネルでチャネルパートナーと連携し、チャネルの状態を更新します。</p>
</li>
<li>
<p>これは、先頭のデータを削除したため、一定の長さを保つために、オニオンの末尾にパディングを追加しています。</p>
</li>
<li>
<p>それはルーティングのヒントに従って、同じ支払いハッシュとionを含む<code>update_add_htlc</code>メッセージを送信することによって、その発信する支払いチャネルに修正されたionパッケージを転送する。</p>
</li>
<li>
<p>発信するチャネルでチャネルパートナーと連携し、チャネルの状態を更新します。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>もちろん、エラーが検出されると、これらのステップは中断され、中止され、エラーメッセージが<code>update_add_htlc</code>メッセージの発信者に送り返される。エラーメッセージはまた、オニオンとしてフォーマットされ、受信チャネルで後方に送信されます。</p>
</div>
<div class="paragraph">
<p>エラーが経路上の各チャネルに逆伝播されると、チャネルパートナーは保留中の支払いを削除し、支払い開始時と逆の方法で支払いをロールバックします。</p>
</div>
<div class="paragraph">
<p>決済が迅速に行われないと支払いに失敗する可能性が高いが、オニオンがエラーで戻る前に、ノードは別の経路で別の支払いの試行を開始してはならない。もし両方の支払いの試みが最終的に成功した場合、送信者は2回支払うことになる。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_peer_to_peer_communication_encryption">ピアツーピア通信の暗号化</h3>
<div class="paragraph">
<p>LNプロトコルは、主に参加者間のピアツーピアのプロトコルである。前のセクションで見たように、ネットワークには2つの重複する機能があり、2つの論理的なネットワークを形成し、それらを合わせて<em>ライトニング・ネットワークと</em>呼んでいます。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>ゴシッププロトコルを使用してトポロジー情報を伝搬する広範なピアツーピアネットワークで、ピア同士がランダムに接続されます。ピア同士は必ずしも決済チャネルを持っていないため、チャネルパートナーとは限りません。</p>
</li>
<li>
<p>チャネルパートナー間の支払いチャネルのネットワーク。チャネルパートナーはトポロジーのゴシップも行い、ゴシッププロトコルのピアノードとなる。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>ピア間の通信は、すべて<em>ライトニングメッセージと</em>呼ばれるメッセージで送信されます。これらのメッセージは、「No<em>ise Protocol Framework</em>」と呼ばれる暗号通信フレームワークを用いて、すべて暗号化されています。Noise Protocol Frameworkは、認証、暗号化、前方秘匿、IDプライバシーを提供する暗号通信プロトコルを構築することができる。Noise Protocol Frameworkは、WhatsApp、WireGuard、I2Pなど、人気の高いエンドツーエンドの暗号通信システムにも利用されています。詳細については、No<a href="https://noiseprotocol.org">ise Protocol Frameworkのウェブサイトを</a>ご覧ください。</p>
</div>
<div class="paragraph">
<p>Noise Protocol FrameworkをLightning Networkで使用することにより、ネットワーク上の全てのメッセージは認証され、暗号化されるため、ネットワークのプライバシーとトラフィック解析、ディープパケットインスペクション、盗聴への耐性が高まります。しかし、パケットキャプチャやWiresharkのようなネットワーク分析ツールで単純にネットワークを観察することができないため、副作用としてプロトコルの開発やテストが少し厄介になる。その代わり、開発者はWiresharkのプラグインである<a href="https://github.com/nayutaco/lightning-dissector"><em>Lightning Disctorの</em></a>ような、あるノードの視点からプロトコルを解読する専用のプラグインを使用しなければならないのです。</p>
</div>
</div>
<div class="sect2">
<h3 id="_thoughts_about_trust">信頼についての考え</h3>
<div class="paragraph">
<p>プロトコルに則り、ノードの安全性を確保していれば、ライトニングネットワークに参加しても資金を失う大きなリスクはない。
ただし、チャネルを開設する際にオンチェーン手数料を支払うというコストは発生します。
どんなコストにも、それに見合ったメリットがあるはずです。
この場合、アリスがチャンネル開設のコストを負担することの報酬は、アリスがコインの一部をチャンネルの反対側に移動した後、ライトニング・ネットワーク上でいつでもビットコインの支払いを送ったり受け取ったりできることと、他の人のために支払いを転送してビットコインの手数料を得ることができることである。
アリスは、理論的にはボブがチャネルを開いた直後に閉じることができ、その結果、アリスにオンチェーン閉鎖手数料が発生することを知っている。
アリスはボブに対してわずかな信頼が必要である。
アリスはボブのカフェに行ったことがあり、明らかにボブは彼女のコーヒーを売ることに興味があるので、アリスはこの意味でボブを信頼することができる。
アリスとボブの双方に利益があります。
アリスは、ボブへのチャネルを作るためのオンチェーン手数料のコストを引き受けるだけの報酬があると判断する。
これに対して、アリスは、新しいチャネルを開くようにという電子メールを送ってきただけの未知の人物にチャネルを開くことはないだろう。</p>
</div>
</div>
<div class="sect2">
<h3 id="_comparison_with_bitcoin">ビットコインとの比較</h3>
<div class="paragraph">
<p>ライトニング・ネットワークはビットコインの上に構築され、その特徴や性質を多く受け継いでいますが、両ネットワークのユーザーが注意しなければならない重要な違いがあります。</p>
</div>
<div class="paragraph">
<p>これらの違いの中には、用語の違いもあります。また、アーキテクチャーの違いやユーザーエクスペリエンスの違いもあります。これから数回に分けて、違いと共通点を調べ、用語の説明をし、期待値を調整します。</p>
</div>
<div class="sect3">
<h4 id="_addresses_versus_invoices_transactions_versus_payments">アドレスと請求書、取引と支払い</h4>
<div class="paragraph">
<p>ビットコインを使った典型的な支払いでは、ユーザーはビットコインアドレスを受け取ります（例えば、ウェブページのQRコードをスキャンしたり、インスタントメッセージや友人からのメールで受け取ったりします）。その後、ユーザーはビットコイン財布を使用して、このアドレスに資金を送るためのトランザクションを作成します。</p>
</div>
<div class="paragraph">
<p>ライトニングネットワークでは、支払いの受取人がインボイスを作成します。ライトニングインボイスは、ビットコインのアドレスに類似していると見なすことができます。受取人は、ビットコインのアドレスのように、QRコードや文字列としてライトニングインボイスを送信者に渡します。</p>
</div>
<div class="paragraph">
<p>送り主は、Lightningウォレットを使って、請求書のテキストをコピーするか、請求書のQRコードをスキャンして支払います。Lightningによる支払いは、ビットコインの「取引」に類似しています。</p>
</div>
<div class="paragraph">
<p>しかし、ユーザーエクスペリエンスにはいくつかの違いがあります。ビットコインアドレスは<em>再利用可能</em>です。ビットコインアドレスは有効期限がなく、アドレスの所有者がまだキーを保持していれば、中に保持されている資金にいつでもアクセスできます。送信者は、以前に使用したアドレスに任意の量のビットコインを送信することができ、受信者は、単一の固定アドレスを投稿して多くの支払いを受けることができます。これはプライバシー上の理由からベストプラクティスに反するが、技術的には可能であり、実際かなり一般的である。</p>
</div>
<div class="paragraph">
<p>しかし、Lightningでは、各請求書は特定の支払額に対して一度しか使用できません。支払額を増やしたり減らしたりすることはできず、請求書を再び使用することはできませんし、請求書には有効期限が組み込まれています。Lightningでは、受取人は支払いのたびに、あらかじめ支払額を指定して新しい請求書を作成する必要があります。これには例外があり、[<em>keysend</em> <a href="#keysend">]</a>と呼ばれる仕組みで検証していきます。</p>
</div>
</div>
<div class="sect3">
<h4 id="_selecting_outputs_versus_finding_a_path">出力選択と経路探索の比較</h4>
<div class="paragraph">
<p>ビットコインネットワーク上で支払いを行うには、送信者は1つまたは複数の未使用のトランザクション出力（UTXO）を消費する必要があります。
ユーザーが複数のUTXOを持っている場合、彼ら（というより彼らのウォレット）はどのUTXOを送るかを選択する必要があります。
例えば、1BTCの支払いを行うユーザーは、1BTCの値を持つ1つの出力、0.25BTCと0.75BTCの値を持つ2つの出力、またはそれぞれ0.25BTCの値を持つ4つの出力を使用することができます。</p>
</div>
<div class="paragraph">
<p>ライトニングでは、支払いにインプットの消費は必要ありません。その代わり、各支払いによってチャネル残高が更新され、2つのチャネルパートナー間で再分配されます。送信者は、チャネル残高をチャネルの端からもう一方の端、つまりチャネルパートナーに「移動」させるということを経験します。ライトニング・ペイメントは、送信者から受信者へのルーティングに一連のチャネルを使用します。これらの各チャネルは、決済をルーティングするのに十分な容量を持っている必要があります。</p>
</div>
<div class="paragraph">
<p>決済には多くのチャンネルや経路が考えられるため、ライトニングのユーザーがチャンネルや経路を選択することは、ビットコインのユーザーがUTXOを選択することに似ている。</p>
</div>
<div class="paragraph">
<p>アトミックマルチパスペイメント（AMP）やマルチパートペイメント（MPP）といった、以降の章でレビューする技術を使えば、複数のビットコインUTXOを1つのアトミックなビットコイン取引に集約できるように、複数のライトニングパスを1つのアトミックな支払いに集約することが可能です。</p>
</div>
</div>
<div class="sect3">
<h4 id="_change_outputs_on_bitcoin_versus_no_change_on_lightning">Bitcoinでの変更出力とLightningでの変更なしとの比較</h4>
<div class="paragraph">
<p>ビットコインネットワーク上で支払いを行うには、送信者は1つ以上の未使用のトランザクション出力（UTXO）を消費する必要があります。UTXOは全額を使用することができ、分割して部分的に使用することはできません。つまり、あるユーザーが0.8BTCを使いたいが、1BTCのUTXOしか持っていない場合、0.8BTCを受取人に送り、0.2BTCをお釣りとして自分に戻すことで、1BTCのUTXO全体を使用する必要があります。0.2BTCのお釣り支払いは、"チェンジアウトプット "と呼ばれる新しいUTXOを作成します。</p>
</div>
<div class="paragraph">
<p>ライトニングでは、資金調達のトランザクションが一部のビットコインUTXOを消費し、マルチシグネチャUTXOを作成してチャネルを開く。ビットコインがそのチャネル内に固定されると、その一部をチャネル内で送受信することができ、変更を作成する必要がない。
これは、チャネルパートナーが単にチャネル残高を更新し、チャネル閉鎖トランザクションを使用してチャネルが最終的に閉鎖されるときにのみ、新しいUTXOを作成するためです。</p>
</div>
</div>
<div class="sect3">
<h4 id="_mining_fees_versus_routing_fees">マイニングフィーとルーティングフィーの比較</h4>
<div class="paragraph">
<p>ビットコインのネットワークでは、ユーザーは、自分の取引がブロックに含まれるように採掘者に手数料を支払います。
これらの手数料は、その特定のブロックを採掘するマイナーに支払われます。
手数料の金額は、ブロック内でトランザクションが使用している<em>バイト</em>単位の<em>サイズと</em>、ユーザーがそのトランザクションの採掘をどれだけ早く望んでいるかに基づいています。
採掘業者は通常、最も収益性の高い取引を最初に採掘するので、自分の取引をすぐに採掘してほしいユーザーは1バイトあたり<em>高い</em>手数料を支払うことになり、急いでいないユーザーは1バイトあたり<em>低い</em>手数料を支払うことになる。</p>
</div>
<div class="paragraph">
<p>ライトニング・ネットワークでは、ユーザーは他の（仲介ノード）ユーザーに手数料を支払って、自分のチャンネルで支払いをルーティングします。
支払いをルーティングするには、仲介ノードが所有する2つ以上のチャネルで資金を移動させるとともに、送信者の支払いのためのデータを送信する必要があります。通常、ルーティングユーザーは、最低<em>基本料金</em>（各支払いに対する定額料金）と<em>手数料率</em>（支払額に比例した比例料金）を設定し、支払<em>額に基づいて</em>送信者に料金を請求します。したがって、価値の高い支払いはルーティングにかかるコストが高くなり、流動性のための市場が形成され、異なるユーザーは自分のチャネルをルーティングするために異なる手数料を請求します。</p>
</div>
</div>
<div class="sect3">
<h4 id="_varying_fees_depending_on_traffic_versus_announced_fees">トラフィックに応じて料金が変動すること vs 発表された料金であること</h4>
<div class="paragraph">
<p>ビットコインのネットワークでは、採掘者は利益を追求し、通常、<em>ブロックウェイトと</em>呼ばれるブロック容量の範囲内で、できるだけ多くの取引を1ブロックに含めます。</p>
</div>
<div class="paragraph">
<p>ブロックに入りきらないほどのトランザクションが待ち行列（<em>メンプールと</em>呼ばれる）にある場合、<em>トランザクションの重</em>さの単位（バイト）あたりで最も高い手数料を支払うトランザクションから採掘を始めることになる。
したがって、待ち行列に多くのトランザクションがある場合、ユーザーは次のブロックに含まれるために高い手数料を支払うか、待ち行列にあるトランザクションが少なくなるまで待たなければならないのである。
このため、ユーザーは自分の取引が次のブロックに含まれることをどれだけ緊急に必要としているかに基づいて料金を支払うという、料金市場の出現が自然発生することになる。</p>
</div>
<div class="paragraph">
<p>ビットコインネットワーク上の希少資源は、ブロック内のスペースです。ビットコインユーザーはブロックスペースを奪い合い、ビットコインの手数料市場は利用可能なブロックスペースに基づいている。ライトニングネットワークの希少資源は、<em>チャネルの流動性</em>（チャネルでルーティングできる資金の容量）と<em>チャネルの接続</em>性（チャネルがどれだけ多くの接続されたノードに到達できるか）である。ライトニングのユーザーは<span class="keep-together">容量とコネクティビティを</span>競うため、ライトニングの手数料市場は容量と<span class="keep-together">コネクティビティに</span>左右されます。</p>
</div>
<div class="paragraph">
<p>ライトニング・ネットワークでは、ユーザーは支払いをルーティングするユーザーに対して手数料を支払っています。支払いをルーティングするということは、経済学的に言えば、送り手に容量を提供し、割り当てることに他なりません。当然、同じキャパシティに対してより低い手数料を課すルーターは、ルーティング先としてより魅力的となる。したがって、ルーターが支払いをルーティングするために請求する手数料をめぐって互いに競争する手数料市場が存在します。</p>
</div>
</div>
<div class="sect3">
<h4 id="_public_bitcoin_transactions_versus_private_lightning_payments">パブリックなビットコイン取引とプライベートなライトニングペイメントの比較</h4>
<div class="paragraph">
<p>ビットコインネットワークでは、すべてのトランザクションがビットコインブロックチェーン上で公開されています。関係するアドレスは仮名であり、通常はアイデンティティに結びつかないが、それでもネットワーク上の他のすべてのユーザーによって見られ、検証される。
さらに、ブロックチェーン監視企業はこのデータを一括して収集・分析し、民間企業、政府、諜報機関などの利害関係者に販売しています。</p>
</div>
<div class="paragraph">
<p>一方、LN決済は、ほぼ完全に非公開である。通常、送信者と受信者のみが、特定の支払いにおける送信元、送信先、および取引額を完全に把握することができる。さらに、受信者は支払元を知らないこともある。決済はオニオンルーティングされるため、決済をルーティングするユーザーは決済額しか知らず、送金元も送金先も特定できない。</p>
</div>
<div class="paragraph">
<p>要約すると、ビットコインの取引は公にブロードキャストされ、永久に保存されます。ライトニングの支払いは、選ばれた少数のピア間で実行され、その情報はチャネルが閉じられるまで非公開で保存されます。ビットコインで使われているものと同等の大規模な監視・分析ツールを作ることは、ライトニングではかなり難しいでしょう。</p>
</div>
</div>
<div class="sect3">
<h4 id="_waiting_for_confirmations_versus_instant_settlement">コンファメーション待ちと即時決済の比較</h4>
<div class="paragraph">
<p>ビットコインのネットワークでは、取引はブロックに含まれた時点で初めて決済され、その場合、そのブロックでは「確認」されたと言われます。より多くのブロックが採掘されればされるほど、取引はより多くの「確認」を獲得し、より安全であるとみなされる。</p>
</div>
<div class="paragraph">
<p>ライトニング・ネットワークでは、確認はオンチェーンでのチャンネルの開設と閉鎖にのみ関係します。資金取引で適切な確認回数（例えば3回）に達すると、チャネルパートナーはチャネルを開いたと見なす。チャネル内のビットコインは、そのチャネルを管理するスマートコントラクトによって保護されているため、最終的な受取人が受け取った時点で、支払いは<em>即座に</em>決済されます。
即時決済とは、決済の実行と決済に数秒しかかからないことを意味する。ビットコインと同様に、ライトニング決済は可逆的ではありません。</p>
</div>
<div class="paragraph">
<p>最後に、チャネルが閉じられると、ビットコインのネットワーク上で取引が行われ、その取引が確認されると、チャネルは閉じられたとみなされます。</p>
</div>
</div>
<div class="sect3">
<h4 id="_sending_arbitrary_amounts_versus_capacity_restrictions">任意の金額を送信する場合と容量制限の場合</h4>
<div class="paragraph">
<p>ビットコインのネットワーク上では、ユーザーが所有するビットコインを容量制限なく、他のユーザーに送ることができます。1回の取引で理論上、最大2100万ビットコインを支払いとして送ることができる。</p>
</div>
<div class="paragraph">
<p>ライトニングネットワークでは、ユーザーは特定のチャンネルの自分側に現在存在するビットコインの量だけ、チャンネルパートナーに送ることができます。例えば、あるユーザーが自分側に0.4BTCのチャンネルを所有し、自分側に0.2BTCのチャンネルを所有している場合、1回の支払いで送信できる最大値は0.4BTCとなります。これは、ユーザーが現在ビットコインウォレットに保有しているビットコインの量に関係なく、同じです。</p>
</div>
<div class="paragraph">
<p>マルチパートペイメント（MPP）とは、先の例で言えば、ユーザーが持っている0.4BTCと0.2BTCの両方のチャンネルを組み合わせて、1回の支払いで最大0.6BTCを送れる機能である。MPPは現在、ライトニング・ネットワーク全体でテストされており、本書が完成する頃には広く利用され、活用されることが期待されています。MPPの詳細については、<a href="#mpp">[mpp]</a>を参照してください。</p>
</div>
<div class="paragraph">
<p>支払いがルーティングされる場合、ルーティングパスに沿ったすべてのルーティ ングノードには、少なくともルーティングされる支払い額と同じ容量を持つチャ ンネルがなければならない。これは、支払いがルーティングされるすべてのチャネルに当てはまらなければならない。パスの中で最も容量の小さいチャネルの容量が、パス全体の容量の上限を設定する。</p>
</div>
<div class="paragraph">
<p>したがって、容量と接続性は、ライトニング・ネットワークにおける重要かつ希少なリソースです。</p>
</div>
</div>
<div class="sect3">
<h4 id="_incentives_for_large_value_payment_versus_small_value_payments">大口支払と小口支払のインセンティブ</h4>
<div class="paragraph">
<p>ビットコインにおける手数料体系は、取引額とは無関係である。
100万ドルの取引は、ビットコインの1ドルの取引と同じ手数料で、同じような取引サイズを想定して、バイト単位（SegWit [Segregated Witness protocol]以降はより具体的に「仮想」バイト単位）で設定されています。
ライトニングでは、手数料は固定ベース手数料に取引額に対するパーセンテージを加えたものとなっています。
したがって、Lightningでは、決済手数料は決済額に応じて増加します。
これらの相反する手数料構造は、取引額に関して異なるインセンティブを生み、異なる利用法をもたらします。
価値の大きい取引は、ビットコインの方が安くなります。したがって、ユーザーは価値の大きい取引にはビットコインを好むようになります。同様に、もう一方のスケールでは、ユーザーは少額の取引にはライトニングを好むでしょう。</p>
</div>
</div>
<div class="sect3">
<h4 id="_using_the_blockchain_as_a_ledger_versus_as_a_court_system">台帳としてのブロックチェーンと裁判システムとしてのブロックチェーンの使い分け</h4>
<div class="paragraph">
<p>ビットコインのネットワークでは、すべての取引は最終的にブロックチェーン上のブロックに記録されます。
ブロックチェーンは、このようにビットコインの誕生以来、すべての取引の完全な履歴を形成し、現存するすべてのビットコインを完全に監査する方法です。
ある取引がブロックチェーンに含まれると、それは最終的なものです。
したがって、いかなる紛争も発生することはなく、ブロックチェーンの特定の時点で特定のアドレスによってどれだけのビットコインが管理されているかが明確になるのです。</p>
</div>
<div class="paragraph">
<p>ライトニングネットワークでは、ある時点のチャネルの残高は、2つのチャネルパートナーにのみ知られ、チャネルが閉じられたときにのみ、ネットワークの残りの部分に表示されます。
チャネルが閉じられると、チャネルの最終的な残高がビットコインのブロックチェーンに提出され、各パートナーはそのチャネルのビットコインの取り分を受け取ります。
例えば、オープニングバランスがアリスによって支払われた1BTCで、アリスがボブに対して0.3BTCの支払いを行った場合、チャンネルの最終バランスはアリスが0.7BTC、ボブが0.3BTCとなります。
アリスが1BTC、ボブが0BTCというチャンネルの開始状態をビットコインのブロックチェーンに提出してごまかそうとした場合、ボブはチャンネルの真の最終状態を提出し、さらにチャンネル内のすべてのビットコインを渡すペナルティ取引を作成して報復することが可能です。
ライトニング・ネットワークでは、ビットコインのブロックチェーンが裁判システムのように機能します。
ロボット裁判官のように、ビットコインは各チャンネルの初期残高と最終残高を記録し、当事者の一方が不正を行おうとした場合にはペナルティを承認します。</p>
</div>
</div>
<div class="sect3">
<h4 id="_offline_versus_online_asynchronous_versus_synchronous">オフラインとオンライン、非同期と同期</h4>
<div class="paragraph">
<p>ビットコインユーザーが宛先アドレスに資金を送るとき、彼らは受取人について何も知る必要がありません。受信者はオフラインかもしれないし、オンラインかもしれないし、送信者と受信者の間の相互作用は必要ない。相互作用は、送信者とビットコインブロックチェーンとの間で行われます。ビットコインブロックチェーン上でビットコインを受け取ることは、<em>受動的</em>で<em>非同期な</em>活動であり、受取人による相互作用や受取人がいつでもオンラインであることは必要ありません。ビットコインアドレスはオフラインで生成することも可能で、ビットコインネットワークに「登録」されることはありません。ビットコインを使うときだけ、相互作用が必要です。</p>
</div>
<div class="paragraph">
<p>Lightningでは、受信者は有効期限が切れる前に支払いを完了するためにオンラインである必要があります。
受取人は、ノードを実行するか、自分に代わってノードを実行する人（サードパーティカストディアン）を持つ必要があります。正確には、送り手のノードと受け手のノードの両方が支払い時にオンラインである必要があり、連携する必要があります。ライトニング決済の受け取りは、ライトニングネットワークやビットコインネットワークの大部分（中間ルーティングノードがある場合は除く）が参加しない、送り手と受け手の間の<em>アクティブで</em> <em>同期的な</em>活動である。</p>
</div>
<div class="paragraph">
<p>ライトニングネットワークの同期性と常時オンライン性は、ユーザーエクスペリエンスにおける最大の違いであり、ビットコインに慣れたユーザーは戸惑うことが多いのではないでしょうか。</p>
</div>
</div>
<div class="sect3">
<h4 id="_satoshis_versus_millisatoshis">サトシとミリサトシの比較</h4>
<div class="paragraph">
<p>ビットコインのネットワークでは、最小の金額は1<em>サトシで</em>、それ以上分割することはできません。ライトニングはもう少し柔軟で、ライトニングノードは<em>ミリサトシ</em>（1サトシの1000分の1）で動作します。このため、Lightningを経由した極小の決済が可能になる。1ミリサトシの支払いは、支払いチャネルを越えて送ることができ、その金額は非常に小さく、<em>ナノペイメントと</em>呼ぶにふさわしい。</p>
</div>
<div class="paragraph">
<p>ミリサトシ単位は、もちろんビットコインのブロックチェーン上でその粒度で決済することはできない。チャネルが閉鎖されると、残高は最も近いサトシに丸められます。しかし、チャネルの寿命が尽きるまで、ミリサトシ単位で数百万回のナノペイメントが可能だ。ライトニング・ネットワークは、マイクロペイメントの壁を打ち破ります。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_commonality_of_bitcoin_and_lightning">ビットコインとライトニングの共通点</h3>
<div class="paragraph">
<p>ライトニングネットワークは、アーキテクチャやユーザーエクスペリエンスなど多くの点でビットコインと異なりますが、ビットコインをベースに構築されており、ビットコインのコア機能の多くを引き継いでいます。</p>
</div>
<div class="sect3">
<h4 id="_monetary_unit">通貨単位</h4>
<div class="paragraph">
<p>ビットコインネットワークとライトニングネットワークは、どちらも同じ通貨単位であるビットコインを使用しています。ライトニング決済は、ビットコイン取引と全く同じビットコインを使用します。暗黙の了解として、通貨単位が同じなので、通貨の上限も同じで、2100万ビットコイン以下となる。ビットコインの総ビットコイン数2,100万枚のうち、一部はライトニングネットワーク上の決済チャンネルの一部として、2-of-2マルチシグネチャアドレスにすでに割り当てられています。</p>
</div>
</div>
<div class="sect3">
<h4 id="_irreversibility_and_finality_of_payments">支払の不可逆性と最終性</h4>
<div class="paragraph">
<p>ビットコインの取引もライトニングの支払いも不可逆的で不変的です。どちらのシステムにも「取り消し」操作や「チャージバック」は存在しない。どちらの送信者としても、責任を持って行動しなければなりませんが、同時に受信者としても取引の最終性が保証されます。</p>
</div>
</div>
<div class="sect3">
<h4 id="_trust_and_counterparty_risk">信託とカウンターパーティーリスク</h4>
<div class="paragraph">
<p>ビットコインと同様に、ライトニングは、数学と暗号化、そしてソフトウェアに重大なバグがないことだけを信用する必要があります。ビットコインもライトニングも、ユーザーが個人、企業、機関、政府を信頼する必要はない。
ライトニングはビットコインの上に乗っており、その基礎となるベースレイヤーとしてビットコインに依存しているため、ライトニングのセキュリティモデルがビットコインのセキュリティに還元されることは明らかです。つまり、ライトニングは、ほとんどの状況下でビットコインとほぼ同じセキュリティを提供し、一部の狭い状況下でセキュリティがわずかに低下する程度です。</p>
</div>
</div>
<div class="sect3">
<h4 id="_permissionless_operation">パーミッションレス・オペレーション</h4>
<div class="paragraph">
<p>ビットコインもライトニングも、インターネットと適切なソフトウェア（ノードやウォレットなど）にアクセスできれば、誰でも利用することができる。
どちらのネットワークも、ユーザーは第三者、企業、機関、政府から許可、審査、承認を得る必要はありません。政府は、管轄内のビットコインやライトニングを非合法化することはできますが、世界的な利用を妨げることはできません。</p>
</div>
</div>
<div class="sect3">
<h4 id="_open_source_and_open_system">オープンソースとオープンシステム</h4>
<div class="paragraph">
<p>ビットコインもライトニングも、分散型グローバルボランティアコミュニティによって構築されたオープンソースソフトウェアシステムであり、オープンライセンスの下で利用可能です。どちらもオープンで相互運用可能なプロトコルをベースにしており、オープンシステム、オープンネットワークとして運用されています。グローバル、オープン、そしてフリー。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_conclusion">結論</h3>
<div class="paragraph">
<p>この章では、ライトニング・ネットワークの実際の仕組みと、その構成要素について見てきました。チャネルの構築、運用、閉鎖の各ステップについて検討しました。そして最後に、ライトニングとビットコインを比較し、その違いと共通点を分析しました。</p>
</div>
<div class="paragraph">
<p>次の章では、これらのトピックをすべて再確認し、より詳細に説明します。</p>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr />
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>.オリジナルの Lightning ホワイトペーパーでは、両方のチャネルパートナーから資金提供されるチャネルが記載されていましたが、2020 年現在の仕様では、一方のパートナーだけがチャネルに資金をコミットすることを想定しています。2021年5月現在、c-lightning LN の実装では、デュアルファンドの Lightning チャネルは実験的なものです。
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>.ジョージ・ダネジス、イアン・ゴールドバーグ、「スフィンクス：コンパクトで証明可能な安全なミックスフォーマット」、<em>IEEE Symposium on Security and Privacy</em>(New York: IEEE, 2009), 269-282.
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>.オニオン」という言葉は、もともとTorプロジェクトが使っていた。さらに、TorネットワークはOnionネットワークとも呼ばれ、同プロジェクトはタマネギをロゴに使用している。インターネット上のTorサービスが使用するトップレベルドメイン名は<em>onion</em>である。
</div>
</div>
<div id="footer">
<div id="footer-text">
最終更新 2022-10-29 15:50:16 +0400
</div>
</div>
</body>
</html>