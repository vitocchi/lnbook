<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="generator" content="Asciidoctor 2.0.16" />
<title>パスファインディングとペイメントデリバリー</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700" />
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;-webkit-tap-highlight-color:transparent}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="path_finding">パスファインディングとペイメントデリバリー</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ライトニング・ネットワークにおける支払い配送は、送信者から受信者への経路を見つけることに依存しており、これは経路<em>探索と</em>呼ばれるプロセスです。経路探索は送信者によって行われるため、送信者は宛先に到達するための適切な経路を見つけなければなりません。この経路は、<a href="#onion_routing">[onion_routing]</a>で見たように、オニオンでエンコードされます。</p>
</div>
<div class="paragraph">
<p>この章では、経路探索の問題を検討し、チャネルバランスの不確実性がいかにこの問題を複雑にしているかを理解し、典型的な経路探索の実装がどのようにこの問題を解決しようとしているかを見ていくことにする。</p>
</div>
<div class="sect2">
<h3 id="_pathfinding_in_the_lightning_protocol_suite">Lightningプロトコルスイートにおけるパスファインディング</h3>
<div class="paragraph">
<p>経路探索、経路選択、マルチパートペイメント（MPP）、支払い試行錯誤ループは、プロトコルスイートの最上位にある支払い層の大部分を占めています。</p>
</div>
<div class="paragraph">
<p>これらのコンポーネントは、<a href="#LN_protocol_pathfinding_highlight">LightningプロトコルスイートのPayment deliveryに</a>示されるプロトコルスイートのアウトラインで強調表示されます。</p>
</div>
<div id="LN_protocol_pathfinding_highlight" class="imageblock">
<div class="content">
<img src="images/mtln_1201.png" alt="Payment delivery in the Lightning protocol suite" />
</div>
<div class="title">図1.Lightningプロトコルスイートにおける決済配信</div>
</div>
<div class="sect3">
<h4 id="_where_is_the_bolt">BOLTはどこにある？</h4>
<div class="paragraph">
<p>これまで、ライトニング・ネットワークの一部であるいくつかの技術について見てきましたが、BOLT規格の一部として、その正確な仕様を見てきました。パスファインディングがBOLTの一部でないことに驚かれたかもしれませんね</p>
</div>
<div class="paragraph">
<p>それは、経路探索が、異なる実装間の調整や相互運用性を必要とする活動ではないからです。これまで見てきたように、パスは送信者によって選択されます。BOLTでルーティングの詳細が指定されていても、パスの発見と選択は完全に送信側に委ねられています。そのため、各ノードの実装では、パスを発見するために異なる戦略／アルゴリズムを選択することができます。実際、異なるノード／クライアントとウォレットの実装は、競合してその経路探索アルゴリズムを差別化ポイントとして使用することさえ可能です。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_pathfinding_what_problem_are_we_solving">パスファインディングどのような問題を解決するのか？</h3>
<div class="paragraph">
<p>経路探索という言葉は、2つのノードを結ぶ<em>単一の経路を</em>探索することを意味するため、やや誤解を招くかもしれません。ライトニング・ネットワークが小規模で相互接続が十分でなかった当初は、確かに支払いチャネルを結合して受取人に到達する方法を見つけることが問題でした。</p>
</div>
<div class="paragraph">
<p>しかし、ライトニングネットワークが爆発的に成長するにつれて、経路探索問題の性質が変化してきました。本書を読み終えた2021年半ば、ライトニングネットワークは2万台のノードが少なくとも5万5000のパブリックチャンネルで接続され、その総容量はほぼ2000BTCに達しています。1つのノードは平均8.8チャンネルを持ち、最も接続されているトップ10のノードは<em>それぞれ</em>400から2,000チャンネルを持っています。LNチャンネルグラフのごく一部を可視化したものが、<a href="#lngraph">A visualization of part of the Lightning Network as of July 2021に</a>示されています。</p>
</div>
<div id="lngraph" class="imageblock">
<div class="content">
<img src="images/mtln_1202.png" alt="mtln 1202" />
</div>
<div class="title">図2.2021年7月時点のライトニングネットワークの一部を可視化したもの</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">備考</div>
</td>
<td class="content">
<div class="paragraph">
<p>のネットワーク可視化<a href="#lngraph">2021年7月時点のライトニングネットワークの一部の可視</a>化は、本書のリポジトリのcode/lngraphにある簡単なPythonスクリプトで作成されたものです。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>送信者と受信者が他のよく接続されたノードに接続され、十分な容量を持つ少なくとも1つのチャネルを持っている場合、パスは何千も存在することになります。問題は、何千もの可能な経路の中から、支払い配送に成功する<em>最適な</em>経路を選択することである。</p>
</div>
<div class="sect3">
<h4 id="_selecting_the_best_path">最適な経路を選択する</h4>
<div class="paragraph">
<p>ベストなパスを選択するためには、まず "ベスト "とは何かを定義する必要があります。などなど、様々な基準があるかもしれません。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>十分な流動性を持つパス。明らかにあるパスが 私たちの支払いをルーティングするのに十分な流動性を持っていなければ それは適切なパスではありません。</p>
</li>
<li>
<p>手数料が安いパス候補が複数ある場合、手数料が安いものを選びたい場合があります。</p>
</li>
<li>
<p>タイムロックの短いパス資金を長くロックすることを避けたいので、タイムロックの短いパスを選択することがあります。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>これらの基準はすべてある程度望ましいものである可能性があり、多くの次元で有利な経路を選択することは容易なことではありません。このような最適化問題は、複雑すぎて「最適」な解を求めることはできないかもしれないが、最適な解の近似解を求めることはできる場合が多く、そうでなければ経路探索は難解な問題になってしまうので、朗報である。</p>
</div>
</div>
<div class="sect3">
<h4 id="_pathfinding_in_math_and_computer_science">数学とコンピュータサイエンスにおける経路探索</h4>
<div class="paragraph">
<p>ライトニング・ネットワークにおける経路探索は、数学では<em>グラフ理論</em>、コンピュータサイエンスでは<em>グラフ・トラバーサルという</em>一般的なカテゴリに分類されます。</p>
</div>
<div class="paragraph">
<p>ライトニングネットワークのようなネットワークは、<em>グラフと</em>呼ばれる数学的構成で表すことができ、<em>ノード</em>同士は<em>エッジ</em>（決済チャネルに相当）で結ばれています。ライトニングネットワークは、チャネル残高が2つのチャネルパートナー間で分割され、支払いの流動性が各方向で異なるため、ノードが<em>非対称に</em>リンクされ、<em>有向グラフを</em>形成しています。エッジに数値的な容量制約がある有向グラフは、<em>フローネットワークと</em>呼ばれ、輸送や他の類似のネットワークを最適化するために使用される数学的構成要素です。フローネットワークは、最小コストフロー問題（MCFP）として知られる、コストを最小化しながら特定のフローを実現する必要がある場合のフレームワークとして使用することができる。</p>
</div>
</div>
<div class="sect3">
<h4 id="_capacity_balance_liquidity">容量、バランス、流動性</h4>
<div class="paragraph">
<p>A地点からB地点への里通貨の輸送問題をよりよく理解するためには、キャパシティ、バランス、流動性という3つの重要な用語をよりよく定義する必要があります。これらの用語は、支払いチャネルが支払いをルーティングする能力を表すために使用されます。</p>
</div>
<div class="paragraph">
<p>A←→Bをつなぐ決済経路で。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">容量</dt>
<dd>
<p>2-of-2マルチシグに資金提供されたサトシの総量です。これはチャネルに保持されている価値の最大量を表している。チャネル容量はゴシッププロトコルによって発表され、ノードに知らされている。</p>
</dd>
<dt class="hdlist1">バランス</dt>
<dd>
<p>これは、各チャネルパートナーが保有するサトシのうち、他のチャネルパートナーに送ることができる量である。Aの残高の一部分はノードBに向かう方向（A→B）に送ることができ、Bの残高の一部分は反対方向（A←B）に送ることができる。</p>
</dd>
<dt class="hdlist1">流動性</dt>
<dd>
<p>実際に一方向にチャネルを渡って送信することができる利用可能な(サブセット)残高。Aの流動性は、Aの残高からチャネルリザーブとAによってコミットされた保留中のHTLCを差し引いたものに等しい。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>ネットワークに知られている唯一の値は、（ゴシップアナウンスによって）チャネルの総容量です。その容量の未知の部分は、各パートナーのバランスとして配布されます。その残高の一部は、チャネルを越えて一方向に送信するために利用可能である。</p>
</div>
<ul class="simplelist">
<li>容量＝バランス(A)＋バランス(B)</li>
<li>流動性(A) = 残高(A) - チャネルリザーブ(A) - ペンディング中のHTLC(A)</li>
</ul>
</div>
<div class="sect3">
<h4 id="_uncertainty_of_balances">残高の不確定性</h4>
<div class="paragraph">
<p>もしすべてのチャネルの正確な容量がわかれば、コンピュータ・サイエンス・プログラムで習う標準的な経路探索アルゴリズムを使って、1つまたは複数の支払い経路を計算することができます。しかし、私たちはチャネル残高を知りません。私たちが知っているのは、ノードがチャネル発表で公表している総チャネル容量だけです。支払いが成功するためには、チャネルの送信側に適切なバランスがなければなりません。チャネルパートナー間で容量がどのように配分されているかがわからなければ、支払いを送信しようとする方向に十分なバランスがあるかどうかわかりません。</p>
</div>
<div class="paragraph">
<p>残高をチャネルアップデートで発表しないのは、プライバシーとスケーラビリティという2つの理由からです。まず、残高を公表すると、残高の変化を統計的に分析することで支払いの監視が可能になるため、ライトニング・ネットワークのプライバシーが低下する。第二に、ノードが支払いのたびに残高を（グローバルに）発表した場合、ライトニングネットワークのスケーリングは、すべての参加者にブロードキャストされるビットコインのオンチェーン取引と同じくらい悪化することになります。そのため、残高を公表していません。残高の不確実性に直面した経路探索問題を解決するためには、革新的な経路探索戦略が必要です。これらの戦略は、ネットワークを通る経路を見つけることが送信者の責任であるソースベースのオニオンルーティングである、使用されているルーティングアルゴリズムと密接に関係しなければならない。</p>
</div>
<div class="paragraph">
<p>不確実性の問題は、既知の情報に基づく流動性の下限と上限を示す<em>流動性の範囲として</em>、数学的に記述することができます。チャネルの容量が分かっており、チャネルのリザーブ・バランス（各端末の最小許容残高）も分かっているので、流動性は次のように定義できます。</p>
</div>
<ul class="simplelist">
<li>min(liquidity) = チャネルリザーブ</li>
<li>max(liquidity) = キャパシティ - チャネルリザーブ</li>
</ul>
<div class="paragraph pagebreak-before">
<p>または範囲として設定します。</p>
</div>
<ul class="simplelist">
<li>チャネルリザーブ &lt;= 流動性 &lt;= (キャパシティ - チャネルリザーブ)</li>
</ul>
<div class="paragraph">
<p>当社のチャネル流動性の不確実性の範囲は、可能な限り最小の流動性と最大の流動性の間の範囲である。これは、2 人のチャネル・パートナー以外のネットワークには知らされていません。しかし、これから説明するように、支払いの試行から返された失敗した HTLC を使用して、流動性の推定値を更新し、不確実性を低減することができます。たとえば、HTLC の失敗コードが返ってきて、チャネルが最大流動性の推定値 よりも小さい HTLC を履行できないことがわかれば、最大流動性を失敗した HTLC の量に更新することができることになります。もっと簡単に言うと、もし私たちが流動性が<em>N個の</em>サトシのHTLCを処理できると考えていて、それが<em>M個の</em>サトシ（ここで<em>Mは</em>より小さい）の配送に失敗したとわかったら、私たちは上限として私たちの推定値を<em>M-</em>1に更新することができるのです。私たちは上限を見つけようとしてそれにぶつかったので、上限は思ったより低くなっています。</p>
</div>
</div>
<div class="sect3">
<h4 id="_pathfinding_complexity">パスファインディングの複雑さ</h4>
<div class="paragraph">
<p>グラフの経路探索は、現代のコンピュータが比較的効率的に解くことができる問題である。
開発者は主に、エッジの重みがすべて等しい場合に幅優先探索を選択する。
エッジの重みが等しくない場合は、Dijkstraのアルゴリズムをベースにした<a href="https://en.wikipedia.org/wiki/A*_search_algorithm">A*（エイスターと発音する）などが</a>使われる。
我々の場合、エッジの重みはルーティングフィーを表すことができる。
送信量より大きい容量を持つエッジのみが探索に含まれる。
この基本形では、ライトニング・ネットワークの経路探索は非常にシンプルでわかりやすい。</p>
</div>
<div class="paragraph">
<p>しかし、チャネルの流動性は送信者にとっては未知である。このため、簡単な理論上のコンピュータサイエンスの問題が、かなり複雑な現実世界の問題に変わってしまいます。
我々は、部分的な知識だけで経路探索問題を解かなければならないのです。
例えば、どのエッジが支払いを転送できるか、その容量が十分大きそうだからと考える。
しかし、実際に試してみるか、チャネルの所有者に直接聞いてみない限り、確信が持てない。
仮にチャネルの所有者に直接尋ねられたとしても、他の人に尋ね、パスを計算し、オニオンを構築し、それを送信するまでに、彼らのバランスが変わってしまうかもしれません。
私たちは限られた情報しか持っていないだけでなく、持っている情報は非常に動的で、私たちの知らないところでいつの間にか変わっているかもしれないのです。</p>
</div>
</div>
<div class="sect3">
<h4 id="_keeping_it_simple">シンプルであること</h4>
<div class="paragraph">
<p>ライトニングノードに実装されている経路探索の仕組みは、まず候補となる経路のリストを作成し、何らかの関数でフィルタリングして並べ替えます。次に、ノードまたはウォレットは、試行錯誤を繰り返しながら、決済に成功するパスが見つかるまで（決済を試みて）パスを探索します。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">備考</div>
</td>
<td class="content">
<div class="paragraph">
<p>このプロービングはライトニングノードまたはウォレットによって行われ、ソフトウェアのユーザが直接観察することはありません。
しかし、決済が即座に完了しない場合、ユーザーはプロービングが行われているのではないかと疑うかもしれません。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>ブラインドプロービングは最適ではなく、改善の余地が十分にありますが、この単純化された戦略でさえ、小規模な支払いや十分に接続されたノードでは驚くほどうまく機能することに留意すべきです。</p>
</div>
<div class="paragraph">
<p>ほとんどのライトニングノードおよびウォレットの実装は、候補となるパスのリストに順序付けや重み付けをすることで、このアプローチを改良しています。一部の実装では、コスト（手数料）またはコストと容量の組み合わせによって候補経路を並べ替えます。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_pathfinding_and_payment_delivery_process">経路探索と支払配送の流れ</h3>
<div class="paragraph">
<p>経路探索と支払配送にはいくつかのステップがあり、ここに列挙する。異なる実装では異なるアルゴリズムと戦略を使用するかもしれないが、基本的なステップは非常に類似している可能性が高い。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>アナウンスとアップデートから、各チャンネルの容量を含む<em>チャンネルグラフを</em>作成し、送信したい量に対して容量が足りないチャンネルを無視してグラフをフィルタリングする。</p>
</li>
<li>
<p>送信者と受信者を結ぶパスを検索します。</p>
</li>
<li>
<p>ある重みで経路を並べる（これは前のステップの<span class="keep-together">アルゴリズムの</span>一部かもしれない）。</p>
</li>
<li>
<p>各パスを順番に試していき、支払いが成功するまで試行錯誤を繰り返す（試行錯誤のループ）。</p>
</li>
<li>
<p>オプションとして、HTLCの失敗報告を使用してグラフを更新し、<span class="keep-together">不確実性を</span>低減します。</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>これらのステップを3つの主要な活動に分類することができます。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>チャンネルグラフの構築</p>
</li>
<li>
<p>パスファインディング（いくつかのヒューリスティックによるフィルタリングと順序付け）</p>
</li>
<li>
<p>支払い方法</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>これらの3つのアクティビティは、失敗のリターンを使ってグラフを更新する場合や、マルチパート決済を行う場合（<a href="#mpp">マルチパート決済を</a>参照）には、<em>決済ラウンドで</em>繰り返すことができる。</p>
</div>
<div class="paragraph">
<p>次のセクションでは、これらの各ステップをより詳しく、またより高度な支払い戦略について見ていきます。</p>
</div>
</div>
<div class="sect2">
<h3 id="_channel_graph_construction">チャンネルグラフの構築</h3>
<div class="paragraph">
<p><a href="#gossip">gossip]</a>では、ノードがゴシップで使用する3つの主要なメッセージ、node_announcement、channel_announcement、channel_updateを取り上げました。これらの 3 つのメッセージにより、ノードは<em>チャンネルグラフの</em>形でライトニングネットワークの「マップ」を徐々に構築することができます。これらのメッセージは、それぞれチャンネルグラフに重要な情報を提供します。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">ノードアナウンス</dt>
<dd>
<p>ライトニングネットワーク上のノードに関する情報（ノードID（公開鍵）、ネットワークアドレス（IPv4/6やTorなど）、能力/特徴など）が格納されています。</p>
</dd>
<dt class="hdlist1">チャネルアナウンス</dt>
<dd>
<p>これは、2つのノード間のパブリック（発表済み）チャネルの容量とチャネルID、およびチャネルの存在と所有権の証明を含んでいます。</p>
</dd>
<dt class="hdlist1">チャンネル更新</dt>
<dd>
<p>これは、指定されたチャネル上で（そのノードから見て）発信される支払いをルーティングするための、ノードの手数料とタイムロック（CLTV）の期待を含んでいます。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>数学的なグラフで言えば、node_announcementは、グラフのノードまたは<em>頂点を</em>作成するために必要な情報である。channel_announcementは、支払いチャネルを表すグラフの<em>エッジを</em>作成することができます。支払いチャネルの各方向は独自のバランスを持つので、有向グラフを作成する。channel_updateでは、手数料やタイムロックを組み込んで、グラフの辺の<em>コストや</em> <em>重みを</em>設定することができます。</p>
</div>
<div class="paragraph">
<p>経路探索に使うアルゴリズムによっては、グラフのエッジに対していくつかの異なるコスト関数を設定することができる。</p>
</div>
<div class="paragraph">
<p>とりあえず、コスト関数を無視して、node_announcement と channel_announcement メッセージを使って、ノードとチャンネルを示すチャンネルグラフを単純に確立することにしましょう。</p>
</div>
<div class="paragraph">
<p>この章では、セレーナがラシッドに100万サトシを支払うための経路を見つけようとする様子を見ることができる。まず、セレーナはライトニングネットワークのゴシップ情報を使って、ノードとチャンネルを発見し、チャンネルグラフを構築しています。そして、セレーナはチャネルグラフを探索し、ラシッドに支払いを送るための経路を見つける。</p>
</div>
<div class="paragraph">
<p>これは<em>セレナの</em>チャンネル・グラフである。チャンネル・<em>グラフという</em>ものは存在せず、あるのは<em>チャンネル・グラフだけ</em>で、それは常にそれを構築したノードの視点からのものです（<a href="#map_territory_relation">地図と領域の関係を</a>参照）。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">チップ</div>
</td>
<td class="content">
<div class="paragraph">
<p>セレーナは、支払いを送信するときだけチャネルグラフを構築するわけではありません。むしろ、セレーナのノードは<em>継続的に</em>チャンネル・グラフを構築し、更新しているのです。セレーナのノードは、ネットワーク上の任意のピアに接続した瞬間からゴシップに参加し、ネットワークについてできるだけ多くを学ぶためにすべてのメッセージを使用します。</p>
</div>
</td>
</tr>
</table>
</div>
<div id="map_territory_relation" class="sidebarblock">
<div class="content">
<div class="title">地図と領土の関係</div>
<div class="paragraph">
<p>ウィキペディアの<a href="https://en.wikipedia.org/wiki/Map%E2%80%93territory_relation">地図-領土関係のページより</a>、"地図-領土関係は、地理的な領土とその地図の関係のように、あるオブジェクトとそのオブジェクトの表現との関係を記述する。"。</p>
</div>
<div class="paragraph">
<p>地図と領土の関係は、ルイス・キャロルの短編小説「シルヴィーとブルーノの結末」によく表れている。この小説では、地図は領土の縮尺が1：1であるため完璧な精度を持つが、広げれば領土全体を覆ってしまい、全く役に立たなくなるという架空の地図が描かれている。</p>
</div>
<div class="paragraph">
<p>ライトニングネットワークの意味とは？ライトニングネットワークはテリトリーであり、チャネルグラフはそのテリトリーの地図である。</p>
</div>
<div class="paragraph">
<p>ライトニングネットワークの完全で最新のマップを表す理論的（プラトニックな理想的）なチャンネルグラフを想像することはできますが、そのようなマップは単にライトニングネットワークそのものに過ぎません。各ノードは、アナウンスメントから構築された独自のチャネルグラフを持っており、必然的に不完全、不正確、そして古いものになります。</p>
</div>
<div class="paragraph">
<p>地図は決して領土を完全かつ正確に表現することはできない。</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Selenaはnode_announcementのメッセージに耳を傾け、（受信者であるRashidの他に）4つのノードを発見している。その結果、グラフは6つのノードからなるネットワークとなる。SelenaとRashidはそれぞれ送信者と受信者であり、Alice、Bob、Xavier、Yanは仲介ノードである。Selenaの最初のグラフは単なるノードのリストであり、<a href="#channel_graph_nodes">ノード・アナウンスメントに</a>示されている。</p>
</div>
<div id="channel_graph_nodes" class="imageblock">
<div class="content">
<img src="images/mtln_1203.png" alt="mtln 1203" />
</div>
<div class="title">図3.ノードのアナウンス</div>
</div>
<div class="paragraph">
<p>また，Selenaは7つのchannel_announcementメッセージとそれに対応するチャネルの容量を受け取り，<a href="#channel_graph_1">The channel graphに</a>示すようなネットワークの基本的な「地図」を構築することができる．(アリス、ボブ、セレナ、ザビエル、ヤン、ラシードという名前は、それぞれのイニシャルに置き換えられている。それぞれA、B、S、X、Rに置き換えている)。</p>
</div>
<div id="channel_graph_1" class="imageblock">
<div class="content">
<img src="images/mtln_1204.png" alt="mtln 1204" />
</div>
<div class="title">図4.チャンネルグラフ</div>
</div>
<div class="sect4">
<h5 id="_uncertainty_in_the_channel_graph">チャンネルグラフの不確かさ</h5>
<div class="paragraph">
<p><a href="#channel_graph_1">チャンネルグラフから</a>わかるように、セレーナはチャンネルのバランスを全く知りません。彼女の最初のチャンネル・グラフは、最も高いレベルの不確実性を含んでいます。</p>
</div>
<div class="paragraph">
<p>しかし、ちょっと待ってください。セレナは<em>ある</em>チャンネルの残高を知っているのです!自分のノードが他のノードと接続しているチャネルの残高を知っているのです。これはあまり重要ではないように見えますが、実は経路を構成する上で非常に重要な情報です。つまり、Selenaは自分のチャネルの実際の流動性を知っているのです。この情報を表示するために、チャネルグラフを更新してみましょう。<a href="#channel_graph_2">既知の残高と未知の残高を含むチャネルグラフに</a>示すように、未知の残高を表すために「？」記号を使用します。</p>
</div>
<div id="channel_graph_2" class="imageblock">
<div class="content">
<img src="images/mtln_1205.png" alt="mtln 1205" />
</div>
<div class="title">図5.既知および未知のバランスを持つチャネルグラフ</div>
</div>
<div class="paragraph">
<p>の記号は不吉な感じがしますが、確実性の欠如は完全な無知と同じではありません。私たちは、試行したHTLCの成功/失敗でグラフを更新することにより、不確実性を<em>定量化</em>し、それを<em>減らす</em>ことができます。</p>
</div>
<div class="paragraph">
<p>不確実性は定量化できる。なぜなら、可能性のある最大と最小の流動性がわかっており、より小さな（より正確な）範囲に対する確率を計算できるからだ。</p>
</div>
<div class="paragraph">
<p>HTLCの送信を試みると、チャネルの残高についてより詳しく知ることができます。一方、"temporary channel failure "というエラーが出た場合、最も可能性の高い理由は、特定の金額を輸送するための流動性が不足していることである。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">チップ</div>
</td>
<td class="content">
<div class="paragraph">
<p>"成功したHTLCから学ぶことに何の意味があるのか "と思われるかもしれません。結局のところ、成功すれば私たちは "おしまい "なのです。しかし、私たちは、複数回の支払いのうちの1回分を送るかもしれないことを考えてみてください。また、短時間のうちに他のシングル・パート・ペイメントを送るかもしれません。流動性について学んだことはすべて、次の試みに役立つのです。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_liquidity_uncertainty_and_probability">流動性の不確実性と蓋然性</h4>
<div class="paragraph">
<p>チャネルの流動性の不確実性を定量化するために、確率論を適用することができる。支払配送の確率の基本モデルによって、かなり明白ではあるが、重要な結論が導き出される。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>小額決済の場合、経路をまたぐと成功する確率が高くなります。</p>
</li>
<li>
<p>容量が大きいチャンネルは、特定金額での決済配信の可能性が高くなります。</p>
</li>
<li>
<p>チャンネル（ホップ）数が多いほど、成功する確率は低くなります。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>これらは当たり前のことかもしれませんが、特にマルチパートペイメント（「<a href="#mpp">マルチパートペイメント</a>」を参照）の使用において、重要な意味を持ちます。数学は難しくない。</p>
</div>
<div class="paragraph">
<p>なぜこのような結論になったのか、確率論で考えてみよう。</p>
</div>
<div class="paragraph">
<p>まず、容量が<em>c</em>のチャネルは、片側に (0,<em>c</em>) または "0 と<em>c の</em>間の範囲" の未知の値を持つ流動性があると仮定してみましょう。例えば、容量が5であれば、流動性は(0, 5)の範囲になります。さて、このことから、5サトシを送りたい場合、成功する確率は6分の1（16.66%）に過ぎないことがわかります。なぜなら、流動性がちょうど5でなければ成功しないからです。</p>
</div>
<div class="paragraph">
<p>より簡単に言うと、流動性の取り得る値が 0、1、2、3、4、および 5 である場合、この 6 つの値のうち 1 つだけが支払いを送信するのに十分な値である。この例を続けると、支払額が 3 の場合、流動性が 3、4、または 5 であれば成功することになります。つまり、成功する確率は6分の3（50％）です。数学で表現すると、1つのチャネルの成功確率関数は次のようになります。</p>
</div>
<div class="stemblock">
<div class="content">
\[$P_c(a) = (c + 1 - a) / (c + 1)$].
</div>
</div>
<div class="paragraph">
<p>ここで、<em>aは</em>量、<em>cは</em>容量である。</p>
</div>
<div class="paragraph">
<p>式から、量が0に近いと確率は1に近くなり、量が容量を超えると確率は0になることがわかる。</p>
</div>
<div class="paragraph">
<p>言い換えれば"少額の決済は成功する確率が高い "とか、"容量の大きいチャネルは特定金額の決済の確率が高い "とか、"容量不足のチャネルでは決済を送れない "ということです。</p>
</div>
<div class="paragraph">
<p>ここで、いくつかのチャンネルで構成される経路の成功確率を考えてみましょう。最初のチャンネルの成功確率が50%<em>(P</em>= 0.5)であるとします。次に、2番目のチャンネルが50％の確率で成功するとすると<em>（P</em>= 0.5）、全体の確率は直感的に25％<em>（P</em>= 0.25）であることがわかります。</p>
</div>
<div class="paragraph">
<p>これは、ある決済が成功する確率を、経路の各チャネルの確率の積として計算する式で表すことができる（複数可）。</p>
</div>
<div class="stemblock">
<div class="content">
\[$P_{payment} = \prod_{i=1}^n P_i$].
</div>
</div>
<div class="paragraph">
<p>ここで、<sub><em>Piは</em></sub>1つのパスまたはチャネルで成功する確率、<em>Ppaymentは</em>すべてのパス/チャネルで支払いが成功する全体的な確率である。</p>
</div>
<div class="paragraph">
<p>この式から、1つのチャネルでの成功確率は常に1以下であるため、多くのチャネルでの成功確率は<em>指数関数的に低下</em>することがわかります。</p>
</div>
<div class="paragraph">
<p>つまり、"チャンネル（ホップ）数が多いほど、成功する確率は低くなる "ということです。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">備考</div>
</td>
<td class="content">
<div class="paragraph">
<p>チャネルの流動性の不確実性の背後には、多くの数学的理論とモデリングが存在します。チャネルの流動性の不確実性区間のモデル化に関する基礎的な研究は、（本書の共著者）Pickhardt<span class="keep-together">らによる</span>論文<a href="https://arxiv.org/abs/2103.08576">「Security and Privacy of Lightning Network Payments with Uncertain Channel Balances</a>」に見ることができます。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_fees_and_other_channel_metrics">手数料およびその他のチャネル指標</h4>
<div class="paragraph">
<p>次に、送信者は仲介ノードから受信したchannel_updateメッセージからグラフに情報を追加することになります。注意点として、channel_updateにはチャネルに関する豊富な情報とチャネルパートナーの1人の期待値が含まれています。</p>
</div>
<div class="paragraph">
<p><a href="#channel_graph_3">Channel graph fees and other channel metrics</a>では，A, B, X, Y からの channel_update メッセージに基づいて，Selena がどのようにチャネルグラフを更新するかが示されている．各チャネル・パートナーは、1つまたは複数のchannel_updateメッセージを送信して、料金の期待値やチャネルに関するその他の情報を発表します。たとえば、左上には、アリスがチャネル A-B と方向 A-to-B に関して送信した channel_update が表示されています。この更新で、アリスは特定のチャネルでボブへ HTLC をルーティングするために、どれだけの料金を請求するかをネットワークに伝えます。ボブは、まったく異なる料金で反対方向のチャネル・アップデート(この図には示されていない)を発表することができます。どのノードも、いつでも料金やタイムロックの予想を変更するために新しい channel_update を送信することができます。</p>
</div>
<div id="channel_graph_3" class="imageblock">
<div class="content">
<img src="images/mtln_1206.png" alt="mtln 1206" />
</div>
<div class="title">図6.チャンネルグラフの料金とその他のチャンネルメトリクス</div>
</div>
<div class="paragraph">
<p>料金やタイムロックの情報は、経路選択の指標としてだけでなく、非常に重要である。<a href="#onion_routing">onion_routing]</a>で見たように、送信者はオニオンを作るために各ホップで料金とタイムロック（cltv_expiry_delta）を合計する必要がある。各中間ホップは、次のホップに送る送信 HTLC よりも高い金額と有効期限の HTLC を期待するため、料金計算のプロセスは受信者から送信者へとパスに沿って<em>後方に</em>発生する。例えば、ボブがラシッドに支払いを送るために1000サトシの手数料と30ブロックの有効期限デルタが欲しい場合、その金額と有効期限デルタは<em>アリスからの</em>HTLCに追加されなければならない。</p>
</div>
<div class="paragraph">
<p>また，チャネルは支払額だけでなく，その後のすべてのホップの累積手数料に対して十分な流動性を持っていなければならないことにも注意が必要です．SelenaからXavierへのチャネル（S→X）は、1M satoshiの支払いには十分な流動性を持っていますが、手数料を考慮すると、十分な流動性を持っているとは<em>言えません</em>。手数料を知る必要があるのは、<em>支払いとすべての</em>手数料に対して十分な流動性を持つ経路だけが考慮されるからです。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_finding_candidate_paths">候補となるパスを探す</h3>
<div class="paragraph">
<p>このような有向グラフから適切な経路を見つけ出すことは、よく研究されているコンピュータ科学の問題（広義には<em>最短経路問題</em>）であり、目的の最適化とリソースの制約に応じて様々なアルゴリズムで解くことができる。</p>
</div>
<div class="paragraph">
<p>この問題を解く最も有名なアルゴリズムは、1956年にオランダの数学者E. W. Dijkstraが発明したもので、単に<a href="https://en.wikipedia.org/wiki/Dijkstra&#8217;s_algorithm"><em>Dijkstraのアルゴリズムとして</em></a>知られている。オリジナルのダイクストラアルゴリズムの他にも、ヒューリスティックベースのアルゴリズムである<a href="https://en.wikipedia.org/wiki/A*_search_algorithm">A*（「A-star」）</a>等、多くのバリエーションや最適化が存在する。</p>
</div>
<div class="paragraph">
<p>前述したように、受信者から送信者に蓄積される手数料を考慮し、「検索」を<em>逆向きに</em>適用する必要があります。したがって、ダイクストラ、A*、またはその他のアルゴリズムは、手数料、推定流動性、およびタイムロックデルタ（またはその組み合わせ）を各ホップのコスト関数として使用して、受信者から送信者への経路を検索します。</p>
</div>
<div class="paragraph">
<p>そのようなアルゴリズムの1つを使って、セレーナはラシードへの可能な経路をいくつか計算し、最短経路から並べ替える。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>S→A→B→R</p>
</li>
<li>
<p>S→X→Y→R</p>
</li>
<li>
<p>S→X→B→R</p>
</li>
<li>
<p>S→A→B→X→Y→R</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>しかし、先に見たように、手数料を考慮すると、チャネルS→Xは1M satoshiの支払いに十分な流動性を持っていない。したがって、経路2と3は実行不可能です。そうすると、1番目と4番目の経路が支払いのための可能な経路として残ります。</p>
</div>
<div class="paragraph">
<p>2つの道を選んだセレーナは、いよいよ出産に挑みます。</p>
</div>
</div>
<div class="sect2">
<h3 id="_payment_delivery_trial_and_error_loop">支払配送（試行錯誤のループ）</h3>
<div class="paragraph">
<p>Selenaのノードは、HTLCを構築し、オニオンを構築し、支払いの配送を試みることで、試行錯誤のループを開始する。各試行では、3つの可能な結果がある。</p>
</div>
<div class="ulist pagebreak-before">
<ul>
<li>
<p>成功した場合 (update_fulfill_htlc)</p>
</li>
<li>
<p>エラー(update_fail_htlc)</p>
</li>
<li>
<p>応答がない（成功でも失敗でもない）「スタック」した支払い。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>決済に失敗した場合は、グラフを更新（チャンネルの指標を変更）し、代替経路を再計算することで、別の経路で再試行することができます。</p>
</div>
<div class="paragraph">
<p><a href="#stuck_payments">stuck_payments]</a>で、支払いが "stuck "した場合に何が起こるかを見てみました。重要なのは、支払いが滞った場合、別のHTLCで再試行することができないため、最悪の結果となることです。なぜなら、両方（滞ったものと再試行したもの）が最終的に通過し、二重支払いを引き起こすかもしれないからです。</p>
</div>
<div class="sect3">
<h4 id="_first_attempt_path_1">ファーストアテンプト（パスその1）</h4>
<div class="paragraph">
<p>Selenaは最初の経路(S→A→B→R)を試行する。彼女はオニオンを構築して送信するが、Bobのノードから失敗コードを受信する。BobはチャネルB→Rを配送できないチャネルとして特定するchannel_updateとともに、一時的なチャネル障害を報告する。この試みは<a href="#path_1_fail">Path #1 attempt failsに</a>示されている。</p>
</div>
<div id="path_1_fail" class="imageblock">
<div class="content">
<img src="images/mtln_1207.png" alt="mtln 1207" />
</div>
<div class="title">図7．パス#1の試みは失敗</div>
</div>
<div class="sect4">
<h5 id="_learning_from_failure">失敗から学ぶ</h5>
<div class="paragraph">
<p>この失敗コードから、Selena は Bob がそのチャネルで Rashid に支払いを行うための十分な流動性を 持っていないと推測します。重要なのは、この失敗によって、そのチャネルの流動性の不確実性が狭まったことです!以前は、Selenaのノードは、Bob側のチャネルの流動性が範囲(0, 4M)のどこかにあると仮定していました。現在では、流動性は範囲 (0, 999999) にあると仮定できます。同様に、セレーナはラシッド側のチャネルの流動性が (0, 4M) ではなく、 (1M, 4M) の範囲にあると仮定することができるようになったのです。セレナはこの失敗から多くのことを学びました。</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_second_attempt_path_4">セカンドアテンプト（パス#4）</h4>
<div class="paragraph">
<p>さて、セレナは第4候補のパス（S→A→B→X→Y→R）に挑戦します。これはより長い経路であり、より多くの手数料が発生するが、支払いの受け渡しのためには現在これが最良の選択肢である。</p>
</div>
<div class="paragraph">
<p>幸いなことに、SelenaはAliceからupdate_fulfill_htlcメッセージを受け取り、<a href="#path_4_success">Path#4の試みが</a>成功したことを示す。</p>
</div>
<div id="path_4_success" class="imageblock">
<div class="content">
<img src="images/mtln_1208.png" alt="mtln 1208" />
</div>
<div class="title">図8．パス#4の試行が成功</div>
</div>
<div class="sect4">
<h5 id="_learning_from_success">成功から学ぶ</h5>
<div class="paragraph">
<p>セレナもまた、この支払いの成功から多くのことを学びました。彼女は、S→A→B→X→Y→Rの経路上のすべてのチャネルが、支払いを行うのに十分な流動性を持っていたことを知ったのである。さらに、これらのチャネルのそれぞれが HTLC の金額 (1M + 手数料) をチャネルのもう一方の端に移動させたことも知っています。これにより、Selenaはその経路のすべてのチャネルの受信側の流動性の範囲を再計算し、最小流動性を1M +手数料に置き換えることができる。</p>
</div>
</div>
<div class="sect4">
<h5 id="_stale_knowledge">陳腐化した知識？</h5>
<div class="paragraph">
<p>これでセレーナは、ライトニングネットワーク（少なくともこの7つのチャンネルに関しては）の「地図」をより良く知ることができました。この知識は、今後セレーナが行おうとする支払いに役立つだろう。</p>
</div>
<div class="paragraph">
<p>しかし、他のノードが支払いを送信またはルーティングすると、この知識は多少「古く」なる。セレナはこれらの支払いを見ることはない(彼女が送信者でない限り)。たとえ支払いをルーティングしていたとしても、オニオン・ルーティング・メカニズムは、彼女が1つのホップ（彼女自身のチャネル）の変更しか見ることができないことを意味する。</p>
</div>
<div class="paragraph">
<p>したがって、セレーナのノードでは、この知識を古くなった、もう役に立たないと判断する前に、どれくらいの期間保存しておくかを考えなければならない。</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="mpp">マルチパートペイメント</h3>
<div class="paragraph">
<p><em>マルチパートペイメント（MPP</em>）は、2020年にライトニングネットワークに導入された機能であり、すでに非常に広く利用されています。マルチパートペイメントは、支払いを複数の<em>パートに</em>分割し、それをHTLCとして複数の異なる経路で意図する受取人に送信し、支払い全体の<em>アトミック</em>性を維持することを可能にします。この文脈では、原子性とは、支払いのすべての HTLC 部分が最終的に履行されるか、支払い全体が失敗し、すべての HTLC 部分が失敗するかのいずれかを意味する。部分的に成功する支払いはあり得ません。</p>
</div>
<div class="paragraph">
<p>マルチパート決済は、十分な流動性を持つ少額に分割することで、単一のチャネルに収まらない金額を送信することを可能にするため、ライトニング・ネットワークの大きな改善点となります。さらに、マルチパート決済は、シングルパス決済と比較して、決済が成功する確率が高くなることが確認されています。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">チップ</div>
</td>
<td class="content">
<div class="paragraph">
<p>MPPが利用できるようになった今、シングルパス決済はMPPのサブカテゴリーと考えるのが一番です。基本的に、シングルパスはサイズ1のマルチパートに過ぎません。支払いのサイズと利用可能な流動性によってシングルパートで提供することが可能である場合を除き、すべての支払いはマルチパート支払いと考えることができます。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_using_mpp">MPPの使用</h4>
<div class="paragraph">
<p>MPPはユーザーが選択するものではなく、ノードの経路探索と決済の受け渡しを行うものである。グラフの作成、パスの選択、試行錯誤のループなど、基本的な手順は同じです。異なるのは、パス選択の際に、支払いをどのように分割して配信を最適化するかについても考慮しなければならない点です。</p>
</div>
<div class="paragraph">
<p>この例では、MPPによって経路探索の問題がすぐに改善されることがわかります。まず、100万サトシと手数料を輸送するには流動性が不十分であることが分かっているS→Xチャネルを利用することができます。そのチャネルでより小さな部品を送ることで、以前は利用できなかった経路を利用することができます。次に、B→Rチャネルの流動性は未知数で、100万ドルを輸送するには不十分ですが、それ以下の金額を輸送するには十分かもしれません。</p>
</div>
<div class="sect4">
<h5 id="_splitting_payments">分割払い</h5>
<div class="paragraph">
<p>根本的な問題は、支払いをどのように分割するかということである。具体的には、最適な分割数と各分割の最適な金額はどのようなものか。</p>
</div>
<div class="paragraph">
<p>これは現在進行中の研究分野であり、新しい戦略が生まれつつあります。マルチパート最適化からシングルパス解が現れることがあっても（つまり、マルチパート経路探索アルゴリズムが提案する最適解がシングルパスである場合もある）、マルチパート支払いはシングルパス支払いと異なるアルゴリズムアプローチを導く。</p>
</div>
<div class="paragraph">
<p>思い起こせば、流動性・残高の不確実性が、MPPパスファインディングに適用できるいくつかの（やや自明な）結論を導くことがわかりました、すなわち。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>少額決済は成功する確率が高い。</p>
</li>
<li>
<p>使用するチャンネルが増えれば増えるほど、成功する確率は（指数関数的に）低くなります。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>このことから、大きな支払い（例えば100万サトシ）を小さな支払いに分割することで、それぞれの小さな支払いが成功する確率が高くなると結論づけることができるだろう。少額の送金であれば、十分な流動性を持つ可能性のある経路の数はより多くなるのである。</p>
</div>
<div class="paragraph">
<p>このアイデアを極端に言えば、100万サトシの支払いを100万個の別々の1サトシに分割してはどうでしょうか。100万個の1サトシのHTLCを送るのに、より多くのチャネルやパスを使うことになるので、成功する確率が指数関数的に下がるからです。</p>
</div>
<div class="paragraph">
<p>この2つの洞察によって、私たちは「スイートスポット」を作り出し、成功の可能性を最大限に高めることができるのです。</p>
</div>
<div class="paragraph">
<p>あるチャネルグラフに対する分割のサイズと数の最適なバランスを定量化することは、本書の範囲外であるが、活発な研究分野である。現在の実装の中には、支払いを2分割、4分割など、非常に単純な戦略を用いるものもある。</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">備考</div>
</td>
<td class="content">
<div class="paragraph">
<p>支払いを様々なサイズに分割してパスに割り当てる際に関係する最小コストフローと呼ばれる最適化問題の詳細については、（本書の共著者）René PickhardtとStefan Richterによる論文<a href="https://arxiv.org/abs/2107.05322">「Optimally Reliable &amp; Cheap Payment Flows on the Lightning Network</a>」をご参照ください。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>この例では、Selenaのノードは1M satoshiの支払いを2つに分割し、それぞれ600k satoshiと400k satoshiにし、2つの異なる経路で送信しようとする。これは、<a href="#mpp_paths">Sending two parts of a multipart</a> paymentに示されている。</p>
</div>
<div class="paragraph">
<p>S→Xチャンネルが使えるようになり、（セレナにとって幸運なことに）B→Rチャンネルには60万サトシ分の流動性があるので、2部はこれまで不可能だった経路で成功した。</p>
</div>
<div id="mpp_paths" class="imageblock">
<div class="content">
<img src="images/mtln_1209.png" alt="mtln 1209" />
</div>
<div class="title">図 9.マルチパートペイメントの2つのパートを送信する</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_trial_and_error_over_multiple_rounds">複数の "ラウンド "で試行錯誤を繰り返す</h4>
<div class="paragraph">
<p>マルチパートペイメントは、ペイメントデリバリーの試行錯誤のループを多少修正することになる。各試行で複数の経路を試行しているため、4つの可能性があります。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>すべてのパーツが成功し、決済も成功</p>
</li>
<li>
<p>ある部分は成功し、ある部分はエラーが返されて失敗する</p>
</li>
<li>
<p>すべてのパーツがエラーを返して失敗</p>
</li>
<li>
<p>一部の部品は「動かない」、エラーは返さない</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>2つ目のケースでは、エラーを返して失敗する部分と成功する部分があるため、今度は<em>残量分だけ</em>試行錯誤のループを<em>繰り返せば</em>よい。</p>
</div>
<div class="paragraph">
<p>たとえば、セレーナがラシッドに到達するための何百もの可能な経路を持つ、より大きなチャネルグラフを持っていたと仮定しよう。彼女の経路探索アルゴリズムは、さまざまな大きさの26の部分からなる最適な支払分割を見つけるかもしれない。最初のラウンドで26個の部品すべてを送信しようとした後、それらの部品のうち3個がエラーで失敗しました。</p>
</div>
<div class="paragraph">
<p>この3つの部品が、例えば15万5千サトシであったとしたら、セレナは15万5千サトシ分だけ経路探索を再開することになる。次のラウンドでは、（155kの残留量に最適化された）全く異なる経路を見つけ、155kの量を全く異なる分割にすることができるのです</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">チップ</div>
</td>
<td class="content">
<div class="paragraph">
<p>26分割は多いように思えますが、ライトニングネットワークでのテストでは、345分割することで0.3679BTCの支払いに成功しました。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>さらに、セレーナのノードでは、1ラウンド目の成功と失敗から得た情報を使ってチャンネルグラフを更新し、2ラウンド目の最適なパスとスプリットを見つけることができる。</p>
</div>
<div class="paragraph">
<p>Selenaのノードが、155kの残金を送るには、80k、42k、15k、11k、6.5k、500サトシの6分割が最適と計算したとする。次のラウンドでは、Selenaは11k satoshiの部分が失敗したことを示す1つのエラーだけを取得する。Selenaは再び、得られた情報に基づいてチャネルグラフを更新し、11kの残りを送るために経路探索を再び実行する。今度は6kサトシと5kサトシの2つのパートで成功した。</p>
</div>
<div class="paragraph">
<p>このMPPを使ったマルチラウンドの例は、<a href="#mpp_rounds">MPPで複数ラウンドで</a>支払いを送信するで紹介されています。</p>
</div>
<div id="mpp_rounds" class="imageblock">
<div class="content">
<img src="images/mtln_1210.png" alt="mtln 1210" />
</div>
<div class="title">図10.MPPによる複数ラウンドでの支払い送信</div>
</div>
<div class="paragraph">
<p>結局、セレーナのノードでは、経路探索を3回繰り返し、100万個のサトシを30回に分けて送信した。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_conclusion">結論</h3>
<div class="paragraph">
<p>この章では、経路探索と支払配送について見ました。送信者から受信者への経路を見つけるために、チャネルグラフを使用する方法を見ました。また、送信者がどのように候補の経路で支払いを配信しようとし、試行錯誤のループを繰り返すかを見ました。</p>
</div>
<div class="paragraph">
<p>また、チャネルの流動性の不確実性（送信者の視点）と、それが経路探索に 与える影響についても検討しました。不確実性を定量化し、確率論を使って有益な結論を導き出す方法について考察しました。また、成功した決済と失敗した決済の両方から学ぶことで、不確実性を低減する方法についても確認した。</p>
</div>
<div class="paragraph">
<p>最後に、今回新たに展開されたマルチパートペイメント機能により、支払いを分割して行うことで、大きな支払いでも成功確率を高めることができることを確認しました。</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
最終更新 2022-10-29 15:50:16 +0400
</div>
</div>
</body>
</html>