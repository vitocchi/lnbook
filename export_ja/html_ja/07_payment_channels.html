<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="generator" content="Asciidoctor 2.0.16" />
<title>決済チャネル</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700" />
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;-webkit-tap-highlight-color:transparent}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="payment_channels">決済チャネル</h2>
<div class="sectionbody">
<div class="paragraph">
<p>この章では、支払いチャネルに飛び込み、それらがどのように構築されるかを見ていきます。まず、アリスのノードがボブのノードにチャネルを開くところから始め、本書の冒頭で紹介した例に基づいて説明します。</p>
</div>
<div class="paragraph pagebreak-after">
<p>アリスとボブのノードによって交換されるメッセージは、<a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/02-peer-protocol.md">「BOLT #2: チャネル管理のためのピアプロトコル</a>」で定義されています。アリスとボブのノードによって作成されるトランザクションは、<a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/03-transactions.md">「BOLT #3: Bitcoin Transaction and Script Formats</a>」で定義されています。この章では、ライトニングプロトコルアーキテクチャの「チャネルの開閉」と「チャネルステートマシン」の部分に焦点を当て、<a href="#LN_protocol_channel_highlight">ライトニングプロトコルスイートのペイメントチャネルの</a>中央（ピアツーピア層）にあるアウトラインで強調されています。</p>
</div>
<div id="LN_protocol_channel_highlight" class="imageblock">
<div class="content">
<img src="images/mtln_0701.png" alt="Payment channels in the Lightning protocol suite" />
</div>
<div class="title">図1.Lightningプロトコルスイートにおける決済チャネル</div>
</div>
<div class="sect2">
<h3 id="_a_different_way_of_using_the_bitcoin_system">ビットコインのシステムの異なる利用方法</h3>
<div class="paragraph">
<p>ライトニングネットワークは、しばしば「レイヤー2ビットコインプロトコル」と表現され、ビットコインとは一線を画しているように聞こえます。ライトニングを別の言葉で表現すると、"ビットコインをよりスマートに使う方法"、あるいは単に "ビットコインの上にあるアプリケーション "ということになる。それを探ってみましょう。</p>
</div>
<div class="paragraph">
<p>歴史的に、ビットコインの取引は、すべての人にブロードキャストされ、ビットコインのブロックチェーンに記録されることで有効とみなされます。しかし、これから見るように、誰かがそのビットコインを使う独占的な能力を与える2-of-2マルチシグ出力を使うプレサインのビットコイン取引を保持している場合、その取引をブロードキャストしなくても事実上そのビットコインを所有していることになります。</p>
</div>
<div class="paragraph">
<p>プリサインのビットコイン取引は、いつでも現金化できる日付指定の小切手（または小切手）のようなものだと考えることができます。しかし、従来の銀行システムとは異なり、このトランザクションは支払いの「約束」（IOUとしても知られています）ではなく、現金と同等の検証可能な無記名式商品です。取引で参照されるビットコインが償還時（または小切手を「現金化」しようとした時）にすでに使用されていない限り、ビットコインのシステムは、この事前署名された取引がいつでもブロードキャストされ記録できることを保証しているのです。もちろん、これは署名された取引がこれだけである場合にのみ当てはまります。ライトニング・ネットワークでは、このような事前署名された取引が2つ以上同時に存在するため、本章でも学ぶように、検証可能な無記名証券の機能を維持するためには、より高度なメカニズムが必要です。</p>
</div>
<div class="paragraph">
<p>ライトニングネットワークは、ビットコインを使用するための異なる創造的な方法です。ライトニングネットワークでは、記録された（オンチェーン）取引と、署名されているが保留されている（オフチェーン）取引の組み合わせが、より速く、安く、よりプライベートなビットコインの使用方法である支払いの「層」を形成しています。このオンチェーンとオフチェーンのビットコイン取引の関係は、<a href="#on_off_chain">オンチェーンとオフチェーンの取引で構成されるライトニング決済</a>チャネルで確認することができます。</p>
</div>
<div id="on_off_chain" class="imageblock">
<div class="content">
<img src="images/mtln_0702.png" alt="Lightning payment channel made of on-chain and off-chain transactions" />
</div>
<div class="title">図2.オンチェーン取引とオフチェーン取引で構成されるライトニング決済チャネル</div>
</div>
<div class="paragraph">
<p>ライトニングはビットコインです。ビットコインのシステムの使い方が違うだけです。</p>
</div>
</div>
<div class="sect2">
<h3 id="_bitcoin_ownership_and_control">ビットコインの所有と管理</h3>
<div class="paragraph">
<p>支払いチャネルを理解する前に、少し下がって、ビットコインにおける所有権と支配権の仕組みを理解する必要があります。</p>
</div>
<div class="paragraph">
<p>誰かがビットコインを「所有」していると言うとき、それは通常、いくつかの未使用の取引出力を持つビットコインアドレスの秘密鍵を知っていることを意味します（<a href="#bitcoin_fundamentals_review">[bitcoin_fundamentals_review]</a>を参照）。この秘密鍵によって、彼らはビットコインを別のアドレスに転送して使用するための取引に署名することができます。ビットコインでは、ビットコインの「所有権」は、そのビットコインを<em>使用する能力として</em>定義することができます。</p>
</div>
<div class="paragraph">
<p>ビットコインで使われる「所有権」という用語は、法的な意味で使われる「所有権」とは異なることに留意してください。秘密鍵を持ち、ビットコインを使うことができる泥棒は、法律上の所有者ではないにもかかわらず、そのビットコインの<em>事実上の所有</em>者である。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">チップ</div>
</td>
<td class="content">
<div class="paragraph">
<p>ビットコインの所有権とは、鍵の管理と、その鍵を使ってビットコインを使う能力だけです。ビットコインの有名な格言にあるように"あなたの鍵、あなたのコイン-あなたの鍵、あなたのコインではない"。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_diversity_of_independent_ownership_and_multisig">独立系）オーナーの多様性とマルチシグマ</h4>
<div class="paragraph">
<p>秘密鍵の所有権や管理権は、必ずしも一人の人間の手にあるわけではありません。ここが面白くて複雑なところです。同じ秘密鍵を複数の人が知るようになることは、盗難や、元の鍵の持ち主がコピーを作って他の人に渡すことによっても起こり得ます。これらの人々はすべて所有者なのでしょうか。なぜなら、秘密鍵を知っている人のうちの誰かが、他の人の承認なしにビットコインを使うことができるからです。</p>
</div>
<div class="paragraph">
<p>また、ビットコインにはマルチシグネチャアドレスがあり、支出前に複数の秘密鍵で署名する必要がある（<a href="#multisig">[multisig]</a>を参照）。実用的な観点から、マルチシグネチャアドレスにおける所有権は、<em>K-of-N</em> スキームで定義される定足数<em>(K</em>) と合計<em>(N</em>) に依存する。1-of-10方式では、10人<em>（N</em>）の署名者のうち1人<em>（K</em>）がそのアドレスにロックされたビットコインの金額を使うことができるようになる。これは、10人が同じ秘密鍵のコピーを持っていて、そのうちの誰かが独立してそれを使うことができる、というシナリオに似ている。</p>
</div>
</div>
<div class="sect3">
<h4 id="_joint_ownership_without_independent_control">独立した支配を伴わない共同所有</h4>
<div class="paragraph">
<p>また、<em>誰も</em>クォーラムを持っていないシナリオもある。ライトニング・ネットワークで使われているような2-of-2方式では、どちらの署名者も相手から署名を得なければビットコインを使うことができない。この場合、ビットコインは誰のものになるのでしょうか。誰もコントロールできないので、本当の所有者はいません。しかし、その決定には両方の投票が必要です。ビットコインでも法律でも、2-of-2方式の重要な問題（シャレ）は、当事者の1人が利用できない場合、または投票が行き詰まり、当事者の1人が協力を拒否した場合にどうなるか、ということです。</p>
</div>
</div>
<div class="sect3">
<h4 id="_preventing_locked_and_un_spendable_bitcoin">ビットコインの「ロック」「使えない」を防止するために</h4>
<div class="paragraph">
<p>2of2マルチシグの2人の署名者のうち、1人が署名できないか、署名をしない場合、 資金は使用できなくなる。このシナリオは偶然に起こりうる(鍵の紛失)だけでなく、どちらかの当事者による脅迫の一形態として使用することができる。「資金の一部を支払ってくれないと署名しない」。</p>
</div>
<div class="paragraph">
<p>ライトニングの決済チャネルは、2-of-2のマルチシグアドレスをベースにしており、2つのチャネルパートナーがマルチシグの署名者として存在します。現時点では、チャネルは2つのチャネルパートナーのうちの1つによってのみ資金が供給されます。チャネルを「開く」ことを選択すると、2-of-2マルチシグアドレスに取引で資金を預けることになります。その取引が採掘され、資金がmultisigに入ると、ビットコインを使うにはチャネルパートナーの署名（も）が必要なので、チャネルパートナーの協力なしには資金を取り戻せません。</p>
</div>
<div class="paragraph">
<p>次のセクションでは、ライトニングチャネルの開設（作成）方法を見ながら、チャネル内のピアが所有するビットコインの量をエンコードした出力の1つをチャネル内で独占的に使用できるようにマルチシグ出力を使用する事前署名トランザクションの助けを借りて、チャネル構築に公平なプロトコルを実装することによって、資金損失や2つのパートナー間の脅迫シナリオを防ぐ方法を説明します。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_constructing_a_payment_channel">ペイメントチャネルの構築</h3>
<div class="paragraph">
<p><a href="#what_is_payment_channel">what_is_payment_channel]</a>では、2つのLightningノード間の<em>金融関係として</em>、2つのチャネルパートナーから2-of-2マルチシグネチャアドレスを資金調達することによって確立される支払いチャネルについて説明しました。</p>
</div>
<div class="paragraph">
<p>アリスがボブの店に直接接続できるような支払いチャネルを構築したい と仮定してみましょう。まず、2つのノード(アリスとボブのノード)は、お互いにインターネット接続を確立し、支払いチャネルを交渉できるようにしなければならない。</p>
</div>
<div class="sect3">
<h4 id="_node_private_and_public_keys">ノードの秘密鍵および公開鍵</h4>
<div class="paragraph">
<p>ライトニング・ネットワーク上のすべてのノードは、<em>ノード公開鍵によって</em>識別されます。公開鍵は特定のノードを一意に識別し、通常は 16 進数のエンコーディングで表示されます。例えば、René Pickhardt は現在 Lightning ノード (ln.rene-pickhardt.de) を運用しており、次のノード公開鍵で識別されます。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>02a1cebfacb2674143b5ad0df3c22c609e935f7bc0ebe801f37b8e9023d45ea7b8</pre>
</div>
</div>
<div class="paragraph">
<p>各ノードは、最初に初期化されたときにルート秘密鍵を生成します。この秘密鍵は常に非公開で（決して共有されない）、ノードのウォレットに安全に保管されます。この秘密鍵から、ノードはノードの識別子となる公開鍵を導き出し、ネットワークと共有する。鍵空間は膨大なので、各ノードが秘密鍵をランダムに生成する限り、一意の公開鍵を持つことになり、ネットワーク上で一意に識別することができる。</p>
</div>
</div>
<div class="sect3">
<h4 id="_node_network_address">ノードネットワークアドレス</h4>
<div class="paragraph">
<p>さらに、各ノードは到達可能なネットワークアドレスも、いくつかの可能なフォーマットのうちの1つで広告する。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">ティーケーピーアイピー</dt>
<dd>
<p>IPv4またはIPv6アドレスとTCPポート番号</p>
</dd>
<dt class="hdlist1">TCP/Tor</dt>
<dd>
<p>Torの "onion "アドレスとTCPポート番号</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>ネットワークアドレスの識別子は、Address:Portと表記され、Webなどで使用されているネットワーク識別子の国際標準と一致している。</p>
</div>
<div class="paragraph">
<p>例えば、ノード公開鍵02a1ceb...45ea7b8を持つRenéのノードは、現在そのネットワークアドレスをTCP/IPアドレスとして広告しています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>172.16.235.20:9735</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">チップ</div>
</td>
<td class="content">
<div class="paragraph">
<p>ライトニングネットワークのデフォルトのTCPポートは9735ですが、ノードは任意のTCPポートでリッスンすることを選択できます。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_node_identifiers">ノード識別子</h4>
<div class="paragraph">
<p>ノード公開鍵とネットワークアドレスを合わせて、@記号で区切って<em>NodeID@Address:Portという</em>形式で記述します。</p>
</div>
<div class="paragraph">
<p>したがって、Renéのノードの完全な識別子は次のようになります。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>02a1cebfacb2674143b5ad0df3c22c609e935f7bc0ebe801f37b8e9023d45ea7b8
@172.16.235.20:9735</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">チップ</div>
</td>
<td class="content">
<div class="paragraph">
<p>Renéのノードのエイリアスは ln.rene-pickhardt.de ですが、この名前は単に読みやすくするために存在します。各ノードオペレータは好きなエイリアスを発表でき、ノードオペレータが既に使われているエイリアスを選択できないようにする仕組みはありません。したがって、ノードを参照するには、<em>NodeID@Address:Port</em>スキーマを使用する必要があります。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>先行する識別子はQRコードで符号化されることが多く、ユーザーが自分のノードとそのアドレスで識別される特定のノードを接続したい場合に、スキャンしやすくなっています。</p>
</div>
<div class="paragraph">
<p>ビットコインノードと同様に、ライトニングノードは、ノード公開キーとネットワークアドレスを「ゴシップ」することで、ライトニングネットワーク上の存在を宣伝します。そうすることで、他のノードはそれらを見つけ、接続可能なすべての既知のノードのインベントリ（データベース）を保持し、ライトニングP2Pメッセージプロトコルで定義されているメッセージを交換することができます。</p>
</div>
</div>
<div class="sect3">
<h4 id="_connecting_nodes_as_direct_peers">ノードをDirect Peerとして接続する</h4>
<div class="paragraph">
<p>アリスのノードがボブのノードに接続するには、 ボブのノードの公開鍵、または公開鍵を含む完全なアドレス、 IPまたはTorアドレス、ポートが必要です。ボブは店を経営しているので、ボブのノードアドレスはウェブ上の請求書や店の支払いページから取得することができます。アリスはそのアドレスを含むQRコードをスキャンし、自分のノードにボブのノードに接続するように指示することができる。</p>
</div>
<div class="paragraph">
<p>アリスがボブのノードに接続すると、両者のノードは直接接続されたピアになります。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">チップ</div>
</td>
<td class="content">
<div class="paragraph">
<p>決済チャネルを開くには、まず2つのノードがインターネット（またはTor）経由で接続を開き、直接ピアとして接続する必要があります。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_constructing_the_channel">チャンネルの構築</h3>
<div class="paragraph">
<p>アリスとボブのライトニングノードが接続されたので、支払いチャネルを構築するプロセスを開始することができます。このセクションでは、<em>チャネル管理のためのライトニングピアプロトコルとして</em>知られている彼らのノード間の通信と、ビットコイン取引を構築するために使用する暗号化プロトコルを確認します。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">チップ</div>
</td>
<td class="content">
<div class="paragraph">
<p>このシナリオでは、2つの異なるプロトコルを説明します。まず、<em>メッセージプロ</em>トコルがあり、これはライトニングノードがインターネット上でどのように通信し、どのようなメッセージを互いに交換するかを確立します。2つ目は<em>暗号化プロ</em>トコルで、2つのノードがビットコイン<span class="keep-together">取引を</span>どのように構築し、署名するかを確立します。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="peer_protocol_channel_management">チャネル管理用ピアプロトコル</h4>
<div class="paragraph">
<p>Lightning Peer Protocol for Channel Management は、<a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/02-peer-protocol.md">BOLT #2: Peer Protocol for Channel Management</a> で定義されています。この章では、BOLT #2の「Channel Establishment」と「Channel Closing」のセクションをより詳細に確認します。</p>
</div>
</div>
<div class="sect3">
<h4 id="_channel_establishment_message_flow">チャネル確立メッセージの流れ</h4>
<div class="paragraph">
<p>チャンネル確立は，アリスとボブのノード間で，open_channel，accept_channel，funding_created，funding_signed，funding_locked，の6つのメッセージ（各ピアから3つ）の交換により達成される．この6つのメッセージは、<a href="#funding_message_flow">The channel establishment message flowに</a>時系列図として示されている。</p>
</div>
<div id="funding_message_flow" class="imageblock">
<div class="content">
<img src="images/mtln_0703.png" alt="The channel establishment message flow" />
</div>
<div class="title">図3.チャネル確立メッセージの流れ</div>
</div>
<div class="paragraph">
<p><a href="#funding_message_flow">チャネル確立のメッセージフローでは</a>、アリスとボブのノードは図の両側の縦線 "A" と "B" で表されています。このような時間順序図は、時間が下に流れ、メッセージが2つの通信相手の間を一方から他方へ流れる様子を示しています。線は、各メッセージの送信に必要な経過時間を表すために傾斜しており、メッセージの方向は各線の端にある矢印で示されている。</p>
</div>
<div class="paragraph">
<p>チャネルの確立には3つの部分があります。まず、2つのピアは彼らの能力と期待を伝えます。アリスは open_channel で要求を開始し、ボブは accept_channel でチャネル要求を受け付けます。</p>
</div>
<div class="paragraph">
<p>次に、Aliceは資金調達と返金トランザクションを構築し(このセクションで後述)、Bobにfunding_createdを送信する。払い戻し」トランザクションの別名は「コミットメント」トランザク ションで、これはチャンネル内の残高の現在の配分をコミットするためである。Bobは必要な署名をfunding_signedで送り返すことで応答する。このやりとりが、チャネルを安全にし、盗難を防ぐための<em>暗号プロトコルの</em>基礎となる。アリスは今、支払いチャネルを確立し固定化するために、資金取引を（オンチェーンで）ブロードキャストする。この取引はビットコインブロックチェーン上で確認される必要があります。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">チップ</div>
</td>
<td class="content">
<div class="paragraph">
<p>funding_signedメッセージの名前は少し紛らわしいかもしれません。このメッセージは資金調達取引の署名を含んでいません。むしろ、アリスがマルチシグからビットコインを取り戻すことを請求するための返金取引のボブの署名を含んでいます。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>取引に十分な確認があると(<code>accept_channel</code>メッセージの<code>minimum_depth</code>フィールドで定義される)、アリスとボブはfunding_lockedメッセージを交換し、チャネルは通常の動作モードに入る。</p>
</div>
<div class="sect4">
<h5 id="_the_open_channel_message">open_channel メッセージ</h5>
<div class="paragraph">
<p>アリスのノードは open_channel メッセージを送信して、ボブのノードとの支払いチャネルを要求します。このメッセージには、チャンネル設定に対するアリスの<em>期待に関する</em>情報が含まれており、ボブはこれを受け入れるか拒否することができる。</p>
</div>
<div class="paragraph">
<p>open_channelメッセージの構造（BOLT#2から引用）を<a href="#open_channel_message">The<code>open_channel</code>message</a>に示す。</p>
</div>
<div id="open_channel_message" class="exampleblock">
<div class="title">例1．<code>open_channel</code>メッセージ</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre>[chain_hash:chain_hash】。］
[32*バイト:temporary_channel_id]。
[u64:funding_satoshis]のようになります。
[u64:push_msat]です。
[u64:dust_limit_satoshis]を指定します。
[u64:max_htlc_value_in_flight_msat]のようになります。
[u64:チャンネルリザーブデータ] [u64:チャンネルリザーブデータ
[u64:htlc_minimum_msat]のようになります。
[u32:feerate_per_kw]のようになります。
[u16:to_self_delay]のようになります。
[u16:max_accepted_htlcs]のようになります。
[point:funding_pubkey]（ポイント：ファンディングパブキー
[ポイント:revocation_basepoint] (ポイント:リボケーションベースポイント)
ポイント:payment_basepoint] [ポイント:delayed_payment_basepoint
[ポイント:delayed_payment_basepoint] (ポイント:delayed_payment_basepoint)
[ポイント:htlc_basepoint] (ポイント:htlc_basepoint)
[ポイント:first_per_commitment_point] (ポイント:ファーストパーコミットメントポイント)
バイト:チャネルフラグ] [バイト:チャネルフラグ] [バイト:チャネルフラグ
[open_channel_tlvs:tlvs]のようになります。</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>このメッセージに含まれるフィールドは、アリスが望むチャネルパラメータと、 チャネルの動作に対するセキュリティの期待を反映したアリスのノードからの様々な構成 設定を指定します。</p>
</div>
<div class="paragraph pagebreak-before">
<p>水路の建設パラメータの一部を紹介します。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">チェーンハッシュ</dt>
<dd>
<p>これは、このチャンネルにどのブロックチェーン（例えば、ビットコインのメインネット）が使用されるかを特定します。通常、そのブロックチェーンの生成ブロックのハッシュです。</p>
</dd>
<dt class="hdlist1">funding_satoshis</dt>
<dd>
<p>アリスがチャネルの資金として使う金額で、チャネルの総容量となります。</p>
</dd>
<dt class="hdlist1">チャンネルリザーブサトシ</dt>
<dd>
<p>チャンネルの両サイドに確保される最低残高（サトシ単位）。これは、ペナルティーについて話すときに戻ってくるでしょう。</p>
</dd>
<dt class="hdlist1">プッシュムサット</dt>
<dd>
<p>チャンネルの資金調達時にアリスがボブに即座に「プッシュ」する金額 (オプション)。<em>この値を 0 以外にすると、チャネルパートナーに実質的にお金を渡すことになるので、 注意して使ってください。</em></p>
</dd>
<dt class="hdlist1">to_self_delay</dt>
<dd>
<p>プロトコルの非常に重要なセキュリティパラメータ。<code>open_channel</code>メッセージの値はレスポンダのコミットメントトランザク ションで、<code>accept_channelの</code>値はイニシエータのコミットメントトランザクション で使用される。この非対称性は、コミットメントトランザクションにおいて、相手側が資金を一方的に要求するのに必要な時間を表現するために存在する。もしBobがAliceの意思に反して一方的にチャネルを閉じた場合、Bobはここで 定義された遅延時間だけ自分の資金にアクセスしないことを約束する。この値が高いほど、アリスはより安全であるが、ボブはより長く彼の資金をロックされる可能性がある。</p>
</dd>
<dt class="hdlist1">funding_pubkey</dt>
<dd>
<p>このチャンネルを固定する2-of-2マルチシグにアリスが寄与する公開鍵。</p>
</dd>
<dt class="hdlist1">X_ベースポイント</dt>
<dd>
<p>マスターキー：コミットメント、リボケーション、ルーティング決済（HTLC）、クロージングトランザク ションの様々な部分の子キーを導き出すために使用される。これらは以降の章で使用され、説明される。</p>
</dd>
</dl>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">チップ</div>
</td>
<td class="content">
<div class="paragraph">
<p>本書で説明していない他のフィールドやLightningピアプロトコルメッセージを理解したい場合は、BOLT仕様書で調べることをお勧めします。これらのメッセージやフィールドは重要ですが、本書の範囲では十分に詳しく説明することができません。本書では、実際のプロトコル仕様（BOLT）を読んで詳細を確認できる程度に、基本原理を理解していただきたいと考えています。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_the_accept_channel_message">accept_channel メッセージ</h5>
<div class="paragraph">
<p>アリスからのopen_channelメッセージに対して、ボブは<a href="#accept_channel_message">The<code>accept_channel</code></a> messageに示すaccept_channelメッセージを返送します。</p>
</div>
<div id="accept_channel_message" class="exampleblock">
<div class="title">例2.<code>accept_channel</code>メッセージ</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre>[32*バイト:temporary_channel_id]。
[u64:dust_limit_satoshis]を指定します。
[u64:max_htlc_value_in_flight_msat]のようになります。
[u64:チャンネルリザーブサイズ] (日本語)
[u64:htlc_minimum_msat]のようになります。
[u32:最小深度] [u16:自己深度
[u16:to_self_delay]のようになります。
[u16:max_accepted_htlcs]のようになります。
[point:funding_pubkey]（ポイント：ファンディングパブキー
[ポイント:revocation_basepoint] (ポイント:リボケーションベースポイント)
ポイント:payment_basepoint] [ポイント:delayed_payment_basepoint
[ポイント:delayed_payment_basepoint] (ポイント:delayed_payment_basepoint)
[ポイント:htlc_basepoint] (ポイント:htlc_basepoint)
[point:first_per_commitment_point]（ポイント：ファーストパーコミットメントポイント）。
[accept_channel_tlvs:tlvs]のようになります。</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>見ての通り、これはopen_channelメッセージと同様で、Bobのノードの期待値と設定値が含まれています。</p>
</div>
<div class="paragraph">
<p>アリスが支払いチャネルを構築するために使用する accept_channel の 2 つの最も重要なフィールドは、次のとおりです。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">funding_pubkey</dt>
<dd>
<p>公開鍵Bobのノードは、チャネルを固定する2-of-2のマルチシグアドレスのために貢献する。</p>
</dd>
<dt class="hdlist1">最小深度</dt>
<dd>
<p>Bobのノードが、チャネルを「オープン」にして使用する準備ができたとみなす前に、資金取引について期待する確認の数。</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_funding_transaction">資金調達の取引</h4>
<div class="paragraph">
<p>アリスのノードがボブの accept_channel メッセージを受信すると、ビットコインブロックチェーンにチャネルを固定する<em>資金取引を</em>構築するために必要な情報を得ます。以前の章で説明したように、ライトニング決済チャネルは2対2のマルチシグネチャアドレスで固定されています。まず、資金取引（および後に説明する返金取引）を構築するために、そのマルチシグネチャアドレスを生成する必要があります。</p>
</div>
</div>
<div class="sect3">
<h4 id="_generating_a_multisignature_address">マルチシグネチャーのアドレスを生成する</h4>
<div class="paragraph">
<p>資金取引は、ある量のビットコイン（open_channelメッセージのfunding_satoshis）を、AliceとBobのfunding_pubkey公開鍵から構築される2-of-2多重署名出力に送信する。</p>
</div>
<div class="paragraph">
<p>Aliceのノードでは、次のようにマルチシグネチャのスクリプトを構築します。</p>
</div>
<pre data-type="programlisting">2 &lt;<em>Alice_funding_pubkey&gt;</em>&lt;<em>Bob_funding_pubkey&gt;</em> 2 CHECKMULTISIG
</pre>
<div class="paragraph">
<p>実際には、資金調達のための鍵は、証人のスクリプトに格納される前に、(公開鍵を直列化した圧縮形式の辞書順を使用して)決定論的に<em>ソート</em>されることに注意してほしい。この並べ替えの順番に前もって合意しておくことで、両当事者が同一の資金取引出力を構築し、交換されたコミットメント取引署名によって署名されることを保証する。</p>
</div>
<div class="paragraph">
<p>このスクリプトは、Pay-to-Witness-Script-Hash（P2WSH）ビットコインアドレスとしてエンコードされており、以下のような形になっています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>bc1q89ju02heg32yrqdrnqghe6132wek25p6sv6e564znvrvez7tq5zqt4dn02</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_constructing_the_funding_transaction">資金調達取引の構築</h4>
<div class="paragraph">
<p>アリスのノードはこれで資金取引を構築し、ボブと合意した金額<code>(funding_satoshis</code>)を 2-of-2 multisigアドレスに送信することができる。funding_satoshisが140,000で、アリスが200,000 satoshiの出力を使い、60,000 satoshiの釣りを作ると仮定してみましょう。取引は次のようになります。<a href="#A_B_funding_Tx">アリスが資金取引を構築</a>します。</p>
</div>
<div id="A_B_funding_Tx" class="imageblock">
<div class="content">
<img src="images/mtln_0704.png" alt="Alice constructs the funding transaction" />
</div>
<div class="title">図4.アリスは資金調達のトランザクションを構築する</div>
</div>
<div class="paragraph">
<p>アリスはこの取引を<em>ブロードキャストしない</em>。ブロードキャストすると14万サトシが危険にさらされるからである。一旦2-of-2マルチシグに使われると、アリスはボブの署名なしにお金を回収することはできない。</p>
</div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">二重資金による支払いチャネル</div>
<div class="paragraph">
<p>ライトニングの現在の実装では、チャネルは、チャネルを開始したノード（この例ではアリス）によってのみ資金が提供されます。デュアルファンデッドチャネルは提案されていますが、まだ実装されていません。デュアルファンデッドチャネルでは、アリスとボブの両方がファンディングトランザクションにインプットを提供することになります。デュアルファンデッドチャネルは、少し複雑なメッセージフローと暗号化プロトコルを必要とするため、まだ実装されていませんが、ライトニングBOLTの将来のアップデートで計画されています。<code>c-lightningの</code>実装には、デュアルファンデッドチャネルの変種の実験版が含まれています。</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_holding_signed_transactions_without_broadcasting">ブロードキャストせずに署名したトランザクションを保持する</h4>
<div class="paragraph">
<p>ライトニングを可能にするビットコインの重要な特徴は、トランザクションを構築して署名することはできても、それをブロードキャストすることはできないことです。取引はあらゆる点で<em>有効</em>ですが、ビットコインのブロックチェーン上でブロードキャストされ確認されるまでは認識されず、その出力はブロックチェーン上に作成されていないため使用することができません。ライトニングネットワークではこの能力を何度も使用します。アリスのノードは資金取引を構築する際にこの能力を使用します：それを保持し、まだブロードキャストしないことです。</p>
</div>
</div>
<div class="sect3">
<h4 id="_refund_before_funding">資金調達前の払い戻し</h4>
<div class="paragraph">
<p>資金の損失を防ぐために、アリスはうまくいかなかったときに払い戻しを受ける方法があるまで、自分のビットコインを2-of-2に入れることができません。基本的に、彼女はこの取り決めに入る前に、チャネルからの「出口」を計画しなければなりません。</p>
</div>
<div class="paragraph">
<p>"プリナップ "とも呼ばれる婚前契約書の法的構成について考えてみましょう。二人が婚姻関係を結ぶと、彼らの金銭は法律で拘束されます（司法権により異なる）。結婚に入る前に、彼らは離婚によって結婚を解消する場合、彼らの資産を分離する方法を指定する契約を締結することができます。</p>
</div>
<div class="paragraph">
<p>ビットコインでも同様の合意を作ることができます。例えば 返金取引を作ることができます これは婚前交渉のように機能します 当事者は資金が実際にマルチシグネチャーの資金調達アドレスに ロックされる前に そのチャンネルの資金をどう分けるかを決めることができます</p>
</div>
</div>
<div class="sect3">
<h4 id="_constructing_the_presigned_refund_transaction">プリサイン・リファンド・トランザクションの構築</h4>
<div class="paragraph">
<p>Aliceは資金調達トランザクションを構築した(ブロードキャストしない)後すぐに、払い 戻しトランザクションを構築する。リファンドトランザクションは、2-of-2<span class="keep-together">マルチシグを</span>アリスのウォレットに戻すために費やす。この払い戻しトランザクションは、チャンネル残高を公平に分配することを両方のチャンネルパートナーに約束させるので、<em>コミットメントトランザクションと</em>呼ぶ。Aliceは自分でチャンネルに資金を供給したので、彼女は残高をすべて手に入れ、AliceとBobの両方がこのトランザクションでAliceに払い戻すことを約束する。</p>
</div>
<div class="paragraph">
<p>実際には、この後の章で見るようにもう少し複雑ですが、今は単純にして、<a href="#A_B_fund_refund_Tx">Aliceも返金トランザクションを構築して</a>いるように見えると仮定しましょう。</p>
</div>
<div id="A_B_fund_refund_Tx" class="imageblock">
<div class="content">
<img src="images/mtln_0705.png" alt="Alice also constructs the refund transaction" />
</div>
<div class="title">図5.アリスはまた、払い戻しトランザクションを構築する</div>
</div>
<div class="paragraph">
<p>この章の後半では、より多くのコミットメント取引を行うことで、チャネルの残高を異なる金額で分配する方法について説明します。</p>
</div>
</div>
<div class="sect3">
<h4 id="_chaining_transactions_without_broadcasting">ブロードキャストせずにトランザクションを連鎖させる</h4>
<div class="paragraph">
<p>これで、アリスは<a href="#A_B_fund_refund_Tx">払い戻し</a>取引を構築したことになります。しかし、どうしてこんなことが可能なのか不思議に思うかもしれません。  アリスは資金提供の取引をビットコインブロックチェーンにブロードキャストしていません。ネットワーク上の誰もが知る限り、その取引は存在しない。払い戻し取引は、資金調達取引のアウトプットの1つを<em>使う</em>ように構築されていますが、そのアウトプットもまだ存在していません。ビットコインのブロックチェーン上で確認されていないアウトプットをどのように使うことができるのでしょうか。</p>
</div>
<div class="paragraph">
<p>払い戻し取引は、まだ有効な取引ではありません。有効なトランザクションになるためには、2つのことが必要です。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>資金調達取引は、ビットコインネットワークにブロードキャストされなければなりません。(ライトニングネットワークのセキュリティを確保するため、ビットコインのブロックチェーンで確認されることも要求されますが、これは<span class="keep-together">取引の</span>連鎖に厳密には必要ありません)。</p>
</li>
<li>
<p>払い戻しトランザクションの入力には、アリスとボブの署名が必要である。</p>
</li>
</ul>
</div>
<div class="paragraph pagebreak-before">
<p>しかし、これら2つのことが起こっていなくても、またアリスのノードが資金取引をブロードキャストしていなくても、彼女は払い戻し取引を構築することができる。なぜなら、資金取引のハッシュを計算し、それを払い戻し取引の入力として参照することができるからである。</p>
</div>
<div class="paragraph">
<p>アリスが資金取引のハッシュとして6da3c2...387710を計算したことに気づいただろうか。資金調達取引がブロードキャストされるとき、そのハッシュは資金調達 取引の取引IDとして記録される。したがって、資金取引の<code>0</code>出力（2-of-2アドレス出力）は、出力ID 6da3c2...387710:0 として参照されることになる。アリスはその識別子が確認されたらどうなるか知っているので、払い戻し取引はまだ存在しないが、その資金調達取引の出力を使うように構築することができる。</p>
</div>
<div class="paragraph">
<p>つまり、アリスはまだ存在しない出力を参照することで、資金調達取引が確認されれば参照が有効になり、返金取引も有効になることを知って、連鎖した取引を作成することができるのです。次のセクションで説明するように、ブロードキャストされる前に取引を連鎖させるこの「トリック」は、2017年の8月に導入されたビットコインの非常に重要な機能を必要とします。<em>分離型証人（Segregated Witness</em>）」です。</p>
</div>
</div>
<div class="sect3">
<h4 id="_solving_malleability_segregated_witness">可解性を解決する（分離型ウィットネス）</h4>
<div class="paragraph">
<p>アリスは、確認前に資金調達取引の取引IDが判明していることに依存しなければならない。しかし、2017年8月にSegWit（Segregated Witness）が導入される以前は、これではアリスを守るには不十分でした。トランザクションIDに署名（証人）が含まれる形でトランザクションが構築されていたため、第三者（例えば、ボブ）がトランザクションIDを<em>マレに</em>した（変更した）別バージョンをブロードキャストすることが可能だったのです。これは<em>トランザクションの不正コピー</em>と呼ばれ、SegWit以前はこの問題により無期限の決済チャネルを安全に実装することが困難であった。</p>
</div>
<div class="paragraph">
<p>もしボブがアリスの資金取引を確認される前に変更し、異なる取引IDを持つ複製を作ることができれば、ボブはアリスの返金取引を無効にして彼女のビットコインをハイジャックすることができます。アリスは資金を放出するための署名を得るためにボブの言いなりになり、簡単に脅迫されることになります。ボブは資金を盗むことはできませんが、アリスが資金を取り戻すのを阻止することはできます。</p>
</div>
<div class="paragraph">
<p>SegWitの導入により、未確認の取引IDは第三者から見て不変となった。つまり、アリスは資金調達取引の取引IDが変更されないことを確信できるのである。その結果、アリスは返金取引にボブの署名があれば、自分の金を回収する方法があると確信できるようになった。彼女は今、自分の資金をマルチシグにロックする前に、ビットコインの「婚前契約」に相当するものを実行する方法を手に入れたのである。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">チップ</div>
</td>
<td class="content">
<div class="paragraph">
<p>アリスが作成し署名したトランザクションをボブがどうやって変更(malleate)できるのか不思議に思ったかもしれません。ボブは確かにアリスの秘密鍵を持っていません。しかし、メッセージに対するECDSA署名は一意ではない。有効なトランザクションに含まれる）署名を知ることで、有効でありながら多くの異なる外見の署名を作成することができる。SegWitがトランザクションダイジェストアルゴリズムから署名を削除する前、ボブは署名を別のトランザクションIDを生成する同等の有効な署名に置き換え、資金調達トランザクションと返金トランザクションの間の連鎖を断ち切ることができる。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_the_funding_created_message">funding_created メッセージ</h5>
<div class="paragraph">
<p>アリスが必要なトランザクションを構築したので、チャネル構築のメッセー ジフローは続く。アリスはfunding_createdメッセージをボブに送信します。このメッセージの内容はここで見ることができます。</p>
</div>
<div id="funding_created_message" class="listingblock">
<div class="title">funding_created メッセージ</div>
<div class="content">
<pre>[32*バイト:temporary_channel_id]。
[sha256:funding_txid]を参照してください。
[u16:funding_output_index]を参照してください。
[signature:シグネチャー](署名)</pre>
</div>
</div>
<div class="paragraph">
<p>このメッセージで、アリスはボブに、支払いチャネルを固定する資金取引に関する重要な情報を与える。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">funding_txid</dt>
<dd>
<p>資金調達取引のトランザクションID（TxID）であり、チャネルが確立された後にチャネルIDを作成するために使用される。</p>
</dd>
<dt class="hdlist1">資金調達出力インデックス</dt>
<dd>
<p>これは出力インデックスであり、したがってボブは、トランザク ションのどの出力(例えば、出力<code>0</code>)がアリスによって資金提供された 2of-2のマルチシグ出力であるかを知る。これはまた、チャネルIDを形成するために使用される。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>最後に、AliceはAliceの<code>funding_pubkeyに</code>対応し、2-of-2マルチシグから支出する ために使用される署名も送信する。これはBobによって必要とされる。なぜなら、Bobは彼自身のコミットメント トランザクションを作成する必要があるからである。そのコミットメントトランザクションはアリスからの署名を必要とし、アリスはそれを彼に提供する。アリスとボブのコミットメントトランザクションはわずかに異なっており、したがって署名も異なっていることに注意。相手のコミットメントトランザクションがどのようなものかを知ることは、有効な署名を提供するためのプロトコルの一部であり、非常に重要です。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">チップ</div>
</td>
<td class="content">
<div class="paragraph">
<p>Lightningプロトコルでは、ノードが署名されたトランザクション全体ではなく、署名を送信しているのをよく見かけます。これは、どちらの側でも同じトランザクションを再構築できるため、署名のみが有効である必要があるためです。トランザクション全体ではなく、署名のみを送信することで、多くのネットワーク帯域幅を節約することができます。</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_the_funding_signed_message">funding_signedのメッセージ</h5>
<div class="paragraph">
<p>アリスからfunding_createdメッセージを受け取った後、ボブはfunding transaction IDとoutput indexを知る。チャネルIDは資金取引IDと出力インデックスのビットごとの排他的論理和(XOR)で作られる。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>channel_id = funding_txid XOR funding_output_index</pre>
</div>
</div>
<div class="paragraph">
<p>より正確には、ファンディングUTXOの32バイト表現である<code>channel_idは</code>、ファンディングTxIDの下位2バイトとファンディング出力のインデックスをXORすることで生成されます。</p>
</div>
<div class="paragraph">
<p>BobはAliceに、2-of-2マルチシグを形成したBobの<code>funding_pubkeyに</code>基づく、返金取引のための彼の署名を送る必要があります。Bobはすでに彼のローカル返金取引を持っているが、これによってAliceは必要なすべての署名で返金取引を完了し、何か問題が起こった場合に彼女のお金が返金可能であることを確認することができる。</p>
</div>
<div class="paragraph">
<p>Bobはfunding_signedメッセージを作成し、Aliceに送信する。ここで、このメッセージの内容を見てみましょう。</p>
</div>
<div id="funding_signed_message" class="listingblock">
<div class="title">funding_signedのメッセージ</div>
<div class="content">
<pre>[チャンネルID:チャンネルID]
[シグネチャ:シグネチャ]</pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_broadcasting_the_funding_transaction">資金調達取引のブロードキャスト</h4>
<div class="paragraph">
<p>Bobからfunding_signedメッセージを受け取ると、Aliceは返金処理に署名するために必要な両方の署名を持つことになる。彼女の「出口計画」は安全なので、彼女は資金がロックされるのを恐れずに資金取引をブロードキャストすることができます。もし何か問題があれば、アリスは単に返金トランザクションをブロードキャストして、ボブからそれ以上の助けを得ることなく、お金を取り戻すことができる。</p>
</div>
<div class="paragraph">
<p>アリスは今、ブロックチェーンに採掘できるように、ビットコインネットワークに資金取引を送信する。アリスとボブはこの取引を監視し、ビットコインブロックチェーン上で最小深度の確認（例えば6回の確認）を待つことになる。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">チップ</div>
</td>
<td class="content">
<div class="paragraph">
<p>もちろんアリスはビットコインプロトコルを使って、ボブが送ってきた署名が本当に有効かどうかを検証します。このステップはとても重要です。もし何らかの理由でボブがアリスに不正なデータを送っていたら、彼女の「出口計画」は妨害されることになります。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_the_funding_locked_message">funding_lockedのメッセージ</h5>
<div class="paragraph">
<p>資金取引が必要な確認回数に達するとすぐに、アリスとボブはお互いにfunding_lockedメッセージを送信し、チャンネルは使用可能な状態になります。</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sending_payments_across_the_channel">チャネルをまたぐ決済の送信</h3>
<div class="paragraph">
<p>チャネルは設定されましたが、初期状態では、すべての容量(14万サトシ)がアリス側にあります。つまり、アリスはチャンネルを越えてボブに支払いを送ることができますが、ボブはまだアリスに送る資金を持っていません。</p>
</div>
<div class="paragraph">
<p>次のいくつかのセクションでは、支払いチャネル全体でどのように支払いが行われ、<em>チャネルの状態が</em>どのように更新されるかを紹介します。</p>
</div>
<div class="paragraph">
<p>アリスがボブのコーヒーショップで会計をするために、ボブへ70,000サトシを送金したいと仮定します。</p>
</div>
<div class="sect3">
<h4 id="_splitting_the_balance">残高を分割する</h4>
<div class="paragraph">
<p>原理的には，アリスからボブに支払いを送ることは，単にチャネルの残高を再分配することである．支払いが送られる前、アリスは14万サトシを持ち、ボブは何も持っていません。7万サトシの支払いが送られた後、アリスは7万サトシを持ち<span class="keep-together">、ボ</span>ブは7万サトシを持っています。</p>
</div>
<div class="paragraph">
<p>したがって、アリスとボブがしなければならないのは、2of2マルチシグを2つの出力に費やし、アリスとボブに対応する残高を支払う取引を作成し、署名することだけである。この更新されたトランザクションを<em>コミットメントトランザク ションと</em>呼ぶ。</p>
</div>
<div class="paragraph">
<p>アリスとボブは、一連のコミットメントによって<em>チャネル状態を</em>進めることで、支払チャネルを操作する。各コミットメントは、チャネルを渡って流れてきた支払いを反映するために残高を更新する。アリスとボブの両方は、チャネルを更新するために新しいコミットメントを開始することができます。</p>
</div>
<div class="paragraph">
<p><a href="#competing_commitments_1">Multiple commitment transactionsでは</a>、複数のコミットメントトランザクションを見ることができます。</p>
</div>
<div class="paragraph">
<p><a href="#competing_commitments_1">複数のコミットメント</a>・トランザクションに示されている最初のコミットメント・トランザクションは、Aliceがチャンネルに資金を供給する前に構築した払い戻しトランザクションです。図では、これはコミットメント#0です。アリスがボブに7万サトシを支払った後、新しいコミットメント取引（コミットメント＃1）には、アリスとボブにそれぞれの残高を支払う2つの出力があります。続く2つのコミットメントトランザクション（コミットメント#2、コミットメント#3）は、アリスがボブにそれぞれ1万サトシ、2万サトシを追加で支払うことを表しています。</p>
</div>
<div class="paragraph">
<p>署名され有効なコミットメントトランザクションは、ビットコインネットワークにブロードキャストすることでチャネルを閉じるために、いつでもチャネルパートナーのどちらかが使用することができます。両者は最新のコミットメントトランザクションを持っており、いつでもそれを使うことができるので、それをブロードキャストせずにそのまま保持することもできます。これは、チャネルからの公正な退出を保証するものです。</p>
</div>
<div id="competing_commitments_1" class="imageblock">
<div class="content">
<img src="images/mtln_0706.png" alt="Multiple commitment transactions" />
</div>
<div class="title">図6.複数のコミットメント・トランザクション</div>
</div>
</div>
<div class="sect3">
<h4 id="_competing_commitments">競合するコミットメント</h4>
<div class="paragraph">
<p>アリスとボブが複数のコミットメント・トランザクションを持ち、それらがすべて資金取引からの同じ2-of-2出力を使おうとしているのはどうしたことかと思うかもしれません。これらのコミットメント・トランザクションは矛盾していないのでしょうか？これはビットコインのシステムが防ぐべき「二重消費」ではないのでしょうか？</p>
</div>
<div class="paragraph">
<p>確かにそうですねー。実は、ライトニングを機能させるために、ビットコインの二重消費を<em>防止</em>する機能に頼っています。アリスとボブがいくらコミットメント取引を構築して署名しても、実際に確認されるのはそのうちの1つだけです。</p>
</div>
<div class="paragraph">
<p>アリスとボブがこれらのトランザクションを保持し、ブロードキャストしない限り、資金出力は消費されない。しかし、コミットメント取引がブロードキャストされ確認されると、それは資金出力を使ってしまうことになります。もしアリスかボブが複数のコミットメント取引をブロードキャストしようとすると、そのうちの一つだけが確認され、他のものは二重支出の試み（そして失敗）として拒否される。</p>
</div>
<div class="paragraph">
<p>複数のコミットメント・トランザクションがブロードキャストされた場合、どちらが先に確認されるかを決定する要因はたくさんあります：含まれる手数料の額、これらの競合するトランザクションの伝搬速度、ネットワークトポロジーなどです。基本的には、結果が予測できない競争になるのです。それはあまり安全とは言えません。誰かが不正をしそうな気がします。</p>
</div>
</div>
<div class="sect3">
<h4 id="_cheating_with_old_commitment_transactions">古いコミットメントトランザクションを使った不正行為</h4>
<div class="paragraph">
<p><a href="#competing_commitments_1">複数の</a>コミットメント・トランザクションの中のコミットメント・トランザクションをもっと注意深く見てみましょう。4つのコミットメント・トランザクションはすべて署名され、有効です。しかし、最後の1つだけが、最新のチャンネル残高を正確に反映しています。この特別なシナリオでは、アリスは古いコミットメントをブロードキャストし、ビットコインのブロックチェーン上で確認させることで不正を行う機会があります。例えば、アリスがコミットメント#0を送信し、それが確認されたとしましょう。彼女は事実上チャンネルを閉じ、14万サトシをすべて自分で手に入れることになります。実際、この例ではコミットメント#3以外のコミットメントはアリスの立場を向上させ、チャンネルに反映された支払いの少なくとも一部を「キャンセル」できるようにします。</p>
</div>
<div class="paragraph">
<p>次のセクションでは、ライトニングネットワークがこの問題をどのように解決しているか、つまり、失効とペナルティのメカニズムによって、古いコミットメントトランザクションがチャネルパートナーによって使用されるのを防止していることを確認します。古いコミットメントトランザクションの送信を防止する方法は、eltooチャンネルなど他にもありますが、入力リバインディング（<a href="#bitcoin_prot_17">[bitcoin_prot_17]</a>を参照）というビットコインのアップグレードが必要です。</p>
</div>
</div>
<div class="sect3">
<h4 id="_revoking_old_commitment_transactions">旧コミットメント・トランザクションの取り消し</h4>
<div class="paragraph">
<p>ビットコインの取引には有効期限がなく、"キャンセル "することはできません。また、一度流れたものを止めたり、検閲したりすることもできない。では、他人が持っている、すでに署名済みの取引を「取り消す」ためにはどうすればいいのでしょうか。</p>
</div>
<div class="paragraph">
<p>Lightning で使用されているソリューションは、公正なプロトコルのもう一つの例です。トランザクションをブロードキャストする能力を制御しようとする代わりに、古いコミットメントトランザクションを送信することが不正行為者の最善の利益にならないことを保証する<em>ペナルティメカニズムが</em>組み込まれている。彼らはいつでもそれをブロードキャストできるが、そうすればほとんどの場合損をすることになる。</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">チップ</div>
</td>
<td class="content">
<div class="paragraph">
<p>リボーク」という言葉は、古いコミットメントが何らかの形で無効となり、ブロードキャストや確認ができなくなることを意味するため、誤った表現となります。しかし、有効なビットコイン取引は取り消すことができないので、これはそうではありません。その代わり、ライトニングプロトコルでは、古いコミットメントをブロードキャストしたチャネルパートナーを罰するためのペナルティメカニズムを使用しています。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Lightningプロトコルの失効とペナルティの仕組みを構成する要素は3つある。</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">非対称的コミットメント取引</dt>
<dd>
<p>アリスのコミットメント取引は、ボブの持つ取引と若干異なる。</p>
</dd>
<dt class="hdlist1">支出の遅延</dt>
<dd>
<p>コミットメント取引を行っている相手方への支払いは遅延（タイムロック）しますが、相手方への支払いは即時請求が可能です。</p>
</dd>
<dt class="hdlist1">失効キー</dt>
<dd>
<p>古いコミットメントに対するペナルティオプションの解除に使用されます。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>この3つの要素について、順を追って見ていきましょう。</p>
</div>
</div>
<div class="sect3">
<h4 id="_asymmetric_commitment_transactions">非対称型コミットメント取引</h4>
<div class="paragraph">
<p>AliceとBobは少し異なるコミットメントトランザクションを保持しています。<a href="#competing_commitments_1">複数のコミットメント・トランザクションから</a>、コミットメント・<a href="#commitment_2">トランザクション</a>#2で具体的に見てみましょう。</p>
</div>
<div id="commitment_2" class="imageblock">
<div class="content">
<img src="images/mtln_0707.png" alt="Commitment transaction #2" />
</div>
<div class="title">図7.コミットメント・トランザクション#2</div>
</div>
<div class="paragraph">
<p>アリスとボブは、<a href="#asymmetric_1">非対称コミットメント取引で</a>説明されているように、この取引の2つの異なるバリエーションを持っています。</p>
</div>
<div id="asymmetric_1" class="imageblock">
<div class="content">
<img src="images/mtln_0708.png" alt="Asymmetric commitment transactions" />
</div>
<div class="title">図8.非対称コミットメント取引</div>
</div>
<div class="paragraph">
<p>Lightningのプロトコルでは、慣習として、2つのチャネルパートナーを、どちらを見ているかに応じて、<code>セルフ</code>（<code>ローカルとも</code>いう）、<code>リモートと</code>呼びます。各チャネルパートナーに支払う出力は、それぞれ<code>to_localと</code> <code>to_remoteと</code>呼ばれます。</p>
</div>
<div class="paragraph">
<p><a href="#asymmetric_1">非対称コミットメント取引では</a>、アリスが6万サトシを<code>自己に</code>（アリスの鍵で使用可能）、8万サトシを<code>遠隔に</code>（ボブの鍵で使用可能）支払う取引を行っていることがわかる。</p>
</div>
<div class="paragraph">
<p>ボブはこのトランザクションの鏡像を持っており、最初の出力は80,000 satoshis<code>to_self</code>（ボブの鍵で使用可能）、60,000 satoshis<code>to_remote</code>（アリスの鍵で使用可能）である。</p>
</div>
</div>
<div class="sect3">
<h4 id="_delayed_timelocked_spending_to_self">遅延(タイムロック)消費 to_self</h4>
<div class="paragraph">
<p>非対称トランザクションを使用することで、プロトコルは不正を行った側に簡単に<em>責任を</em>負わせることができる。<em>放送する</em>側は常に待機しなければならないという不変条件により、「正直な」側はその主張に反論し、資金を取り消す時間があることを保証する。この非対称性はそれぞれの側で異なる出力という形で示される。<code>to_local</code>出力は常にタイムロックされており、すぐに使うことはできないが、<code>to_remote</code>出力はタイムロックされておらず、すぐに使うことができる。</p>
</div>
<div class="paragraph">
<p>例えばAliceが持つコミットメントトランザクションでは、彼女に支払う<code>to_local</code>出力は432ブロック間タイムロックされていますが、Bobに支払う<code>to_remote</code>出力はすぐに使うことができます（<a href="#asymmetric_delayed_1">非対称および遅延コミットメントトランザクションを</a>参照してください）。ボブのコミットメント2のトランザクションは鏡像です。彼自身の<code>（to_local</code>）出力はタイムロックされ、アリスの<code>to_remote</code>出力はすぐに使うことができます。</p>
</div>
<div id="asymmetric_delayed_1" class="imageblock">
<div class="content">
<img src="images/mtln_0709.png" alt="Asymmetric and delayed commitment transactions" />
</div>
<div class="title">図9.非対称・遅延コミットメント取引</div>
</div>
<div class="paragraph pagebreak-before">
<p>つまり、アリスが自分の持つコミットメント取引をブロードキャストして確認することでチャンネルを閉じると、アリスは432ブロックの間自分の残高を使うことができないが、ボブはすぐに自分の残高を請求することができる、ということだ。もしボブが自分の持っているコミットメント取引を使ってチャンネルを閉じると、彼は432ブロックの間自分の出力を使うことができないが、アリスは彼女の出力をすぐに使うことができる。</p>
</div>
<div class="paragraph">
<p>それは、古い(取り消された)コミットメントが他のチャネルパートナーからブロードキャストされた場合、<em>リモート</em>パーティがペナルティオプションを行使できるようにするためである。次に、取り消しキーとペナルティ・オプションについて見てみよう。</p>
</div>
<div class="paragraph">
<p>この遅延は、最初のチャネル構築メッセージフロー中に、to_self_delayと呼ばれるフィールドとして、アリスとボブによってネゴシエートされる。チャネルのセキュリティを確保するために、遅延はチャネルの容量に比例します。つまり、より多くの資金を持つチャネルは、コミットメントのto_self出力でより長い遅延を持つことになります。アリスのノードは、open_channelメッセージに希望するto_self_delayを含める。もしボブがこれを受け入れると、彼のノードはaccept_channelメッセージに同じ値のto_self_delayを含める。もし同意しない場合は、チャネルは拒否されます(「<a href="#theShutdownmessage">シャットダウン・メッセージ</a>」を参照)。</p>
</div>
</div>
<div class="sect3">
<h4 id="_revocation_keys">失効キー</h4>
<div class="paragraph">
<p>前回説明したように、「取り消し」という言葉は、「取り消された」トランザクションが使用できなくなることを意味するため、少し誤解を招きやすい。</p>
</div>
<div class="paragraph">
<p>実際には、取り消されたトランザクションを使用することは可能ですが、もし使用され、取り消された場合、チャネルパートナーの1人がペナルティトランザクションを作成することにより、チャネル資金をすべて奪うことができます。</p>
</div>
<div class="paragraph">
<p>この仕組みは、<code>to_local</code>出力がタイムロックされているだけでなく、スクリプト内に2つの消費条件があります：タイムロック遅延後に<em>selfが</em>消費<em>するか、</em>このコミットメントのためのリボケーションキーですぐに<em>リモートが</em>消費することができます。</p>
</div>
<div class="paragraph">
<p>そこで、この例では、<a href="#asymmetric_delayed_revocable_1">Asymmetric, delayed, and revocable commitmentsに</a>示すように、各サイドが<code>to_local</code>出力にrevocationオプションを含むコミットメントトランザクションを保持しています。</p>
</div>
<div id="asymmetric_delayed_revocable_1" class="imageblock">
<div class="content">
<img src="images/mtln_0710.png" alt="Asymmetric, delayed and revocable commitments" />
</div>
<div class="title">図10.非対称型、遅延型、取り消し可能なコミットメント</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="commitment_transaction">コミットメント・トランザクション</h3>
<div class="paragraph">
<p>さて、コミットメント・トランザクションの構造と、なぜ非対称で遅延した取り消し可能なコミットメントが必要なのかを理解したところで、これを実装したビットコインスクリプトを見てみましょう。</p>
</div>
<div class="paragraph">
<p>コミットメント・トランザクションの最初の<code>（to_local</code>）出力は、<a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/03-transactions.md#to_local-output">BOLT#3: Commitment Transaction,<code>to_local</code>Outputで</a>次のように定義されています。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OP_IF
    # ペナルティトランザクション
    &lt;リボケーションパブキー&gt;
OP_ELSE
    &lt;自己遅延
    OP_CHECKSECENSEVERIFY
    OP_DROP
    &lt;ローカルディレイパブキー
OP_ENDIF
OP_CHECKSIG</pre>
</div>
</div>
<div class="paragraph">
<p>これは条件付きスクリプトで(<a href="#conditional_scripts">[conditional_scripts]</a>を参照)、2つの条件の<em>どちらかが</em>満たされた場合に出力を使うことができることを意味します。最初の条件は、&lt;revocationpubkey&gt; に署名できる人であれば誰でも出力を使うことができる。2番目の条件は、&lt;to_self_delay&gt; ブロックでタイムロックされ、&lt;local_delayedpubkey&gt; に署名できる人は、そのブロック数の後にのみ使うことができます。この例では、&lt;to_self_delay&gt;タイムロックを432ブロックに設定しましたが、これは2つのチャネルパートナーが交渉する設定可能な遅延です。つまり、より大きな容量のチャネル（より多くの資金）では、当事者を保護するためにより長いto_self_delayタイムロックが設定されます。</p>
</div>
<div class="paragraph">
<p>最初の句は、&lt;revocationpubkey&gt;に署名できる人であれば誰でも出力を使うことができるようにするものです。このスクリプトのセキュリティに対する重要な要件は、リモートパーティが一方的に<code>revocationpubkeyで</code>署名<em>できない</em>ことである。なぜこれが重要かというと、リモートパーティが以前に取り消した約束を破るというシナリオを考えてみてください。もしこの鍵で署名できるなら、彼らは単に<em>自分たちで</em>取り消し条項を取り、チャンネル内のすべての資金を盗むことができます。その代わりに、自己（ローカル）とリモートパーティーの<em>両方からの</em>情報に基づいて、<em>各状態の</em> <code>revocationpubkeyを</code>導出するのです。対称暗号と非対称暗号を巧みに使い分け、<code>リボケーションパブキーの</code>公開鍵は双方が計算できるが、秘密情報を与えられた正直なセルフパーティーのみが秘密鍵を計算できるようにしています（詳細は<a href="#revocation_sidebar">リボケーションとコミットメントの秘密導出で</a>説明します）。</p>
</div>
<div id="revocation_sidebar" class="sidebarblock">
<div class="content">
<div class="title">失効とコミットメントの秘密派生物</div>
<div class="paragraph">
<p>各サイドは最初のチャネルネゴシエーションメッセージの間に<code>revocation_basepoint</code>と<code>first_per_commitment_point</code> を送信します。<code>revocation_basepointは</code>チャネルの有効期間中静的であり、新しいチャネル状態はそれぞれ新しい<code>first_per_commitment_pointを</code>基に決定される。</p>
</div>
<div class="paragraph">
<p>この情報をもとに、各チャネルの状態に対する<code>revocationpubkey</code>を、以下のような楕円曲線とハッシュ化の一連の操作によって導出する。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>revocationpubkey = revocation_basepoint * sha256(revocation_basepoint || per_commitment_point) + per_commitment_point * sha256(per_commitment_point || revocation_basepoint)</pre>
</div>
</div>
<div class="paragraph">
<p>楕円曲線が定義されるエーベル群の可換性により、<code>per_commitment_secret</code>（<code>per_commitment_pointの</code>秘密鍵）がリモートパーティから公開されると、selfは以下の操作で<code>revocationpubkeyの</code>秘密鍵を導出することができる。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>revocation_priv = (revocationbase_priv * sha256(revocation_basepoint || per_commitment_point)) + (per_commitment_secret * sha256(per_commitment_point || revocation_basepoint)) mod N+ (per_commitment_secret*sha256(per_commitment_point || revocation_basepoint)) mod N</pre>
</div>
</div>
<div class="paragraph">
<p>なぜこれが実際に機能するかというと、<code>revocationpubkeyの</code>元の式の（commute）を<em>並べ替えて</em>公開鍵計算を拡張できることに気づくからである。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>revocationpubkey = G*(revocationbase_priv * sha256(revocation_basepoint || per_commitment_point)) + G*(per_commitment_secret * sha256(per_commitment_point || revocation_basepoint))
                 = revocation_basepoint * sha256(revocation_basepoint || per_commitment_point) + per_commitment_point * sha256(per_commitment_point || revocation_basepoint) ))</code></pre>
</div>
</div>
<div class="paragraph">
<p>つまり、<code>revocationbase</code> <code>_</code> <em>privと</em> <code>per_commitment_secretの</code> <em>両方を知って</em>いる当事者だけが、<code>revocationbase_privを</code>導き出す（そして<code>revocationpubkeyへの</code>署名に使う）ことができるのです。この小さな仕掛けが、ライトニング・ネットワークで使われている公開鍵ベースのリボケーションシステムを安全なものにしているのです。</p>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">チップ</div>
</td>
<td class="content">
<div class="paragraph">
<p>CHECK&amp;#x200b;SE&amp;#x2060;QUENCEVERIFY によるコミットメント・トランザクションで使用されるタイムロックは、<em>相対的なタイムロック</em>です。これはこの出力の確認から経過したブロックを数えます。つまり、このコミットメント・トランザクションがブロードキャストされ、確認された<em>後の</em>to_self_delayブロックまで使用することができないことになります。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>コミットメントトランザクションの2番目の出力（to_remote）は<a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/03-transactions.md#to_remote-output">BOLT #3: Commitment Transaction,<code>to_remote</code>Outputで</a>定義されており、最も単純な形は&lt;remote_pubkey&gt;に対するP2WPKH (Pay-to-Witness-Public-Key-Hash) 、つまり単に&lt;remote_pubkey&gt;に対して署名できる所有者にお金を支払うというものである。</p>
</div>
<div class="paragraph">
<p>さて、コミットメント・トランザクションを詳しく定義したので、アリスとボブがどのようにチャネルの状態を進め、新しいコミットメント・トランザクションを作成し署名し、古いコミットメント・トランザクションを取り消すかを見てみましょう。</p>
</div>
</div>
<div class="sect2">
<h3 id="_advancing_the_channel_state">チャンネル・ステートの推進</h3>
<div class="paragraph">
<p>チャネルの状態を進めるために、アリスとボブは commitment_signed と revoke_and_ack メッセージの2つのメッセージを交換します。commitment_signed メッセージは、どちらかのチャネルパートナーがチャネルの状態を更新したときに送信することができます。もう一方のチャネルパートナーは、古いコミットメントを<em>取り消し</em>、新しいコミットメントを<em>承認</em>するためにrevoke_and_ackで応答することができます。</p>
</div>
<div class="paragraph">
<p><a href="#commitment_message_flow">コミットメントと失効のメッセージフローでは</a>、アリスとボブがcommitment_signedとrevoke_and_ackの2つのペアを交換する様子を見ることができます。最初のフローは、アリスが開始した状態更新(左から右へのcommitment_signed)と、それに応答するボブ(右から左へのrevoke_and_ack)を示しています。2番目のフローは、ボブによって開始され、アリスによって応答された状態の更新を示す。</p>
</div>
<div id="commitment_message_flow" class="imageblock">
<div class="content">
<img src="images/mtln_0711.png" alt="Commitment and revocation message flow" />
</div>
<div class="title">図11.コミットメントとリボケーションのメッセージフロー</div>
</div>
<div class="sect3">
<h4 id="_the_commitment_signed_message">コミットメント署名メッセージ</h4>
<div class="paragraph">
<p>commitment_signedメッセージの構造は、<a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/02-peer-protocol.md#committing-updates-so-far-commitment_signed">BOLT#2: Peer Protocol,<code>commitment_signedで</code></a>定義されており、ここに示されています。</p>
</div>
<div id="commitment_signed_message" class="listingblock">
<div class="title">コミットメント署名メッセージ</div>
<div class="content">
<pre>[チャンネルID:チャンネルID]
[シグネチャ:シグネチャ]
[u16:num_htlcs]である。
[num_htlcs*signature:htlc_signature]のようになります。</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">チャンネルID</dt>
<dd>
<p>チャネルの識別子</p>
</dd>
<dt class="hdlist1">署名</dt>
<dd>
<p>新しいリモートコミットメントのための署名</p>
</dd>
<dt class="hdlist1">num_htlcs</dt>
<dd>
<p>今回のコミットメントで更新されたHTLCの数</p>
</dd>
<dt class="hdlist1">htlc_signature</dt>
<dd>
<p>アップデートのための署名</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">備考</div>
</td>
<td class="content">
<div class="paragraph">
<p>更新をコミットするための HTLC の使用については、<a href="#htlcs">[htlcs]</a>および<a href="#channel_operation">[channel_operation]</a> で詳しく説明します。</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>アリスのcommitment_signedメッセージは、新しいコミットメントトランザ クションに必要な署名(アリスの2-of-2の部分)をボブに与える。</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_revoke_and_ack_message">revoke_and_ack メッセージ</h4>
<div class="paragraph">
<p>今、ボブは新しいコミットメントトランザクションを持っているので、アリスに取り消し鍵を与えることによって前のコミットメントを取り消し、アリスの署名で新しいコミットメントを構築することができます。</p>
</div>
<div class="paragraph">
<p>revoke_and_ack メッセージは、<a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/02-peer-protocol.md#completing-the-transition-to-the-updated-state-revoke_and_ack">BOLT #2: Peer Protocol,<code>revoke_and_ack</code></a> で定義されており、ここに示されている。</p>
</div>
<div id="revoke_and_ack_message" class="listingblock">
<div class="title">revoke_and_ack メッセージ</div>
<div class="content">
<pre>[チャンネルID:チャンネルID]
[32*バイト:per_commitment_secret]。
[ポイント:next_per_commitment_point] (ポイント:次のコミットメントポイント)</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">チャンネルID</dt>
<dd>
<p>チャネルの識別子である。</p>
</dd>
<dt class="hdlist1">per_commitment_secret</dt>
<dd>
<p>前の（古い）コミットメントの取り消しキーを生成するために使用され、効果的にそれを取り消すことができます。</p>
</dd>
<dt class="hdlist1">ネクストパーコミットメントポイント</dt>
<dd>
<p>新しいコミットメントに対して<code>revocation_pubkey</code>を作成するために使用し、後で取り消すことができるようにします。</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="revocation">取り消しと再申請</h4>
<div class="paragraph">
<p>このアリスとボブのやり取りをもう少し詳しく見てみましょう。</p>
</div>
<div class="paragraph">
<p>アリスはボブに新しいコミットメントを作成する手段を与えています。その見返りとして、ボブは古いコミットメントを取り消し、それを使わないことをアリスに保証しています。アリスは、古いコミットメントを公開したボブを罰するための取り消し鍵を持っている場合のみ、新しいコミットメントを信用することができます。ボブから見ると、彼は新しいコミットメントの署名を持っているので、アリスに彼を罰するためのキーを与えることによって、安全に古いコミットメントを取り消すことができます。</p>
</div>
<div class="paragraph">
<p>ボブがrevoke_and_ackで応答するとき、ボブはアリスにper_commitment_secretを与える。この秘密は、古いコミットメントに対する取り消し署名鍵を構築するために使用され、アリスはペナルティを行使することによって、すべてのチャネル資金を押収することができます。</p>
</div>
<div class="paragraph">
<p>ボブがこの秘密をアリスに伝えたらすぐに、彼はその古いコミットメントを決して広めては<em>ならない</em>。もしそうすれば、彼はアリスに資金を奪うことによって彼にペナルティを与える機会を与えることになります。本質的に、ボブはアリスに古いコミットメントを流したことの責任を問う能力を与え、事実上その古いコミットメントを使う能力を取り消したのです。</p>
</div>
<div class="paragraph">
<p>AliceはBobからrevoke_and_ackを受け取ると、Bobがペナルティを受けることなく古いコミットメントをブロードキャストできないことを確認できる。彼女は今、Bobが古いコミットメントをブロードキャストした場合に、ペナルティのトランザクションを作成するのに必要な鍵を持っている。</p>
</div>
</div>
<div class="sect3">
<h4 id="revocation_secret_derivation">不正行為と罰則の実際</h4>
<div class="paragraph">
<p>実際には、アリスとボブの両方が不正行為を監視しなければならない。彼らは、自分たちが運営しているチャンネルのいずれかに関連するコミットメント取引をビットコインブロックチェーンで監視している。もしチェーン上で確認されたコミットメントトランザクションを見たら、それが最新のコミットメントであるかどうかを確認する。もしそれが「古い」コミットメントであれば、彼らは直ちにペナルティトランザクションを構築し、ブロードキャストしなければならない。ペナルティ・トランザクションはto_localとto_remoteの<em>両方の</em>出力を使い、チャネルを閉じ、両方の残高を不正行為をしたチャネルパートナーに送信する。</p>
</div>
<div class="paragraph">
<p>渡されたrevokeコミットメントのコミットメント番号を双方がより簡単に追跡できるように、各コミットメントは実際には遷移のロックタイムとシーケンスフィールド内にコミットメントの番号を<em>エンコードして</em>います。プロトコル内では、この特別なエンコーディングを<em>ステートヒントと</em>呼びます。当事者が現在のコミットメント番号を知っていると仮定すると、放送されたコミットメントが破棄されたものかどうか、破棄された場合はどのコミットメント番号が破られたかを、状態ヒントを用いて簡単に認識することができます。</p>
</div>
<div class="paragraph">
<p>ステートヒントをわかりやすく暗号化するのではなく、難読<em>化された</em>ステートヒントを代わりに使用する。この難読化は、まず現在のコミットメント番号と、チャネルの両側の資金公開鍵を使用して決定論的に生成された一連のランダムバイトをXORすることで実現される。ロックタイムとシーケンス（ロックタイムの24ビットとシーケンスの24ビット）を含む合計6バイトがコミットメントトランザクション内のステートヒントをエンコードするために使用されるので、6つのランダムバイトがXOR処理に使用するために必要とされます。これらの6バイトを得るために、双方はイニシエータのファンディングキーをレスポンダのファンディングキーに連結したSHA-256ハッシュを得る。現在のコミットメントの高さをエンコードする前に、整数はこのステートヒント難読化剤でXORされ、その後、ロックタイムの下位24ビットとシーケンスの上位64ビットにエンコードされる。</p>
</div>
<div class="paragraph">
<p>AliceとBobの間のチャネルを確認し、ペナルティのトランザクションの具体例を示してみましょう。<a href="#competing_commitments_2">Revoked and current commitmentsに</a>、AliceとBobのチャンネルにある4つのコミットメントが表示されています。アリスはボブに3回支払いを行っています。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>70,000サトシを支払い、コミットメント1号でボブに約束する。</p>
</li>
<li>
<p>10,000サトシを支払い、コミットメントその2でボブに約束する。</p>
</li>
<li>
<p>20,000サトシを支払い、コミットメント3号でボブに約束する。</p>
</li>
</ul>
</div>
<div id="competing_commitments_2" class="imageblock">
<div class="content">
<img src="images/mtln_0712.png" alt="Revoked and current commitments" />
</div>
<div class="title">図12.取り消されたコミットメントと現在のコミットメント</div>
</div>
<div class="paragraph">
<p>それぞれのコミットメントで、アリスは前の(古い)コミットメントを取り消したことになります。チャネルの現在の状態と正しいバランスはコミットメント#3で表される。以前のコミットメントはすべて取り消され、Aliceがそれらのコミットメントをブロードキャストしようとした場合に備えて、Bobはそれらに対してペナルティトランザクションを発行するために必要な鍵を持っている。</p>
</div>
<div class="paragraph">
<p>アリスには不正をする動機があるかもしれません。なぜなら、これまでのすべてのコミットメント取引によって、彼女に権利があるよりも高い割合のチャンネル残高が与えられるからです。例えば、アリスがコミットメント#1をブロードキャストしようとしたとしましょう。そのコミットメント取引はアリスに70,000サトシを、ボブに70,000サトシを支払うことになります。もしアリスがブロードキャストしてto_local出力を使うことができたなら、彼女はボブへの最後の2つの支払いを巻き戻すことによって、事実上ボブから30,000サトシを盗むことになります。</p>
</div>
<div class="paragraph">
<p>アリスは、ボブから3万サトシを盗むために、大きなリスクを負って、取り消されたコミットメント#1をブロードキャストすることを決心します。<a href="#cheating_commitment">アリス・チーティングでは</a>、アリスがビットコイン・ブロックチェーンにブロードキャストした古いコミットメントを見ることができます。</p>
</div>
<div id="cheating_commitment" class="imageblock">
<div class="content">
<img src="images/mtln_0713.png" alt="Alice cheating" />
</div>
<div class="title">図13.アリス・チーティング</div>
</div>
<div class="paragraph">
<p>見ての通り、アリスの古いコミットメントには2つの出力があります。1つは自分への7万サトシの支払い（to_local出力）、もう1つはボブへの7万サトシの支払いです。アリスはまだ70,000のto_local出力を使うことができません。それは432ブロック（3日）のタイムロックがあるからです。彼女は今、ボブが3日間気づかないことを望んでいます。</p>
</div>
<div class="paragraph">
<p>アリスにとって不運なことに、ボブのノードはビットコインのブロックチェーンを熱心に監視しており、古いコミットメント取引がブロードキャストされ、（最終的に）オンチェーンで確認されるのを見ます。</p>
</div>
<div class="paragraph">
<p>ボブのノードは直ちにペナルティトランザクションをブロードキャストする。この古いコミットメントはアリスによって取り消されたので、ボブはアリスが送ったper_commitment_secretを持つ。彼はその秘密をrevocation_pubkeyの署名を作成するために使用する。アリスが432ブロック待たなければならないのに対して、ボブは<em>両方の</em>アウトプットをすぐに使うことができる。彼は、自分の秘密鍵でto_remote出力を使うことができる。 なぜなら、それはいずれにせよ彼に支払うためのものだからである。彼はまた、Aliceへの出力を失効鍵の署名で使うことができる。彼のノードは「<a href="#penalty_transaction">不正行為とペナルティ</a>」で示されるペナルティ・トランザクションをブロードキャストする。</p>
</div>
<div id="penalty_transaction" class="imageblock">
<div class="content">
<img src="images/mtln_0714.png" alt="Cheating and penalty" />
</div>
<div class="title">図 14.不正行為とペナルティ</div>
</div>
<div class="paragraph">
<p>ボブのペナルティ取引は14万サトシを自分の財布に支払い、チャネルの全容量を奪ってしまう。アリスは不正行為に失敗しただけでなく、その試みですべてを失ってしまったのです!</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_channel_reserve_ensuring_skin_in_the_game">チャンネル・リザーブゲームにおけるスキンの確保</h4>
<div class="paragraph">
<p>対処しなければならない特別な状況があることにお気づきでしょうか。もしアリスが残高がゼロになるまで使い続けることができたら、彼女はペナルティを負うリスクなしに古いコミットメント取引をブロードキャストすることによってチャネルを閉じることができる状態になる。取り消したコミットメント取引が遅延後に成功するか、不正者が捕まるがペナルティはゼロなので結果が出ないかのどちらかである。ゲーム理論の観点からは、この状況で不正を行おうとするのはタダの金儲けです。このため、チャネル・リザーブが機能し、詐欺師候補は常にペナルティのリスクに直面することになります。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_closing_the_channel_cooperative_close">チャンネルを閉じる（Cooperative Close）</h3>
<div class="paragraph">
<p>これまで、チャネルを一方的にクローズする方法の1つとして、コミットメント・トランザクションを見てきました。このタイプのチャネル閉鎖は、それを使用するチャネル・パートナーにタイムロックを強制するため、理想的ではありません。</p>
</div>
<div class="paragraph">
<p>チャネルを閉じるより良い方法として、協同クローズがあります。協調クローズでは、2つのチャネルパートナーは<em>クロージングトランザクションと</em>呼ばれる最終コミットメントトランザクションを交渉し、各パーティが選択した宛先ウォレットに直ちに残高を支払います。そして、チャネル閉鎖フローを開始したパートナーは、閉鎖トランザクションをブロードキャストする。</p>
</div>
<div class="paragraph">
<p>クロージングメッセージフローは、<a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/02-peer-protocol.md#channel-close">BOLT #2: Peer Protocol, Channel Closeで</a>定義されており、<a href="#closing_message_flow">The channel close message flowで</a>示されている。</p>
</div>
<div id="closing_message_flow" class="imageblock">
<div class="content">
<img src="images/mtln_0715.png" alt="The channel close message flow" />
</div>
<div class="title">図 15.チャネルクローズメッセージフロー</div>
</div>
<div class="sect3">
<h4 id="theShutdownmessage">シャットダウンメッセージ</h4>
<div class="paragraph">
<p>チャネルクロージングは、2つのチャネルパートナーのうち1つがシャットダウンメッセージを送信することから始まります。このメッセージの内容を以下に示す。</p>
</div>
<div id="shutdown_message" class="listingblock">
<div class="title">シャットダウンメッセージ</div>
<div class="content">
<pre>[チャンネルID:チャンネルID]
[u16:len]です。
[len*byte:スクリプトパブキー]。</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">チャンネルID</dt>
<dd>
<p>閉じたいチャネルのチャネル識別子</p>
</dd>
<dt class="hdlist1">レン</dt>
<dd>
<p>このチャネルパートナーが残高を受け取りたい宛先ウォレットのスクリプトの長さ</p>
</dd>
<dt class="hdlist1">スクリプトパブキー</dt>
<dd>
<p>宛先ウォレットのビットコインスクリプトで、「標準」ビットコインアドレス形式（P2PKH、P2SH、P2WPKH、P2WSHなど。</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>アリスがボブにシャットダウンメッセージを送り、彼らのチャンネルを閉じるとしましょう。アリスは自分の財布のビットコインアドレスに対応するビットコインスクリプトを指定します。彼女はボブにこう言っています: 私の残高をこの財布に支払う取引を終了させましょう。</p>
</div>
<div class="paragraph">
<p>Bobは自分自身のシャットダウンメッセージで応答し、チャネルを協調的に閉じることに同意することを示す。彼のシャットダウンメッセージには、彼のウォレットアドレスのスクリプトが含まれています。</p>
</div>
<div class="paragraph">
<p>これで、アリスとボブはお互いのウォレットアドレスを知っており、チャンネル残高を決済するために同一の決済取引を行うことができる。</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_closing_signed_message">closing_signed メッセージ</h4>
<div class="paragraph">
<p>チャネルに未解決のコミットメントや更新がなく、チャネルパートナーが前のセクションで示したシャットダウンメッセージを交換したと仮定すると、この協調的なクローズを終了することができます。</p>
</div>
<div class="paragraph">
<p>チャネルの<em>資金提供者</em>(この例ではアリス)はまずボブにclosing_signedメッセージを送信する。このメッセージはオンチェーン取引の取引手数料と、クロージング取引のアリスの署名(2-of-2 multisig)を提案する。closing_signedメッセージはここに示されている。</p>
</div>
<div id="closing_signed_message" class="listingblock">
<div class="title">closing_signedのメッセージ</div>
<div class="content">
<pre>[チャンネルID:チャンネルID]を
[u64:fee_satoshis]です。
[シグネチャー:シグネチャー］</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">チャンネルID</dt>
<dd>
<p>チャンネル識別子</p>
</dd>
<dt class="hdlist1">フィーサトシ</dt>
<dd>
<p>オンチェーン取引手数料の提案（単位：サトシ</p>
</dd>
<dt class="hdlist1">署名</dt>
<dd>
<p>クロージングトランザクションの送信者の署名</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Bobはこれを受信すると、自分のclosing_signedメッセージで返信することができる。もしその料金に同意すれば、彼は単に提案された料金と自分の署名を返すだけでよい。もし反対であれば、別の料金案_satoshisを提案しなければならない。</p>
</div>
<div class="paragraph">
<p>この交渉は、2つのチャネルパートナーが料金に合意するまで、closing_signedメッセージの往復で続けられるかもしれません。</p>
</div>
<div class="paragraph">
<p>アリスが最後のメッセージで提案した料金と同じ料金のclosing_signedメッセージを 受け取ったら、ネゴシエーションは完了する。アリスはクロージングトランザクションに署名してブロードキャストし、チャネルは閉じられる。</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_cooperative_close_transaction">協同組合のクローズ取引</h4>
<div class="paragraph">
<p>cooperative closeトランザクションは、AliceとBobが合意した最後のコミットメントトランザ クションと同様に見える。しかし、最後のコミットメント取引とは異なり、出力にタイムロックやペナルティ失効鍵はない。両者はこのトランザクションを生成するために協力し、それ以上のコミットメントは行わないので、このトランザクションには非対称、遅延、および取り消し可能の要素は必要ない。</p>
</div>
<div class="paragraph">
<p>通常、この協同決済取引で使用されるアドレスは、決済される各チャネルごとに新しく生成されます。しかし、双方が、協調決済された資金を送るために使用される「配送」アドレスを<em>固定</em>することも可能である。<code>open_channelと</code> <code>accept_channel</code>メッセージのTLV名前空間内で、双方は「up-front shutdown script」を自由に指定することができる。一般に、このアドレスはコールドストレージに存在する鍵から導き出される。この方法は、チャネルのセキュリティを向上させるもので、チャネルパートナーが何らかの理由でハッキングされた場合、ハッカーは自分の管理するアドレスを使用してチャネルを協調的に閉じることができません。その代わり、妥協しない誠実なチャネルパートナーは、指定されたシャットダウンアドレスが使用されていない場合、チャネル閉鎖の協力を拒否する。この機能は効果的に「閉じたループ」を作り出し、あるチャネルからの資金の流れを制限します。</p>
</div>
<div class="paragraph">
<p>Aliceはチャネルを閉じるために、<a href="#closing_transaction">The cooperative close transactionで</a>示されるトランザクションをブロードキャストする。</p>
</div>
<div id="closing_transaction" class="imageblock">
<div class="content">
<img src="images/mtln_0716.png" alt="The cooperative close transaction" />
</div>
<div class="title">図 16.協力なクローズ・トランザクション</div>
</div>
<div class="paragraph">
<p>この終了する取引がビットコインのブロックチェーン上で確認されると同時に、チャネルは閉じられます。これで、アリスとボブは好きなように出力を使うことができます。</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_conclusion">結論</h3>
<div class="paragraph">
<p>このセクションでは、支払いチャネルをより詳細に見た。アリスとボブがチャネルの資金調達、コミットメント、閉鎖をネゴシ エートするために使用する3つのメッセージフローを検証した。また、資金調達、コミットメント、およびクロージング・トランザクションの構造を示し、取り消しとペナルティのメカニズムについても見てみた。</p>
</div>
<div class="paragraph">
<p>次の数章で見るように、HTLCはチャネルパートナー間のローカルな支払いにさえ使用されます。HTLCは必要ではありませんが、ローカル（1つのチャネル）とルーティング（多数のチャネル）の支払いが同じ方法で行われるなら、プロトコルはずっとシンプルになります。</p>
</div>
<div class="paragraph">
<p>単一の支払いチャネルでは、1秒あたりの支払い回数は、アリスとボブの間のネットワーク容量によってのみ制限されます。チャネルパートナーが新しいチャネルバランスに合意するために数バイトのデータを送り返すことができる限り、彼らは事実上支払いを行ったことになります。このため、ライトニングネットワーク（オフチェーン）では、ビットコインのブロックチェーン（オンチェーン）で処理できる取引スループットよりもはるかに大きな支払いスループットを実現できるのです。</p>
</div>
<div class="paragraph">
<p>次の数章では、ルーティング、HTLC、およびチャネル運用におけるその使用について説明します。</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
最終更新 2022-10-29 15:50:16 +0400
</div>
</div>
</body>
</html>