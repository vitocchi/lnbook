<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.16">
<title>Payment Channels</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;-webkit-tap-highlight-color:transparent}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="payment_channels">Payment Channels</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this chapter we will dive into payment channels and see how they are constructed. We will start with Alice&#8217;s node opening a channel to Bob&#8217;s node, building on the examples presented in the beginning of this book.</p>
</div>
<div class="paragraph pagebreak-after">
<p>The messages exchanged by Alice and Bob&#8217;s nodes are defined in <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/02-peer-protocol.md">"BOLT #2: Peer Protocol for Channel Management"</a>. The transactions created by Alice and Bob&#8217;s nodes are defined in <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/03-transactions.md">"BOLT #3: Bitcoin Transaction and Script Formats"</a>. In this chapter we are focusing on the "Channel open and close" and "Channel state machine" parts of the Lightning protocol architecture, highlighted by an outline in the center (peer-to-peer layer) of <a href="#LN_protocol_channel_highlight">Payment channels in the Lightning protocol suite</a>.</p>
</div>
<div id="LN_protocol_channel_highlight" class="imageblock">
<div class="content">
<img src="images/mtln_0701.png" alt="Payment channels in the Lightning protocol suite">
</div>
<div class="title">Figure 1. Payment channels in the Lightning protocol suite</div>
</div>
<div class="sect2">
<h3 id="_a_different_way_of_using_the_bitcoin_system">A Different Way of Using the Bitcoin System</h3>
<div class="paragraph">
<p>The Lightning Network is often described as a "Layer 2 Bitcoin Protocol," which makes it sound distinct from Bitcoin. Another way to describe Lightning is as a "smarter way to use Bitcoin" or just as an "application on top of Bitcoin." Let&#8217;s explore that.</p>
</div>
<div class="paragraph">
<p>Historically, Bitcoin transactions are broadcast to everyone and recorded on the Bitcoin blockchain to be considered valid. As we will see, however, if someone holds a presigned Bitcoin transaction that spends a 2-of-2 multisig output that gives them the exclusive ability to spend that Bitcoin, they effectively own that Bitcoin even if they don&#8217;t broadcast the transaction.</p>
</div>
<div class="paragraph">
<p>You can think of the presigned Bitcoin transaction like a postdated check (or cheque), one that can be cashed at any time. Unlike the traditional banking system, however, this transaction is not a "promise" of payment (also known as an IOU), but a verifiable bearer instrument that is equivalent to cash. So long as the bitcoin referenced in the transaction has not already been spent at the time of redemption (or at the time you try to "cash" the check), the Bitcoin system guarantees that this presigned transaction can be broadcast and recorded at any time. This is only true, of course, if this is the only presigned transaction. Within the Lightning Network two or more such presigned transactions exist at the same time; therefore, we need a more sophisticated mechanism to still have the functionality of such a verifiable bearer instrument, as you will also learn in this chapter.</p>
</div>
<div class="paragraph">
<p>The Lightning Network is simply a different and creative way of using Bitcoin. In the Lightning Network a combination of recorded (on-chain) and presigned but withheld (off-chain) transactions form a "layer" of payments that is a faster, cheaper, and more private way to use Bitcoin. You can see this relationship between on-chain and off-chain Bitcoin transactions in <a href="#on_off_chain">Lightning payment channel made of on-chain and off-chain transactions</a>.</p>
</div>
<div id="on_off_chain" class="imageblock">
<div class="content">
<img src="images/mtln_0702.png" alt="Lightning payment channel made of on-chain and off-chain transactions">
</div>
<div class="title">Figure 2. Lightning payment channel made of on-chain and off-chain transactions</div>
</div>
<div class="paragraph">
<p>Lightning is Bitcoin. It&#8217;s just a different way of using the Bitcoin system.</p>
</div>
</div>
<div class="sect2">
<h3 id="_bitcoin_ownership_and_control">Bitcoin Ownership and Control</h3>
<div class="paragraph">
<p>Before we understand payment channels, we have to take a small step back and understand how ownership and control work in Bitcoin.</p>
</div>
<div class="paragraph">
<p>When someone says they "own" bitcoin, they typically mean that they know the private key of a Bitcoin address that has some unspent transaction outputs (see <a href="#bitcoin_fundamentals_review">[bitcoin_fundamentals_review]</a>). The private key allows them to sign a transaction to spend that bitcoin by transferring it to a different address. In Bitcoin "ownership" of bitcoin can be defined as the <em>ability to spend</em> that bitcoin.</p>
</div>
<div class="paragraph">
<p>Keep in mind that the term "ownership" as used in Bitcoin is distinct from the term "ownership" used in a legal sense. A thief who has the private keys and can spend Bitcoin is a <em>de facto owner</em> of that Bitcoin even though they are not a lawful owner.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>Bitcoin ownership is only about control of keys and the ability to spend the Bitcoin with those keys. As the popular Bitcoin saying goes: "Your keys, your coins—not your keys, not your coins."</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_diversity_of_independent_ownership_and_multisig">Diversity of (Independent) Ownership and Multisig</h4>
<div class="paragraph">
<p>Ownership and control of private keys is not always in the hands of one person. That&#8217;s where things get interesting and complicated. We know that more than one person can come to know the same private key, either through theft or because the original holder of the key makes a copy and gives it to someone else. Are all these people owners? In a practical sense, they are, because any one of the people who know the private key can spend the bitcoin without the approval of any other.</p>
</div>
<div class="paragraph">
<p>Bitcoin also has multisignature addresses where multiple private keys are needed to sign before spending (see <a href="#multisig">[multisig]</a>). From a practical perspective, ownership in a multisignature address depends on the quorum (<em>K</em>) and total (<em>N</em>) defined in the <em>K</em>-of-<em>N</em> scheme. A 1-of-10 multisignature scheme would allow any 1 (<em>K</em>) of 10 (<em>N</em>) signers to spend a bitcoin amount locked in that address. This is similar to the scenario where 10 people have a copy of the same private key and any of them can independently spend it.</p>
</div>
</div>
<div class="sect3">
<h4 id="_joint_ownership_without_independent_control">Joint Ownership Without Independent Control</h4>
<div class="paragraph">
<p>There is also the scenario where <em>no one</em> has quorum. In a 2-of-2 scheme like that used in the Lightning Network, neither signer can spend the bitcoin without obtaining a signature from the other party. Who owns the bitcoin in that case? No one really has ownership because no one has control. They each own the equivalent of a voting share in the decision, but both votes are needed. A key problem (pun intended) with a 2-of-2 scheme, in both Bitcoin and the law, is what happens if one of the parties is unavailable, or if there is a vote deadlock and any one party refuses to cooperate.</p>
</div>
</div>
<div class="sect3">
<h4 id="_preventing_locked_and_un_spendable_bitcoin">Preventing "Locked" and Un-Spendable Bitcoin</h4>
<div class="paragraph">
<p>If one of the two signers of a 2-of-2 multisig cannot or will not sign, the funds become un-spendable. Not only can this scenario occur accidentally (loss of keys), but it can be used as a form of blackmail by either party: "I won&#8217;t sign unless you pay me a part of the funds."</p>
</div>
<div class="paragraph">
<p>Payment channels in Lightning are based on a 2-of-2 multisig address, with the two channel partners as signers in the multisig. At this time, channels are funded only by one of the two channel partners: when you choose to "open" a channel, you deposit funds into the 2-of-2 multisig address with a transaction. Once that transaction is mined and the funds are in the multisig, you can&#8217;t get them back without cooperation from your channel partner, because you need their signature (also) to spend the bitcoin.</p>
</div>
<div class="paragraph">
<p>In the next section, as we look at how to open (create) a Lightning channel, we will see how we can prevent loss of funds or any blackmail scenario between the two partners by implementing a fairness protocol for the channel construction with the help of presigned transactions that spend the multisig output in a way that gives the peers in the channel exclusive ability to spend one of the outputs which encodes the amount of bitcoin they own in the channel.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_constructing_a_payment_channel">Constructing a Payment Channel</h3>
<div class="paragraph">
<p>In <a href="#what_is_payment_channel">[what_is_payment_channel]</a>, we described payment channels as a <em>financial relationship</em> between two Lightning nodes, which is established by funding a 2-of-2 multisignature address from the two channel partners.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s assume that Alice wants to construct a payment channel allowing her to connect to Bob&#8217;s store directly. First, the two nodes (Alice&#8217;s and Bob&#8217;s) have to establish an internet connection to each other, so that they can negotiate a payment channel.</p>
</div>
<div class="sect3">
<h4 id="_node_private_and_public_keys">Node Private and Public Keys</h4>
<div class="paragraph">
<p>Every node on the Lightning Network is identified by a <em>node public key</em>. The public key uniquely identifies the specific node and is usually presented as a hexadecimal encoding. For example, René Pickhardt currently runs a Lightning Node (ln.rene-pickhardt.de) that is identified by the following node public key:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>02a1cebfacb2674143b5ad0df3c22c609e935f7bc0ebe801f37b8e9023d45ea7b8</pre>
</div>
</div>
<div class="paragraph">
<p>Each node generates a root private key when first initialized. The private key is kept private at all times (never shared) and securely stored in the node&#8217;s wallet. From that private key, the node derives a public key that is the node identifier and shared with the network. Since the key space is enormous, as long as each node generates the private key randomly, it will have a unique public key, which can therefore uniquely identify it on the network.</p>
</div>
</div>
<div class="sect3">
<h4 id="_node_network_address">Node Network Address</h4>
<div class="paragraph">
<p>Additionally, every node also advertises a network address where it can be reached, in one of several possible formats:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">TCP/IP</dt>
<dd>
<p>An IPv4 or IPv6 address and TCP port number</p>
</dd>
<dt class="hdlist1">TCP/Tor</dt>
<dd>
<p>A Tor "onion" address and TCP port number</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The network address identifier is written as Address:Port, which is consistent with international standards for network identifiers, as used, for example, on the web.</p>
</div>
<div class="paragraph">
<p>For example, René&#8217;s node with node public key 02a1ceb...45ea7b8 currently advertises its network address as the TCP/IP address:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>172.16.235.20:9735</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>The default TCP port for the Lightning Network is 9735, but a node can choose to listen on any TCP port.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_node_identifiers">Node Identifiers</h4>
<div class="paragraph">
<p>Together, the node public key and network address are written in the following format, separated by an @ sign, as <em>NodeID@Address:Port</em>.</p>
</div>
<div class="paragraph">
<p>So the full identifier for René&#8217;s node would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>02a1cebfacb2674143b5ad0df3c22c609e935f7bc0ebe801f37b8e9023d45ea7b8
@172.16.235.20:9735</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>The alias of René&#8217;s node is ln.rene-pickhardt.de; however, this name exists just for better readability. Every node operator can announce whatever alias they want, and there is no mechanism that prevents node operators from selecting an alias that is already being used. Thus to refer to a node, one must use the <em>NodeID@Address:Port</em> schema.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The preceding identifier is often encoded in a QR code, making it easier for users to scan if they want to connect their own node to the specific node identified by that address.</p>
</div>
<div class="paragraph">
<p>Much like Bitcoin nodes, Lightning nodes advertise their presence on the Lightning Network by "gossiping" their node public key and network address. That way, other nodes can find them and keep an inventory (database) of all the known nodes that they can connect to and exchange the messages that are defined in the Lightning P2P message protocol.</p>
</div>
</div>
<div class="sect3">
<h4 id="_connecting_nodes_as_direct_peers">Connecting Nodes as Direct Peers</h4>
<div class="paragraph">
<p>In order for Alice&#8217;s node to connect to Bob&#8217;s node, she will need Bob&#8217;s node public key, or the full address containing the public key, IP or Tor address, and port. Because Bob runs a store, Bob&#8217;s node address can be retrieved from an invoice or a store payment page on the web. Alice can scan a QR code that contains the address and instruct her node to connect to Bob&#8217;s node.</p>
</div>
<div class="paragraph">
<p>Once Alice has connected to Bob&#8217;s node, their nodes are now directly connected peers.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>To open a payment channel, two nodes must first be connected as direct peers by opening a connection over the internet (or Tor).</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_constructing_the_channel">Constructing the Channel</h3>
<div class="paragraph">
<p>Now that Alice&#8217;s and Bob&#8217;s Lightning nodes are connected, they can begin the process of constructing a payment channel. In this section we will review the communications between their nodes, known as the <em>Lightning Peer Protocol for Channel Management</em>, and the cryptographic protocol that they use to build Bitcoin transactions.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>We describe two different protocols in this scenario. First, there is a <em>message protocol</em>, which establishes how the Lightning nodes communicate over the internet and what messages they exchange with each other. Second, there is the <em>cryptographic protocol</em>, which establishes how the two nodes construct and sign Bitcoin <span class="keep-together">transactions</span>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="peer_protocol_channel_management">Peer Protocol for Channel Management</h4>
<div class="paragraph">
<p>The Lightning Peer Protocol for Channel Management is defined in <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/02-peer-protocol.md">BOLT #2: Peer Protocol for Channel Management</a>. In this chapter we will be reviewing the "Channel Establishment" and "Channel Closing" sections of BOLT #2 in more detail.</p>
</div>
</div>
<div class="sect3">
<h4 id="_channel_establishment_message_flow">Channel Establishment Message Flow</h4>
<div class="paragraph">
<p>Channel establishment is achieved by the exchange of six messages between Alice and Bob&#8217;s nodes (three from each peer): open_channel, accept_channel, funding_created, funding_signed, funding_locked, and funding_locked. The six messages are shown as a time-sequence diagram in <a href="#funding_message_flow">The channel establishment message flow</a>.</p>
</div>
<div id="funding_message_flow" class="imageblock">
<div class="content">
<img src="images/mtln_0703.png" alt="The channel establishment message flow">
</div>
<div class="title">Figure 3. The channel establishment message flow</div>
</div>
<div class="paragraph">
<p>In <a href="#funding_message_flow">The channel establishment message flow</a>, Alice and Bob&#8217;s nodes are represented by the vertical lines "A" and "B" on either side of the diagram. A time-sequence diagram like this shows time flowing downward, and messages flowing from one side to the other between the two communication peers. The lines are sloped down to represent the elapsed time needed to transmit each message, and the direction of the message is shown by an arrow at the end of each line.</p>
</div>
<div class="paragraph">
<p>The channel establishment involves three parts. First, the two peers communicate their capabilities and expectations, with Alice initiating a request through open_channel and Bob accepting the channel request through accept_channel.</p>
</div>
<div class="paragraph">
<p>Second, Alice constructs the funding and refund transactions (as we will see later in this section) and sends funding_created to Bob. Another name for the "refund" transaction is a "commitment" transaction, as it commits to the current distribution of balances in the channel. Bob responds by sending back the necessary signatures with funding_signed. This interaction is the basis for the <em>cryptographic protocol</em> to secure the channel and prevent theft. Alice will now broadcast the funding transaction (on-chain) to establish and anchor the payment channel. The transaction will need to be confirmed on the Bitcoin blockchain.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>The name of the funding_signed message can be a bit confusing. This message does not contain a signature for the funding transaction, but rather it contains Bob&#8217;s signature for the refund transaction that allows Alice to claim her bitcoin back from the multisig.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once the transaction has sufficient confirmations (as defined by the <code>minimum_depth</code> field in the <code>accept_channel</code> message), Alice and Bob exchange funding_locked messages, and the channel enters normal operating mode.</p>
</div>
<div class="sect4">
<h5 id="_the_open_channel_message">The open_channel message</h5>
<div class="paragraph">
<p>Alice&#8217;s node requests a payment channel with Bob&#8217;s node by sending an open_channel message. The message contains information about Alice&#8217;s <em>expectations</em> for the channel setup, which Bob may accept or decline.</p>
</div>
<div class="paragraph">
<p>The structure of the open_channel message (taken from BOLT #2) is shown in <a href="#open_channel_message">The <code>open_channel</code> message</a>.</p>
</div>
<div id="open_channel_message" class="exampleblock">
<div class="title">Example 1. The <code>open_channel</code> message</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre>[chain_hash:chain_hash]
[32*byte:temporary_channel_id]
[u64:funding_satoshis]
[u64:push_msat]
[u64:dust_limit_satoshis]
[u64:max_htlc_value_in_flight_msat]
[u64:channel_reserve_satoshis]
[u64:htlc_minimum_msat]
[u32:feerate_per_kw]
[u16:to_self_delay]
[u16:max_accepted_htlcs]
[point:funding_pubkey]
[point:revocation_basepoint]
[point:payment_basepoint]
[point:delayed_payment_basepoint]
[point:htlc_basepoint]
[point:first_per_commitment_point]
[byte:channel_flags]
[open_channel_tlvs:tlvs]</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The fields contained in this message specify the channel parameters that Alice wants, as well as various configuration settings from Alice&#8217;s nodes that reflect the security expectations for the operation of the channel.</p>
</div>
<div class="paragraph pagebreak-before">
<p>Some of the channel construction parameters are listed here:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">chain_hash</dt>
<dd>
<p>This identifies which blockchain (e.g., Bitcoin mainnet) will be used for this channel. It is usually the hash of the genesis block of that blockchain.</p>
</dd>
<dt class="hdlist1">funding_satoshis</dt>
<dd>
<p>The amount Alice will use to fund the channel, which is the total channel capacity.</p>
</dd>
<dt class="hdlist1">channel_reserve_satoshis</dt>
<dd>
<p>The minimum balance, in satoshis, that is reserved on each side of a channel. We will come back to this when we talk about penalties.</p>
</dd>
<dt class="hdlist1">push_msat</dt>
<dd>
<p>An optional amount that Alice will immediately "push" to Bob as a payment upon channel funding. <em>Setting this value to anything but 0 means effectively gifting money to your channel partner and should be used with caution.</em></p>
</dd>
<dt class="hdlist1">to_self_delay</dt>
<dd>
<p>A very important security parameter for the protocol. The value in the <code>open_channel</code> message is used in the responder&#8217;s commitment transaction, and the <code>accept_channel</code> in the initiator&#8217;s. This asymmetry exists to allow each side to express how long the other side needs to wait to unilaterally claim the funds in a commitment transaction. If Bob at any time unilaterally closes the channel against the will of Alice, he commits to not accessing his own funds for the delay defined here. The higher this value, the more security Alice has, but the longer Bob might have his funds locked.</p>
</dd>
<dt class="hdlist1">funding_pubkey</dt>
<dd>
<p>The public key that Alice will contribute to the 2-of-2 multisig that anchors this channel.</p>
</dd>
<dt class="hdlist1">X_basepoint</dt>
<dd>
<p>Master keys, used to derive child keys for various parts of the commitment, revocation, routed payment (HTLCs), and closing transactions. These will be used and explained in subsequent chapters.</p>
</dd>
</dl>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>If you want to understand the other fields and Lightning peer protocol messages that we do not discuss in this book, we suggest you look them up in the BOLT specifications. These messages and fields are important, but cannot be covered in enough detail in the scope of this book. We want you to understand the fundamental principles well enough that you can fill in the details by reading the actual protocol specification (BOLTs).</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_the_accept_channel_message">The accept_channel message</h5>
<div class="paragraph">
<p>In response to Alice&#8217;s open_channel message, Bob sends back the accept_channel message shown in <a href="#accept_channel_message">The <code>accept_channel</code> message</a>.</p>
</div>
<div id="accept_channel_message" class="exampleblock">
<div class="title">Example 2. The <code>accept_channel</code> message</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre>[32*byte:temporary_channel_id]
[u64:dust_limit_satoshis]
[u64:max_htlc_value_in_flight_msat]
[u64:channel_reserve_satoshis]
[u64:htlc_minimum_msat]
[u32:minimum_depth]
[u16:to_self_delay]
[u16:max_accepted_htlcs]
[point:funding_pubkey]
[point:revocation_basepoint]
[point:payment_basepoint]
[point:delayed_payment_basepoint]
[point:htlc_basepoint]
[point:first_per_commitment_point]
[accept_channel_tlvs:tlvs]</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>As you can see, this is similar to the open_channel message and contains Bob&#8217;s node expectations and configuration values.</p>
</div>
<div class="paragraph">
<p>The two most important fields in accept_channel that Alice will use to construct the payment channel are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">funding_pubkey</dt>
<dd>
<p>The public key Bob&#8217;s node contributes for the 2-of-2 multisig address that anchors the channel.</p>
</dd>
<dt class="hdlist1">minimum_depth</dt>
<dd>
<p>The number of confirmations that Bob&#8217;s node expects for the funding transaction before it considers the channel "open" and ready to use.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_funding_transaction">The Funding Transaction</h4>
<div class="paragraph">
<p>Once Alice&#8217;s node receives Bob&#8217;s accept_channel message, it has the information necessary to construct the <em>funding transaction</em> that anchors the channel to the Bitcoin blockchain. As we discussed in earlier chapters, a Lightning payment channel is anchored by a 2-of-2 multisignature address. First, we need to generate that multisignature address to allow us to construct the funding transaction (and the refund transaction as described subsequently).</p>
</div>
</div>
<div class="sect3">
<h4 id="_generating_a_multisignature_address">Generating a Multisignature Address</h4>
<div class="paragraph">
<p>The funding transaction sends some amount of bitcoin (funding_satoshis from the open_channel message) to a 2-of-2 multisignature output that is constructed from Alice and Bob&#8217;s funding_pubkey public keys.</p>
</div>
<div class="paragraph">
<p>Alice&#8217;s node constructs a multisignature script as shown here:</p>
</div>
<pre data-type="programlisting">2 &lt;<em>Alice_funding_pubkey</em>&gt; &lt;<em>Bob_funding_pubkey</em>&gt; 2 CHECKMULTISIG
</pre>
<div class="paragraph">
<p>Note that, in practice, the funding keys are deterministically <em>sorted</em> (using lexicographical order of the serialized compressed form of the public keys) before being placed in the witness script. By agreeing to this sorted order ahead of time, we ensure that both parties will construct an identical funding transaction output, which is signed by the exchanged commitment transaction signature.</p>
</div>
<div class="paragraph">
<p>This script is encoded as a Pay-to-Witness-Script-Hash (P2WSH) Bitcoin address, which looks something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>bc1q89ju02heg32yrqdrnqghe6132wek25p6sv6e564znvrvez7tq5zqt4dn02</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_constructing_the_funding_transaction">Constructing the Funding Transaction</h4>
<div class="paragraph">
<p>Alice&#8217;s node can now construct a funding transaction, sending the amount agreed on with Bob (<code>funding_satoshis</code>) to the 2-of-2 multisig address. Let&#8217;s assume that funding_satoshis was 140,000 and Alice is spending a 200,000 satoshi output and creating 60,000 satoshi change. The transaction will look something like <a href="#A_B_funding_Tx">Alice constructs the funding transaction</a>.</p>
</div>
<div id="A_B_funding_Tx" class="imageblock">
<div class="content">
<img src="images/mtln_0704.png" alt="Alice constructs the funding transaction">
</div>
<div class="title">Figure 4. Alice constructs the funding transaction</div>
</div>
<div class="paragraph">
<p>Alice <em>does not broadcast</em> this transaction because doing so would put her 140,000 satoshi at risk. Once spent to the 2-of-2 multisig, there is no way for Alice to recover her money without Bob&#8217;s signature.</p>
</div>
<div class="sidebarblock pagebreak-before less_space">
<div class="content">
<div class="title">Dual-Funded Payment Channels</div>
<div class="paragraph">
<p>In the current implementation of Lightning, channels are funded only by the node initiating the channel (Alice in our example). Dual-funded channels have been proposed, but not yet implemented. In a dual-funded channel, both Alice and Bob would contribute inputs to the funding transaction. Dual-funded channels require a slightly more complicated message flow and cryptographic protocol, so they have not been implemented yet but are planned for a future update to the Lightning BOLTs. The <code>c-lightning</code> implementation includes an experimental version of a variant on dual-funded channels.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_holding_signed_transactions_without_broadcasting">Holding Signed Transactions Without Broadcasting</h4>
<div class="paragraph">
<p>An important Bitcoin feature that makes Lightning possible is the ability to construct and sign transactions, but not broadcast them. The transaction is <em>valid</em> in every way, but until it is broadcast and confirmed on the Bitcoin blockchain it is not recognized and its outputs are not spendable because they have not been created on the blockchain. We will use this capability many times in the Lightning Network, and Alice&#8217;s node uses the capability when constructing the funding transaction: holding it and not broadcasting it yet.</p>
</div>
</div>
<div class="sect3">
<h4 id="_refund_before_funding">Refund Before Funding</h4>
<div class="paragraph">
<p>To prevent loss of funds, Alice cannot put her bitcoin into a 2-of-2 until she has a way to get a refund if things go wrong. Essentially, she must plan the "exit" from the channel before she enters into this arrangement.</p>
</div>
<div class="paragraph">
<p>Consider the legal construct of a prenuptial agreement, also known as a "prenup." When two people enter into a marriage their money is bound together by law (depending on jurisdiction). Prior to entering into the marriage, they can sign an agreement that specifies how to separate their assets if they dissolve their marriage through divorce.</p>
</div>
<div class="paragraph">
<p>We can create a similar agreement in Bitcoin. For example, we can create a refund transaction, which functions like a prenup, allowing the parties decide how the funds in their channel will be divided before their funds are actually locked into the multisignature funding address.</p>
</div>
</div>
<div class="sect3">
<h4 id="_constructing_the_presigned_refund_transaction">Constructing the Presigned Refund Transaction</h4>
<div class="paragraph">
<p>Alice will construct the refund transaction immediately after constructing (but not broadcasting) the funding transaction. The refund transaction spends the 2-of-2 <span class="keep-together">multisig</span> back to Alice&#8217;s wallet. We call this refund transaction a <em>commitment transaction</em> because it commits both channel partners to distributing the channel balance fairly. Since Alice funded the channel on her own, she gets the entire balance, and both Alice and Bob commit to refunding Alice  with this transaction.</p>
</div>
<div class="paragraph">
<p>In practice, it is a bit more complicated as we will see in subsequent chapters, but for now let&#8217;s keep things simple and assume it looks like <a href="#A_B_fund_refund_Tx">Alice also constructs the refund transaction</a>.</p>
</div>
<div id="A_B_fund_refund_Tx" class="imageblock">
<div class="content">
<img src="images/mtln_0705.png" alt="Alice also constructs the refund transaction">
</div>
<div class="title">Figure 5. Alice also constructs the refund transaction</div>
</div>
<div class="paragraph">
<p>Later in this chapter we will see how more commitment transactions can be made to distribute the balance of the channel in different amounts.</p>
</div>
</div>
<div class="sect3">
<h4 id="_chaining_transactions_without_broadcasting">Chaining Transactions Without Broadcasting</h4>
<div class="paragraph">
<p>So now, Alice has constructed the two transactions shown in <a href="#A_B_fund_refund_Tx">Alice also constructs the refund transaction</a>. But you might be wondering how this is possible.  Alice hasn&#8217;t broadcast the funding transaction to the Bitcoin blockchain. As far as everyone on the network is concerned, that transaction doesn&#8217;t exist. The refund transaction is constructed so as to <em>spend</em> one of the outputs of the funding transaction, even though that output doesn&#8217;t exist yet either. How can you spend an output that hasn&#8217;t been confirmed on the Bitcoin blockchain?</p>
</div>
<div class="paragraph">
<p>The refund transaction is not yet a valid transaction. For it to become a valid transaction two things must happen:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The funding transaction must be broadcast to the Bitcoin network. (To ensure the security of the Lightning Network, we will also require it to be confirmed by the Bitcoin blockchain, though this is not strictly necessary to chain <span class="keep-together">transactions</span>.)</p>
</li>
<li>
<p>The refund transaction&#8217;s input needs Alice&#8217;s and Bob&#8217;s signatures.</p>
</li>
</ul>
</div>
<div class="paragraph pagebreak-before">
<p>But even though these two things haven&#8217;t happened, and even though Alice&#8217;s node hasn&#8217;t broadcast the funding transaction, she can still construct the refund transaction. She can do so because she can calculate the funding transaction&#8217;s hash and reference it as an input in the refund transaction.</p>
</div>
<div class="paragraph">
<p>Notice how Alice has calculated 6da3c2...387710 as the funding transaction hash? If and when the funding transaction is broadcast, that hash will be recorded as the transaction ID of the funding transaction. Therefore, the <code>0</code> output of the funding transaction (the 2-of-2 address output) will then be referenced as output ID 6da3c2...387710:0. The refund transaction can be constructed to spend that funding transaction output even though it doesn&#8217;t exist yet, because Alice knows what its identifier will be once confirmed.</p>
</div>
<div class="paragraph">
<p>This means that Alice can create a chained transaction by referencing an output that doesn&#8217;t yet exist, knowing that the reference will be valid if the funding transaction is confirmed, making the refund transaction valid too. As we will see in the next section, this "trick" of chaining transactions before they are broadcast requires a very important feature of Bitcoin that was introduced in August of 2017: <em>Segregated Witness</em>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_solving_malleability_segregated_witness">Solving Malleability (Segregated Witness)</h4>
<div class="paragraph">
<p>Alice has to depend on the transaction ID of the funding transaction being known before confirmation. But before the introduction of  Segregated Witness (SegWit) in August 2017, this was not sufficient to protect Alice. Because of the way transactions were constructed with the signatures (witnesses) included in the transaction ID, it was possible for a third party (e.g., Bob) to broadcast an alternative version of a transaction with a <em>malleated</em> (modified) transaction ID. This is known as <em>transaction malleability</em>, and prior to SegWit, this problem made it difficult to implement indefinite lifetime payment channels securely.</p>
</div>
<div class="paragraph">
<p>If Bob could modify Alice&#8217;s funding transaction before it was confirmed, and produce a replica that had a different transaction ID, Bob could make Alice&#8217;s refund transaction invalid and hijack her bitcoin. Alice would be at Bob&#8217;s mercy to get a signature to release her funds and could easily be blackmailed. Bob couldn&#8217;t steal the funds, but he could prevent Alice from getting them back.</p>
</div>
<div class="paragraph">
<p>The introduction of SegWit made unconfirmed transaction IDs immutable from the point of view of third parties, meaning that Alice could be sure that the transaction ID of the funding transaction would not change. As a result, Alice can be confident that if she gets Bob&#8217;s signature on the refund transaction, she has a way to recover her money. She now has a way to implement the Bitcoin equivalent of a "prenup" before locking her funds into the multisig.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>You might have wondered how Bob would be able to alter (malleate) a transaction created and signed by Alice. Bob certainly does not have Alice&#8217;s private keys. However ECDSA signatures for a message are not unique. Knowing a signature (which is included in a valid transaction) allows one to produce many different-looking signatures that are still valid. Before SegWit removed signatures from the transaction digest algorithm, Bob could replace the signature with an equivalent valid signature that produced a different transaction ID, breaking the chain between the funding transaction and the refund transaction.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_the_funding_created_message">The funding_created message</h5>
<div class="paragraph">
<p>Now that Alice has constructed the necessary transactions, the channel construction message flow continues. Alice transmits the funding_created message to Bob. You can see the contents of this message here:</p>
</div>
<div id="funding_created_message" class="listingblock">
<div class="title">The funding_created message</div>
<div class="content">
<pre>[32*byte:temporary_channel_id]
[sha256:funding_txid]
[u16:funding_output_index]
[signature:signature]</pre>
</div>
</div>
<div class="paragraph">
<p>With this message, Alice gives Bob the important information about the funding transaction that anchors the payment channel:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">funding_txid</dt>
<dd>
<p>This is the transaction ID (TxID) of the funding transaction, and is used to create the channel ID once the channel is established.</p>
</dd>
<dt class="hdlist1">funding_output_index</dt>
<dd>
<p>This is the output index, so Bob knows which output of the transaction (e.g., output <code>0</code>) is the 2-of-2 multisig output funded by Alice. This is also used to form the channel ID.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Finally, Alice also sends the signature corresponding to Alice&#8217;s <code>funding_pubkey</code> and used to spend from the 2-of-2 multisig. This is needed by Bob because he will also need to create his own version of a commitment transaction. That commitment transaction needs a signature from Alice, which she provides to him. Note that the commitment transactions of Alice and Bob look slightly different, thus the signatures will be different. Knowing what the commitment transaction of the other party looks like is crucial and part of the protocol to provide the valid signature.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>In the Lightning protocol we often see nodes sending signatures instead of entire signed transactions. That&#8217;s because either side can reconstruct the same transaction and therefore only the signature is needed to make it valid. Sending only the signature and not the entire transaction saves a lot of network bandwidth.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_the_funding_signed_message">The funding_signed message</h5>
<div class="paragraph">
<p>After receiving the funding_created message from Alice, Bob now  knows the funding transaction ID and output index. The channel ID is made by a bitwise "exclusive or" (XOR) of the funding transaction ID and output index:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>channel_id = funding_txid XOR funding_output_index</pre>
</div>
</div>
<div class="paragraph">
<p>More precisely, a <code>channel_id</code>, which is the 32-byte representation of a funding UTXO, is generated by XORing the lower 2 bytes of the funding TxID with the index of the funding output.</p>
</div>
<div class="paragraph">
<p>Bob will also need to send Alice his signature for the refund transaction, based on Bob&#8217;s <code>funding_pubkey</code> that formed the 2-of-2 multisig. Although Bob already has his local refund transaction, this will allow Alice to complete the refund transaction with all necessary signatures and be sure her money is refundable in case something goes wrong.</p>
</div>
<div class="paragraph">
<p>Bob constructs a funding_signed message and sends it to Alice. Here we see the contents of this message:</p>
</div>
<div id="funding_signed_message" class="listingblock">
<div class="title">The funding_signed message</div>
<div class="content">
<pre>[channel_id:channel_id]
[signature:signature]</pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_broadcasting_the_funding_transaction">Broadcasting the Funding Transaction</h4>
<div class="paragraph">
<p>Upon receiving the funding_signed message from Bob, Alice now has both signatures needed to sign the refund transaction. Her "exit plan" is now secure, and therefore she can broadcast the funding transaction without fear of having her funds locked. If anything goes wrong, Alice can simply broadcast the refund transaction and get her money back, without any further help from Bob.</p>
</div>
<div class="paragraph">
<p>Alice now sends the funding transaction to the Bitcoin network so that it can be mined into the blockchain. Both Alice and Bob will be watching for this transaction and waiting for minimum_depth confirmations (e.g., six confirmations) on the Bitcoin blockchain.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>Of course Alice will use the Bitcoin Protocol to verify that the signature that Bob sent her is indeed valid. This step is very crucial. If for some reason Bob was sending wrongful data to Alice, her "exit plan" would be sabotaged.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_the_funding_locked_message">The funding_locked message</h5>
<div class="paragraph">
<p>As soon as the funding transaction has reached the required number of confirmations, both Alice and Bob send the funding_locked message to each other and the channel is ready for use.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sending_payments_across_the_channel">Sending Payments Across the Channel</h3>
<div class="paragraph">
<p>The channel has been set up, but in its initial state, all the capacity (140,000 satoshis) is on Alice&#8217;s side. This means that Alice can send payments to Bob across the channel, but Bob has no funds to send to Alice yet.</p>
</div>
<div class="paragraph">
<p>In the next few sections we will show how payments are made across the payment channel and how the <em>channel state</em> is updated.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s assume that Alice wants to send 70,000 satoshis to Bob to pay her bill at Bob&#8217;s coffee shop.</p>
</div>
<div class="sect3">
<h4 id="_splitting_the_balance">Splitting the Balance</h4>
<div class="paragraph">
<p>In principle, sending a payment from Alice to Bob is simply a matter of redistributing the balance of the channel. Before the payment is sent, Alice has 140,000 satoshis and Bob has none. After the 70,000 satoshi payment is sent, Alice has 70,000 satoshis <span class="keep-together">and Bob</span> has 70,000 satoshis.</p>
</div>
<div class="paragraph">
<p>Therefore, all Alice and Bob have to do is create and sign a transaction that spends the 2-of-2 multisig to two outputs paying Alice and Bob their corresponding balances. We call this updated transaction a <em>commitment transaction</em>.</p>
</div>
<div class="paragraph">
<p>Alice and Bob operate the payment channel by <em>advancing the channel state</em> through a series of commitments. Each commitment updates the balances to reflect payments that have flowed across the channel. Both Alice and Bob can initiate a new commitment to update the channel.</p>
</div>
<div class="paragraph">
<p>In <a href="#competing_commitments_1">Multiple commitment transactions</a> we see several commitment transactions.</p>
</div>
<div class="paragraph">
<p>The first commitment transaction shown in <a href="#competing_commitments_1">Multiple commitment transactions</a> is the refund transaction that Alice constructed before funding the channel. In the diagram, this is Commitment #0. After Alice pays Bob 70,000 satoshis, the new commitment transaction (Commitment #1) has two outputs paying Alice and Bob their respective balances. We have included two subsequent commitment transactions (Commitment #2 and Commitment #3) which represent Alice paying Bob an additional 10,000 satoshis and then 20,000 satoshis, respectively.</p>
</div>
<div class="paragraph">
<p>Each signed and valid commitment transaction can be used by either channel partner at any time to close the channel by broadcasting it to the Bitcoin network. Since they both have the most recent commitment transaction and can use it at any time, they can also just hold it and not broadcast it. It&#8217;s their guarantee of a fair exit from the channel.</p>
</div>
<div id="competing_commitments_1" class="imageblock">
<div class="content">
<img src="images/mtln_0706.png" alt="Multiple commitment transactions">
</div>
<div class="title">Figure 6. Multiple commitment transactions</div>
</div>
</div>
<div class="sect3">
<h4 id="_competing_commitments">Competing Commitments</h4>
<div class="paragraph">
<p>You may be wondering how it is possible for Alice and Bob to have multiple commitment transactions, all of them attempting to spend the same 2-of-2 output from the funding transaction. Aren&#8217;t these commitment transactions conflicting? Isn&#8217;t this a "double-spend" that the Bitcoin system is meant to prevent?</p>
</div>
<div class="paragraph">
<p>It is indeed! In fact, we rely on Bitcoin&#8217;s ability to <em>prevent</em> a double-spend to make Lightning work. No matter how many commitment transactions Alice and Bob construct and sign, only one of them can actually get confirmed.</p>
</div>
<div class="paragraph">
<p>As long as Alice and Bob hold these transactions and don&#8217;t broadcast them, the funding output is unspent. But if a commitment transaction is broadcast and confirmed, it will spend the funding output. If Alice or Bob attempts to broadcast more than one commitment transaction, only one of them will be confirmed and the others will be rejected as attempted (and failed) double-spends.</p>
</div>
<div class="paragraph">
<p>If more than one commitment transaction is broadcast, there are many factors that will determine which one gets confirmed first: the amount of fees included, the speed of propagation of these competing transactions, network topology, etc. Essentially it becomes a race without a predictable outcome. That doesn&#8217;t sound very secure. It sounds like someone could cheat.</p>
</div>
</div>
<div class="sect3">
<h4 id="_cheating_with_old_commitment_transactions">Cheating with Old Commitment Transactions</h4>
<div class="paragraph">
<p>Let&#8217;s look more carefully at the commitment transactions in <a href="#competing_commitments_1">Multiple commitment transactions</a>. All four commitment transactions are signed and valid. But only the last one accurately reflects the most recent channel balances. In this particular scenario, Alice has an opportunity to cheat by broadcasting an older commitment and getting it confirmed on the Bitcoin blockchain. Let&#8217;s say Alice transmits Commitment #0 and gets it confirmed: she will effectively close the channel and take all 140,000 satoshis herself. In fact, in this particular example any commitment but Commitment #3 improves Alice&#8217;s position and allows her to "cancel" at least part of the payments reflected in the channel.</p>
</div>
<div class="paragraph">
<p>In the next section we will see how the Lightning Network resolves this problem—preventing older commitment transactions from being used by the channel partners by a mechanism of revocation and penalties. There are other ways to prevent the transmission of older commitment transactions, such as eltoo channels, but they require an upgrade to Bitcoin called input rebinding (see <a href="#bitcoin_prot_17">[bitcoin_prot_17]</a>).</p>
</div>
</div>
<div class="sect3">
<h4 id="_revoking_old_commitment_transactions">Revoking Old Commitment Transactions</h4>
<div class="paragraph">
<p>Bitcoin transactions do not expire and cannot be "canceled." Neither can they be stopped or censored once they have been broadcast. So how do we "revoke" a transaction that another person holds that has already been signed?</p>
</div>
<div class="paragraph">
<p>The solution used in Lightning is another example of a fairness protocol. Instead of trying to control the ability to broadcast a transaction, there is a built-in <em>penalty mechanism</em> that ensures it is not in the best interest of a would-be cheater to transmit an old commitment transaction. They can always broadcast it, but they will most likely lose money if they do so.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>The word "revoke" is a misnomer because it implies that older commitments are somehow made invalid and cannot be broadcast and confirmed. But this is not the case, since valid Bitcoin transactions cannot be revoked. Instead, the Lightning protocol uses a penalty mechanism to punish the channel partner who broadcasts an old commitment.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There are three elements that make up the Lightning protocol&#8217;s revocation and penalty mechanism:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Asymmetric commitment transactions</dt>
<dd>
<p>Alice&#8217;s commitment transactions are slightly different from those held by Bob.</p>
</dd>
<dt class="hdlist1">Delayed spending</dt>
<dd>
<p>The payment to the party holding the commitment transaction is delayed (timelocked), whereas the payment to the other party can be claimed immediately.</p>
</dd>
<dt class="hdlist1">Revocation keys</dt>
<dd>
<p>Used to unlock a penalty option for old commitments.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Let&#8217;s look at these three elements in turn.</p>
</div>
</div>
<div class="sect3">
<h4 id="_asymmetric_commitment_transactions">Asymmetric Commitment Transactions</h4>
<div class="paragraph">
<p>Alice and Bob hold slightly different commitment transactions. Let&#8217;s look specifically at Commitment #2 from <a href="#competing_commitments_1">Multiple commitment transactions</a>, in more detail in <a href="#commitment_2">Commitment transaction #2</a>.</p>
</div>
<div id="commitment_2" class="imageblock">
<div class="content">
<img src="images/mtln_0707.png" alt="Commitment transaction #2">
</div>
<div class="title">Figure 7. Commitment transaction #2</div>
</div>
<div class="paragraph">
<p>Alice and Bob hold two different variations of this transaction, as illustrated in <a href="#asymmetric_1">Asymmetric commitment transactions</a>.</p>
</div>
<div id="asymmetric_1" class="imageblock">
<div class="content">
<img src="images/mtln_0708.png" alt="Asymmetric commitment transactions">
</div>
<div class="title">Figure 8. Asymmetric commitment transactions</div>
</div>
<div class="paragraph">
<p>By convention, within the Lightning protocol, we refer to the two channel partners as <code>self</code> (also known as <code>local</code>) and <code>remote</code>, depending on which side we&#8217;re looking at. The outputs that pay each channel partner are called <code>to_local</code> and <code>to_remote</code>, respectively.</p>
</div>
<div class="paragraph">
<p>In <a href="#asymmetric_1">Asymmetric commitment transactions</a> we see that Alice holds a transaction that pays 60,000 satoshis <code>to_self</code> (can be spent by Alice&#8217;s keys), and 80,000 satoshis <code>to_remote</code> (can be spent by Bob&#8217;s keys).</p>
</div>
<div class="paragraph">
<p>Bob holds the mirror image of that transaction, where the first output is 80,000 satoshis <code>to_self</code> (can be spent by Bob&#8217;s keys), and 60,000 satoshis <code>to_remote</code> (can be spent by Alice&#8217;s keys).</p>
</div>
</div>
<div class="sect3">
<h4 id="_delayed_timelocked_spending_to_self">Delayed (Timelocked) Spending to_self</h4>
<div class="paragraph">
<p>Using asymmetric transactions allows the protocol to easily ascribe <em>blame</em> to the cheating party. An invariant that the <em>broadcasting</em> party must always wait ensures that the "honest" party has time to refute the claim and revoke their funds. This asymmetry is manifested in the form of differing outputs for each side: the <code>to_local</code> output is always timelocked and can&#8217;t be spent immediately, whereas the <code>to_remote</code> output is not timelocked and can be spent immediately.</p>
</div>
<div class="paragraph">
<p>In the commitment transaction held by Alice, for example, the <code>to_local</code> output that pays her is timelocked for 432 blocks, whereas the <code>to_remote</code> output that pays Bob can be spent immediately (see <a href="#asymmetric_delayed_1">Asymmetric and delayed commitment transactions</a>). Bob&#8217;s commitment transaction for Commitment #2 is the mirror image: his own (<code>to_local</code>) output is timelocked and Alice&#8217;s <code>to_remote</code> output can be spent immediately.</p>
</div>
<div id="asymmetric_delayed_1" class="imageblock">
<div class="content">
<img src="images/mtln_0709.png" alt="Asymmetric and delayed commitment transactions">
</div>
<div class="title">Figure 9. Asymmetric and delayed commitment transactions</div>
</div>
<div class="paragraph pagebreak-before">
<p>That means that if Alice closes the channel by broadcasting and confirming the commitment transaction she holds, she cannot spend her balance for 432 blocks, but Bob can claim his balance immediately. If Bob closes the channel using the commitment transaction he holds, he cannot spend his output for 432 blocks while Alice can immediately spend hers.</p>
</div>
<div class="paragraph">
<p>The delay is there for one reason: to allow the <em>remote</em> party to exercise a penalty option if an old (revoked) commitment should be broadcast by the other channel partner. Let&#8217;s look at the revocation keys and penalty option next.</p>
</div>
<div class="paragraph">
<p>The delay is negotiated by Alice and Bob, during the initial channel construction message flow, as a field called to_self_delay. To ensure the security of the channel, the delay is scaled to the capacity of the channel—meaning a channel with more funds has longer delays in the to_self outputs in commitments. Alice&#8217;s node includes a desired to_self_delay in the open_channel message. If Bob finds this acceptable, his node includes the same value for to_self_delay in the accept_channel message. If they do not agree, then the channel is rejected (see <a href="#theShutdownmessage">The Shutdown Message</a>).</p>
</div>
</div>
<div class="sect3">
<h4 id="_revocation_keys">Revocation Keys</h4>
<div class="paragraph">
<p>As we discussed previously, the word "revocation" is a bit misleading because it implies that the "revoked" transaction cannot be used.</p>
</div>
<div class="paragraph">
<p>In fact, the revoked transaction can be used, but if it is used, and it has been revoked, then one of the channel partners can take all of the channel funds by creating a penalty transaction.</p>
</div>
<div class="paragraph">
<p>The way this works is that the <code>to_local</code> output is not only timelocked, but it also has two spending conditions in the script: it can be spent by <em>self</em> after the timelock delay <em>or</em> it can be spent by <em>remote</em> immediately with a revocation key for this commitment.</p>
</div>
<div class="paragraph">
<p>So, in our example, each side holds a commitment transaction that includes a revocation option in the <code>to_local</code> output, as shown in <a href="#asymmetric_delayed_revocable_1">Asymmetric, delayed, and revocable commitments</a>.</p>
</div>
<div id="asymmetric_delayed_revocable_1" class="imageblock">
<div class="content">
<img src="images/mtln_0710.png" alt="Asymmetric, delayed and revocable commitments">
</div>
<div class="title">Figure 10. Asymmetric, delayed, and revocable commitments</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="commitment_transaction">The Commitment Transaction</h3>
<div class="paragraph">
<p>Now that we understand the structure of commitment transactions and why we need asymmetric, delayed, revocable commitments, let&#8217;s look at the Bitcoin Script that implements this.</p>
</div>
<div class="paragraph">
<p>The first (<code>to_local</code>) output of a commitment transaction is defined in <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/03-transactions.md#to_local-output">BOLT #3: Commitment Transaction, <code>to_local</code> Output</a>, as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OP_IF
    # Penalty transaction
    &lt;revocationpubkey&gt;
OP_ELSE
    &lt;to_self_delay&gt;
    OP_CHECKSEQUENCEVERIFY
    OP_DROP
    &lt;local_delayedpubkey&gt;
OP_ENDIF
OP_CHECKSIG</pre>
</div>
</div>
<div class="paragraph">
<p>This is a conditional script (see <a href="#conditional_scripts">[conditional_scripts]</a>), which means the output can be spent if <em>either</em> of the two conditions is met. The first clause allows the output to be spent by anyone who can sign for &lt;revocationpubkey&gt;. The second clause is timelocked by &lt;to_self_delay&gt; blocks and can only be spent after that many blocks by anyone who can sign for &lt;local_delayedpubkey&gt;. In our example, we had set the &lt;to_self_delay&gt; timelock to 432 blocks, but this is a configurable delay that is negotiated by the two channel partners. The to_self_delay timelock duration is usually chosen in proportion to the channel capacity, meaning that larger capacity channels (more funds), have longer to_self_delay timelocks to protect the parties.</p>
</div>
<div class="paragraph">
<p>The first clause allows the output to be spent by anyone who can sign for &lt;revocationpubkey&gt;. A critical requirement to the security of this script is that the remote party <em>cannot</em> unilaterally sign with the <code>revocationpubkey</code>. To see why this is important, consider the scenario in which the remote party breaches a previously revoked commitment. If they can sign with this key, then they can simply take the revocation clause <em>themselves</em> and steal all the funds in the channel. Instead, we derive the <code>revocationpubkey</code> for <em>each</em> state based on information from <em>both</em> the self (local) and remote party. A clever use of symmetric and asymmetric cryptography is used to allow both sides to compute the <code>revocationpubkey</code> public key, but only allow the honest self party to compute the private key given their secret information, as detailed in <a href="#revocation_sidebar">Revocation and Commitment Secret Derivations</a>.</p>
</div>
<div id="revocation_sidebar" class="sidebarblock">
<div class="content">
<div class="title">Revocation and Commitment Secret Derivations</div>
<div class="paragraph">
<p>Each side sends a <code>revocation_basepoint</code> during the initial channel negotiation messages as well as a <code>first_per_commitment_point</code>. The <code>revocation_basepoint</code> is static for the lifetime of the channel, while each new channel state will be based off a new <code>first_per_commitment_point</code>.</p>
</div>
<div class="paragraph">
<p>Given this information, the <code>revocationpubkey</code> for each channel state is derived via the following series of elliptic curve and hashing operations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>revocationpubkey = revocation_basepoint * sha256(revocation_basepoint || per_commitment_point) + per_commitment_point * sha256(per_commitment_point || revocation_basepoint)</pre>
</div>
</div>
<div class="paragraph">
<p>Due to the commutative property of the abelian groups that elliptic curves are defined over, once the <code>per_commitment_secret</code> (the private key for the <code>per_commitment_point</code>) is revealed by the remote party, self can derive the private key for the <code>revocationpubkey</code> with the following operation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>revocation_priv = (revocationbase_priv * sha256(revocation_basepoint || per_commitment_point)) + (per_commitment_secret * sha256(per_commitment_point || revocation_basepoint)) mod N</pre>
</div>
</div>
<div class="paragraph">
<p>To see why this works in practice, notice that we can <em>reorder</em> (commute) and expand the public key computation of the original formula for <code>revocationpubkey</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>revocationpubkey = G*(revocationbase_priv * sha256(revocation_basepoint || per_commitment_point) + G*(per_commitment_secret * sha256(per_commitment_point || revocation_basepoint))
                 = revocation_basepoint * sha256(revocation_basepoint || per_commitment_point) + per_commitment_point * sha256(per_commitment_point || revocation_basepoint))</code></pre>
</div>
</div>
<div class="paragraph">
<p>In other words, the <code>revocationbase_priv</code> can only be derived (and used to sign for the <code>revocationpubkey</code>) by the party that knows <em>both</em> the <code>revocationbase_priv</code> <em>and</em> the <code>per_commitment_secret</code>. This little trick is what makes the public-key-based revocation system used in the Lightning Network secure.</p>
</div>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph">
<p>The timelock used in the commitment transaction with CHECK&amp;#x200b;SE&amp;#x2060;QUENCEVERIFY is a <em>relative timelock</em>. It counts elapsed blocks from the confirmation of this output. That means it will not be spendable until the to_self_delay block <em>after</em> this commitment transaction is broadcast and confirmed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The second output (to_remote) output of the commitment transaction is defined in <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/03-transactions.md#to_remote-output">BOLT #3: Commitment Transaction,  <code>to_remote</code> Output</a>, and in the simplest form is a Pay-to-Witness-Public-Key-Hash (P2WPKH) for &lt;remote_pubkey&gt;, meaning that it simply pays the owner who can sign for &lt;remote_pubkey&gt;.</p>
</div>
<div class="paragraph">
<p>Now that we&#8217;ve defined the commitment transactions in detail, let&#8217;s see how Alice and Bob advance the state of the channel, create and sign new commitment transactions, and revoke old commitment transactions.</p>
</div>
</div>
<div class="sect2">
<h3 id="_advancing_the_channel_state">Advancing the Channel State</h3>
<div class="paragraph">
<p>To advance the state of the channel, Alice and Bob exchange two messages: commitment_signed and revoke_and_ack messages. The commitment_signed message can be sent by either channel partner when they have an update to the channel state. The other channel partner then may respond with revoke_and_ack to <em>revoke</em> the old commitment and <em>acknowledge</em> the new commitment.</p>
</div>
<div class="paragraph">
<p>In <a href="#commitment_message_flow">Commitment and revocation message flow</a> we see Alice and Bob exchanging two pairs of commitment_signed and revoke_and_ack. The first flow shows a state update initiated by Alice (left to right commitment_signed), to which Bob responds (right to left revoke_and_ack). The second flow shows a state update initiated by Bob and responded to by Alice.</p>
</div>
<div id="commitment_message_flow" class="imageblock">
<div class="content">
<img src="images/mtln_0711.png" alt="Commitment and revocation message flow">
</div>
<div class="title">Figure 11. Commitment and revocation message flow</div>
</div>
<div class="sect3">
<h4 id="_the_commitment_signed_message">The commitment_signed Message</h4>
<div class="paragraph">
<p>The structure of the commitment_signed message is defined in <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/02-peer-protocol.md#committing-updates-so-far-commitment_signed">BOLT #2: Peer Protocol, <code>commitment_signed</code></a>, and shown here:</p>
</div>
<div id="commitment_signed_message" class="listingblock">
<div class="title">The commitment_signed message</div>
<div class="content">
<pre>[channel_id:channel_id]
[signature:signature]
[u16:num_htlcs]
[num_htlcs*signature:htlc_signature]</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">channel_id</dt>
<dd>
<p>The identifier of the channel</p>
</dd>
<dt class="hdlist1">signature</dt>
<dd>
<p>The signature for the new remote commitment</p>
</dd>
<dt class="hdlist1">num_htlcs</dt>
<dd>
<p>The number of updated HTLCs in this commitment</p>
</dd>
<dt class="hdlist1">htlc_signature</dt>
<dd>
<p>The signatures for the updates</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The use of HTLCs to commit updates will be explained in detail in <a href="#htlcs">[htlcs]</a> and in <a href="#channel_operation">[channel_operation]</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Alice&#8217;s commitment_signed message gives Bob the signature needed (Alice&#8217;s part of the 2-of-2) for a new commitment transaction.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_revoke_and_ack_message">The revoke_and_ack Message</h4>
<div class="paragraph">
<p>Now that Bob has a new commitment transaction, he can revoke the previous commitment by giving Alice a revocation key, and construct the new commitment with Alice&#8217;s signature.</p>
</div>
<div class="paragraph">
<p>The revoke_and_ack message is defined in <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/02-peer-protocol.md#completing-the-transition-to-the-updated-state-revoke_and_ack">BOLT #2: Peer Protocol, <code>revoke_and_ack</code></a>, and shown here:</p>
</div>
<div id="revoke_and_ack_message" class="listingblock">
<div class="title">The revoke_and_ack message</div>
<div class="content">
<pre>[channel_id:channel_id]
[32*byte:per_commitment_secret]
[point:next_per_commitment_point]</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">channel_id</dt>
<dd>
<p>This is the identifier of the channel.</p>
</dd>
<dt class="hdlist1">per_commitment_secret</dt>
<dd>
<p>Used to generate a revocation key for the previous (old) commitment, effectively revoking it.</p>
</dd>
<dt class="hdlist1">next_per_commitment_point</dt>
<dd>
<p>Used to build a <code>revocation_pubkey</code> for the new commitment, so that it can later be revoked.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="revocation">Revoking and Recommitting</h4>
<div class="paragraph">
<p>Let&#8217;s look at this interaction between Alice and Bob more closely.</p>
</div>
<div class="paragraph">
<p>Alice is giving Bob the means to create a new commitment. In return, Bob is revoking the old commitment to assure Alice that he won&#8217;t use it. Alice can only trust the new commitment if she has the revocation key to punish Bob for publishing the old commitment. From Bob&#8217;s perspective, he can safely revoke the old commitment by giving Alice the keys to penalize him, because he has a signature for a new commitment.</p>
</div>
<div class="paragraph">
<p>When Bob responds with revoke_and_ack, he gives Alice a per_commitment_secret. This secret can be used to construct the revocation signing key for the old commitment, which allows Alice to seize all channel funds by exercising a penalty.</p>
</div>
<div class="paragraph">
<p>As soon as Bob has given this secret to Alice, he <em>must not</em> ever broadcast that old commitment. If he does, he will give Alice the opportunity to penalize him by taking the funds. Essentially, Bob is giving Alice the ability to hold him accountable for broadcasting an old commitment, and in effect he has revoked his ability to use that old commitment.</p>
</div>
<div class="paragraph">
<p>Once Alice has received the revoke_and_ack from Bob, she can be sure that Bob cannot broadcast the old commitment without being penalized. She now has the keys necessary to create a penalty transaction if Bob broadcasts an old commitment.</p>
</div>
</div>
<div class="sect3">
<h4 id="revocation_secret_derivation">Cheating and Penalty in Practice</h4>
<div class="paragraph">
<p>In practice, both Alice and Bob have to monitor for cheating. They are monitoring the Bitcoin blockchain for any commitment transactions related to any of the channels they are operating. If they see a commitment transaction confirmed on-chain, they will check to see if it is the most recent commitment. If it is an "old" commitment, they must immediately construct and broadcast a penalty transaction. The penalty transaction spends <em>both</em> the to_local and to_remote outputs, closing the channel and sending both balances to the cheated channel partner.</p>
</div>
<div class="paragraph">
<p>To more easily allow both sides to keep track of the commitment numbers of the passed revoke commitments, each commitment actually <em>encodes</em> the number of the commitment within the lock time and sequence fields in a transition. Within the protocol, this special encoding is referred to as <em>state hints</em>. Assuming a party knows the current commitment number, they&#8217;re able to use the state hints to easily recognize if a broadcasted commitment was a revoked one, and if so, which commitment number was breached, as that number is used to easily look up which revocation secret should be used in the revocation secret tree (shachain).</p>
</div>
<div class="paragraph">
<p>Rather than encode the state hint in plain sight, an <em>obfuscated</em> state hint is used in its place. This obfuscation is achieved by first XORing the current commitment number with a set of random bytes generated deterministically using the funding public keys of both sides of the channel. A total of 6 bytes across the lock time and sequence (24 bits of the locktime and 24 bits of the sequence) are used to encode the state hint within the commitment transaction, so 6 random bytes are needed to use for XORing. To obtain these 6 bytes, both sides obtain the SHA-256 hash of the initiator&#8217;s funding key concatenated to the responder&#8217;s funding key. Before encoding the current commitment height, the integer is XORed with this state hint obfuscator, and then encoded in the lower 24 bits of the locktime, and the upper 64 bits of the sequence.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s review our channel between Alice and Bob and show a specific example of a penalty transaction. In <a href="#competing_commitments_2">Revoked and current commitments</a> we see the four commitments on Alice and Bob&#8217;s channel. Alice has made three payments to Bob:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>70,000 satoshis paid and committed to Bob with Commitment #1</p>
</li>
<li>
<p>10,000 satoshis paid and committed to Bob with Commitment #2</p>
</li>
<li>
<p>20,000 satoshis paid and committed to Bob with Commitment #3</p>
</li>
</ul>
</div>
<div id="competing_commitments_2" class="imageblock">
<div class="content">
<img src="images/mtln_0712.png" alt="Revoked and current commitments">
</div>
<div class="title">Figure 12. Revoked and current commitments</div>
</div>
<div class="paragraph">
<p>With each commitment, Alice has revoked the previous (older) commitment. The current state of the channel and the correct balance is represented by Commitment #3. All previous commitments have been revoked, and Bob has the keys necessary to issue penalty transactions against them, in case Alice tries to broadcast one of them.</p>
</div>
<div class="paragraph">
<p>Alice might have an incentive to cheat because all the previous commitment transactions would give her a higher proportion of the channel balance than she is entitled to. Let&#8217;s say for example that Alice tried to broadcast Commitment #1. That commitment transaction would pay Alice 70,000 satoshis and Bob 70,000 satoshis. If Alice was able to broadcast and spend her to_local output, she would effectively be stealing 30,000 satoshis from Bob by rolling back her last two payments to Bob.</p>
</div>
<div class="paragraph">
<p>Alice decides to take a huge risk and broadcast the revoked Commitment #1, to steal 30,000 satoshis from Bob. In <a href="#cheating_commitment">Alice cheating</a> we see Alice&#8217;s old commitment that she broadcasts to the Bitcoin blockchain.</p>
</div>
<div id="cheating_commitment" class="imageblock">
<div class="content">
<img src="images/mtln_0713.png" alt="Alice cheating">
</div>
<div class="title">Figure 13. Alice cheating</div>
</div>
<div class="paragraph">
<p>As you can see, Alice&#8217;s old commitment has two outputs, one paying herself 70,000 satoshis (to_local output) and one paying Bob 70,000 satoshis. Alice can&#8217;t yet spend her 70,000 to_local output because it has a 432 block (3 day) timelock. She is now hoping that Bob doesn&#8217;t notice for three days.</p>
</div>
<div class="paragraph">
<p>Unfortunately for Alice, Bob&#8217;s node is diligently monitoring the Bitcoin blockchain and sees an old commitment transaction broadcast and (eventually) confirmed on-chain.</p>
</div>
<div class="paragraph">
<p>Bob&#8217;s node will immediately broadcast a penalty transaction. Since this old commitment was revoked by Alice, Bob has the per_commitment_secret that Alice sent him. He uses that secret to construct a signature for the revocation_pubkey. While Alice has to wait for 432 blocks, Bob can spend <em>both</em> outputs immediately. He can spend the to_remote output with his private keys because it was meant to pay him anyway. He can also spend the output meant for Alice with a signature from the revocation key. His node broadcasts the penalty transaction shown in <a href="#penalty_transaction">Cheating and penalty</a>.</p>
</div>
<div id="penalty_transaction" class="imageblock">
<div class="content">
<img src="images/mtln_0714.png" alt="Cheating and penalty">
</div>
<div class="title">Figure 14. Cheating and penalty</div>
</div>
<div class="paragraph">
<p>Bob&#8217;s penalty transaction pays 140,000 satoshis to his own wallet, taking the entire channel capacity. Alice has not only failed to cheat, she has lost everything in the attempt!</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_channel_reserve_ensuring_skin_in_the_game">The Channel Reserve: Ensuring Skin in the Game</h4>
<div class="paragraph">
<p>You may have noticed there is a special situation that needs to be dealt with. If Alice could keep spending her balance until it is zero, she would be in a position to close the channel by broadcasting an old commitment transaction without risking a penalty: either the revoked commitment transaction succeeds after the delay, or the cheater gets caught but there&#8217;s no consequence because the penalty is zero. From a game theory perspective, it is free money to attempt to cheat in this situation. This is why the channel reserve is in play, so a prospective cheater always faces the risk of a penalty.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_closing_the_channel_cooperative_close">Closing the Channel (Cooperative Close)</h3>
<div class="paragraph">
<p>So far we&#8217;ve looked at the commitment transactions as one possible way to close a channel, unilaterally. This type of channel closure is not ideal because it forces a timelock on the channel partner that uses it.</p>
</div>
<div class="paragraph">
<p>A better way to close a channel is a cooperative close. In a cooperative close, the two channel partners negotiate a final commitment transaction called the <em>closing transaction</em> that pays each party their balance immediately to the destination wallet of their choice. Then, the partner that initiated the channel closing flow will broadcast the closing transaction.</p>
</div>
<div class="paragraph">
<p>The closing message flow is defined in <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/02-peer-protocol.md#channel-close">BOLT #2: Peer Protocol, Channel Close</a>, and is shown in <a href="#closing_message_flow">The channel close message flow</a>.</p>
</div>
<div id="closing_message_flow" class="imageblock">
<div class="content">
<img src="images/mtln_0715.png" alt="The channel close message flow">
</div>
<div class="title">Figure 15. The channel close message flow</div>
</div>
<div class="sect3">
<h4 id="theShutdownmessage">The Shutdown Message</h4>
<div class="paragraph">
<p>Channel closing starts with one of the two channel partners sending the shutdown message. The contents of this message are shown here:</p>
</div>
<div id="shutdown_message" class="listingblock">
<div class="title">The shutdown message</div>
<div class="content">
<pre>[channel_id:channel_id]
[u16:len]
[len*byte:scriptpubkey]</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">channel_id</dt>
<dd>
<p>The channel identifier for the channel we want to close</p>
</dd>
<dt class="hdlist1">len</dt>
<dd>
<p>The length of the script of the destination wallet that this channel partner wants to receive their balance</p>
</dd>
<dt class="hdlist1">scriptpubkey</dt>
<dd>
<p>A Bitcoin script of the destination wallet, in one of the "standard" Bitcoin address formats (P2PKH, P2SH, P2WPKH, P2WSH, etc.; see the <a href="#glossary">[glossary]</a>)</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Let&#8217;s say Alice sends the shutdown message to Bob to close their channel. Alice will specify a Bitcoin script that corresponds to the Bitcoin address of her wallet. She&#8217;s telling Bob: let&#8217;s make a closing transaction that pays my balance to this wallet.</p>
</div>
<div class="paragraph">
<p>Bob will respond with his own shutdown message indicating that he agrees to cooperatively close the channel. His shutdown message includes the script for his wallet address.</p>
</div>
<div class="paragraph">
<p>Now both Alice and Bob have each other&#8217;s preferred wallet address, and they can construct identical closing transactions to settle the channel balance.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_closing_signed_message">The closing_signed Message</h4>
<div class="paragraph">
<p>Assuming the channel has no outstanding commitments or updates and the channel partners have exchanged the shutdown messages shown in the previous section, they can now finish this cooperative close.</p>
</div>
<div class="paragraph">
<p>The <em>funder</em> of the channel (Alice in our example) starts by sending a closing_signed message to Bob. This message proposes a transaction fee for the on-chain transaction, and Alice&#8217;s signature (the 2-of-2 multisig) for the closing transaction. The closing_signed message is shown here:</p>
</div>
<div id="closing_signed_message" class="listingblock">
<div class="title">The closing_signed message</div>
<div class="content">
<pre>[channel_id:channel_id]
[u64:fee_satoshis]
[signature:signature]</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">channel_id</dt>
<dd>
<p>The channel identifier</p>
</dd>
<dt class="hdlist1">fee_satoshis</dt>
<dd>
<p>The proposed on-chain transaction fee, in satoshis</p>
</dd>
<dt class="hdlist1">signature</dt>
<dd>
<p>The sender&#8217;s signature for the closing transaction</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>When Bob receives this, he can reply with a closing_signed message of his own. If he agrees with the fee, he simply returns the same proposed fee and his own signature. If he disagrees, he must propose a different fee_satoshis fee.</p>
</div>
<div class="paragraph">
<p>This negotiation may continue with back-and-forth closing_signed messages until the two channel partners agree on a fee.</p>
</div>
<div class="paragraph">
<p>Once Alice receives a closing_signed message with the same fee as the one she proposed in her last message, the negotiation is complete. Alice signs and broadcasts the closing transaction and the channel is closed.</p>
</div>
</div>
<div class="sect3">
<h4 id="_the_cooperative_close_transaction">The Cooperative Close Transaction</h4>
<div class="paragraph">
<p>The cooperative close transaction looks similar to the last commitment transaction that Alice and Bob had agreed on. However, unlike the last commitment transaction, it does not have timelocks or penalty revocation keys in the outputs. Since both parties cooperate to produce this transaction and they won&#8217;t be making any further commitments, there is no need for the asymmetric, delayed, and revocable elements in this transaction.</p>
</div>
<div class="paragraph">
<p>Typically the addresses used in this cooperative close transaction are generated freshly for each channel being closed. However, it&#8217;s also possible for both sides to <em>lock in</em> a "delivery" address to be used to send their cooperatively settled funds to. Within the TLV namespace of both the <code>open_channel</code> and <code>accept_channel</code> messages, both sides are free to specify an "up-front shutdown script." Commonly, this address is derived from keys that reside in cold storage. This practice serves to increase the security of channels: if a channel partner is somehow hacked, then the hacker isn&#8217;t able to cooperatively close the channel using an address they control. Instead, the uncompromised honest channel partner will refuse to cooperate on a channel closure if the specified up-front shutdown address isn&#8217;t used. This feature effectively creates a "closed loop," restricting the flow of funds out of a given channel.</p>
</div>
<div class="paragraph">
<p>Alice broadcasts a transaction shown in <a href="#closing_transaction">The cooperative close transaction</a> to close the channel.</p>
</div>
<div id="closing_transaction" class="imageblock">
<div class="content">
<img src="images/mtln_0716.png" alt="The cooperative close transaction">
</div>
<div class="title">Figure 16. The cooperative close transaction</div>
</div>
<div class="paragraph">
<p>As soon as this closing transaction is confirmed on the Bitcoin blockchain, the channel is closed. Now, Alice and Bob can spend their outputs as they please.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_conclusion">Conclusion</h3>
<div class="paragraph">
<p>In this section we looked at payment channels in much more detail. We examined three message flows used by Alice and Bob to negotiate funding, commitments, and closing of the channel. We also showed the structure of the funding, commitment, and closing transactions, and looked at the revocation and penalty mechanisms.</p>
</div>
<div class="paragraph">
<p>As we will see in the next few chapters, HTLCs are used even for local payments between channel partners. They are not necessary, but the protocol is much simpler if local (one channel) and routed (many channels) payments are done in the same way.</p>
</div>
<div class="paragraph">
<p>In a single payment channel, the number of payments per second is only bound by the network capacity between Alice and Bob. As long as the channel partners are able to send a few bytes of data back and forth to agree to a new channel balance, they have effectively made a payment. This is why we can achieve a much greater throughput of payments on the Lightning Network (off-chain) than the transaction throughput that can be handled by the Bitcoin blockchain (on-chain).</p>
</div>
<div class="paragraph">
<p>In the next few chapters we will discuss routing, HTLCs, and their use in channel operations.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2022-10-29 15:50:16 +0400
</div>
</div>
</body>
</html>