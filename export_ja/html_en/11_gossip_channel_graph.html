<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.16">
<title>Gossip and the Channel Graph</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;-webkit-tap-highlight-color:transparent}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="gossip">Gossip and the Channel Graph</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this chapter we will describe the Lightning Network&#8217;s gossip protocol and how it is used by nodes to construct and maintain a channel graph. We will also review the DNS bootstrap mechanism used to find peers to "gossip" with.</p>
</div>
<div class="paragraph">
<p>The "Routing fees and Gossip relaying" section is highlighted by an outline spanning the routing layer and peer-to-peer layer of <a href="#LN_protocol_gossip_highlight">Gossip protocol in the Lightning protocol suite</a>.</p>
</div>
<div id="LN_protocol_gossip_highlight" class="imageblock">
<div class="content">
<img src="images/mtln_1101.png" alt="Gossip protocol in the Lightning protocol suite">
</div>
<div class="title">Figure 1. Gossip protocol in the Lightning protocol suite</div>
</div>
<div class="paragraph">
<p>As we&#8217;ve learned already, the Lightning Network uses a source-based onion routing protocol to deliver a payment from a sender to the recipient.
To do this, the sending node must be able to construct a path of payment channels that connects it with the recipient, as we will see in <a href="#path_finding">[path_finding]</a>.
Thus, the sender has to be able to map the Lightning Network by constructing a channel graph.
The <em>channel graph</em> is the interconnected set of publicly advertised channels and the nodes that these channels interlink.</p>
</div>
<div class="paragraph">
<p>As channels are backed by a funding transaction that is happening on-chain, one might falsely believe that Lightning nodes could just extract the existing channels from the Bitcoin blockchain.
However this is only possible to a certain extent.
The funding transactions are Pay-to-Witness-Script-Hash (P2WSH) addresses, and the nature of the script (a 2-of-2 multisig) will only be revealed once the funding transaction output is spent.
Even if the nature of the script were known, it&#8217;s important to remember that not all 2-of-2 multisig scripts correspond to payment channels.</p>
</div>
<div class="paragraph">
<p>There are even more reasons why looking at the Bitcoin blockchain might not be helpful.
For example, on the Lightning Network, the Bitcoin keys that are used for signing are rotated by the nodes for every channel and update.
Thus, even if we could reliably detect funding transactions on the Bitcoin blockchain, we would not know which two nodes on the Lightning Network own that particular channel.</p>
</div>
<div class="paragraph">
<p>The Lightning Network solves this problem by implementing a <em>gossip protocol</em>.
Gossip protocols are typical for peer-to-peer (P2P) networks and allow nodes to share information with the whole network with just a few direct connections to peers.
Lightning nodes open encrypted peer-to-peer connections to each other and share (gossip) information that they have received from other peers.
As soon as a node wants to share some information, for example, about a newly created channel, it sends a message to all its peers.
Upon receiving a message, a node decides if the received message was novel and, if so, forwards the information to its peers.
In this way, if the peer-to-peer network is well connected, all new information that is necessary for the operation of the network will eventually be propagated to all other peers.</p>
</div>
<div class="paragraph">
<p>Obviously, if a new peer joins the network for the first time, it needs to know some other peers on the network, so it can connect to others and participate in the network.</p>
</div>
<div class="paragraph">
<p>In this chapter, we&#8217;ll explore exactly <em>how</em> Lightning nodes discover each other, discover and update their node status, and communicate with one another.</p>
</div>
<div class="paragraph">
<p>When most refer to the <em>network</em> part of the Lightning Network, they&#8217;re referring to the <em>channel graph</em> which itself is a unique authenticated data structure <em>anchored</em> in the base Bitcoin
blockchain.</p>
</div>
<div class="paragraph">
<p>However, the Lightning Network is also a peer-to-peer network of nodes that gossip information about payment channels and nodes. Usually, for two peers to maintain a payment channel they need to talk to each other directly, which means that there will be a peer connection between them.
This suggests that the channel graph is a subnetwork of the peer-to-peer network.
However, this is not true because payment channels can remain open even if one or both peers go temporarily offline.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s revisit some of the terminology that we have used throughout the book, specifically looking at what they mean in terms of the channel graph and the peer-to-peer network (see <a href="#network_terminology">Terminology of the different networks</a>).</p>
</div>
<table id="network_terminology" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Terminology of the different networks</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Channel graph</th>
<th class="tableblock halign-left valign-top">Peer-to-peer network</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">channel</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">connection</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">open</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">connect</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">close</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">disconnect</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">funding transaction</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">encrypted TCP/IP connection</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">send</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">transmit</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">payment</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">message</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Because the Lightning Network is a peer-to-peer network, some initial bootstrapping is required in order for peers to discover each other.  Within this chapter we&#8217;ll follow the story of a new peer connecting to the network for the first time and examine each step in the bootstrapping process, from initial peer discovery to channel graph syncing and validation.</p>
</div>
<div class="paragraph">
<p>As an initial step, our new node needs to somehow <em>discover</em> at least <em>one</em> peer that is already connected to the network and has a full channel graph (as we&#8217;ll see later, there&#8217;s no canonical version of the channel graph). Using one of many initial bootstrapping protocols to find that first peer, after a connection is established, our new
peer now needs to <em>download</em> and <em>validate</em> the channel graph. Once the channel graph has been fully validated, our new peer is ready to start opening channels and sending payments on the network.</p>
</div>
<div class="paragraph">
<p>After initial bootstrap, a node on the network needs to continue to maintain its view of the channel graph by processing new channel routing policy updates, discovering and validating new channels, removing channels that have been closed on-chain, and finally pruning channels that fail to send out a proper "heartbeat" every two weeks <span class="keep-together">or so</span>.</p>
</div>
<div class="paragraph">
<p>Upon completion of this chapter, you will understand a key component of
the peer-to-peer Lightning Network: namely, how peers discover each other and maintain a local copy (perspective) of the channel graph. We&#8217;ll begin by exploring the story of a new node that has just booted up and needs to find other peers to connect to on the network.</p>
</div>
<div class="sect2 pagebreak-before less_space">
<h3 id="_peer_discovery">Peer Discovery</h3>
<div class="paragraph">
<p>In this section, we&#8217;ll begin to follow a new Lightning node that wishes to join the network through three steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Discover a set of bootstrap peers</p>
</li>
<li>
<p>Download and validate the channel graph</p>
</li>
<li>
<p>Begin the process of ongoing maintenance of the channel graph itself</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_p2p_bootstrapping">P2P Bootstrapping</h4>
<div class="paragraph">
<p>Before doing any thing else, our new node first needs to discover a set of peers who are already part of the network. We call this process initial peer bootstrapping, and it&#8217;s something that every peer-to-peer network needs to implement properly to ensure a robust, healthy network.</p>
</div>
<div class="paragraph">
<p>Bootstrapping new peers to existing peer-to-peer networks is a very well studied problem with several known solutions, each with their own distinct trade-offs. The simplest solution to this problem is simply to package a set of <em>hardcoded</em> bootstrap peers into the packaged P2P node software. This is simple in that each new node has a list of bootstrap peers in the software they&#8217;re running, but rather fragile given that if the set of bootstrap peers goes offline, then no new nodes will be able to join the network. Due to this fragility, this
option is usually used as a fallback in case none of the other P2P bootstrapping mechanisms work properly.</p>
</div>
<div class="paragraph">
<p>Rather than hardcoding the set of bootstrap peers within the software/binary itself, we can instead allow peers to dynamically obtain a fresh/new set of bootstrap peers they can use to join the network. We&#8217;ll call this process <em>initial peer discovery</em>. Typically we&#8217;ll leverage
existing internet protocols to maintain and distribute a set of bootstrapping peers. A nonexhaustive list of protocols that have been used in the past to accomplish initial peer discovery includes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Domain Name Service (DNS)</p>
</li>
<li>
<p>Internet Relay Chat (IRC)</p>
</li>
<li>
<p>Hypertext Transfer Protocol (HTTP)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Similar to the Bitcoin protocol, the primary initial peer discovery mechanism used in the Lightning Network happens via DNS. Because initial peer discovery is a critical and universal task for the network, the process has been <em>standardized</em> in <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/10-dns-bootstrap.md">BOLT #10: DNS Bootstrap</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_dns_bootstrapping">DNS Bootstrapping</h4>
<div class="paragraph">
<p>The <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/10-dns-bootstrap.md">BOLT #10</a> document describes a standardized way of implementing peer
discovery using the DNS. Lightning&#8217;s flavor of DNS-based bootstrapping uses up to three distinct record types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SRV records for discovering a set of <em>node public keys</em>.</p>
</li>
<li>
<p>A records for mapping a node&#8217;s public key to its current IPv4 address.</p>
</li>
<li>
<p>AAA records for mapping a node&#8217;s public key to its current IPv6 address.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Those somewhat familiar with the DNS protocol may already be familiar with the A (name to IPv4 address) and AAA (name to IPv6 address) record types, but not the SRV type. The SRV record type is used by protocols built on top of DNS to determine the <em>location</em> for a specified service. In our context, the service in question is a given Lightning node, and the location is its IP address. We need to use this additional record type because, unlike nodes within the Bitcoin protocol, we need both a public key <em>and</em> an IP address to connect to a node. As we see in <a href="#wire_protocol">[wire_protocol]</a>, the transport encryption protocol used in the Lightning Network requires knowledge of the public key of a node before connecting, so as to implement identity hiding for nodes in the network.</p>
</div>
<div class="sect4">
<h5 id="_a_new_peers_bootstrapping_workflow">A new peer&#8217;s bootstrapping workflow</h5>
<div class="paragraph">
<p>Before diving into the specifics of <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/10-dns-bootstrap.md">BOLT #10</a>, we&#8217;ll first outline the high-level flow of a new node that wishes to use BOLT #10 to join the network.</p>
</div>
<div class="paragraph">
<p>First, a node needs to identify a single DNS server or set of DNS servers that understand BOLT #10 so they can be used for P2P bootstrapping.</p>
</div>
<div class="paragraph">
<p>While BOLT #10 uses <em>lseed.bitcoinstats.com</em> as the seed server, there exists no "official" set of DNS seeds for this purpose, but each of the major implementations maintains their own DNS seed, and they cross-query each other&#8217;s seeds for redundancy purposes. In <a href="#dns_seeds">Table of known Lightning DNS seed servers</a> you&#8217;ll see a nonexhaustive list of some popular DNS seed servers.</p>
</div>
<table id="dns_seeds" class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Table of known Lightning DNS seed servers</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">DNS server</th>
<th class="tableblock halign-left valign-top">Maintainer</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>lseed.bitcoinstats.com</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Christian Decker</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>nodes.lightning.directory</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Lightning Labs (Olaoluwa Osuntokun)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>soa.nodes.lightning.directory</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Lightning Labs (Olaoluwa Osuntokun)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>lseed.darosior.ninja</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Antoine Poinsot</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>DNS seeds exist for both Bitcoin&#8217;s mainnet and testnet. For the sake
of our example, we&#8217;ll assume the existence of a valid BOLT #10 DNS seed at <em>nodes.lightning.directory</em>.</p>
</div>
<div class="paragraph">
<p>Next, our new node will issue an SRV query to obtain a set of <em>candidate bootstrap peers</em>. The response to our query will be a series of bech32 encoded public keys. Because DNS is a text-based protocol, we can&#8217;t send raw binary data, so an encoding scheme is required. BOLT #10 specifies a bech32 encoding due to its use in the wider Bitcoin ecosystem. The number of encoded public keys returned depends on the server returning the query, as well as all the resolvers that stand between the client and the authoritative server.</p>
</div>
<div class="paragraph">
<p>Using the widely available dig command-line tool, we can query the <em>testnet</em> version of the DNS seed mentioned previously with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ dig @8.8.8.8 test.nodes.lightning.directory SRV</pre>
</div>
</div>
<div class="paragraph">
<p>We use the @ argument to force resolution via Google&#8217;s nameserver (with IP address 8.8.8.8) because it does not filter large SRV query responses. At the end of the command, we specify that we only want SRV records to be returned. A sample response looks something like <a href="#ex1101">Querying the DNS seed for reachable nodes</a>.</p>
</div>
<div id="ex1101" class="exampleblock">
<div class="title">Example 1. Querying the DNS seed for reachable nodes</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre>$ dig @8.8.8.8 test.nodes.lightning.directory SRV

; &lt;&lt;&gt;&gt; DiG 9.10.6 &lt;&lt;&gt;&gt; @8.8.8.8 test.nodes.lightning.directory SRV
; (1 server found)
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 43610
;; flags: qr rd ra; QUERY: 1, ANSWER: 25, AUTHORITY: 0, ADDITIONAL: 1

;; QUESTION SECTION:
;test.nodes.lightning.directory.	IN	SRV

;; ANSWER SECTION:
test.nodes.lightning.directory.	59 IN	SRV	10 10 9735 <b class="conum">(1)</b>
ln1qfkxfad87fxx7lcwr4hvsalj8vhkwta539nuy4zlyf7hqcmrjh40xx5frs7.test.nodes.lightning.directory. <b class="conum">(2)</b>
test.nodes.lightning.directory.	59 IN	SRV	10 10 15735 ln1qtgsl3efj8verd4z27k44xu0a59kncvsarxatahm334exgnuvwhnz8dkhx8.test.nodes.lightning.directory.

 [...]

;; Query time: 89 msec
;; SERVER: 8.8.8.8#53(8.8.8.8)
;; WHEN: Thu Dec 31 16:41:07 PST 2020</pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>TCP port number where the LN node can be reached.</p>
</li>
<li>
<p>Node public key (ID) encoded as a virtual domain name.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ve truncated the response for brevity and show only two of the returned responses. The responses contain a "virtual" domain name for a target node, then to the left we have the <em>TCP port</em> where this node can be reached. The first response uses the standard TCP port for the Lightning Network: 9735. The second response uses a custom port, which is permitted by the protocol.</p>
</div>
<div class="paragraph">
<p>Next, we&#8217;ll attempt to obtain the other piece of information we need to connect to a node: its IP address. Before we can query for this, however, we&#8217;ll first <em>decode</em> the bech32 encoding of the public key from the virtual domain name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>ln1qfkxfad87fxx7lcwr4hvsalj8vhkwta539nuy4zlyf7hqcmrjh40xx5frs7</pre>
</div>
</div>
<div class="paragraph">
<p>Decoding this bech32 string we obtain the following valid
secp256k1 public key:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>026c64f5a7f24c6f7f0e1d6ec877f23b2f672fb48967c2545f227d70636395eaf3</pre>
</div>
</div>
<div class="paragraph">
<p>Now that we have the raw public key, we&#8217;ll ask the DNS server to <em>resolve</em> the virtual host given so we can obtain the IP information (A record) for the node, as shown in <a href="#ex1102">[ex1102]</a>.</p>
</div>
<div id="ex1102" data-type="example">
<h5>Obtaining the latest IP address for a node</h5>

<pre data-type="programlisting">$ dig ln1qfkxfad87fxx7lcwr4hvsalj8vhkwta539nuy4zlyf7hqcmrjh40xx5frs7.test.nodes.lightning.directory A

; &lt;&lt;&gt;&gt; DiG 9.10.6 &lt;&lt;&gt;&gt; ln1qfkxfad87fxx7lcwr4hvsalj8vhkwta539nuy4zlyf7hqcmrjh40xx5frs7.test.nodes.lightning.directory A
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 41934
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;ln1qfkxfad87fxx7lcwr4hvsalj8vhkwta539nuy4zlyf7hqcmrjh40xx5frs7.test.nodes.lightning.directory. IN A

;; ANSWER SECTION:
ln1qfkxfad87fxx7lcwr4hvsalj8vhkwta539nuy4zlyf7hqcmrjh40xx5frs7.test.nodes.lightning.directory. 60 IN A <em>X.X.X.X</em> <a class="co" id="comarker1" href="#c01"><img src="callouts/1.png" alt="1"/></a>

;; Query time: 83 msec
;; SERVER: 2600:1700:6971:6dd0::1#53(2600:1700:6971:6dd0::1)
;; WHEN: Thu Dec 31 16:59:22 PST 2020
;; MSG SIZE  rcvd: 138</pre>

<dl class="calloutlist">
<dt><a class="co" id="c01" href="#comarker1"><img src="callouts/1.png" alt="1"/></a></dt>
<dd><p>The DNS server returns an IP address <code><em>X.X.X.X</em></code>. We’ve replaced it with X’s in the text here so as to avoid presenting a real IP address.</p></dd>
</dl></div>
<div class="paragraph">
<p>In the preceding command, we&#8217;ve queried the server so we can obtain an IPv4 <span class="keep-together">(<code>A</code> record)</span> address for our target node (replaced by __X.X.X.X__ in the preceding example). Now that we have the raw public key, IP address, and TCP port, we can connect to the node transport protocol at:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>026c64f5a7f24c6f7f0e1d6ec877f23b2f672fb48967c2545f227d70636395eaf3@X.X.X.X:9735</pre>
</div>
</div>
<div class="paragraph">
<p>Querying the current DNS A record for a given node can also be used to look up the <em>latest</em> set of addresses. Such queries can be used to more quickly sync the latest addressing information for a node, compared to waiting for address updates on the gossip network (see <a href="#node_announcement">The node_announcement Message</a>).</p>
</div>
<div class="paragraph">
<p>At this point in our journey, our new Lightning node has found its first
peer and established its first connection! Now we can begin the second phase of new peer bootstrapping: channel graph synchronization and validation.</p>
</div>
<div class="paragraph">
<p>First, we&#8217;ll explore more of the intricacies of BOLT #10 itself to take a deeper look into how things work under the hood.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_srv_query_options">SRV Query Options</h4>
<div class="paragraph">
<p>The <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/10-dns-bootstrap.md">BOLT #10</a> standard is highly extensible due to its usage of nested
subdomains as a communication layer for additional query options. The
bootstrapping protocol allows clients to further specify the <em>type</em> of nodes they&#8217;re attempting to query for versus the default of receiving a random subset of nodes in the query responses.</p>
</div>
<div class="paragraph">
<p>The query option subdomain scheme uses a series of key-value pairs where the key itself is a <em>single letter</em> and the remaining set of text is the value itself. The following query types exist in the current version of the <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/10-dns-bootstrap.md">BOLT #10</a> standards document:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">r</dt>
<dd>
<p>The <em>realm</em> byte which is used to determine which chain or realm    queries should be returned for. As is, the only value for this key is 0 which denotes "Bitcoin."</p>
</dd>
<dt class="hdlist1">a</dt>
<dd>
<p>Allows clients to filter out returned nodes based on the <em>types</em> of addresses they advertise. As an example, this can be used to only obtain nodes that advertise a valid IPv6 address. The value that follows this type is based on a bitfield that <em>indexes</em> into the set of specified address <em>types</em> that are defined in <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/07-routing-gossip.md">BOLT #7</a>. The default value for this field is 6, which represents both IPv4 and IPv6 (bits 1 and 2 are set).</p>
</dd>
<dt class="hdlist1">l</dt>
<dd>
<p>A valid node public key serialized in compressed format. This allows a client to query for a specified node rather than receiving a set of random nodes.</p>
</dd>
<dt class="hdlist1">n</dt>
<dd>
<p>The number of records to return. The default value for this field is 25.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>An example query with additional query options looks something like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>r0.a2.n10.nodes.lightning.directory</pre>
</div>
</div>
<div class="paragraph">
<p>Breaking down the query one key-value pair at a time, we gain the following
insights:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">r0</dt>
<dd>
<p>The query targets the Bitcoin realm</p>
</dd>
<dt class="hdlist1">a2</dt>
<dd>
<p>The query only wants IPv4 addresses to be returned</p>
</dd>
<dt class="hdlist1">n10</dt>
<dd>
<p>The query requests</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Try some combinations of the various flags using the dig DNS command-line tool yourself:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>dig @8.8.8.8 r0.a6.nodes.lightning.directory SRV</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_channel_graph">The Channel Graph</h3>
<div class="paragraph">
<p>Now that our new node is able to use the DNS bootstrapping protocol to connect to its very first peer, it can start to sync the channel graph! However, before we sync the channel graph, we&#8217;ll need to learn exactly <em>what</em> we mean by the channel graph. In this section we&#8217;ll explore the precise <em>structure</em> of the channel graph and examine the unique aspects of the channel graph compared to the typical abstract "graph" data structure which is well-known/used in the field of computer science.</p>
</div>
<div class="sect3">
<h4 id="_a_directed_graph">A Directed Graph</h4>
<div class="paragraph">
<p>A <em>graph</em> in computer science is a special data structure composed of vertices (typically referred to as nodes) and edges (also known as links). Two nodes may be connected by one or more edges. The channel graph is also <em>directed</em> given that a payment is able to flow in either direction over a given edge (a channel). An example of a <em>directed graph</em> is shown in <a href="#directed_graph">A directed graph</a>.</p>
</div>
<div id="directed_graph" class="imageblock">
<div class="content">
<img src="images/mtln_1102.png" alt="A directed graph">
</div>
<div class="title">Figure 2. A directed graph</div>
</div>
<div class="paragraph">
<p>In the context of the Lightning Network, our vertices are the Lightning nodes themselves, with our edges being the payment channels connecting these nodes. Because we&#8217;re concerned with <em>routing payments</em>, in our model a node with no edges (no payment channels) isn&#8217;t considered to be a part of the graph since it isn&#8217;t useful.</p>
</div>
<div class="paragraph">
<p>Because channels themselves are UTXOs (funded 2-of-2 multisig addresses), we can view the channel graph as a special subset of the Bitcoin UTXO set, on top of which we can add some additional information (the nodes, etc.) to arrive at the final overlay structure, which is the channel graph. This anchoring of fundamental components of the channel graph in the
base Bitcoin blockchain means that it&#8217;s impossible to <em>fake</em> a valid channel graph, which has useful properties when it comes to spam prevention as we&#8217;ll see later.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_gossip_protocol_messages">Gossip Protocol Messages</h3>
<div class="paragraph">
<p>The channel graph information is propagated across the Lightning P2P Network as three messages, which are described in <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/07-routing-gossip.md">BOLT #7</a>:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">node_announcement</dt>
<dd>
<p>The vertex in our graph which communicates the public key of a node, as well as how to reach the node over the internet and some additional metadata describing the set of <em>features</em> the node supports.</p>
</dd>
<dt class="hdlist1">channel_announcement</dt>
<dd>
<p>A blockchain anchored proof of the existence of a channel between two individual nodes. Any third party can verify this proof to ensure that a <em>real</em> channel is actually being advertised. Similar to the node_announcement, this message also contains information describing the <em>capabilities</em> of the channel, which is useful when attempting to route a payment.</p>
</dd>
<dt class="hdlist1">channel_update</dt>
<dd>
<p>A <em>pair</em> of structures that describes the set of routing policies for a given channel. channel_update messages come in a <em>pair</em> because a channel is a directed edge, so each side of the channel is able to specify its own custom routing policy.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>It&#8217;s important to note that each component of the channel graph is <em>authenticated</em>, allowing a third party to ensure that the owner of a channel/update/node is actually the one sending out an update. This effectively makes the channel graph a unique type of <em>authenticated data structure</em> that cannot be counterfeited. For authentication, we use an secp256k1 ECDSA digital signature (or a series of them) over the serialized digest of the message itself. We won&#8217;t get into the specific of the messaging framing/serialization used in the Lightning Network in this chapter, as we&#8217;ll cover that information in <a href="#wire_protocol">[wire_protocol]</a>.</p>
</div>
<div class="paragraph">
<p>With the high-level structure of the channel graph laid out, we&#8217;ll now dive down into the precise structure of each of the three messages used to gossip the channel graph. We&#8217;ll also explain how one can also verify each message and component of the channel graph.</p>
</div>
<div class="sect3">
<h4 id="node_announcement">The node_announcement Message</h4>
<div class="paragraph">
<p>First, we have the node_announcement message, which serves two primary
purposes:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>To advertise connection information so other nodes can connect to a node either to bootstrap to the network or to attempt to establish a  new payment channel with that node.</p>
</li>
<li>
<p>To communicate the set of protocol-level features (capabilities) a node understands/supports. Feature negotiation between nodes allows developers to add new features independently and support them with any other node on an opt-in basis.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Unlike channel announcements, node announcements are not anchored in
the base blockchain. Therefore, node announcements are
only considered valid if they have propagated with a corresponding channel announcement. In other words, we always reject nodes without payment channels to ensure a malicious peer can&#8217;t flood the network with bogus nodes that are not part of the channel graph.</p>
</div>
<div class="sect4">
<h5 id="_the_node_announcement_message_structure">The node_announcement message structure</h5>
<div class="paragraph">
<p>The node_announcement is comprised of
the following fields:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">signature</dt>
<dd>
<p>A valid ECDSA signature that covers the serialized digest of all fields listed below. This signature must correspond to the public key of the advertised node.</p>
</dd>
<dt class="hdlist1">features</dt>
<dd>
<p>A bit vector that describes the set of protocol features that this node understands. We&#8217;ll cover this field in more detail in <a href="#feature_bits">[feature_bits]</a> on the extensibility of the Lightning protocol. At a high level, this field carries a set of bits that represent the features a node understands. As an example, a node may signal that it understands the latest channel type.</p>
</dd>
<dt class="hdlist1">timestamp</dt>
<dd>
<p>A Unix epoch encoded timestamp. This allows clients to enforce a partial ordering over the updates to a node&#8217;s announcement.</p>
</dd>
<dt class="hdlist1">node_id</dt>
<dd>
<p>The secp256k1 public key that this node announcement belongs to. There can only be a single node_announcement for a given node in the channel graph at any given time. As a result, a node_announcement can supersede a prior node_announcement for the same node if it carries a higher (later) timestamp.</p>
</dd>
<dt class="hdlist1">rgb_color</dt>
<dd>
<p>A field that allows a node to specify an RGB color to be associated with it, often used in channel graph visualizations and node directories.</p>
</dd>
<dt class="hdlist1">alias</dt>
<dd>
<p>A UTF-8 string to serve as the nickname for a given node. Note that these aliases aren&#8217;t required to be globally unique, nor are they verified in any way. As a result, they should not be relied on as a form of identity—they can be easily spoofed.</p>
</dd>
<dt class="hdlist1">addresses</dt>
<dd>
<p>A set of public internet reachable addresses that are to be associated with a given node. In the current version of the protocol, four address types are supported: IPv4 (type: 1), IPv6 (type: 2), Tor v2 (type: 3), and Tor v3 (type: 4). In the node_announcement message, each of these address types is denoted by an integer type which is included in parenthesis after the address type.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_validating_node_announcements">Validating node announcements</h5>
<div class="paragraph">
<p>Validating an incoming node_announcement is straightforward. The following assertions should be upheld when examining a node announcement:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If an existing node_announcement for that node is already known, then the timestamp field of a new incoming node_announcement must be greater than the prior one.</p>
</li>
<li>
<p>With this constraint, we enforce a forced level of "freshness."</p>
</li>
<li>
<p>If no node_announcement exists for the given node, then an existing channel_announcement that references the given node (more on that later) must already exist in one&#8217;s local channel graph.</p>
</li>
<li>
<p>The included signature must be a valid ECDSA signature verified using the included node_id public key and the double–SHA-256 digest of the raw message encoding (minus the signature and frame header) as the message.</p>
</li>
<li>
<p>All included addresses must be sorted in ascending order based on their address identifier.</p>
</li>
<li>
<p>The included alias bytes must be a valid UTF-8 string.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_channel_announcement_message">The channel_announcement Message</h4>
<div class="paragraph">
<p>Next, we have the channel_announcement message, which is used to <em>announce</em> a new <em>public</em> channel to the wider network. Note that announcing a channel is <em>optional</em>. A channel only needs to be announced if it is intended to be used for routing by the Lightning Network. Active routing nodes may wish to announce all their channels. However, certain nodes like mobile nodes likely don&#8217;t have the
uptime or desire to be an active routing node. As a result, these
mobile nodes (which typically use light clients to connect to the Bitcoin P2P network) instead may have purely <em>unannounced</em> (private) channels.</p>
</div>
<div class="sect4">
<h5 id="_unannounced_private_channels">Unannounced (private) channels</h5>
<div class="paragraph">
<p>An unannounced channel isn&#8217;t part of the known public channel graph, but can still be used to send/receive payments. An astute reader may now be wondering how a channel which isn&#8217;t part of the public channel graph is able to receive payments. The solution to this problem is a set of "pathfinding helpers" that we call routing hints. As we&#8217;ll see in <a href="#invoices">[invoices]</a>, invoices created by nodes with unadvertised channels will include information to help the sender route to them, assuming the node has at least a single channel with an existing public routing node.</p>
</div>
<div class="paragraph">
<p>Due to the existence of unadvertised channels, the <em>true</em> size of the channel graph (both the public and private components) is unknown.</p>
</div>
</div>
<div class="sect4">
<h5 id="_locating_a_channel_on_the_bitcoin_blockchain">Locating a channel on the bitcoin blockchain</h5>
<div class="paragraph">
<p>As mentioned earlier, the channel graph is authenticated due to its usage of public key cryptography, as well as the Bitcoin blockchain as a spam prevention system. To have a node accept a new channel_announcement, the advertisement must <em>prove</em> that the channel actually exists in the Bitcoin blockchain. This proof system adds an up-front cost to adding a new entry to the channel graph (the on-chain fees one must pay to create the UTXO of the channel). As a result, we mitigate spam and ensure that a dishonest node on the network can&#8217;t fill up the memory of an honest node at no cost with bogus channels.</p>
</div>
<div class="paragraph">
<p>Given that we need to construct a proof of the existence of a channel, a
natural question that arises is: how do we "point to" or reference a given channel for the verifier? Given that a payment channel is anchored in an unspent transaction output (see <a href="#utxo">[utxo]</a>), an initial thought might be to first attempt to advertise the full outpoint (txid:index) of the channel. Given that the outpoint is globally unique and confirmed in the chain, this sounds like a good idea; however, it has a drawback: the verifier must maintain a full copy of the UTXO set to verify channels. This works fine for Bitcoin full nodes, but clients that rely on lightweight verification don&#8217;t typically maintain a full UTXO set. Because we want to ensure we can support mobile nodes in the Lightning Network, we&#8217;re forced to find another solution.</p>
</div>
<div class="paragraph">
<p>What if rather than referencing a channel by its UTXO, we reference it based on its "location" in the chain? To do this, we&#8217;ll need a scheme that allows us to reference a given block, then a transaction within that block, and finally a specific output created by that transaction. Such an identifier is described in <a href="https://github.com/lightningnetwork/lightning-rfc/blob/master/07-routing-gossip.md">BOLT #7</a> and is referred to as a <em>short channel ID</em>, or scid.
The scid is used in channel_announcement (and channel_update) as well as within the onion-encrypted routing packet included within HTLCs, as we learned in <a href="#onion_routing">[onion_routing]</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="scid">The short channel ID</h5>
<div class="paragraph">
<p>Based on the preceding information, we have three pieces of information we need to encode to uniquely reference a given channel. Because we want a compact representation, we&#8217;ll attempt to encode the information into a <em>single</em> integer. Our integer format of choice is an unsigned 64-bit integer, comprised of 8 bytes.</p>
</div>
<div class="paragraph">
<p>First, the block height. Using 3 bytes (24 bits) we can encode 16,777,216 blocks. That leaves 5 bytes for us to encode the transaction index and the output index, respectively. We&#8217;ll use the next 3
bytes to encode the transaction index <em>within</em> a block. This is more than enough given that it&#8217;s only possible to fix tens of thousands of transactions in a block at current block sizes. This leaves 2 bytes left for us to encode the output index of the channel within the transaction.</p>
</div>
<div class="paragraph">
<p>Our final scid format resembles:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>block_height (3 bytes) || transaction_index (3 bytes) || output_index (2 bytes)</pre>
</div>
</div>
<div class="paragraph">
<p>Using bit packing techniques, we first encode the most significant 3 bytes as the block height, the next 3 bytes as the transaction index, and the least significant 2 bytes as the output index of that creates the channel UTXO.</p>
</div>
<div class="paragraph">
<p>A short channel ID can be represented as a single integer
(695313561322258433) or as a more human friendly string: 632384x1568x1. Here we see the channel was mined in block 632384, was the 1568th transaction in the block, with the channel output as the second (UTXOs are zero-indexed) output produced by the transaction.</p>
</div>
<div class="paragraph">
<p>Now that we&#8217;re able to succinctly point to a given channel funding output in the chain, we can examine the full structure of the channel_announcement message, as well as see how to verify the proof-of-existence included within the message.</p>
</div>
</div>
<div class="sect4">
<h5 id="_the_channel_announcement_message_structure">The channel_announcement message structure</h5>
<div class="paragraph">
<p>A channel_announcement primarily communicates two things:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A proof that a channel exists between node A and node B with both nodes controlling the mulitsig keys in that channel output.</p>
</li>
<li>
<p>The set of capabilities of the channel (what types of HTLCs can it route, etc.).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>When describing the proof, we&#8217;ll typically refer to node 1 and node 2. Out of the two nodes that a channel connects, the "first" node is the node that has a "lower" public key encoding when we compare the public key of the two nodes in compressed format hex-encoded in lexicographical order. Correspondingly, in addition to a node public key on the network, each node should also control a public key within the Bitcoin blockchain.</p>
</div>
<div class="paragraph">
<p>Similar to the node_announcement message, all included signatures of the channel_announcement message should be signed/verified against the raw encoding of the message (minus the header) that follows <em>after</em> the final signature (because it isn&#8217;t possible for a digital signature to sign itself).</p>
</div>
<div class="paragraph">
<p>With that said, a channel_announcement message has the following fields:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">node_signature_1</dt>
<dd>
<p>The signature of the first node over the message digest.</p>
</dd>
<dt class="hdlist1">node_signature_2</dt>
<dd>
<p>The signature of the second node over the message digest.</p>
</dd>
<dt class="hdlist1">bitcoin_signature_1</dt>
<dd>
<p>The signature of the multisig key (in the funding output) of the first node over the message digest.</p>
</dd>
<dt class="hdlist1">bitcoin_signature_2</dt>
<dd>
<p>The signature of the multisig key (in the funding output) of the second node over the message digest.</p>
</dd>
<dt class="hdlist1">features</dt>
<dd>
<p>A feature bit vector that describes the set of protocol level features supported by this channel.</p>
</dd>
<dt class="hdlist1">chain_hash</dt>
<dd>
<p>A 32-byte hash which is typically the genesis block hash of the blockchain (e.g., Bitcoin mainnet) the channel was opened in.</p>
</dd>
<dt class="hdlist1">short_channel_id</dt>
<dd>
<p>The scid that uniquely locates the given channel funding output within the blockchain.</p>
</dd>
<dt class="hdlist1">node_id_1</dt>
<dd>
<p>The public key of the first node in the network.</p>
</dd>
<dt class="hdlist1">node_id_2</dt>
<dd>
<p>The public key of the second node in the network.</p>
</dd>
<dt class="hdlist1">bitcoin_key_1</dt>
<dd>
<p>The raw multisig key for the channel funding output for the first node in the network.</p>
</dd>
<dt class="hdlist1">bitcoin_key_2</dt>
<dd>
<p>The raw multisig key for the channel funding output for the second node in the network.</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="_channel_announcement_validation">Channel announcement validation</h5>
<div class="paragraph">
<p>Now that we know what a channel_announcement contains, we can look at how to verify the channel&#8217;s existence on-chain.</p>
</div>
<div class="paragraph">
<p>Armed with the information in the channel_announcement, any Lightning node (even one without a full copy of the Bitcoin blockchain) can verify the existence and authenticity of the payment channel.</p>
</div>
<div class="paragraph">
<p>First, the verifier will use the short channel ID to find which Bitcoin block contains the channel funding output. With the block height information, the verifier can request only that specific block from a Bitcoin node. The block can then be linked back to the genesis block by following the block header chain backward (verifying the proof-of-work), confirming that this is in fact a block belonging to the Bitcoin blockchain.</p>
</div>
<div class="paragraph">
<p>Next, the verifier uses the transaction index number to identify the transaction ID of the transaction containing the payment channel. Most modern Bitcoin libraries will allow indexing into the transaction of a block based on the index of the transaction within the greater block.</p>
</div>
<div class="paragraph">
<p>Next, the verifier uses a Bitcoin library (in the verifier&#8217;s language) to extract the relevant transaction according to its index within the block. The verifier will validate the transaction (checking that it is properly signed and produces the same transaction ID when hashed).</p>
</div>
<div class="paragraph">
<p>Next, the verifier will extract the Pay-to-Witness-Script-Hash (P2WSH) output referenced by the output index number of the short channel ID. This is the address of the channel funding output. Additionally, the verifier will ensure that the size of the alleged channel matches the value of the output produced at the specified output index.</p>
</div>
<div class="paragraph">
<p>Finally, the verifier will reconstruct the multisig script from bitcoin_key_1 and bitcoin_key_2 and confirm that it produces the same address as in the output.</p>
</div>
<div class="paragraph">
<p>The verifier has now independently verified that the payment channel in the announcement is funded and confirmed on the Bitcoin blockchain!</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_channel_update_message">The channel_update Message</h4>
<div class="paragraph">
<p>The third and final message used in the gossip protocol is the channel_update message. Two of these are generated for each payment channel (one by each channel partner) announcing their routing fees, timelock expectations, and capabilities.</p>
</div>
<div class="paragraph">
<p>The channel_update message also contains a timestamp, allowing a node to update its routing fees and other expectations and capabilities by sending a new channel_update message with a higher (later) timestamp that supersedes any older updates.</p>
</div>
<div class="paragraph">
<p>The channel_update message contains the following fields:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">signature</dt>
<dd>
<p>A digital signature matching the node&#8217;s public key, to authenticate the source and integrity of the channel update</p>
</dd>
<dt class="hdlist1">chain_hash</dt>
<dd>
<p>The hash of the genesis block of the chain containing the channel</p>
</dd>
<dt class="hdlist1">short_channel_id</dt>
<dd>
<p>The short channel ID to identify the channel</p>
</dd>
<dt class="hdlist1">timestamp</dt>
<dd>
<p>The timestamp of this update, to allow recipients to sequence updates and replace older updates</p>
</dd>
<dt class="hdlist1">message_flags</dt>
<dd>
<p>A bit field indicating the presence of additional fields in the channel_update message</p>
</dd>
<dt class="hdlist1">channel_flags</dt>
<dd>
<p>A bit field showing the direction of the channel and other channel options</p>
</dd>
<dt class="hdlist1">cltv_expiry_delta</dt>
<dd>
<p>The timelock delta expectations of this node for routing (see <a href="#onion_routing">[onion_routing]</a>)</p>
</dd>
<dt class="hdlist1">htlc_minimum_msat</dt>
<dd>
<p>The minimum HTLC amount that will be routed</p>
</dd>
<dt class="hdlist1">fee_base_msat</dt>
<dd>
<p>The base fee that will be charged for routing</p>
</dd>
<dt class="hdlist1">fee_proportional_millionths</dt>
<dd>
<p>The proportional fee rate that will be charged for routing</p>
</dd>
<dt class="hdlist1">htlc_maximum_msat (option_channel_htlc_max)</dt>
<dd>
<p>The maximum amount that will be routed</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>A node that receives the channel_update message can attach this metadata to the channel graph edge to enable pathfinding,  as we will see in <a href="#path_finding">[path_finding]</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ongoing_channel_graph_maintenance">Ongoing Channel Graph Maintenance</h3>
<div class="paragraph">
<p>The construction of a channel graph is not a one-time event, but rather an ongoing activity. As a node bootstraps into the network it will start receiving "gossip," in the form of the three update messages. It will use these messages to immediately start building a validated channel graph.</p>
</div>
<div class="paragraph">
<p>The more information a node receives, the better its "map" of the Lightning Network becomes and the more effective it can be at pathfinding and payment delivery.</p>
</div>
<div class="paragraph">
<p>A node won&#8217;t only add information to the channel graph. It will also keep track of the last time a channel was updated and will delete "stale" channels that have not been updated in more than two weeks. Finally, if it sees that some node no longer has any channels, it will also remove that node.</p>
</div>
<div class="paragraph">
<p>The information collected from the gossip protocol is not the only information that can be stored in the channel graph. Different Lightning node implementations may attach other metadata to nodes and channels. For example, some node implementations calculate a "score" that evaluates a node&#8217;s "quality" as a routing peer. This score is used as part of pathfinding to prioritize or deprioritize paths.</p>
</div>
</div>
<div class="sect2">
<h3 id="_conclusion">Conclusion</h3>
<div class="paragraph">
<p>In this chapter, we&#8217;ve learned how Lightning nodes discover each
other, discover and update their node status, and communicate with one another. We&#8217;ve learned how channel graphs are created and maintained, and we&#8217;ve explored a few ways that the Lightning Network discourages bad actors or dishonest nodes from spamming the network.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2022-10-29 15:50:16 +0400
</div>
</div>
</body>
</html>